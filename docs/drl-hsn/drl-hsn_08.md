

# ç¬¬å…«ç« ï¼šDQN æ‰©å±•

è‡ªä»Ž DeepMind åœ¨ 2015 å¹´å‘å¸ƒå…¶æ·±åº¦ Q ç½‘ç»œï¼ˆDQNï¼‰æ¨¡åž‹çš„è®ºæ–‡ä»¥æ¥ï¼Œè®¸å¤šæ”¹è¿›æ–¹æ¡ˆå·²ç»è¢«æå‡ºï¼Œå¹¶å¯¹åŸºç¡€æž¶æž„è¿›è¡Œäº†è°ƒæ•´ï¼Œæ˜¾è‘—æé«˜äº† DeepMind åŸºç¡€ DQN çš„æ”¶æ•›æ€§ã€ç¨³å®šæ€§å’Œæ ·æœ¬æ•ˆçŽ‡ã€‚æœ¬ç« å°†æ·±å…¥æŽ¢è®¨å…¶ä¸­çš„ä¸€äº›æ€æƒ³ã€‚

2017 å¹´ 10 æœˆï¼ŒDeepMind çš„ Hessel ç­‰äººå‘å¸ƒäº†ä¸€ç¯‡åä¸ºã€ŠRainbow: Combining improvements in deep reinforcement learningã€‹çš„è®ºæ–‡[Hes+18]ï¼Œä»‹ç»äº†å¯¹ DQN çš„å…­ä¸ªæœ€é‡è¦çš„æ”¹è¿›ï¼›å…¶ä¸­ä¸€äº›æ˜¯åœ¨ 2015 å¹´å‘æ˜Žçš„ï¼Œä½†å…¶ä»–ä¸€äº›åˆ™è¾ƒä¸ºè¿‘æœŸã€‚åœ¨è¿™ç¯‡è®ºæ–‡ä¸­ï¼Œé€šè¿‡ç®€å•åœ°ç»“åˆè¿™å…­ä¸ªæ–¹æ³•ï¼Œè¾¾åˆ°äº† Atari æ¸¸æˆå¥—ä»¶ä¸Šçš„æœ€å…ˆè¿›æˆæžœã€‚

è‡ª 2017 å¹´ä»¥æ¥ï¼Œæ›´å¤šçš„è®ºæ–‡è¢«å‘è¡¨ï¼Œå¹¶ä¸”æœ€å…ˆè¿›çš„ç»“æžœè¢«è¿›ä¸€æ­¥æŽ¨åŠ¨ï¼Œä½†è®ºæ–‡ä¸­ä»‹ç»çš„æ‰€æœ‰æ–¹æ³•ä»ç„¶æ˜¯ç›¸å…³çš„ï¼Œå¹¶åœ¨å®žè·µä¸­å¹¿æ³›ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œåœ¨ 2023 å¹´ï¼ŒMarc Bellemare å‡ºç‰ˆäº†ã€ŠDistributional reinforcement learningã€‹ä¸€ä¹¦[BDR23]ï¼Œä¹¦ä¸­è®¨è®ºäº†è®ºæ–‡ä¸­çš„ä¸€ç§æ–¹æ³•ã€‚æ­¤å¤–ï¼Œæ‰€æè¿°çš„æ”¹è¿›ç›¸å¯¹ç®€å•æ˜“äºŽå®žçŽ°å’Œç†è§£ï¼Œå› æ­¤åœ¨æœ¬ç‰ˆä¸­æˆ‘æ²¡æœ‰å¯¹è¿™ä¸€ç« åšé‡å¤§ä¿®æ”¹ã€‚

æˆ‘ä»¬å°†ç†Ÿæ‚‰çš„ DQN æ‰©å±•å¦‚ä¸‹ï¼š

+   N æ­¥ DQNï¼šå¦‚ä½•é€šè¿‡ç®€å•åœ°å±•å¼€è´å°”æ›¼æ–¹ç¨‹æé«˜æ”¶æ•›é€Ÿåº¦å’Œç¨³å®šæ€§ï¼Œä»¥åŠä¸ºä»€ä¹ˆå®ƒä¸æ˜¯ç»ˆæžè§£å†³æ–¹æ¡ˆ

+   åŒ DQNï¼šå¦‚ä½•å¤„ç† DQN å¯¹åŠ¨ä½œå€¼çš„é«˜ä¼°

+   å™ªå£°ç½‘ç»œï¼šå¦‚ä½•é€šè¿‡ç»™ç½‘ç»œæƒé‡æ·»åŠ å™ªå£°æ¥æé«˜æŽ¢ç´¢æ•ˆçŽ‡

+   ä¼˜å…ˆå›žæ”¾ç¼“å†²åŒºï¼šä¸ºä»€ä¹ˆå‡åŒ€é‡‡æ ·æˆ‘ä»¬çš„ç»éªŒä¸æ˜¯è®­ç»ƒçš„æœ€ä½³æ–¹å¼

+   å¯¹æŠ— DQNï¼šå¦‚ä½•é€šè¿‡ä½¿æˆ‘ä»¬çš„ç½‘ç»œæž¶æž„æ›´ç´§å¯†åœ°åæ˜ æˆ‘ä»¬æ­£åœ¨è§£å†³çš„é—®é¢˜ï¼Œæ¥æé«˜æ”¶æ•›é€Ÿåº¦

+   åˆ†ç±» DQNï¼šå¦‚ä½•è¶…è¶Šå•ä¸€çš„æœŸæœ›åŠ¨ä½œå€¼ï¼Œå¤„ç†å®Œæ•´çš„åˆ†å¸ƒ

æœ¬ç« å°†ä»‹ç»æ‰€æœ‰è¿™äº›æ–¹æ³•ã€‚æˆ‘ä»¬å°†åˆ†æžè¿™äº›æ–¹æ³•èƒŒåŽçš„æ€æƒ³ï¼Œä»¥åŠå¦‚ä½•å®žçŽ°å®ƒä»¬ï¼Œå¹¶ä¸Žç»å…¸çš„ DQN æ€§èƒ½è¿›è¡Œæ¯”è¾ƒã€‚æœ€åŽï¼Œæˆ‘ä»¬å°†åˆ†æžç»“åˆæ‰€æœ‰æ–¹æ³•çš„ç³»ç»Ÿè¡¨çŽ°ã€‚

# åŸºç¡€ DQN

ä¸ºäº†å¼€å§‹ï¼Œæˆ‘ä»¬å°†å®žçŽ°ä¸Žç¬¬å…­ç« ç›¸åŒçš„ DQN æ–¹æ³•ï¼Œä½†åˆ©ç”¨ç¬¬ä¸ƒç« ä¸­æè¿°çš„é«˜çº§åŽŸè¯­ã€‚è¿™å°†ä½¿æˆ‘ä»¬çš„ä»£ç æ›´åŠ ç®€æ´ï¼Œè¿™æ˜¯å¥½çš„ï¼Œå› ä¸ºæ— å…³çš„ç»†èŠ‚ä¸ä¼šä½¿æˆ‘ä»¬åç¦»æ–¹æ³•çš„é€»è¾‘ã€‚åŒæ—¶ï¼Œæœ¬ä¹¦çš„ç›®çš„å¹¶éžæ•™ä½ å¦‚ä½•ä½¿ç”¨çŽ°æœ‰çš„åº“ï¼Œè€Œæ˜¯å¦‚ä½•åŸ¹å…»å¯¹å¼ºåŒ–å­¦ä¹ æ–¹æ³•çš„ç›´è§‰ï¼Œå¿…è¦æ—¶ï¼Œä»Žé›¶å¼€å§‹å®žçŽ°ä¸€åˆ‡ã€‚ä»Žæˆ‘çš„è§’åº¦æ¥çœ‹ï¼Œè¿™æ˜¯ä¸€ä¸ªæ›´æœ‰ä»·å€¼çš„æŠ€èƒ½ï¼Œå› ä¸ºåº“ä¼šä¸æ–­å˜åŒ–ï¼Œä½†å¯¹é¢†åŸŸçš„çœŸæ­£ç†è§£å°†ä½¿ä½ èƒ½å¤Ÿè¿…é€Ÿç†è§£ä»–äººçš„ä»£ç ï¼Œå¹¶æœ‰æ„è¯†åœ°åº”ç”¨å®ƒã€‚

åœ¨åŸºæœ¬çš„ DQN å®žçŽ°ä¸­ï¼Œæˆ‘ä»¬åœ¨æœ¬ä¹¦çš„ GitHub ä»“åº“ä¸­çš„ Chapter08 æ–‡ä»¶å¤¹ä¸­æœ‰ä¸‰ä¸ªæ¨¡å—ï¼š

+   Chapter08/lib/dqn_model.py: DQN ç¥žç»ç½‘ç»œï¼ˆNNï¼‰ï¼Œä¸Žç¬¬å…­ç« ç›¸åŒï¼Œå› æ­¤æˆ‘ä¸ä¼šé‡å¤å®ƒã€‚

+   Chapter08/lib/common.py: æœ¬ç« ä»£ç å…±äº«çš„å¸¸ç”¨å‡½æ•°å’Œå£°æ˜Žã€‚

+   Chapter08/01_dqn_basic.py: 77 è¡Œä»£ç ï¼Œåˆ©ç”¨ PTAN å’Œ Ignite åº“å®žçŽ°åŸºæœ¬çš„ DQN æ–¹æ³•ã€‚

## å…¬å…±åº“

è®©æˆ‘ä»¬ä»Ž lib/common.py çš„å†…å®¹å¼€å§‹ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬æœ‰ä¸Šä¸€ç« ä¸­ä¸º Pong çŽ¯å¢ƒè®¾ç½®çš„è¶…å‚æ•°ã€‚è¿™äº›è¶…å‚æ•°å­˜å‚¨åœ¨ä¸€ä¸ªæ•°æ®ç±»å¯¹è±¡ä¸­ï¼Œè¿™æ˜¯å­˜å‚¨ä¸€ç»„æ•°æ®å­—æ®µåŠå…¶ç±»åž‹æ³¨é‡Šçš„æ ‡å‡†æ–¹å¼ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾ä¸ºä¸åŒã€æ›´å¤æ‚çš„ Atari æ¸¸æˆæ·»åŠ å¦ä¸€ä¸ªé…ç½®é›†ï¼Œå¹¶å…è®¸æˆ‘ä»¬å¯¹è¶…å‚æ•°è¿›è¡Œå®žéªŒï¼š

```py
@dataclasses.dataclass 
class Hyperparams: 
    env_name: str 
    stop_reward: float 
    run_name: str 
    replay_size: int 
    replay_initial: int 
    target_net_sync: int 
    epsilon_frames: int 

    learning_rate: float = 0.0001 
    batch_size: int = 32 
    gamma: float = 0.99 
    epsilon_start: float = 1.0 
    epsilon_final: float = 0.1 

    tuner_mode: bool = False 
    episodes_to_solve: int = 500 

GAME_PARAMS = { 
    â€™pongâ€™: Hyperparams( 
        env_name="PongNoFrameskip-v4", 
        stop_reward=18.0, 
        run_name="pong", 
        replay_size=100_000, 
        replay_initial=10_000, 
        target_net_sync=1000, 
        epsilon_frames=100_000, 
        epsilon_final=0.02, 
    ),
```

lib/common.py ä¸­çš„ä¸‹ä¸€ä¸ªå‡½æ•°åä¸º unpack_batchï¼Œå®ƒæŽ¥æ”¶è½¬ç§»çš„æ‰¹æ¬¡å¹¶å°†å…¶è½¬æ¢ä¸ºé€‚åˆè®­ç»ƒçš„ NumPy æ•°ç»„é›†åˆã€‚æ¥è‡ª ExperienceSourceFirstLast çš„æ¯ä¸ªè½¬ç§»éƒ½å±žäºŽ ExperienceFirstLast ç±»åž‹ï¼Œè¿™æ˜¯ä¸€ä¸ªæ•°æ®ç±»ï¼ŒåŒ…å«ä»¥ä¸‹å­—æ®µï¼š

+   state: æ¥è‡ªçŽ¯å¢ƒçš„è§‚æµ‹å€¼ã€‚

+   action: ä»£ç†æ‰§è¡Œçš„æ•´æ•°åŠ¨ä½œã€‚

+   reward: å¦‚æžœæˆ‘ä»¬åˆ›å»ºäº† ExperienceSourceFirstLast å¹¶è®¾ç½®äº†å±žæ€§ steps_count=1ï¼Œé‚£ä¹ˆå®ƒåªæ˜¯å³æ—¶å¥–åŠ±ã€‚å¯¹äºŽæ›´å¤§çš„æ­¥æ•°è®¡æ•°ï¼Œå®ƒåŒ…å«äº†è¿™ä¸ªæ­¥æ•°å†…çš„å¥–åŠ±çš„æŠ˜æ‰£æ€»å’Œã€‚

+   last_state: å¦‚æžœè½¬ç§»å¯¹åº”äºŽçŽ¯å¢ƒä¸­çš„æœ€åŽä¸€æ­¥ï¼Œé‚£ä¹ˆè¿™ä¸ªå­—æ®µä¸º Noneï¼›å¦åˆ™ï¼Œå®ƒåŒ…å«ç»éªŒé“¾ä¸­çš„æœ€åŽä¸€ä¸ªè§‚æµ‹å€¼ã€‚

unpack_batch çš„ä»£ç å¦‚ä¸‹ï¼š

```py
def unpack_batch(batch: tt.List[ExperienceFirstLast]): 
    states, actions, rewards, dones, last_states = [],[],[],[],[] 
    for exp in batch: 
        states.append(exp.state) 
        actions.append(exp.action) 
        rewards.append(exp.reward) 
        dones.append(exp.last_state is None) 
        if exp.last_state is None: 
            lstate = exp.state  # the result will be masked anyway 
        else: 
            lstate = exp.last_state 
        last_states.append(lstate) 
    return np.asarray(states), np.array(actions), np.array(rewards, dtype=np.float32), \ 
        np.array(dones, dtype=bool), np.asarray(last_states)
```

è¯·æ³¨æ„æˆ‘ä»¬å¦‚ä½•å¤„ç†æ‰¹æ¬¡ä¸­çš„æœ€ç»ˆè½¬ç§»ã€‚ä¸ºäº†é¿å…å¯¹è¿™ç§æƒ…å†µçš„ç‰¹æ®Šå¤„ç†ï¼Œå¯¹äºŽç»ˆæ­¢è½¬ç§»ï¼Œæˆ‘ä»¬å°†åˆå§‹çŠ¶æ€å­˜å‚¨åœ¨ last_states æ•°ç»„ä¸­ã€‚ä¸ºäº†ä½¿æˆ‘ä»¬çš„ Bellman æ›´æ–°è®¡ç®—æ­£ç¡®ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨æŸå¤±è®¡ç®—æ—¶ä½¿ç”¨ dones æ•°ç»„å¯¹è¿™äº›æ‰¹æ¬¡æ¡ç›®è¿›è¡ŒæŽ©ç ã€‚å¦ä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯ä»…å¯¹éžç»ˆæ­¢è½¬ç§»è®¡ç®—æœ€åŽçŠ¶æ€çš„å€¼ï¼Œä½†è¿™ä¼šä½¿æˆ‘ä»¬çš„æŸå¤±å‡½æ•°é€»è¾‘ç¨å¾®å¤æ‚ä¸€äº›ã€‚

DQN æŸå¤±å‡½æ•°çš„è®¡ç®—ç”± calc_loss_dqn å‡½æ•°æä¾›ï¼Œä»£ç å‡ ä¹Žä¸Žç¬¬å…­ç« ç›¸åŒã€‚å”¯ä¸€çš„å°æ”¹åŠ¨æ˜¯ torch.no_grad()ï¼Œå®ƒé˜»æ­¢äº† PyTorch è®¡ç®—å›¾è¢«è®°å½•åˆ°ç›®æ ‡ç½‘ç»œä¸­ï¼š

```py
def calc_loss_dqn( 
        batch: tt.List[ExperienceFirstLast], net: nn.Module, tgt_net: nn.Module, 
        gamma: float, device: torch.device) -> torch.Tensor: 
    states, actions, rewards, dones, next_states = unpack_batch(batch) 

    states_v = torch.as_tensor(states).to(device) 
    next_states_v = torch.as_tensor(next_states).to(device) 
    actions_v = torch.tensor(actions).to(device) 
    rewards_v = torch.tensor(rewards).to(device) 
    done_mask = torch.BoolTensor(dones).to(device) 

    actions_v = actions_v.unsqueeze(-1) 
    state_action_vals = net(states_v).gather(1, actions_v) 
    state_action_vals = state_action_vals.squeeze(-1) 
    with torch.no_grad(): 
        next_state_vals = tgt_net(next_states_v).max(1)[0] 
        next_state_vals[done_mask] = 0.0 

    bellman_vals = next_state_vals.detach() * gamma + rewards_v 
    return nn.MSELoss()(state_action_vals, bellman_vals)
```

é™¤äº†æ ¸å¿ƒçš„ DQN å‡½æ•°å¤–ï¼Œcommon.py è¿˜æä¾›äº†ä¸Žè®­ç»ƒå¾ªçŽ¯ã€æ•°æ®ç”Ÿæˆå’Œ TensorBoard è·Ÿè¸ªç›¸å…³çš„å¤šä¸ªå®žç”¨å·¥å…·ã€‚ç¬¬ä¸€ä¸ªè¿™æ ·çš„å·¥å…·æ˜¯ä¸€ä¸ªå°ç±»ï¼Œå®ƒåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­å®žçŽ°äº† epsilon è¡°å‡ã€‚Epsilon å®šä¹‰äº†ä»£ç†æ‰§è¡ŒéšæœºåŠ¨ä½œçš„æ¦‚çŽ‡ã€‚å®ƒåº”ä»Ž 1.0 å¼€å§‹ï¼ˆå®Œå…¨éšæœºçš„ä»£ç†ï¼‰ï¼Œé€æ¸è¡°å‡åˆ°æŸä¸ªå°å€¼ï¼Œæ¯”å¦‚ 0.02 æˆ– 0.01ã€‚è¿™ä¸ªä»£ç éžå¸¸ç®€å•ï¼Œä½†å‡ ä¹Žåœ¨ä»»ä½• DQN ä¸­éƒ½éœ€è¦ï¼Œå› æ­¤é€šè¿‡ä»¥ä¸‹å°ç±»æä¾›ï¼š

```py
class EpsilonTracker: 
    def __init__(self, selector: EpsilonGreedyActionSelector, params: Hyperparams): 
        self.selector = selector 
        self.params = params 
        self.frame(0) 

    def frame(self, frame_idx: int): 
        eps = self.params.epsilon_start - frame_idx / self.params.epsilon_frames 
        self.selector.epsilon = max(self.params.epsilon_final, eps)
```

å¦ä¸€ä¸ªå°å‡½æ•°æ˜¯ batch_generatorï¼Œå®ƒæŽ¥æ”¶ ExperienceReplayBufferï¼ˆPTAN ç±»ï¼Œåœ¨ç¬¬ä¸ƒç« ä¸­æè¿°ï¼‰å¹¶æ— é™æ¬¡ç”Ÿæˆä»Žç¼“å†²åŒºä¸­é‡‡æ ·çš„è®­ç»ƒæ‰¹æ¬¡ã€‚å¼€å§‹æ—¶ï¼Œå‡½æ•°ç¡®ä¿ç¼“å†²åŒºåŒ…å«æ‰€éœ€æ•°é‡çš„æ ·æœ¬ï¼š

```py
def batch_generator(buffer: ExperienceReplayBuffer, initial: int, batch_size: int) -> \ 
        tt.Generator[tt.List[ExperienceFirstLast], None, None]: 
    buffer.populate(initial) 
    while True: 
        buffer.populate(1) 
        yield buffer.sample(batch_size)
```

æœ€åŽï¼Œä¸€ä¸ªå†—é•¿ä½†éžå¸¸æœ‰ç”¨çš„å‡½æ•°å«åš setup_igniteï¼Œå®ƒé™„åŠ äº†æ‰€éœ€çš„ Ignite å¤„ç†å™¨ï¼Œæ˜¾ç¤ºè®­ç»ƒè¿›åº¦å¹¶å°†åº¦é‡å†™å…¥ TensorBoardã€‚è®©æˆ‘ä»¬ä¸€å—å„¿çœ‹è¿™ä¸ªå‡½æ•°ï¼š

```py
def setup_ignite( 
        engine: Engine, params: Hyperparams, exp_source: ExperienceSourceFirstLast, 
        run_name: str, extra_metrics: tt.Iterable[str] = (), 
        tuner_reward_episode: int = 100, tuner_reward_min: float = -19, 
): 
    handler = ptan_ignite.EndOfEpisodeHandler( 
        exp_source, bound_avg_reward=params.stop_reward) 
    handler.attach(engine) 
    ptan_ignite.EpisodeFPSHandler().attach(engine)
```

æœ€åˆï¼Œsetup_ignite é™„åŠ äº† PTAN æä¾›çš„ä¸¤ä¸ª Ignite å¤„ç†å™¨ï¼š

+   EndOfEpisodeHandlerï¼Œæ¯å½“æ¸¸æˆå›žåˆç»“æŸæ—¶ï¼Œå®ƒä¼šè§¦å‘ Ignite äº‹ä»¶ã€‚å½“å›žåˆçš„å¹³å‡å¥–åŠ±è¶…è¿‡æŸä¸ªè¾¹ç•Œæ—¶ï¼Œå®ƒè¿˜å¯ä»¥è§¦å‘äº‹ä»¶ã€‚æˆ‘ä»¬ç”¨å®ƒæ¥æ£€æµ‹æ¸¸æˆä½•æ—¶æœ€ç»ˆè§£å†³ã€‚

+   EpisodeFPSHandlerï¼Œè¿™æ˜¯ä¸€ä¸ªå°ç±»ï¼Œè·Ÿè¸ªæ¯ä¸ªå›žåˆæ‰€èŠ±è´¹çš„æ—¶é—´ä»¥åŠæˆ‘ä»¬ä¸ŽçŽ¯å¢ƒäº¤äº’çš„æ¬¡æ•°ã€‚æ ¹æ®è¿™äº›ä¿¡æ¯ï¼Œæˆ‘ä»¬è®¡ç®—æ¯ç§’å¸§æ•°ï¼ˆFPSï¼‰ï¼Œå®ƒæ˜¯ä¸€ä¸ªé‡è¦çš„æ€§èƒ½åº¦é‡æŒ‡æ ‡ã€‚

ç„¶åŽï¼Œæˆ‘ä»¬å®‰è£…ä¸¤ä¸ªäº‹ä»¶å¤„ç†å™¨ï¼š

```py
 @engine.on(ptan_ignite.EpisodeEvents.EPISODE_COMPLETED) 
    def episode_completed(trainer: Engine): 
        passed = trainer.state.metrics.get(â€™time_passedâ€™, 0) 
        print("Episode %d: reward=%.0f, steps=%s, speed=%.1f f/s, elapsed=%s" % ( 
            trainer.state.episode, trainer.state.episode_reward, 
            trainer.state.episode_steps, trainer.state.metrics.get(â€™avg_fpsâ€™, 0), 
            timedelta(seconds=int(passed)))) 

    @engine.on(ptan_ignite.EpisodeEvents.BOUND_REWARD_REACHED) 
    def game_solved(trainer: Engine): 
        passed = trainer.state.metrics[â€™time_passedâ€™] 
        print("Game solved in %s, after %d episodes and %d iterations!" % ( 
            timedelta(seconds=int(passed)), trainer.state.episode, 
            trainer.state.iteration)) 
        trainer.should_terminate = True 
        trainer.state.solved = True
```

å…¶ä¸­ä¸€ä¸ªäº‹ä»¶å¤„ç†å™¨ä¼šåœ¨å›žåˆç»“æŸæ—¶è¢«è°ƒç”¨ã€‚å®ƒå°†åœ¨æŽ§åˆ¶å°ä¸Šæ˜¾ç¤ºæœ‰å…³å·²å®Œæˆå›žåˆçš„ä¿¡æ¯ã€‚å¦ä¸€ä¸ªå‡½æ•°ä¼šåœ¨å¹³å‡å¥–åŠ±è¶…è¿‡è¶…å‚æ•°ä¸­å®šä¹‰çš„è¾¹ç•Œæ—¶è¢«è°ƒç”¨ï¼ˆåœ¨ Pong çš„æƒ…å†µä¸‹æ˜¯ 18.0ï¼‰ã€‚æ­¤å‡½æ•°æ˜¾ç¤ºå…³äºŽå·²è§£å†³æ¸¸æˆçš„æ¶ˆæ¯ï¼Œå¹¶åœæ­¢è®­ç»ƒã€‚

è¯¥å‡½æ•°çš„å…¶ä½™éƒ¨åˆ†ä¸Žæˆ‘ä»¬æƒ³è¦è·Ÿè¸ªçš„ TensorBoard æ•°æ®æœ‰å…³ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª TensorboardLoggerï¼š

```py
 now = datetime.now().isoformat(timespec=â€™minutesâ€™).replace(â€™:â€™, â€™â€™) 
    logdir = f"runs/{now}-{params.run_name}-{run_name}" 
    tb = tb_logger.TensorboardLogger(log_dir=logdir) 
    run_avg = RunningAverage(output_transform=lambda v: v[â€™lossâ€™]) 
    run_avg.attach(engine, "avg_loss")
```

è¿™æ˜¯ Ignite æä¾›çš„ä¸€ä¸ªç‰¹æ®Šç±»ï¼Œç”¨äºŽå†™å…¥ TensorBoardã€‚æˆ‘ä»¬çš„å¤„ç†å‡½æ•°å°†è¿”å›žæŸå¤±å€¼ï¼Œå› æ­¤æˆ‘ä»¬é™„åŠ äº† RunningAverage è½¬æ¢ï¼ˆåŒæ ·ç”± Ignite æä¾›ï¼‰ï¼Œä»¥èŽ·å–éšæ—¶é—´å¹³æ»‘çš„æŸå¤±ç‰ˆæœ¬ã€‚

æŽ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è¦è·Ÿè¸ªçš„åº¦é‡å€¼é™„åŠ åˆ° Ignite äº‹ä»¶ï¼š

```py
 metrics = [â€™rewardâ€™, â€™stepsâ€™, â€™avg_rewardâ€™] 
    handler = tb_logger.OutputHandler(tag="episodes", metric_names=metrics) 
    event = ptan_ignite.EpisodeEvents.EPISODE_COMPLETED 
    tb.attach(engine, log_handler=handler, event_name=event)
```

TensorboardLogger å¯ä»¥è·Ÿè¸ªæ¥è‡ª Ignite çš„ä¸¤ç»„å€¼ï¼šè¾“å‡ºï¼ˆç”±è½¬æ¢å‡½æ•°è¿”å›žçš„å€¼ï¼‰å’Œåº¦é‡ï¼ˆåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­è®¡ç®—å¹¶ä¿å­˜åœ¨å¼•æ“ŽçŠ¶æ€ä¸­ï¼‰ã€‚EndOfEpisodeHandler å’Œ EpisodeFPSHandler æä¾›åº¦é‡ï¼Œè¿™äº›åº¦é‡åœ¨æ¯ä¸ªæ¸¸æˆå›žåˆç»“æŸæ—¶æ›´æ–°ã€‚å› æ­¤ï¼Œæˆ‘ä»¬é™„åŠ äº† OutputHandlerï¼Œæ¯å½“å›žåˆå®Œæˆæ—¶ï¼Œå®ƒå°†æŠŠæœ‰å…³è¯¥å›žåˆçš„ä¿¡æ¯å†™å…¥ TensorBoardã€‚

æŽ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è·Ÿè¸ªè®­ç»ƒè¿‡ç¨‹ä¸­çš„å¦ä¸€ç»„å€¼ï¼Œè®­ç»ƒè¿‡ç¨‹ä¸­çš„åº¦é‡å€¼ï¼šæŸå¤±ã€FPSï¼Œä»¥åŠå¯èƒ½ä¸Žç‰¹å®šæ‰©å±•é€»è¾‘ç›¸å…³çš„è‡ªå®šä¹‰åº¦é‡ï¼š

```py
 ptan_ignite.PeriodicEvents().attach(engine) 
    metrics = [â€™avg_lossâ€™, â€™avg_fpsâ€™] 
    metrics.extend(extra_metrics) 
    handler = tb_logger.OutputHandler(tag="train", metric_names=metrics, 
                                      output_transform=lambda a: a) 
    event = ptan_ignite.PeriodEvents.ITERS_100_COMPLETED 
    tb.attach(engine, log_handler=handler, event_name=event)
```

è¿™äº›å€¼ä¼šåœ¨æ¯æ¬¡è®­ç»ƒè¿­ä»£æ—¶æ›´æ–°ï¼Œä½†æˆ‘ä»¬å°†è¿›è¡Œæ•°ç™¾ä¸‡æ¬¡è¿­ä»£ï¼Œå› æ­¤æˆ‘ä»¬æ¯è¿›è¡Œ 100 æ¬¡è®­ç»ƒè¿­ä»£å°±å°†å€¼å­˜å‚¨åˆ° TensorBoardï¼›å¦åˆ™ï¼Œæ•°æ®æ–‡ä»¶ä¼šéžå¸¸å¤§ã€‚æ‰€æœ‰è¿™äº›åŠŸèƒ½çœ‹èµ·æ¥å¯èƒ½å¾ˆå¤æ‚ï¼Œä½†å®ƒä¸ºæˆ‘ä»¬æä¾›äº†ä»Žè®­ç»ƒè¿‡ç¨‹ä¸­æ”¶é›†çš„ç»Ÿä¸€åº¦é‡é›†ã€‚äº‹å®žä¸Šï¼ŒIgnite å¹¶ä¸å¤æ‚ï¼Œè€ƒè™‘åˆ°å®ƒæ‰€æä¾›çš„çµæ´»æ€§ã€‚common.py å°±åˆ°è¿™é‡Œã€‚

## å®žçŽ°

çŽ°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ 01_dqn_basic.pyï¼Œå®ƒåˆ›å»ºäº†æ‰€éœ€çš„ç±»å¹¶å¼€å§‹è®­ç»ƒã€‚æˆ‘å°†çœç•¥ä¸ç›¸å…³çš„ä»£ç ï¼Œåªå…³æ³¨é‡è¦éƒ¨åˆ†ï¼ˆå®Œæ•´ç‰ˆæœ¬å¯ä»¥åœ¨ GitHub ä»“åº“ä¸­æ‰¾åˆ°ï¼‰ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºçŽ¯å¢ƒï¼š

```py
 env = gym.make(params.env_name) 
    env = ptan.common.wrappers.wrap_dqn(env) 

    net = dqn_model.DQN(env.observation_space.shape, env.action_space.n).to(device) 
    tgt_net = ptan.agent.TargetNet(net)
```

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åº”ç”¨ä¸€ç»„æ ‡å‡†åŒ…è£…å™¨ã€‚æˆ‘ä»¬åœ¨ç¬¬å…­ç« ä¸­è®¨è®ºäº†è¿™äº›åŒ…è£…å™¨ï¼Œå¹¶ä¸”åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œå½“æˆ‘ä»¬ä¼˜åŒ– Pong æ±‚è§£å™¨çš„æ€§èƒ½æ—¶ï¼Œè¿˜ä¼šå†æ¬¡æ¶‰åŠåˆ°å®ƒä»¬ã€‚ç„¶åŽï¼Œæˆ‘ä»¬åˆ›å»º DQN æ¨¡åž‹å’Œç›®æ ‡ç½‘ç»œã€‚

æŽ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ›å»ºä»£ç†ï¼Œå¹¶ä¼ å…¥ä¸€ä¸ª epsilon-greedy åŠ¨ä½œé€‰æ‹©å™¨ï¼š

```py
 selector = ptan.actions.EpsilonGreedyActionSelector(epsilon=params.epsilon_start) 
    epsilon_tracker = common.EpsilonTracker(selector, params) 
    agent = ptan.agent.DQNAgent(net, selector, device=device)
```

åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œepsilon å°†ç”±æˆ‘ä»¬ä¹‹å‰è®¨è®ºè¿‡çš„ EpsilonTracker ç±»è¿›è¡Œå‡å°‘ã€‚è¿™å°†å‡å°‘éšæœºé€‰æ‹©çš„åŠ¨ä½œæ•°é‡ï¼Œå¹¶ç»™äºˆæˆ‘ä»¬çš„ç¥žç»ç½‘ç»œæ›´å¤šçš„æŽ§åˆ¶æƒã€‚

æŽ¥ä¸‹æ¥ï¼Œä¸¤ä¸ªéžå¸¸é‡è¦çš„å¯¹è±¡æ˜¯ ExperienceSourceFirstLast å’Œ ExperienceReplayBufferï¼š

```py
 exp_source = ptan.experience.ExperienceSourceFirstLast( 
        env, agent, gamma=params.gamma, env_seed=common.SEED) 
    buffer = ptan.experience.ExperienceReplayBuffer( 
        exp_source, buffer_size=params.replay_size)
```

ExperienceSourceFirstLast æŽ¥æ”¶ä»£ç†å’ŒçŽ¯å¢ƒï¼Œå¹¶åœ¨æ¸¸æˆå›žåˆä¸­æä¾›è¿‡æ¸¡ã€‚è¿™äº›è¿‡æ¸¡å°†è¢«ä¿å­˜åœ¨ç»éªŒå›žæ”¾ç¼“å†²åŒºä¸­ã€‚

ç„¶åŽæˆ‘ä»¬åˆ›å»ºä¼˜åŒ–å™¨å¹¶å®šä¹‰å¤„ç†å‡½æ•°ï¼š

```py
 optimizer = optim.Adam(net.parameters(), lr=params.learning_rate) 

    def process_batch(engine, batch): 
        optimizer.zero_grad() 
        loss_v = common.calc_loss_dqn(batch, net, tgt_net.target_model, 
                                      gamma=params.gamma, device=device) 
        loss_v.backward() 
        optimizer.step() 
        epsilon_tracker.frame(engine.state.iteration) 
        if engine.state.iteration % params.target_net_sync == 0: 
            tgt_net.sync() 
        return { 
            "loss": loss_v.item(), 
            "epsilon": selector.epsilon, 
        }
```

å¤„ç†å‡½æ•°å°†åœ¨æ¯æ‰¹è¿‡æ¸¡æ—¶è¢«è°ƒç”¨ä»¥è®­ç»ƒæ¨¡åž‹ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬è°ƒç”¨ common.calc_loss_dqn å‡½æ•°ï¼Œç„¶åŽå¯¹ç»“æžœè¿›è¡Œåå‘ä¼ æ’­ã€‚è¯¥å‡½æ•°è¿˜ä¼šè¦æ±‚ EpsilonTracker å‡å°‘ epsilonï¼Œå¹¶è¿›è¡Œå®šæœŸçš„ç›®æ ‡ç½‘ç»œåŒæ­¥ã€‚

æœ€åŽï¼Œæˆ‘ä»¬åˆ›å»º Ignite Engine å¯¹è±¡ï¼š

```py
 engine = Engine(process_batch) 
    common.setup_ignite(engine, params, exp_source, NAME) 
    engine.run(common.batch_generator(buffer, params.replay_initial, params.batch_size))
```

æˆ‘ä»¬ä½¿ç”¨æ¥è‡ª common.py çš„å‡½æ•°è¿›è¡Œé…ç½®ï¼Œå¹¶è¿è¡Œè®­ç»ƒè¿‡ç¨‹ã€‚

## è¶…å‚æ•°è°ƒä¼˜

ä¸ºäº†ä½¿æˆ‘ä»¬å¯¹ DQN æ‰©å±•çš„æ¯”è¾ƒæ›´åŠ å…¬å¹³ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è°ƒä¼˜è¶…å‚æ•°ã€‚è¿™ä¸€ç‚¹è‡³å…³é‡è¦ï¼Œå› ä¸ºå³ä½¿å¯¹äºŽç›¸åŒçš„æ¸¸æˆï¼ˆPongï¼‰ï¼Œä½¿ç”¨å›ºå®šçš„è®­ç»ƒå‚æ•°é›†å¯èƒ½åœ¨æˆ‘ä»¬æ”¹å˜æ–¹æ³•ç»†èŠ‚æ—¶ç»™å‡ºè¾ƒå·®çš„ç»“æžœã€‚

åŽŸåˆ™ä¸Šï¼Œæˆ‘ä»¬ä»£ç ä¸­çš„æ¯ä¸ªæ˜¾å¼æˆ–éšå¼å¸¸é‡éƒ½å¯ä»¥è¿›è¡Œè°ƒä¼˜ï¼Œä¾‹å¦‚ï¼š

+   ç½‘ç»œé…ç½®ï¼šå±‚çš„æ•°é‡å’Œå¤§å°ï¼Œæ¿€æ´»å‡½æ•°ï¼Œdropout ç­‰

+   ä¼˜åŒ–å‚æ•°ï¼šæ–¹æ³•ï¼ˆåŽŸç”Ÿ SGDã€Adamã€AdaGrad ç­‰ï¼‰ã€å­¦ä¹ çŽ‡å’Œå…¶ä»–ä¼˜åŒ–å™¨å‚æ•°

+   æŽ¢ç´¢å‚æ•°ï¼šðœ– çš„è¡°å‡çŽ‡ï¼Œæœ€ç»ˆ ðœ– å€¼

+   Bellman æ–¹ç¨‹ä¸­çš„æŠ˜æ‰£å› å­ Î³

ä½†æ˜¯ï¼Œæˆ‘ä»¬è°ƒæ•´çš„æ¯ä¸ªæ–°å‚æ•°éƒ½ä¼šå¯¹æ‰€éœ€çš„è¯•éªŒè®­ç»ƒé‡äº§ç”Ÿä¹˜æ³•æ•ˆåº”ï¼Œå› æ­¤è°ƒèŠ‚è¿‡å¤šçš„è¶…å‚æ•°å¯èƒ½éœ€è¦è¿›è¡Œæ•°ç™¾æ¬¡ç”šè‡³ä¸Šåƒæ¬¡è®­ç»ƒã€‚åƒ Google å’Œ Meta è¿™æ ·çš„å¤§å…¬å¸æ‹¥æœ‰æ¯”æˆ‘ä»¬è¿™äº›ä¸ªäººç ”ç©¶è€…æ›´å¤šçš„ GPU èµ„æºï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨è¿™é‡Œä¿æŒå¹³è¡¡ã€‚

åœ¨æˆ‘çš„ä¾‹å­ä¸­ï¼Œæˆ‘å°†æ¼”ç¤ºå¦‚ä½•è¿›è¡Œè¶…å‚æ•°è°ƒä¼˜ï¼Œä½†æˆ‘ä»¬åªä¼šåœ¨å°‘æ•°å‡ ä¸ªå€¼ä¸Šè¿›è¡Œæœç´¢ï¼š

+   å­¦ä¹ çŽ‡

+   æŠ˜æ‰£å› å­ Î³

+   æˆ‘ä»¬æ­£åœ¨è€ƒè™‘çš„ DQN æ‰©å±•ç‰¹å®šçš„å‚æ•°

æœ‰å‡ ä¸ªåº“å¯èƒ½å¯¹è¶…å‚æ•°è°ƒæ•´æœ‰æ‰€å¸®åŠ©ã€‚è¿™é‡Œï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯ Ray Tuneï¼ˆ[`docs.ray.io/en/latest/tune/index.xhtml`](https://docs.ray.io/en/latest/tune/index.xhtml)ï¼‰ï¼Œå®ƒæ˜¯ Ray é¡¹ç›®çš„ä¸€éƒ¨åˆ†â€”â€”ä¸€ä¸ªç”¨äºŽæœºå™¨å­¦ä¹ å’Œæ·±åº¦å­¦ä¹ çš„åˆ†å¸ƒå¼è®¡ç®—æ¡†æž¶ã€‚ä»Žé«˜å±‚æ¬¡æ¥çœ‹ï¼Œä½ éœ€è¦å®šä¹‰ï¼š

+   ä½ å¸Œæœ›æŽ¢ç´¢çš„è¶…å‚æ•°ç©ºé—´ï¼ˆå€¼çš„è¾¹ç•Œæˆ–æ˜¾å¼åˆ—å‡ºçš„å°è¯•å€¼åˆ—è¡¨ï¼‰

+   è¯¥å‡½æ•°æ‰§è¡Œä½¿ç”¨ç‰¹å®šè¶…å‚æ•°å€¼çš„è®­ç»ƒï¼Œå¹¶è¿”å›žä½ æƒ³è¦ä¼˜åŒ–çš„åº¦é‡ã€‚

è¿™å¯èƒ½çœ‹èµ·æ¥ä¸Žæœºå™¨å­¦ä¹ é—®é¢˜éžå¸¸ç›¸ä¼¼ï¼Œäº‹å®žä¸Šå®ƒç¡®å®žæ˜¯â€”â€”è¿™ä¹Ÿæ˜¯ä¸€ä¸ªä¼˜åŒ–é—®é¢˜ã€‚ä½†å®ƒæœ‰ä¸€äº›æ˜¾è‘—çš„ä¸åŒï¼šæˆ‘ä»¬æ­£åœ¨ä¼˜åŒ–çš„å‡½æ•°æ˜¯ä¸å¯å¾®åˆ†çš„ï¼ˆå› æ­¤æ— æ³•æ‰§è¡Œæ¢¯åº¦ä¸‹é™æ¥æŽ¨åŠ¨è¶…å‚æ•°æœå‘æœŸæœ›çš„åº¦é‡æ–¹å‘ï¼‰ï¼Œè€Œä¸”ä¼˜åŒ–ç©ºé—´å¯èƒ½æ˜¯ç¦»æ•£çš„ï¼ˆä¾‹å¦‚ï¼Œä½ æ— æ³•ç”¨ 2.435 å±‚çš„ç¥žç»ç½‘ç»œè¿›è¡Œè®­ç»ƒï¼Œå› ä¸ºæˆ‘ä»¬æ— æ³•å¯¹ä¸€ä¸ªä¸å¹³æ»‘çš„å‡½æ•°æ±‚å¯¼ï¼‰ã€‚

åœ¨åŽç»­ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä¼šç¨å¾®è§¦åŠä¸€ä¸‹è¿™ä¸ªé—®é¢˜ï¼Œè®¨è®ºé»‘ç®±ä¼˜åŒ–æ–¹æ³•ï¼ˆç¬¬åä¸ƒç« ï¼‰å’Œç¦»æ•£ä¼˜åŒ–ä¸­çš„å¼ºåŒ–å­¦ä¹ ï¼ˆç¬¬äºŒåä¸€ç« ï¼‰ï¼Œä½†çŽ°åœ¨æˆ‘ä»¬å°†ä½¿ç”¨æœ€ç®€å•çš„æ–¹æ³•â€”â€”è¶…å‚æ•°çš„éšæœºæœç´¢ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ`ray.tune`åº“ä¼šéšæœºå¤šæ¬¡é‡‡æ ·å…·ä½“çš„å‚æ•°ï¼Œå¹¶è°ƒç”¨å‡½æ•°ä»¥èŽ·å¾—åº¦é‡ã€‚æœ€å°ï¼ˆæˆ–æœ€å¤§ï¼‰çš„åº¦é‡å€¼å¯¹åº”äºŽåœ¨æ­¤æ¬¡è¿è¡Œä¸­æ‰¾åˆ°çš„æœ€ä½³è¶…å‚æ•°ç»„åˆã€‚

åœ¨è¿™ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬çš„åº¦é‡ï¼ˆä¼˜åŒ–ç›®æ ‡ï¼‰å°†æ˜¯ä»£ç†éœ€è¦çŽ©å¤šå°‘å±€æ¸¸æˆæ‰èƒ½è§£å†³æ¸¸æˆï¼ˆå³åœ¨ Pong ä¸­è¾¾åˆ°å¤§äºŽ 18 çš„å¹³å‡å¾—åˆ†ï¼‰ã€‚

ä¸ºäº†è¯´æ˜Žè°ƒæ•´çš„æ•ˆæžœï¼Œå¯¹äºŽæ¯ä¸ª DQN æ‰©å±•ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ç»„å›ºå®šçš„å‚æ•°ï¼ˆä¸Žç¬¬å…­ç« ç›¸åŒï¼‰æ£€æŸ¥è®­ç»ƒåŠ¨æ€ï¼Œå¹¶ä½¿ç”¨åœ¨ 20-30 è½®è°ƒæ•´åŽæ‰¾åˆ°çš„æœ€ä½³è¶…å‚æ•°è¿›è¡Œè®­ç»ƒã€‚å¦‚æžœä½ æ„¿æ„ï¼Œä½ å¯ä»¥åšè‡ªå·±çš„å®žéªŒï¼Œä¼˜åŒ–æ›´å¤šçš„è¶…å‚æ•°ã€‚æœ€æœ‰å¯èƒ½çš„æ˜¯ï¼Œè¿™å°†ä½¿ä½ èƒ½å¤Ÿæ‰¾åˆ°ä¸€ä¸ªæ›´å¥½çš„è®­ç»ƒé…ç½®ã€‚

è¿™ä¸ªè¿‡ç¨‹çš„æ ¸å¿ƒå®žçŽ°æ˜¯åœ¨`common.tune_params`å‡½æ•°ä¸­ã€‚è®©æˆ‘ä»¬çœ‹çœ‹å®ƒçš„ä»£ç ã€‚æˆ‘ä»¬ä»Žç±»åž‹å£°æ˜Žå’Œè¶…å‚æ•°ç©ºé—´å¼€å§‹ï¼š

```py
TrainFunc = tt.Callable[ 
    [Hyperparams, torch.device, dict], 
    tt.Optional[int] 
] 

BASE_SPACE = { 
    "learning_rate": tune.loguniform(1e-5, 1e-4), 
    "gamma": tune.choice([0.9, 0.92, 0.95, 0.98, 0.99, 0.995]), 
}
```

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬é¦–å…ˆå®šä¹‰è®­ç»ƒå‡½æ•°çš„ç±»åž‹ï¼Œå®ƒæŽ¥æ”¶ä¸€ä¸ª`Hyperparams`æ•°æ®ç±»ã€ä¸€ä¸ªè¦ä½¿ç”¨çš„`torch.device`ï¼Œä»¥åŠä¸€ä¸ªåŒ…å«é¢å¤–å‚æ•°çš„å­—å…¸ï¼ˆå› ä¸ºæˆ‘ä»¬å³å°†ä»‹ç»çš„æŸäº› DQN æ‰©å±•å¯èƒ½éœ€è¦é™¤äº†åœ¨`Hyperparams`ä¸­å£°æ˜Žçš„å‚æ•°ä»¥å¤–çš„é¢å¤–å‚æ•°ï¼‰ã€‚

å‡½æ•°çš„ç»“æžœå¯ä»¥æ˜¯ä¸€ä¸ªæ•´æ•°å€¼ï¼Œè¡¨ç¤ºåœ¨è¾¾åˆ° 18 åˆ†çš„å¾—åˆ†ä¹‹å‰æˆ‘ä»¬çŽ©äº†å¤šå°‘å±€æ¸¸æˆï¼Œæˆ–è€…æ˜¯ Noneï¼Œå¦‚æžœæˆ‘ä»¬å†³å®šæå‰åœæ­¢è®­ç»ƒã€‚è¿™æ˜¯å¿…éœ€çš„ï¼Œå› ä¸ºæŸäº›è¶…å‚æ•°ç»„åˆå¯èƒ½æ— æ³•æ”¶æ•›æˆ–æ”¶æ•›å¾—å¤ªæ…¢ï¼Œå› æ­¤ä¸ºäº†èŠ‚çœæ—¶é—´ï¼Œæˆ‘ä»¬ä¼šåœ¨ä¸ç­‰å¾…å¤ªä¹…çš„æƒ…å†µä¸‹åœæ­¢è®­ç»ƒã€‚

ç„¶åŽæˆ‘ä»¬å®šä¹‰è¶…å‚æ•°æœç´¢ç©ºé—´â€”â€”è¿™æ˜¯ä¸€ä¸ªå…·æœ‰å­—ç¬¦ä¸²é”®ï¼ˆå‚æ•°åï¼‰å’Œå¯èƒ½å€¼æŽ¢ç´¢çš„ `tune` å£°æ˜Žçš„å­—å…¸ã€‚å®ƒå¯ä»¥æ˜¯ä¸€ä¸ªæ¦‚çŽ‡åˆ†å¸ƒï¼ˆå‡åŒ€ã€å¯¹æ•°å‡åŒ€ã€æ­£æ€ç­‰ï¼‰æˆ–è¦å°è¯•çš„æ˜¾å¼å€¼åˆ—è¡¨ã€‚ä½ è¿˜å¯ä»¥ä½¿ç”¨ `tune.grid_search` å£°æ˜Žï¼Œæä¾›ä¸€ä¸ªå€¼åˆ—è¡¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°†å°è¯•æ‰€æœ‰å€¼ã€‚

åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä»Žå¯¹æ•°å‡åŒ€åˆ†å¸ƒä¸­é‡‡æ ·å­¦ä¹ çŽ‡ï¼Œå¹¶ä»Žä¸€ä¸ªåŒ…å« 6 ä¸ªå€¼ï¼ˆèŒƒå›´ä»Ž 0.9 åˆ° 0.995ï¼‰çš„åˆ—è¡¨ä¸­é‡‡æ · gammaã€‚

æŽ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æœ‰ `tune_params` å‡½æ•°ï¼š

```py
def tune_params( 
        base_params: Hyperparams, train_func: TrainFunc, device: torch.device, 
        samples: int = 10, extra_space: tt.Optional[tt.Dict[str, tt.Any]] = None, 
): 
    search_space = dict(BASE_SPACE) 
    if extra_space is not None: 
        search_space.update(extra_space) 
    config = tune.TuneConfig(num_samples=samples) 

    def objective(config: dict, device: torch.device) -> dict: 
        keys = dataclasses.asdict(base_params).keys() 
        upd = {"tuner_mode": True} 
        for k, v in config.items(): 
            if k in keys: 
                upd[k] = v 
        params = dataclasses.replace(base_params, **upd) 
        res = train_func(params, device, config) 
        return {"episodes": res if res is not None else 10**6}
```

è¯¥å‡½æ•°ç»™å®šä»¥ä¸‹å‚æ•°ï¼š

+   ç”¨äºŽè®­ç»ƒçš„åŸºç¡€è¶…å‚æ•°é›†

+   è®­ç»ƒå‡½æ•°

+   ä½¿ç”¨çš„ Torch è®¾å¤‡

+   åœ¨å›žåˆä¸­æ‰§è¡Œçš„æ ·æœ¬æ•°é‡

+   å…·æœ‰æœç´¢ç©ºé—´çš„é™„åŠ å­—å…¸

åœ¨æ­¤å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªç›®æ ‡å‡½æ•°ï¼Œå®ƒä»Žé‡‡æ ·çš„å­—å…¸ä¸­åˆ›å»º `Hyperparameters` å¯¹è±¡ï¼Œè°ƒç”¨è®­ç»ƒå‡½æ•°ï¼Œå¹¶è¿”å›žå­—å…¸ï¼ˆè¿™æ˜¯ ray.tune åº“çš„è¦æ±‚ï¼‰ã€‚

`tune_params` å‡½æ•°çš„å…¶ä½™éƒ¨åˆ†å¾ˆç®€å•ï¼š

```py
 obj = tune.with_parameters(objective, device=device) 
    if device.type == "cuda": 
        obj = tune.with_resources(obj, {"gpu": 1}) 
    tuner = tune.Tuner(obj, param_space=search_space, tune_config=config) 
    results = tuner.fit() 
    best = results.get_best_result(metric="episodes", mode="min") 
    print(best.config) 
    print(best.metrics)
```

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åŒ…è£…ç›®æ ‡å‡½æ•°ï¼Œä»¥ä¼ é€’ Torch è®¾å¤‡å¹¶è€ƒè™‘ GPU èµ„æºã€‚è¿™æ˜¯ä¸ºäº†è®© Ray èƒ½å¤Ÿæ­£ç¡®åœ°å¹¶è¡ŒåŒ–è°ƒä¼˜è¿‡ç¨‹ã€‚å¦‚æžœä½ æœºå™¨ä¸Šå®‰è£…äº†å¤šä¸ª GPUï¼Œå®ƒå°†å¹¶è¡Œè¿è¡Œå¤šä¸ªè®­ç»ƒã€‚ç„¶åŽï¼Œæˆ‘ä»¬åªéœ€åˆ›å»º `Tuner` å¯¹è±¡ï¼Œå¹¶è¦æ±‚å®ƒæ‰§è¡Œè¶…å‚æ•°æœç´¢ã€‚

ä¸Žè¶…å‚æ•°è°ƒä¼˜ç›¸å…³çš„æœ€åŽä¸€éƒ¨åˆ†ä»£ç åœ¨ `setup_ignite` å‡½æ•°ä¸­ã€‚å®ƒæ£€æŸ¥è®­ç»ƒè¿‡ç¨‹æ˜¯å¦æ²¡æœ‰æ”¶æ•›ï¼Œå¦‚æžœæ²¡æœ‰æ”¶æ•›ï¼Œåˆ™åœæ­¢è®­ç»ƒä»¥é¿å…æ— é™ç­‰å¾…ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬åœ¨è¶…å‚æ•°è°ƒä¼˜æ¨¡å¼ä¸‹å®‰è£… Ignite äº‹ä»¶å¤„ç†ç¨‹åºï¼š

```py
 if params.tuner_mode: 
        @engine.on(ptan_ignite.EpisodeEvents.EPISODE_COMPLETED) 
        def episode_completed(trainer: Engine): 
            avg_reward = trainer.state.metrics.get(â€™avg_rewardâ€™) 
            max_episodes = params.episodes_to_solve * 1.1 
            if trainer.state.episode > tuner_reward_episode and \ 
                    avg_reward < tuner_reward_min: 
                trainer.should_terminate = True 
                trainer.state.solved = False 
            elif trainer.state.episode > max_episodes: 
                trainer.should_terminate = True 
                trainer.state.solved = False 
            if trainer.should_terminate: 
                print(f"Episode {trainer.state.episode}, " 
                      f"avg_reward {avg_reward:.2f}, terminating")
```

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æ£€æŸ¥ä¸¤ä¸ªæ¡ä»¶ï¼š

+   å¦‚æžœå¹³å‡å¥–åŠ±ä½ŽäºŽ `tuner_reward_min`ï¼ˆè¿™æ˜¯ `setup_ignite` å‡½æ•°çš„ä¸€ä¸ªå‚æ•°ï¼Œé»˜è®¤ä¸º -19ï¼‰ï¼Œå¹¶ä¸”åœ¨ 100 å±€æ¸¸æˆåŽï¼ˆç”± `tuner_reward_episode` å‚æ•°æä¾›ï¼‰ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å‡ ä¹Žä¸å¯èƒ½æ”¶æ•›ã€‚

+   æˆ‘ä»¬å·²ç»çŽ©äº†è¶…è¿‡ `max_episodes` å±€æ¸¸æˆï¼Œä»ç„¶æ²¡æœ‰è§£å†³æ¸¸æˆã€‚åœ¨é»˜è®¤é…ç½®ä¸­ï¼Œæˆ‘ä»¬å°†æ­¤é™åˆ¶è®¾ç½®ä¸º 500 å±€æ¸¸æˆã€‚

åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½ä¼šåœæ­¢è®­ç»ƒå¹¶å°† `solved` å±žæ€§è®¾ç½®ä¸º `False`ï¼Œè¿™å°†åœ¨è°ƒä¼˜è¿‡ç¨‹ä¸­è¿”å›žä¸€ä¸ªè¾ƒé«˜çš„å¸¸æ•°æŒ‡æ ‡å€¼ã€‚

è¿™å°±æ˜¯è¶…å‚æ•°è°ƒä¼˜ä»£ç çš„å…¨éƒ¨å†…å®¹ã€‚åœ¨è¿è¡Œå¹¶æ£€æŸ¥ç»“æžœä¹‹å‰ï¼Œè®©æˆ‘ä»¬é¦–å…ˆä½¿ç”¨æˆ‘ä»¬åœ¨ç¬¬å…­ç« ä¸­ä½¿ç”¨çš„å‚æ•°å¼€å§‹ä¸€æ¬¡å•æ¬¡è®­ç»ƒã€‚

## ä½¿ç”¨å¸¸è§å‚æ•°çš„ç»“æžœ

å¦‚æžœæˆ‘ä»¬ä½¿ç”¨å‚æ•° `--params common` è¿è¡Œè®­ç»ƒï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æ¥è‡ª `common.py` æ¨¡å—çš„è¶…å‚æ•°è®­ç»ƒ Pong æ¸¸æˆã€‚ä½œä¸ºé€‰é¡¹ï¼Œä½ å¯ä»¥ä½¿ç”¨ `--params best` å‘½ä»¤è¡Œæ¥è®­ç»ƒè¯¥ DQN æ‰©å±•çš„æœ€ä½³å€¼ã€‚

å¥½çš„ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¼€å§‹è®­ç»ƒï¼š

```py
Chapter08$ ./01_dqn_basic.py --dev cuda --params common 
A.L.E: Arcade Learning Environment (version 0.8.1+53f58b7) 
[Powered by Stella] 
Episode 1: reward=-21, steps=848, speed=0.0 f/s, elapsed=0:00:11 
Episode 2: reward=-21, steps=850, speed=0.0 f/s, elapsed=0:00:11 
Episode 3: reward=-19, steps=1039, speed=0.0 f/s, elapsed=0:00:11 
Episode 4: reward=-21, steps=884, speed=0.0 f/s, elapsed=0:00:11 
Episode 5: reward=-19, steps=1146, speed=0.0 f/s, elapsed=0:00:11 
Episode 6: reward=-20, steps=997, speed=0.0 f/s, elapsed=0:00:11 
Episode 7: reward=-21, steps=972, speed=0.0 f/s, elapsed=0:00:11 
Episode 8: reward=-21, steps=882, speed=0.0 f/s, elapsed=0:00:11 
Episode 9: reward=-21, steps=898, speed=0.0 f/s, elapsed=0:00:11 
Episode 10: reward=-20, steps=947, speed=0.0 f/s, elapsed=0:00:11 
Episode 11: reward=-21, steps=762, speed=227.7 f/s, elapsed=0:00:12 
Episode 12: reward=-20, steps=991, speed=227.8 f/s, elapsed=0:00:17 
Episode 13: reward=-21, steps=762, speed=227.9 f/s, elapsed=0:00:20 
Episode 14: reward=-20, steps=948, speed=227.9 f/s, elapsed=0:00:24 
Episode 15: reward=-20, steps=992, speed=228.0 f/s, elapsed=0:00:28 
......
```

è¾“å‡ºä¸­çš„æ¯ä¸€è¡Œéƒ½æ˜¯åœ¨æ¸¸æˆå›žåˆç»“æŸæ—¶å†™å…¥çš„ï¼Œæ˜¾ç¤ºå›žåˆå¥–åŠ±ã€æ­¥æ•°ã€é€Ÿåº¦å’Œæ€»è®­ç»ƒæ—¶é—´ã€‚å¯¹äºŽåŸºç¡€çš„ DQN ç‰ˆæœ¬å’Œå¸¸è§çš„è¶…å‚æ•°ï¼Œé€šå¸¸éœ€è¦å¤§çº¦ 70 ä¸‡å¸§å’Œçº¦ 400 å±€æ¸¸æˆæ‰èƒ½è¾¾åˆ° 18 çš„å¹³å‡å¥–åŠ±ï¼Œå› æ­¤éœ€è¦è€å¿ƒã€‚åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ TensorBoard ä¸­æŸ¥çœ‹è®­ç»ƒè¿‡ç¨‹çš„åŠ¨æ€ï¼Œé‡Œé¢æ˜¾ç¤ºäº†Îµå€¼ã€åŽŸå§‹å¥–åŠ±å€¼ã€å¹³å‡å¥–åŠ±å’Œé€Ÿåº¦çš„å›¾è¡¨ã€‚ä»¥ä¸‹å›¾è¡¨æ˜¾ç¤ºäº†æ¯å›žåˆçš„å¥–åŠ±å’Œæ­¥æ•°ï¼ˆåº•éƒ¨ x è½´è¡¨ç¤ºå¢™é’Ÿæ—¶é—´ï¼Œé¡¶éƒ¨ x è½´è¡¨ç¤ºå›žåˆæ•°ï¼‰ï¼š

![PIC](img/B22150_08_01.png)

å›¾ 8.1ï¼šå¥–åŠ±å›¾ï¼ˆå·¦ï¼‰å’Œæ¯å›žåˆæ­¥æ•°å›¾ï¼ˆå³ï¼‰

![PIC](img/B22150_08_02.png)

å›¾ 8.2ï¼šè®­ç»ƒé€Ÿåº¦å›¾ï¼ˆå·¦ï¼‰å’Œå¹³å‡è®­ç»ƒæŸå¤±å›¾ï¼ˆå³ï¼‰

è¿˜å€¼å¾—æ³¨æ„çš„æ˜¯æ¯å›žåˆæ­¥æ•°åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­æ˜¯å¦‚ä½•å˜åŒ–çš„ã€‚æœ€å¼€å§‹æ—¶ï¼Œæ­¥æ•°å¢žåŠ ï¼Œå› ä¸ºæˆ‘ä»¬çš„ç½‘ç»œå¼€å§‹èµ¢å¾—è¶Šæ¥è¶Šå¤šçš„æ¸¸æˆï¼Œä½†åœ¨è¾¾åˆ°æŸä¸ªæ°´å¹³åŽï¼Œæ­¥æ•°å‡å°‘äº† 2 å€å¹¶å‡ ä¹Žä¿æŒä¸å˜ã€‚è¿™æ˜¯ç”±æˆ‘ä»¬çš„Î³å‚æ•°é©±åŠ¨çš„ï¼Œå®ƒä¼šéšç€æ—¶é—´çš„æŽ¨ç§»æŠ˜æ‰£æ™ºèƒ½ä½“çš„å¥–åŠ±ï¼Œæ‰€ä»¥å®ƒä¸ä»…ä»…æ˜¯å°½å¯èƒ½å¤šåœ°ç§¯ç´¯å¥–åŠ±ï¼Œè¿˜è¦é«˜æ•ˆåœ°å®Œæˆä»»åŠ¡ã€‚

## è°ƒæ•´è¿‡çš„åŸºå‡† DQN

åœ¨ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°--tune 30ï¼ˆè¿™åœ¨ä¸€å— GPU ä¸ŠèŠ±è´¹äº†å¤§çº¦ä¸€å¤©ï¼‰è¿è¡ŒåŸºå‡† DQN ä¹‹åŽï¼Œæˆ‘æ‰¾åˆ°äº†ä»¥ä¸‹å‚æ•°ï¼Œè¿™å¯ä»¥åœ¨ 340 å›žåˆå†…è§£å†³ Pong é—®é¢˜ï¼ˆè€Œä¸æ˜¯ 360 å›žåˆï¼‰ï¼š

```py
 learning_rate=9.932831968547505e-05, 
    gamma=0.98,
```

å¦‚ä½ æ‰€è§ï¼Œå­¦ä¹ çŽ‡å‡ ä¹Žä¸Žä¹‹å‰ä¸€æ ·ï¼ˆ10^(âˆ’4)ï¼‰ï¼Œä½†Î³å€¼è¾ƒä½Žï¼ˆ0.98 å¯¹æ¯” 0.99ï¼‰ã€‚è¿™å¯èƒ½è¡¨æ˜Ž Pong æœ‰ç›¸å¯¹è¾ƒçŸ­çš„å­è½¨è¿¹ä¸ŽåŠ¨ä½œ-å¥–åŠ±å› æžœå…³ç³»ï¼Œå› æ­¤å‡å°‘Î³å¯¹è®­ç»ƒæœ‰ç¨³å®šä½œç”¨ã€‚

åœ¨ä¸‹å›¾ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ°è°ƒæ•´è¿‡å’Œæœªè°ƒæ•´ç‰ˆæœ¬çš„å¥–åŠ±ä¸Žæ¯ä¸ªå›žåˆæ­¥æ•°çš„æ¯”è¾ƒï¼ˆåŒºåˆ«éžå¸¸å°ï¼‰ï¼š

![PIC](img/B22150_08_03.png)

å›¾ 8.3ï¼šè°ƒæ•´è¿‡çš„å’Œæœªè°ƒæ•´è¶…å‚æ•°çš„å¥–åŠ±å›¾ï¼ˆå·¦ï¼‰å’Œæ¯å›žåˆæ­¥æ•°å›¾ï¼ˆå³ï¼‰

çŽ°åœ¨æˆ‘ä»¬æœ‰äº†åŸºå‡† DQN ç‰ˆæœ¬ï¼Œå¹¶å‡†å¤‡æŽ¢ç´¢ Hessel ç­‰äººæå‡ºçš„æ”¹è¿›æ–¹æ³•ã€‚

# N æ­¥ DQN

æˆ‘ä»¬å°†è¦å®žçŽ°å¹¶è¯„ä¼°çš„ç¬¬ä¸€ä¸ªæ”¹è¿›æ˜¯ä¸€ä¸ªæ¯”è¾ƒè€çš„æ–¹æ³•ã€‚å®ƒæœ€æ—©ç”± Sutton åœ¨è®ºæ–‡ã€Šé€šè¿‡æ—¶é—´å·®åˆ†æ–¹æ³•å­¦ä¹ é¢„æµ‹ã€‹[Sut88]ä¸­æå‡ºã€‚ä¸ºäº†ç†è§£è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬å†çœ‹ä¸€é Q-learning ä¸­ä½¿ç”¨çš„ Bellman æ›´æ–°ï¼š

![Ï€ (a |s) = P[At = a|St = s] ](img/eq26.png)

è¿™ä¸ªæ–¹ç¨‹æ˜¯é€’å½’çš„ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ç”¨è‡ªèº«æ¥è¡¨ç¤º Q(s[t+1],a[t+1])ï¼Œä»Žè€Œå¾—åˆ°è¿™ä¸ªç»“æžœï¼š

![Ï€ (a |s) = P[At = a|St = s] ](img/eq27.png)

å€¼ r[a,t+1]è¡¨ç¤ºåœ¨æ—¶é—´ t + 1 æ—¶å‘å‡ºåŠ¨ä½œ a åŽçš„å±€éƒ¨å¥–åŠ±ã€‚ç„¶è€Œï¼Œå¦‚æžœæˆ‘ä»¬å‡è®¾åœ¨ t + 1 æ­¥æ—¶çš„åŠ¨ä½œ a æ˜¯æœ€ä¼˜é€‰æ‹©æˆ–æŽ¥è¿‘æœ€ä¼˜é€‰æ‹©ï¼Œæˆ‘ä»¬å¯ä»¥çœç•¥ max[a]æ“ä½œï¼Œå¾—åˆ°ä»¥ä¸‹ç»“æžœï¼š

![Ï€ (a |s) = P[At = a|St = s] ](img/eq28.png)

è¿™ä¸ªå€¼å¯ä»¥åå¤å±•å¼€ï¼Œæ¬¡æ•°ä¸é™ã€‚æ­£å¦‚ä½ å¯èƒ½çŒœåˆ°çš„ï¼Œè¿™ç§å±•å¼€å¯ä»¥è½»æ¾åº”ç”¨åˆ°æˆ‘ä»¬çš„ DQN æ›´æ–°ä¸­ï¼Œé€šè¿‡ç”¨æ›´é•¿çš„ n æ­¥è½¬ç§»åºåˆ—æ›¿æ¢ä¸€æ­¥è½¬ç§»é‡‡æ ·ã€‚ä¸ºäº†ç†è§£ä¸ºä»€ä¹ˆè¿™ç§å±•å¼€å¯ä»¥å¸®åŠ©æˆ‘ä»¬åŠ é€Ÿè®­ç»ƒï¼Œè®©æˆ‘ä»¬è€ƒè™‘å›¾ 8.4 ä¸­çš„ç¤ºä¾‹ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªç®€å•çš„å››çŠ¶æ€çŽ¯å¢ƒï¼ˆs[1]ã€s[2]ã€s[3]ã€s[4]ï¼‰ï¼Œé™¤äº†ç»ˆæ­¢çŠ¶æ€ s[4] å¤–ï¼Œæ¯ä¸ªçŠ¶æ€éƒ½æœ‰å”¯ä¸€å¯æ‰§è¡Œçš„åŠ¨ä½œï¼š

![ssssararar1234123 ](img/B22150_08_04.png)

å›¾ 8.4ï¼šä¸€ä¸ªç®€å•çŽ¯å¢ƒçš„è½¬ç§»å›¾

é‚£ä¹ˆï¼Œä¸€æ­¥æƒ…å†µä¸‹ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬æ€»å…±æœ‰ä¸‰ä¸ªæ›´æ–°æ˜¯å¯èƒ½çš„ï¼ˆæˆ‘ä»¬ä¸ä½¿ç”¨ maxï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªå¯æ‰§è¡ŒåŠ¨ä½œï¼‰ï¼š

1.  Q(s[1],a) â†r[1] + Î³Q(s[2],a)

1.  Q(s[2],a) â†r[2] + Î³Q(s[3],a)

1.  Q(s[3],a) â†r[3]

å‡è®¾åœ¨è®­ç»ƒå¼€å§‹æ—¶ï¼Œæˆ‘ä»¬æŒ‰ç…§è¿™ä¸ªé¡ºåºå®Œæˆä¹‹å‰çš„æ›´æ–°ã€‚å‰ä¸¤ä¸ªæ›´æ–°å°†æ²¡æœ‰ç”¨ï¼Œå› ä¸ºæˆ‘ä»¬å½“å‰çš„ Q(s[2],a) å’Œ Q(s[3],a) æ˜¯ä¸æ­£ç¡®çš„ï¼Œä¸”åŒ…å«åˆå§‹çš„éšæœºå€¼ã€‚å”¯ä¸€æœ‰ç”¨çš„æ›´æ–°æ˜¯æ›´æ–° 3ï¼Œå®ƒä¼šå°†å¥–åŠ± r[3] æ­£ç¡®åœ°åˆ†é…ç»™ç»ˆæ­¢çŠ¶æ€ä¹‹å‰çš„çŠ¶æ€ s[3]ã€‚

çŽ°åœ¨è®©æˆ‘ä»¬ä¸€æ¬¡æ¬¡æ‰§è¡Œè¿™äº›æ›´æ–°ã€‚åœ¨ç¬¬äºŒæ¬¡è¿­ä»£æ—¶ï¼ŒQ(s[2],a) ä¼šè¢«èµ‹äºˆæ­£ç¡®çš„å€¼ï¼Œä½† Q(s[1],a) çš„æ›´æ–°ä»ç„¶ä¼šå¸¦æœ‰å™ªå£°ã€‚ç›´åˆ°ç¬¬ä¸‰æ¬¡è¿­ä»£ï¼Œæˆ‘ä»¬æ‰ä¼šä¸ºæ¯ä¸ª Q èŽ·å¾—æœ‰æ•ˆçš„å€¼ã€‚æ‰€ä»¥ï¼Œå³ä½¿æ˜¯åœ¨ä¸€æ­¥æƒ…å†µä¸‹ï¼Œä¹Ÿéœ€è¦ä¸‰æ­¥æ‰èƒ½å°†æ­£ç¡®çš„å€¼ä¼ æ’­åˆ°æ‰€æœ‰çŠ¶æ€ã€‚

çŽ°åœ¨è®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸ªä¸¤æ­¥çš„æƒ…å†µã€‚è¿™ä¸ªæƒ…å†µåŒæ ·æœ‰ä¸‰ä¸ªæ›´æ–°ï¼š

1.  Q(s[1],a) â†r[1] + Î³r[2] + Î³Â²Q(s[3],a)

1.  Q(s[2],a) â†r[2] + Î³r[3]

1.  Q(s[3],a) â†r[3]

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåœ¨ç¬¬ä¸€æ¬¡æ›´æ–°å¾ªçŽ¯ä¸­ï¼Œæ­£ç¡®çš„å€¼å°†åˆ†åˆ«åˆ†é…ç»™ Q(s[2],a) å’Œ Q(s[3],a)ã€‚åœ¨ç¬¬äºŒæ¬¡è¿­ä»£ä¸­ï¼ŒQ(s[1],a) çš„å€¼ä¹Ÿå°†å¾—åˆ°æ­£ç¡®æ›´æ–°ã€‚å› æ­¤ï¼Œå¤šæ­¥æ“ä½œæé«˜äº†å€¼çš„ä¼ æ’­é€Ÿåº¦ï¼Œä»Žè€Œæ”¹å–„äº†æ”¶æ•›æ€§ã€‚ä½ å¯èƒ½ä¼šæƒ³ï¼Œâ€œå¦‚æžœè¿™æ ·è¿™ä¹ˆæœ‰å¸®åŠ©ï¼Œé‚£æˆ‘ä»¬ä¸å¦¨å°† Bellman æ–¹ç¨‹å±•å¼€ 100 æ­¥ã€‚è¿™æ ·ä¼šè®©æˆ‘ä»¬çš„æ”¶æ•›é€Ÿåº¦åŠ å¿« 100 å€å—ï¼Ÿâ€ä¸å¹¸çš„æ˜¯ï¼Œç­”æ¡ˆæ˜¯å¦å®šçš„ã€‚å°½ç®¡æˆ‘ä»¬æœ‰æ‰€æœŸå¾…ï¼Œæˆ‘ä»¬çš„ DQN å®Œå…¨æ— æ³•æ”¶æ•›ã€‚

ä¸ºäº†ç†è§£ä¸ºä»€ä¹ˆå¦‚æ­¤ï¼Œæˆ‘ä»¬å†æ¬¡å›žåˆ°æˆ‘ä»¬çš„å±•å¼€è¿‡ç¨‹ï¼Œç‰¹åˆ«æ˜¯æˆ‘ä»¬çœç•¥äº† max[a]ã€‚è¿™æ ·åšå¯¹å—ï¼Ÿä¸¥æ ¼æ¥è¯´ï¼Œç­”æ¡ˆæ˜¯å¦å®šçš„ã€‚æˆ‘ä»¬åœ¨ä¸­é—´æ­¥éª¤çœç•¥äº† max æ“ä½œï¼Œå‡è®¾æˆ‘ä»¬åœ¨ç»éªŒæ”¶é›†è¿‡ç¨‹ä¸­ï¼ˆæˆ–è€…æˆ‘ä»¬çš„ç­–ç•¥ï¼‰æ˜¯æœ€ä¼˜çš„ã€‚å‡å¦‚ä¸æ˜¯å‘¢ï¼Ÿä¾‹å¦‚ï¼Œåœ¨è®­ç»ƒåˆæœŸï¼Œæˆ‘ä»¬çš„æ™ºèƒ½ä½“æ˜¯éšæœºè¡Œä¸ºçš„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è®¡ç®—å‡ºçš„ Q(s[t],a[t]) å€¼å¯èƒ½å°äºŽè¯¥çŠ¶æ€çš„æœ€ä¼˜å€¼ï¼ˆå› ä¸ºæŸäº›æ­¥éª¤æ˜¯éšæœºæ‰§è¡Œçš„ï¼Œè€Œä¸æ˜¯é€šè¿‡æœ€å¤§åŒ– Q å€¼æ¥éµå¾ªæœ€æœ‰å¸Œæœ›çš„è·¯å¾„ï¼‰ã€‚æˆ‘ä»¬å±•å¼€ Bellman æ–¹ç¨‹çš„æ­¥æ•°è¶Šå¤šï¼Œæˆ‘ä»¬çš„æ›´æ–°å¯èƒ½å°±è¶Šä¸å‡†ç¡®ã€‚

æˆ‘ä»¬çš„å¤§åž‹ç»éªŒå›žæ”¾ç¼“å†²åŒºå°†ä½¿æƒ…å†µå˜å¾—æ›´ç³Ÿï¼Œå› ä¸ºå®ƒä¼šå¢žåŠ ä»Žæ—§çš„ç³Ÿç³•ç­–ç•¥ï¼ˆç”±æ—§çš„ç³Ÿç³• Q è¿‘ä¼¼æ‰€å†³å®šï¼‰èŽ·å¾—è¿‡æ¸¡çš„æœºä¼šã€‚è¿™å°†å¯¼è‡´å½“å‰ Q è¿‘ä¼¼çš„é”™è¯¯æ›´æ–°ï¼Œä»Žè€Œå¾ˆå®¹æ˜“ç ´åæˆ‘ä»¬çš„è®­ç»ƒè¿›ç¨‹ã€‚è¿™ä¸ªé—®é¢˜æ˜¯å¼ºåŒ–å­¦ä¹ æ–¹æ³•çš„ä¸€ä¸ªåŸºæœ¬ç‰¹å¾ï¼Œæ­£å¦‚æˆ‘ä»¬åœ¨ç¬¬å››ç« ç®€è¦æåˆ°çš„ï¼Œå½“æ—¶æˆ‘ä»¬è®¨è®ºäº†å¼ºåŒ–å­¦ä¹ æ–¹æ³•çš„åˆ†ç±»ã€‚

æœ‰ä¸¤å¤§ç±»æ–¹æ³•ï¼š

+   åŸºäºŽéžç­–ç•¥çš„æ–¹æ³•ï¼šç¬¬ä¸€ç±»åŸºäºŽéžç­–ç•¥çš„æ–¹æ³•ä¸ä¾èµ–äºŽâ€œæ•°æ®çš„æ–°é²œåº¦â€ã€‚ä¾‹å¦‚ï¼Œç®€å•çš„ DQN å°±æ˜¯åŸºäºŽéžç­–ç•¥çš„ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‡ ç™¾ä¸‡æ­¥ä¹‹å‰ä»ŽçŽ¯å¢ƒä¸­é‡‡æ ·çš„éžå¸¸æ—§çš„æ•°æ®ï¼Œè¿™äº›æ•°æ®ä»ç„¶å¯¹å­¦ä¹ æœ‰ç”¨ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬åªæ˜¯ç”¨å³æ—¶å¥–åŠ±åŠ ä¸Šæœ€ä½³è¡ŒåŠ¨ä»·å€¼çš„å½“å‰æŠ˜æ‰£è¿‘ä¼¼æ¥æ›´æ–°åŠ¨ä½œçš„ä»·å€¼ Q(s[t],a[t])ã€‚å³ä½¿åŠ¨ä½œ a[t]æ˜¯éšæœºé‡‡æ ·çš„ï¼Œä¹Ÿæ— å…³ç´§è¦ï¼Œå› ä¸ºå¯¹äºŽè¿™ä¸ªç‰¹å®šçš„åŠ¨ä½œ a[t]ï¼Œåœ¨çŠ¶æ€ s[t]ä¸‹ï¼Œæˆ‘ä»¬çš„æ›´æ–°æ˜¯æ­£ç¡®çš„ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨åŸºäºŽéžç­–ç•¥çš„æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªéžå¸¸å¤§çš„ç»éªŒç¼“å†²åŒºï¼Œä½¿æˆ‘ä»¬çš„æ•°æ®æ›´æŽ¥è¿‘ç‹¬ç«‹åŒåˆ†å¸ƒï¼ˆiidï¼‰ã€‚

+   åŸºäºŽç­–ç•¥çš„æ–¹æ³•ï¼šå¦ä¸€æ–¹é¢ï¼ŒåŸºäºŽç­–ç•¥çš„æ–¹æ³•ä¸¥é‡ä¾èµ–äºŽæ ¹æ®æˆ‘ä»¬æ­£åœ¨æ›´æ–°çš„å½“å‰ç­–ç•¥æ¥é‡‡æ ·çš„è®­ç»ƒæ•°æ®ã€‚è¿™æ˜¯å› ä¸ºåŸºäºŽç­–ç•¥çš„æ–¹æ³•è¯•å›¾é—´æŽ¥ï¼ˆå¦‚ä¹‹å‰çš„ n æ­¥ DQNï¼‰æˆ–ç›´æŽ¥ï¼ˆæœ¬ä¹¦ç¬¬ä¸‰éƒ¨åˆ†çš„å†…å®¹å®Œå…¨æ˜¯å…³äºŽè¿™ç§æ–¹æ³•ï¼‰æ”¹è¿›å½“å‰ç­–ç•¥ã€‚

é‚£ä¹ˆï¼Œå“ªç§æ–¹æ³•æ›´å¥½å‘¢ï¼Ÿå—¯ï¼Œè¿™å–å†³äºŽã€‚åŸºäºŽéžç­–ç•¥çš„æ–¹æ³•å…è®¸ä½ åœ¨å…ˆå‰çš„å¤§é‡æ•°æ®åŽ†å²ä¸Šè¿›è¡Œè®­ç»ƒï¼Œç”šè‡³åœ¨äººå·¥ç¤ºèŒƒä¸Šè¿›è¡Œè®­ç»ƒï¼Œä½†å®ƒä»¬é€šå¸¸æ”¶æ•›è¾ƒæ…¢ã€‚åŸºäºŽç­–ç•¥çš„æ–¹æ³•é€šå¸¸æ›´å¿«ï¼Œä½†éœ€è¦æ›´å¤šæ¥è‡ªçŽ¯å¢ƒçš„æ–°é²œæ•°æ®ï¼Œè¿™å¯èƒ½ä¼šå¾ˆæ˜‚è´µã€‚è¯•æƒ³ä¸€ä¸‹ï¼Œä½¿ç”¨åŸºäºŽç­–ç•¥çš„æ–¹æ³•è®­ç»ƒä¸€ä¸ªè‡ªåŠ¨é©¾é©¶æ±½è½¦ã€‚åœ¨ç³»ç»Ÿå­¦ä¼šé¿å¼€å¢™å£å’Œæ ‘æœ¨ä¹‹å‰ï¼Œä½ å¾—èŠ±è´¹å¤§é‡çš„æ’žè½¦æˆæœ¬ï¼

ä½ å¯èƒ½ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼šä¸ºä»€ä¹ˆæˆ‘ä»¬è¦è®¨è®ºä¸€ä¸ª n æ­¥ DQNï¼Œå¦‚æžœè¿™ä¸ªâ€œn æ­¥æ€§â€ä¼šä½¿å®ƒå˜æˆä¸€ä¸ªåŸºäºŽç­–ç•¥çš„æ–¹æ³•ï¼Œè¿™å°†ä½¿æˆ‘ä»¬çš„å¤§åž‹ç»éªŒç¼“å†²åŒºå˜å¾—æ²¡ç”¨ï¼Ÿå®žé™…ä¸Šï¼Œè¿™é€šå¸¸ä¸æ˜¯éžé»‘å³ç™½çš„ã€‚ä½ ä»ç„¶å¯ä»¥ä½¿ç”¨ n æ­¥ DQNï¼Œå¦‚æžœå®ƒæœ‰åŠ©äºŽåŠ é€Ÿ DQN çš„è®­ç»ƒï¼Œä½†ä½ éœ€è¦åœ¨é€‰æ‹© n æ—¶ä¿æŒè°¨æ…Žã€‚å°çš„å€¼ï¼Œå¦‚äºŒæˆ–ä¸‰ï¼Œé€šå¸¸æ•ˆæžœå¾ˆå¥½ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ç»éªŒç¼“å†²åŒºä¸­çš„è½¨è¿¹ä¸Žä¸€æ­¥è¿‡æ¸¡å·®åˆ«ä¸å¤§ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ”¶æ•›é€Ÿåº¦é€šå¸¸ä¼šæˆæ¯”ä¾‹åœ°æé«˜ï¼Œä½† n å€¼è¿‡å¤§å¯èƒ½ä¼šç ´åè®­ç»ƒè¿‡ç¨‹ã€‚å› æ­¤ï¼Œæ­¥æ•°åº”è¯¥è¿›è¡Œè°ƒä¼˜ï¼Œä½†åŠ é€Ÿæ”¶æ•›é€šå¸¸ä½¿å¾—è¿™æ ·åšæ˜¯å€¼å¾—çš„ã€‚

## å®žçŽ°

ç”±äºŽ ExperienceSourceFirstLast ç±»å·²ç»æ”¯æŒå¤šæ­¥ Bellman å±•å¼€ï¼Œå› æ­¤æˆ‘ä»¬çš„ n æ­¥ç‰ˆæœ¬çš„ DQN éžå¸¸ç®€å•ã€‚æˆ‘ä»¬åªéœ€è¦å¯¹åŸºç¡€ DQN è¿›è¡Œä¸¤ä¸ªä¿®æ”¹ï¼Œå°±èƒ½å°†å…¶è½¬æ¢ä¸º n æ­¥ç‰ˆæœ¬ï¼š

+   åœ¨ ExperienceSourceFirstLast åˆ›å»ºæ—¶ï¼Œé€šè¿‡ steps_count å‚æ•°ä¼ é€’æˆ‘ä»¬å¸Œæœ›å±•å¼€çš„æ­¥éª¤æ•°ã€‚

+   å°†æ­£ç¡®çš„ gamma å€¼ä¼ é€’ç»™ calc_loss_dqn å‡½æ•°ã€‚è¿™ä¸ªä¿®æ”¹éžå¸¸å®¹æ˜“è¢«å¿½è§†ï¼Œä½†å´å¯èƒ½å¯¹æ”¶æ•›æ€§äº§ç”Ÿä¸åˆ©å½±å“ã€‚ç”±äºŽæˆ‘ä»¬çš„ Bellman çŽ°åœ¨æ˜¯ n æ­¥çš„ï¼Œç»éªŒé“¾ä¸­æœ€åŽä¸€ä¸ªçŠ¶æ€çš„æŠ˜æ‰£ç³»æ•°å°†ä¸å†æ˜¯Î³ï¼Œè€Œæ˜¯Î³^nã€‚

ä½ å¯ä»¥åœ¨ Chapter08/02_dqn_n_steps.py ä¸­æ‰¾åˆ°æ•´ä¸ªç¤ºä¾‹ï¼Œè¿™é‡Œåªå±•ç¤ºäº†ä¿®æ”¹è¿‡çš„è¡Œï¼š

```py
 exp_source = ptan.experience.ExperienceSourceFirstLast( 
        env, agent, gamma=params.gamma, env_seed=common.SEED, 
        steps_count=n_steps 
    )
```

n_steps å€¼æ˜¯åœ¨å‘½ä»¤è¡Œå‚æ•°ä¸­ä¼ é€’çš„æ­¥æ•°è®¡æ•°ï¼›é»˜è®¤ä½¿ç”¨å››æ­¥ã€‚

å¦ä¸€ä¸ªä¿®æ”¹æ˜¯åœ¨ä¼ é€’ç»™ calc_loss_dqn å‡½æ•°çš„ gamma å€¼ï¼š

```py
 loss_v = common.calc_loss_dqn( 
            batch, net, tgt_net.target_model, 
            gamma=params.gamma**n_steps, device=device)
```

## ç»“æžœ

è®­ç»ƒæ¨¡å— Chapter08/02_dqn_n_steps.py å¯ä»¥åƒä»¥å‰ä¸€æ ·å¯åŠ¨ï¼Œå¢žåŠ äº†å‘½ä»¤è¡Œé€‰é¡¹-nï¼Œè¡¨ç¤ºå±•å¼€ Bellman æ–¹ç¨‹çš„æ­¥éª¤æ•°ã€‚è¿™äº›æ˜¯æˆ‘ä»¬åŸºçº¿å’Œ n æ­¥ DQN çš„å›¾è¡¨ï¼ˆä½¿ç”¨ç›¸åŒçš„å‚æ•°é›†ï¼‰ï¼Œå…¶ä¸­ n å€¼ä¸º 2 å’Œ 3ã€‚æ­£å¦‚ä½ æ‰€è§ï¼ŒBellman å±•å¼€å¤§å¤§åŠ é€Ÿäº†æ”¶æ•›é€Ÿåº¦ï¼š

![PIC](img/B22150_08_05.png)

å›¾ 8.5ï¼šåŸºæœ¬ï¼ˆå•æ­¥ï¼‰DQN å’Œ n æ­¥ç‰ˆæœ¬çš„å¥–åŠ±å’Œæ­¥éª¤æ•°

å¦‚å›¾æ‰€ç¤ºï¼Œä¸‰æ­¥ DQN çš„æ”¶æ•›é€Ÿåº¦æ˜¾è‘—å¿«äºŽç®€å• DQNï¼Œè¿™æ˜¯ä¸€ä¸ªä¸é”™çš„æ”¹è¿›ã€‚é‚£ä¹ˆï¼Œn å€¼æ›´å¤§å‘¢ï¼Ÿå›¾ 8.6 å±•ç¤ºäº† n = 3â€¦6 çš„å¥–åŠ±åŠ¨æ€ï¼š

![PIC](img/B22150_08_06.png)

å›¾ 8.6ï¼šn = 3â€¦6 çš„å¥–åŠ±åŠ¨æ€ï¼Œä½¿ç”¨ç›¸åŒçš„è¶…å‚æ•°

å¦‚ä½ æ‰€è§ï¼Œä»Žä¸‰æ­¥åˆ°å››æ­¥æœ‰æ‰€æå‡ï¼Œä½†è¿œä¸å¦‚ä¹‹å‰çš„æ”¹è¿›ã€‚n = 5 çš„å˜ä½“è¡¨çŽ°æ›´å·®ï¼Œå‡ ä¹Žä¸Ž n = 2 ç›¸å½“ã€‚n = 6 ä¹Ÿæ˜¯å¦‚æ­¤ã€‚æ‰€ä»¥ï¼Œåœ¨æˆ‘ä»¬çš„æƒ…å†µä¸‹ï¼Œn = 3 çœ‹èµ·æ¥æ˜¯æœ€ä¼˜çš„ã€‚

## è¶…å‚æ•°è°ƒä¼˜

åœ¨è¿™ä¸ªæ‰©å±•ä¸­ï¼Œè¶…å‚æ•°è°ƒä¼˜æ˜¯é’ˆå¯¹æ¯ä¸ª n å€¼ä»Ž 2 åˆ° 7 å•ç‹¬è¿›è¡Œçš„ã€‚ä»¥ä¸‹è¡¨æ ¼æ˜¾ç¤ºäº†æœ€ä½³å‚æ•°ä»¥åŠå®ƒä»¬è§£å†³æ¸¸æˆæ‰€éœ€çš„æ¸¸æˆæ¬¡æ•°ï¼š

| n | å­¦ä¹ çŽ‡ | Î³ | æ¸¸æˆæ¬¡æ•° |
| --- | --- | --- | --- |
| 2 | 3.97 â‹… 10^(âˆ’5) | 0.98 | 293 |
| 3 | 7.82 â‹… 10^(âˆ’5) | 0.98 | 260 |
| 4 | 6.07 â‹… 10^(âˆ’5) | 0.98 | 290 |
| 5 | 7.52 â‹… 10^(âˆ’5) | 0.99 | 268 |
| 6 | 6.78 â‹… 10^(âˆ’5) | 0.995 | 261 |
| 7 | 8.59 â‹… 10^(âˆ’5) | 0.98 | 284 |

è¡¨ 8.1ï¼šæ¯ä¸ª n å€¼çš„æœ€ä½³è¶…å‚æ•°ï¼ˆå­¦ä¹ çŽ‡å’Œ gammaï¼‰

è¿™å¼ è¡¨æ ¼ä¹ŸéªŒè¯äº†æœªè°ƒä¼˜ç‰ˆæœ¬æ¯”è¾ƒçš„ç»“è®ºâ€”â€”å¯¹ä¸¤æ­¥å’Œä¸‰æ­¥å±•å¼€ Bellman æ–¹ç¨‹å¯ä»¥æé«˜æ”¶æ•›æ€§ï¼Œä½†è¿›ä¸€æ­¥å¢žåŠ  n ä¼šå¯¼è‡´æ›´å·®çš„ç»“æžœã€‚n = 6 çš„ç»“æžœä¸Ž n = 3 ç›¸å½“ï¼Œä½† n = 4 å’Œ n = 5 çš„ç»“æžœæ›´å·®ï¼Œå› æ­¤æˆ‘ä»¬åº”è¯¥åœåœ¨ n = 3ã€‚

å›¾ 8.7 æ¯”è¾ƒäº†åŸºçº¿å’Œ N æ­¥ DQN è°ƒä¼˜ç‰ˆæœ¬çš„è®­ç»ƒåŠ¨æ€ï¼Œåˆ†åˆ«ä¸º n = 2 å’Œ n = 3ã€‚

![PIC](img/B22150_08_07.png)

å›¾Â 8.7ï¼šè¶…å‚æ•°è°ƒæ•´åŽçš„å¥–åŠ±å’Œæ­¥æ•°

# Double DQN

å¦‚ä½•æ”¹è¿›åŸºæœ¬ DQN çš„ä¸‹ä¸€ä¸ªå¯Œæœ‰æˆæ•ˆçš„æƒ³æ³•æ¥è‡ª DeepMind ç ”ç©¶äººå‘˜åœ¨æ ‡é¢˜ä¸ºæ·±åº¦å¼ºåŒ–å­¦ä¹ ä¸­çš„åŒé‡ Q å­¦ä¹ çš„è®ºæ–‡ä¸­[VGS16]ã€‚åœ¨è®ºæ–‡ä¸­ï¼Œä½œè€…è¯æ˜Žäº†åŸºæœ¬ DQN å€¾å‘äºŽé«˜ä¼° Q å€¼ï¼Œè¿™å¯èƒ½å¯¹è®­ç»ƒæ€§èƒ½æœ‰å®³ï¼Œå¹¶ä¸”æœ‰æ—¶å¯èƒ½å¯¼è‡´æ¬¡ä¼˜ç­–ç•¥ã€‚è¿™èƒŒåŽçš„æ ¹æœ¬åŽŸå› æ˜¯ Bellman æ–¹ç¨‹ä¸­çš„ max æ“ä½œï¼Œä½†å…¶ä¸¥æ ¼è¯æ˜Žæœ‰ç‚¹å¤æ‚ï¼ˆæ‚¨å¯ä»¥åœ¨è®ºæ–‡ä¸­æ‰¾åˆ°å®Œæ•´çš„è§£é‡Šï¼‰ã€‚ä½œä¸ºè§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•ï¼Œä½œè€…å»ºè®®ç¨å¾®ä¿®æ”¹è´å°”æ›¼æ›´æ–°ã€‚

åœ¨åŸºæœ¬ DQN ä¸­ï¼Œæˆ‘ä»¬çš„ Q çš„ç›®æ ‡å€¼çœ‹èµ·æ¥åƒè¿™æ ·ï¼š

![Ï€ (a |s) = P[At = a|St = s] ](img/eq29.png)

Qâ€²(s[t+1],a) æ˜¯ä½¿ç”¨æˆ‘ä»¬çš„ç›®æ ‡ç½‘ç»œè®¡ç®—çš„ Q å€¼ï¼Œå…¶æƒé‡æ¯éš” n æ­¥ä»Žè®­ç»ƒç½‘ç»œå¤åˆ¶ä¸€æ¬¡ã€‚è®ºæ–‡çš„ä½œè€…å»ºè®®é€‰æ‹©ä½¿ç”¨è®­ç»ƒç½‘ç»œä¸ºä¸‹ä¸€ä¸ªçŠ¶æ€é€‰æ‹©åŠ¨ä½œï¼Œä½†ä»Žç›®æ ‡ç½‘ç»œèŽ·å– Q å€¼ã€‚å› æ­¤ï¼Œç›®æ ‡ Q å€¼çš„æ–°è¡¨è¾¾å¼å¦‚ä¸‹æ‰€ç¤ºï¼š

![Ï€ (a |s) = P[At = a|St = s] ](img/eq30.png)

ä½œè€…è¯æ˜Žäº†è¿™ä¸ªç®€å•çš„å°æ”¹è¿›å®Œå…¨ä¿®å¤äº†é«˜ä¼°é—®é¢˜ï¼Œå¹¶ç§°è¿™ç§æ–°æž¶æž„ä¸ºåŒé‡ DQNã€‚

## å®žæ–½

æ ¸å¿ƒå®žçŽ°éžå¸¸ç®€å•ã€‚æˆ‘ä»¬éœ€è¦åšçš„æ˜¯ç¨å¾®ä¿®æ”¹æˆ‘ä»¬çš„æŸå¤±å‡½æ•°ã€‚ä½†æ˜¯è®©æˆ‘ä»¬å†è¿›ä¸€æ­¥ï¼Œæ¯”è¾ƒåŸºæœ¬ DQN å’ŒåŒé‡ DQN ç”Ÿæˆçš„åŠ¨ä½œå€¼ã€‚æ ¹æ®è®ºæ–‡ä½œè€…çš„è¯´æ³•ï¼Œæˆ‘ä»¬çš„åŸºçº¿ DQN åº”è¯¥å¯¹äºŽç›¸åŒçŠ¶æ€çš„é¢„æµ‹å€¼å§‹ç»ˆè¾ƒé«˜ã€‚ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å­˜å‚¨ä¸€ç»„éšæœºä¿ç•™çš„çŠ¶æ€ï¼Œå¹¶å‘¨æœŸæ€§åœ°è®¡ç®—è¯„ä¼°é›†ä¸­æ¯ä¸ªçŠ¶æ€çš„æœ€ä½³åŠ¨ä½œçš„å‡å€¼ã€‚

å®Œæ•´çš„ç¤ºä¾‹ä½äºŽ Chapter08/03_dqn_double.py ä¸­ã€‚è®©æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹æŸå¤±å‡½æ•°ï¼š

```py
def calc_loss_double_dqn( 
        batch: tt.List[ptan.experience.ExperienceFirstLast], 
        net: nn.Module, tgt_net: nn.Module, gamma: float, device: torch.device): 
    states, actions, rewards, dones, next_states = common.unpack_batch(batch) 

    states_v = torch.as_tensor(states).to(device) 
    actions_v = torch.tensor(actions).to(device) 
    rewards_v = torch.tensor(rewards).to(device) 
    done_mask = torch.BoolTensor(dones).to(device)
```

æˆ‘ä»¬å°†ä½¿ç”¨è¿™ä¸ªå‡½æ•°è€Œä¸æ˜¯ common.calc_loss_dqnï¼Œå®ƒä»¬éƒ½å…±äº«å¤§é‡ä»£ç ã€‚ä¸»è¦åŒºåˆ«åœ¨äºŽä¸‹ä¸€ä¸ª Q å€¼çš„ä¼°è®¡ï¼š

```py
 actions_v = actions_v.unsqueeze(-1) 
    state_action_vals = net(states_v).gather(1, actions_v) 
    state_action_vals = state_action_vals.squeeze(-1) 
    with torch.no_grad(): 
        next_states_v = torch.as_tensor(next_states).to(device) 
        next_state_acts = net(next_states_v).max(1)[1] 
        next_state_acts = next_state_acts.unsqueeze(-1) 
        next_state_vals = tgt_net(next_states_v).gather(1, next_state_acts).squeeze(-1) 
        next_state_vals[done_mask] = 0.0 
        exp_sa_vals = next_state_vals.detach() * gamma + rewards_v 
    return nn.MSELoss()(state_action_vals, exp_sa_vals)
```

å‰é¢çš„ä»£ç ç‰‡æ®µä»¥ç¨å¾®ä¸åŒçš„æ–¹å¼è®¡ç®—æŸå¤±ã€‚åœ¨åŒé‡ DQN ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨æˆ‘ä»¬çš„ä¸»è®­ç»ƒç½‘ç»œè®¡ç®—ä¸‹ä¸€ä¸ªçŠ¶æ€ä¸­è¦é‡‡å–çš„æœ€ä½³åŠ¨ä½œï¼Œä½†ä¸Žæ­¤åŠ¨ä½œå¯¹åº”çš„å€¼æ¥è‡ªç›®æ ‡ç½‘ç»œã€‚

è¿™éƒ¨åˆ†å¯ä»¥é€šè¿‡å°† next_states_v ä¸Ž states_v åˆå¹¶ï¼Œå¹¶ä»…è°ƒç”¨æˆ‘ä»¬çš„ä¸»ç½‘ç»œä¸€æ¬¡æ¥æ›´å¿«åœ°å®žçŽ°ï¼Œä½†è¿™ä¼šä½¿ä»£ç ä¸å¤ªæ¸…æ™°ã€‚

å‡½æ•°çš„å…¶ä½™éƒ¨åˆ†ä¸Žä¹‹ç›¸åŒï¼šæˆ‘ä»¬é®ç›–å·²å®Œæˆçš„å‰§é›†ï¼Œå¹¶è®¡ç®—ç½‘ç»œé¢„æµ‹çš„ Q å€¼ä¸Žè¿‘ä¼¼ Q å€¼ä¹‹é—´çš„å‡æ–¹è¯¯å·®ï¼ˆMSEï¼‰æŸå¤±ã€‚

æˆ‘ä»¬è€ƒè™‘çš„æœ€åŽä¸€ä¸ªå‡½æ•°è®¡ç®—äº†æˆ‘ä»¬ä¿ç•™çŠ¶æ€çš„å€¼ï¼š

```py
@torch.no_grad() 
def calc_values_of_states(states: np.ndarray, net: nn.Module, device: torch.device): 
    mean_vals = [] 
    for batch in np.array_split(states, 64): 
        states_v = torch.tensor(batch).to(device) 
        action_values_v = net(states_v) 
        best_action_values_v = action_values_v.max(1)[0] 
        mean_vals.append(best_action_values_v.mean().item()) 
    return np.mean(mean_vals)
```

è¿™é‡Œå¹¶æ²¡æœ‰ä»€ä¹ˆå¤æ‚çš„å†…å®¹ï¼šæˆ‘ä»¬åªæ˜¯å°†ä¿ç•™çš„çŠ¶æ€æ•°ç»„åˆ’åˆ†æˆç›¸ç­‰çš„å—ï¼Œå¹¶å°†æ¯ä¸ªå—ä¼ é€’ç»™ç½‘ç»œä»¥èŽ·å¾—åŠ¨ä½œå€¼ã€‚ä»Žè¿™äº›å€¼ä¸­ï¼Œæˆ‘ä»¬é€‰æ‹©æœ€å¤§å€¼çš„åŠ¨ä½œï¼ˆå¯¹äºŽæ¯ä¸ªçŠ¶æ€ï¼‰ï¼Œå¹¶è®¡ç®—è¿™äº›å€¼çš„å¹³å‡å€¼ã€‚ç”±äºŽæˆ‘ä»¬çš„çŠ¶æ€æ•°ç»„åœ¨æ•´ä¸ªè®­ç»ƒè¿‡ç¨‹ä¸­æ˜¯å›ºå®šçš„ï¼Œå¹¶ä¸”è¿™ä¸ªæ•°ç»„è¶³å¤Ÿå¤§ï¼ˆåœ¨ä»£ç ä¸­ï¼Œæˆ‘ä»¬å­˜å‚¨äº† 1,000 ä¸ªçŠ¶æ€ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥æ¯”è¾ƒè¿™ä¸¤ä¸ª DQN å˜ä½“ä¸­çš„å‡å€¼åŠ¨æ€ã€‚03_dqn_double.py æ–‡ä»¶ä¸­çš„å…¶ä½™éƒ¨åˆ†å‡ ä¹Žç›¸åŒï¼›ä¸¤ä¸ªä¸åŒä¹‹å¤„æ˜¯ä½¿ç”¨äº†æˆ‘ä»¬è°ƒæ•´è¿‡çš„æŸå¤±å‡½æ•°ï¼Œå¹¶ä¸”å®šæœŸè¯„ä¼°æ—¶ä¿æŒäº†éšæœºæŠ½å–çš„ 1,000 ä¸ªçŠ¶æ€ã€‚è¿™ä¸€è¿‡ç¨‹å‘ç”Ÿåœ¨ process_batch å‡½æ•°ä¸­ï¼š

```py
 if engine.state.iteration % EVAL_EVERY_FRAME == 0: 
            eval_states = getattr(engine.state, "eval_states", None) 
            if eval_states is None: 
                eval_states = buffer.sample(STATES_TO_EVALUATE) 
                eval_states = [ 
                    np.asarray(transition.state) 
                    for transition in eval_states 
                ] 
                eval_states = np.asarray(eval_states) 
                engine.state.eval_states = eval_states 
            engine.state.metrics["values"] = \ 
                common.calc_values_of_states(eval_states, net, device)
```

## ç»“æžœ

æˆ‘çš„å®žéªŒè¡¨æ˜Žï¼Œä½¿ç”¨å¸¸è§çš„è¶…å‚æ•°æ—¶ï¼ŒåŒé‡ DQN å¯¹å¥–åŠ±åŠ¨æ€æœ‰è´Ÿé¢å½±å“ã€‚æœ‰æ—¶ï¼ŒåŒé‡ DQN ä¼šå¯¼è‡´æ›´å¥½çš„åˆå§‹åŠ¨æ€ï¼Œè®­ç»ƒçš„æ™ºèƒ½ä½“å­¦ä¼šå¦‚ä½•æ›´å¿«åœ°èµ¢å¾—æ›´å¤šçš„æ¸¸æˆï¼Œä½†è¾¾åˆ°æœ€ç»ˆå¥–åŠ±è¾¹ç•Œéœ€è¦æ›´é•¿æ—¶é—´ã€‚ä½ å¯ä»¥åœ¨å…¶ä»–æ¸¸æˆä¸Šè¿›è¡Œè‡ªå·±çš„å®žéªŒï¼Œæˆ–è€…å°è¯•åŽŸå§‹è®ºæ–‡ä¸­çš„å‚æ•°ã€‚

ä»¥ä¸‹æ˜¯å®žéªŒä¸­çš„å¥–åŠ±å›¾è¡¨ï¼Œå…¶ä¸­åŒé‡ DQN ç¨å¾®ä¼˜äºŽåŸºçº¿ç‰ˆæœ¬ï¼š

![PIC](img/B22150_08_08.png)

å›¾ 8.8ï¼šåŒé‡ DQN å’ŒåŸºçº¿ DQN çš„å¥–åŠ±åŠ¨æ€

é™¤äº†æ ‡å‡†åº¦é‡å¤–ï¼Œç¤ºä¾‹è¿˜è¾“å‡ºäº†ä¿ç•™çŠ¶æ€é›†çš„å‡å€¼ï¼Œè¿™äº›å‡å€¼æ˜¾ç¤ºåœ¨å›¾ 8.9 ä¸­ã€‚

![PIC](img/B22150_08_09.png)

å›¾ 8.9ï¼šç½‘ç»œé¢„æµ‹çš„ä¿ç•™çŠ¶æ€çš„å€¼

å¦‚ä½ æ‰€è§ï¼ŒåŸºæœ¬çš„ DQN ä¼šé«˜ä¼°å€¼ï¼Œå› æ­¤å€¼åœ¨è¾¾åˆ°æŸä¸€æ°´å¹³åŽä¼šä¸‹é™ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒåŒé‡ DQN åˆ™å¢žé•¿å¾—æ›´åŠ ç¨³å®šã€‚åœ¨æˆ‘çš„å®žéªŒä¸­ï¼ŒåŒé‡ DQN å¯¹è®­ç»ƒæ—¶é—´çš„å½±å“å¾ˆå°ï¼Œä½†è¿™å¹¶ä¸ä¸€å®šæ„å‘³ç€åŒé‡ DQN æ²¡æœ‰ç”¨ï¼Œå› ä¸º Pong æ˜¯ä¸€ä¸ªç®€å•çš„çŽ¯å¢ƒã€‚åœ¨æ›´å¤æ‚çš„æ¸¸æˆä¸­ï¼ŒåŒé‡ DQN å¯èƒ½ä¼šç»™å‡ºæ›´å¥½çš„ç»“æžœã€‚

## è¶…å‚æ•°è°ƒèŠ‚

å¯¹äºŽåŒé‡ DQNï¼Œè¶…å‚æ•°è°ƒèŠ‚ä¹Ÿä¸æ˜¯ç‰¹åˆ«æˆåŠŸã€‚ç»è¿‡ 30 æ¬¡å®žéªŒåŽï¼Œå­¦ä¹ çŽ‡å’Œ gamma çš„æœ€ä½³å€¼èƒ½åœ¨ 412 å±€æ¸¸æˆå†…è§£å†³ Pong é—®é¢˜ï¼Œä½†è¿™æ¯”åŸºçº¿ DQN æ›´å·®ã€‚

# å™ªå£°ç½‘ç»œ

ä¸‹ä¸€æ­¥æ”¹è¿›æ˜¯é’ˆå¯¹å¦ä¸€ä¸ª RL é—®é¢˜ï¼šçŽ¯å¢ƒæŽ¢ç´¢ã€‚æˆ‘ä»¬å°†å‚è€ƒçš„è®ºæ–‡å«åšã€ŠNoisy networks for explorationã€‹[For+17]ï¼Œå®ƒæå‡ºäº†ä¸€ä¸ªéžå¸¸ç®€å•çš„æƒ³æ³•ï¼Œå³åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­å­¦ä¹ æŽ¢ç´¢ç‰¹å¾ï¼Œè€Œä¸æ˜¯ä¾èµ–ä¸ŽæŽ¢ç´¢ç›¸å…³çš„ç‹¬ç«‹è°ƒåº¦ã€‚

ä¸€ä¸ªç»å…¸çš„ DQN é€šè¿‡é€‰æ‹©éšæœºåŠ¨ä½œæ¥å®žçŽ°æŽ¢ç´¢ï¼Œè¿™ä¾èµ–äºŽä¸€ä¸ªç‰¹åˆ«å®šä¹‰çš„è¶…å‚æ•°ðœ–ï¼Œè¯¥è¶…å‚æ•°ä¼šéšç€æ—¶é—´çš„æŽ¨ç§»ä»Ž 1.0ï¼ˆå®Œå…¨éšæœºåŠ¨ä½œï¼‰é€æ¸é™ä½Žè‡³ä¸€ä¸ªè¾ƒå°çš„æ¯”çŽ‡ï¼Œä¾‹å¦‚ 0.1 æˆ– 0.02ã€‚è¿™ä¸ªè¿‡ç¨‹åœ¨ç®€å•çš„çŽ¯å¢ƒä¸­è¡¨çŽ°è‰¯å¥½ï¼Œå°¤å…¶æ˜¯åœ¨æ¸¸æˆä¸­æ²¡æœ‰å¤ªå¤šéžå¹³ç¨³æ€§çš„çŸ­æœŸå›žåˆå†…ï¼›ä½†æ˜¯å³ä½¿æ˜¯åœ¨è¿™äº›ç®€å•çš„æƒ…å†µä¸‹ï¼Œä¹Ÿéœ€è¦è°ƒå‚æ¥æé«˜è®­ç»ƒè¿‡ç¨‹çš„æ•ˆçŽ‡ã€‚

åœ¨ã€Šå™ªå£°ç½‘ç»œã€‹è®ºæ–‡ä¸­ï¼Œä½œè€…æå‡ºäº†ä¸€ä¸ªç›¸å½“ç®€å•çš„è§£å†³æ–¹æ¡ˆï¼Œå°½ç®¡å¦‚æ­¤ï¼Œå®ƒä»ç„¶è¡¨çŽ°å¾—éžå¸¸æœ‰æ•ˆã€‚ä»–ä»¬å‘ç½‘ç»œçš„å…¨è¿žæŽ¥å±‚çš„æƒé‡ä¸­æ·»åŠ å™ªå£°ï¼Œå¹¶åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­é€šè¿‡åå‘ä¼ æ’­è°ƒæ•´è¿™äº›å™ªå£°çš„å‚æ•°ã€‚

è¿™ç§æ–¹æ³•ä¸åº”ä¸Žâ€œç½‘ç»œå†³å®šåœ¨å“ªäº›åœ°æ–¹æŽ¢ç´¢æ›´å¤šâ€æ··æ·†ï¼Œè¿™æ˜¯ä¸€ç§æ›´åŠ å¤æ‚çš„æ–¹æ³•ï¼Œå¹¶ä¸”å¾—åˆ°äº†å¹¿æ³›çš„æ”¯æŒï¼ˆä¾‹å¦‚ï¼Œå‚è§å…³äºŽå†…åœ¨åŠ¨æœºå’ŒåŸºäºŽè®¡æ•°çš„æŽ¢ç´¢æ–¹æ³•çš„æ–‡ç« [Ost+17]ï¼Œ [Mar+17 ]ï¼‰ã€‚æˆ‘ä»¬å°†åœ¨ç¬¬äºŒåä¸€ç« è®¨è®ºé«˜çº§æŽ¢ç´¢æŠ€æœ¯ã€‚

ä½œè€…æå‡ºäº†ä¸¤ç§æ·»åŠ å™ªå£°çš„æ–¹å¼ï¼Œå®žéªŒè¡¨æ˜Žè¿™ä¸¤ç§æ–¹æ³•éƒ½æœ‰æ•ˆï¼Œä½†å®ƒä»¬æœ‰ä¸åŒçš„è®¡ç®—å¼€é”€ï¼š

+   ç‹¬ç«‹é«˜æ–¯å™ªå£°ï¼šå¯¹äºŽæ¯ä¸ªå…¨è¿žæŽ¥å±‚çš„æƒé‡ï¼Œæˆ‘ä»¬éƒ½æœ‰ä¸€ä¸ªä»Žæ­£æ€åˆ†å¸ƒä¸­æŠ½å–çš„éšæœºå€¼ã€‚å™ªå£°çš„å‚æ•°Î¼å’ŒÏƒå­˜å‚¨åœ¨è¯¥å±‚å†…ï¼Œå¹¶é€šè¿‡åå‘ä¼ æ’­è¿›è¡Œè®­ç»ƒï¼Œå°±åƒè®­ç»ƒæ ‡å‡†çº¿æ€§å±‚çš„æƒé‡ä¸€æ ·ã€‚è¿™ç§â€œå™ªå£°å±‚â€çš„è¾“å‡ºè®¡ç®—æ–¹å¼ä¸Žçº¿æ€§å±‚ç›¸åŒã€‚

+   åˆ†è§£é«˜æ–¯å™ªå£°ï¼šä¸ºäº†æœ€å°åŒ–éœ€è¦é‡‡æ ·çš„éšæœºå€¼æ•°é‡ï¼Œä½œè€…å»ºè®®åªä¿ç•™ä¸¤ä¸ªéšæœºå‘é‡ï¼šä¸€ä¸ªæ˜¯è¾“å…¥å¤§å°ï¼Œå¦ä¸€ä¸ªæ˜¯å±‚çš„è¾“å‡ºå¤§å°ã€‚ç„¶åŽï¼Œé€šè¿‡è®¡ç®—è¿™ä¸¤ä¸ªå‘é‡çš„å¤–ç§¯ï¼Œåˆ›å»ºå±‚çš„éšæœºçŸ©é˜µã€‚

## å®žçŽ°

åœ¨ PyTorch ä¸­ï¼Œä¸¤ç§æ–¹æ³•éƒ½å¯ä»¥éžå¸¸ç›´æŽ¥åœ°å®žçŽ°ã€‚æˆ‘ä»¬éœ€è¦åšçš„æ˜¯åˆ›å»ºè‡ªå®šä¹‰çš„ nn.Linear å±‚ï¼Œæƒé‡è®¡ç®—æ–¹å¼ä¸º w[i,j] = Î¼[i,j] + Ïƒ[i,j] â‹…ðœ–[i,j]ï¼Œå…¶ä¸­Î¼å’ŒÏƒæ˜¯å¯è®­ç»ƒå‚æ•°ï¼Œðœ–âˆ¼ð’©(0,1)æ˜¯æ¯æ¬¡ä¼˜åŒ–æ­¥éª¤åŽä»Žæ­£æ€åˆ†å¸ƒä¸­é‡‡æ ·çš„éšæœºå™ªå£°ã€‚

æœ¬ä¹¦çš„æ—©æœŸç‰ˆæœ¬ä½¿ç”¨äº†æˆ‘è‡ªå·±å®žçŽ°çš„è¿™ä¸¤ç§æ–¹æ³•ï¼Œä½†çŽ°åœ¨æˆ‘ä»¬å°†ç›´æŽ¥ä½¿ç”¨æˆ‘åœ¨ç¬¬ä¸ƒç« æåˆ°çš„æµè¡Œ TorchRL åº“ä¸­çš„å®žçŽ°ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®žçŽ°çš„ç›¸å…³éƒ¨åˆ†ï¼ˆå®Œæ•´ä»£ç å¯ä»¥åœ¨ TorchRL ä»“åº“ä¸­çš„ torchrl/modules/models/exploration.py ä¸­æ‰¾åˆ°ï¼‰ã€‚ä»¥ä¸‹æ˜¯ NoisyLinear ç±»çš„æž„é€ å‡½æ•°ï¼Œå®ƒåˆ›å»ºäº†æˆ‘ä»¬éœ€è¦ä¼˜åŒ–çš„æ‰€æœ‰å‚æ•°ï¼š

```py
class NoisyLinear(nn.Linear): 
    def __init__( 
        self, in_features: int, out_features: int, bias: bool = True, 
        device: Optional[DEVICE_TYPING] = None, dtype: Optional[torch.dtype] = None, 
        std_init: float = 0.1, 
    ): 
        nn.Module.__init__(self) 
        self.in_features = int(in_features) 
        self.out_features = int(out_features) 
        self.std_init = std_init 

        self.weight_mu = nn.Parameter( 
            torch.empty(out_features, in_features, device=device, 
                        dtype=dtype, requires_grad=True) 
        ) 
        self.weight_sigma = nn.Parameter( 
            torch.empty(out_features, in_features, device=device, 
                        dtype=dtype, requires_grad=True) 
        ) 
        self.register_buffer( 
            "weight_epsilon", 
            torch.empty(out_features, in_features, device=device, dtype=dtype), 
        ) 
        if bias: 
            self.bias_mu = nn.Parameter( 
                torch.empty(out_features, device=device, dtype=dtype, requires_grad=True) 
            ) 
            self.bias_sigma = nn.Parameter( 
                torch.empty(out_features, device=device, dtype=dtype, requires_grad=True) 
            ) 
            self.register_buffer( 
                "bias_epsilon", torch.empty(out_features, device=device, dtype=dtype), 
            ) 
        else: 
            self.bias_mu = None 
        self.reset_parameters() 
        self.reset_noise()
```

åœ¨æž„é€ å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ä¸ºÎ¼å’ŒÏƒåˆ›å»ºäº†çŸ©é˜µã€‚æ­¤å®žçŽ°ç»§æ‰¿è‡ª torch.nn.Linearï¼Œä½†è°ƒç”¨äº† nn.Module.__init__()æ–¹æ³•ï¼Œå› æ­¤ä¸ä¼šåˆ›å»ºæ ‡å‡† Linear æƒé‡å’Œåç½®ç¼“å†²åŒºã€‚

ä¸ºäº†ä½¿æ–°çš„çŸ©é˜µå¯è®­ç»ƒï¼Œæˆ‘ä»¬éœ€è¦å°†å®ƒä»¬çš„å¼ é‡åŒ…è£…åœ¨ nn.Parameter ä¸­ã€‚register_buffer æ–¹æ³•åœ¨ç½‘ç»œä¸­åˆ›å»ºä¸€ä¸ªä¸ä¼šåœ¨åå‘ä¼ æ’­æœŸé—´æ›´æ–°çš„å¼ é‡ï¼Œä½†ä¼šç”± nn.Module æœºåˆ¶å¤„ç†ï¼ˆä¾‹å¦‚ï¼Œå®ƒä¼šé€šè¿‡ cuda()è°ƒç”¨è¢«å¤åˆ¶åˆ° GPUï¼‰ã€‚ä¸ºå±‚çš„åç½®åˆ›å»ºäº†é¢å¤–çš„å‚æ•°å’Œç¼“å†²åŒºã€‚æœ€åŽï¼Œæˆ‘ä»¬è°ƒç”¨ reset_parameters()å’Œ reset_noise()æ–¹æ³•ï¼Œæ‰§è¡Œåˆ›å»ºçš„å¯è®­ç»ƒå‚æ•°å’Œå¸¦æœ‰ epsilon å€¼çš„ç¼“å†²åŒºçš„åˆå§‹åŒ–ã€‚

åœ¨ä»¥ä¸‹ä¸‰ä¸ªæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬æ ¹æ®è®ºæ–‡åˆå§‹åŒ–å¯è®­ç»ƒå‚æ•°Î¼å’ŒÏƒï¼š

```py
 def reset_parameters(self) -> None: 
        mu_range = 1 / math.sqrt(self.in_features) 
        self.weight_mu.data.uniform_(-mu_range, mu_range) 
        self.weight_sigma.data.fill_(self.std_init / math.sqrt(self.in_features)) 
        if self.bias_mu is not None: 
            self.bias_mu.data.uniform_(-mu_range, mu_range) 
            self.bias_sigma.data.fill_(self.std_init / math.sqrt(self.out_features)) 

    def reset_noise(self) -> None: 
        epsilon_in = self._scale_noise(self.in_features) 
        epsilon_out = self._scale_noise(self.out_features) 
        self.weight_epsilon.copy_(epsilon_out.outer(epsilon_in)) 
        if self.bias_mu is not None: 
            self.bias_epsilon.copy_(epsilon_out) 

    def _scale_noise( 
            self, size: Union[int, torch.Size, Sequence]) -> torch.Tensor: 
        if isinstance(size, int): 
            size = (size,) 
        x = torch.randn(*size, device=self.weight_mu.device) 
        return x.sign().mul_(x.abs().sqrt_())
```

Î¼çš„çŸ©é˜µåˆå§‹åŒ–ä¸ºå‡åŒ€éšæœºå€¼ã€‚Ïƒçš„åˆå§‹å€¼æ˜¯å¸¸é‡ï¼Œå–å†³äºŽå±‚ä¸­ç¥žç»å…ƒçš„æ•°é‡ã€‚

å¯¹äºŽå™ªå£°åˆå§‹åŒ–ï¼Œä½¿ç”¨äº†å› å¼åˆ†è§£é«˜æ–¯å™ªå£°â€”â€”æˆ‘ä»¬é‡‡æ ·ä¸¤ä¸ªéšæœºå‘é‡å¹¶è®¡ç®—å¤–ç§¯ä»¥èŽ·å¾—ðœ–çš„çŸ©é˜µã€‚å¤–ç§¯æ˜¯ä¸€ä¸ªçº¿æ€§ä»£æ•°æ“ä½œï¼Œå½“ä¸¤ä¸ªå¤§å°ç›¸åŒçš„å‘é‡äº§ç”Ÿä¸€ä¸ªå¡«å……äº†æ¯ä¸ªå‘é‡å…ƒç´ ç»„åˆä¹˜ç§¯çš„æ–¹é˜µæ—¶å°±ä¼šå‘ç”Ÿã€‚å…¶ä½™çš„å¾ˆç®€å•ï¼šæˆ‘ä»¬é‡æ–°å®šä¹‰æƒé‡å’Œåç½®å±žæ€§ï¼Œè¿™äº›å±žæ€§åœ¨ nn.Linear å±‚ä¸­æ˜¯é¢„æœŸçš„ï¼Œå› æ­¤ NoisyLinear å¯ä»¥åœ¨ä»»ä½•ä½¿ç”¨ nn.Linear çš„åœ°æ–¹ä½¿ç”¨ï¼š

```py
 @property 
    def weight(self) -> torch.Tensor: 
        if self.training: 
            return self.weight_mu + self.weight_sigma * self.weight_epsilon 
        else: 
            return self.weight_mu 

    @property 
    def bias(self) -> Optional[torch.Tensor]: 
        if self.bias_mu is not None: 
            if self.training: 
                return self.bias_mu + self.bias_sigma * self.bias_epsilon 
            else: 
                return self.bias_mu 
        else: 
            return None
```

è¿™ä¸ªå®žçŽ°å¾ˆç®€å•ï¼Œä½†æœ‰ä¸€ä¸ªéžå¸¸å¾®å¦™çš„ç»†èŠ‚â€”â€”ðœ–å€¼åœ¨æ¯æ¬¡ä¼˜åŒ–æ­¥éª¤åŽå¹¶ä¸ä¼šæ›´æ–°ï¼ˆæ–‡æ¡£ä¸­æ²¡æœ‰æåˆ°è¿™ä¸€ç‚¹ï¼‰ã€‚è¿™ä¸ªé—®é¢˜å·²ç»åœ¨ TorchRL ä»“åº“ä¸­æŠ¥å‘Šï¼Œä½†åœ¨å½“å‰ç¨³å®šç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬å¿…é¡»æ˜¾å¼è°ƒç”¨ reset_noise()æ–¹æ³•ã€‚å¸Œæœ›è¿™ä¸ªé—®é¢˜èƒ½å¾—åˆ°ä¿®å¤ï¼ŒNoisyLinear å±‚èƒ½å¤Ÿè‡ªåŠ¨æ›´æ–°å™ªå£°ã€‚

ä»Žå®žçŽ°è§’åº¦æ¥çœ‹ï¼Œå°±æ˜¯è¿™æ ·ã€‚çŽ°åœ¨æˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯å°†ç»å…¸çš„ DQN è½¬æ¢ä¸ºå™ªå£°ç½‘ç»œå˜ä½“ï¼Œåªéœ€å°† nn.Linearï¼ˆè¿™æ˜¯æˆ‘ä»¬ DQN ç½‘ç»œä¸­çš„æœ€åŽä¸¤å±‚ï¼‰æ›¿æ¢ä¸º NoisyLinear å±‚ã€‚å½“ç„¶ï¼Œæ‚¨éœ€è¦ç§»é™¤ä¸Ž epsilon-greedy ç­–ç•¥ç›¸å…³çš„æ‰€æœ‰ä»£ç ã€‚

ä¸ºäº†åœ¨è®­ç»ƒæœŸé—´æ£€æŸ¥å†…éƒ¨å™ªå£°æ°´å¹³ï¼Œæˆ‘ä»¬å¯ä»¥ç›‘æŽ§å™ªå£°å±‚çš„ä¿¡å™ªæ¯”ï¼ˆSNRï¼‰ï¼Œå…¶è®¡ç®—æ–¹å¼ä¸º RMS(Î¼)âˆ•RMS(Ïƒ)ï¼Œå…¶ä¸­ RMS æ˜¯ç›¸åº”æƒé‡çš„å‡æ–¹æ ¹ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼ŒSNR æ˜¾ç¤ºå™ªå£°å±‚çš„é™æ€æˆåˆ†æ¯”æ³¨å…¥å™ªå£°å¤§å¤šå°‘å€ã€‚

## ç»“æžœ

è®­ç»ƒåŽï¼ŒTensorBoard å›¾è¡¨æ˜¾ç¤ºå‡ºæ›´å¥½çš„è®­ç»ƒåŠ¨æ€ã€‚æ¨¡åž‹åœ¨ 250 å±€æ¸¸æˆåŽè¾¾åˆ°äº†å¹³å‡å¾—åˆ† 18ï¼Œç›¸æ¯”åŸºå‡† DQN çš„ 350 åˆ†æœ‰æ‰€æå‡ã€‚ä½†ç”±äºŽå™ªå£°ç½‘ç»œéœ€è¦é¢å¤–çš„æ“ä½œï¼Œå®ƒä»¬çš„è®­ç»ƒé€Ÿåº¦ç¨æ…¢ï¼ˆ194 FPS å¯¹æ¯”åŸºå‡†çš„ 240 FPSï¼‰ï¼Œæ‰€ä»¥åœ¨æ—¶é—´ä¸Šï¼Œå·®å¼‚ä¸é‚£ä¹ˆå¼•äººæ³¨ç›®ã€‚ä½†ä»ç„¶ï¼Œç»“æžœçœ‹èµ·æ¥å¾ˆå¥½ï¼š

![PIC](img/B22150_08_10.png)

å›¾ 8.10ï¼šä¸ŽåŸºå‡† DQN ç›¸æ¯”çš„å™ªå£°ç½‘ç»œ

åœ¨æŸ¥çœ‹ä¿¡å™ªæ¯”ï¼ˆSNRï¼‰å›¾è¡¨ï¼ˆå›¾ 8.11ï¼‰åŽï¼Œæ‚¨å¯èƒ½ä¼šæ³¨æ„åˆ°ä¸¤ä¸ªå±‚çš„å™ªå£°æ°´å¹³éƒ½è¿…é€Ÿä¸‹é™äº†ã€‚

![PIC](img/B22150_08_11.png)

å›¾ 8.11ï¼šç¬¬ 1 å±‚ï¼ˆå·¦ï¼‰å’Œç¬¬ 2 å±‚ï¼ˆå³ï¼‰çš„ SNR å˜åŒ–

ç¬¬ä¸€å±‚çš„å™ªå£°æ¯”çŽ‡å·²ç»ä»Ž![1 2](img/eq31.png)å˜åŒ–åˆ°æŽ¥è¿‘![ -1- 2.6](img/eq32.png)ã€‚ç¬¬äºŒå±‚æ›´æœ‰è¶£ï¼Œå› ä¸ºå®ƒçš„å™ªå£°æ°´å¹³ä»Žæœ€åˆçš„![1 4](img/eq33.png)é™ä½Žåˆ°äº†![1- 16](img/eq34.png)ï¼Œä½†åœ¨ 450K å¸§ä¹‹åŽï¼ˆå¤§è‡´ä¸ŽåŽŸå§‹å¥–åŠ±æŽ¥è¿‘ 20 åˆ†æ—¶çš„æ—¶é—´ç›¸åŒï¼‰ï¼Œæœ€åŽä¸€å±‚çš„å™ªå£°æ°´å¹³å¼€å§‹å†æ¬¡ä¸Šå‡ï¼ŒæŽ¨åŠ¨ä»£ç†æ›´æ·±å…¥åœ°æŽ¢ç´¢çŽ¯å¢ƒã€‚è¿™æ˜¯éžå¸¸æœ‰æ„ä¹‰çš„ï¼Œå› ä¸ºåœ¨è¾¾åˆ°é«˜åˆ†æ°´å¹³åŽï¼Œä»£ç†åŸºæœ¬ä¸Šå·²ç»çŸ¥é“å¦‚ä½•çŽ©å¾—å¾ˆå¥½ï¼Œä½†ä»ç„¶éœ€è¦â€œæ‰“ç£¨â€è‡ªå·±çš„è¡ŒåŠ¨ï¼Œä»¥è¿›ä¸€æ­¥æé«˜ç»“æžœã€‚

## è¶…å‚æ•°è°ƒä¼˜

è°ƒä¼˜åŽï¼Œæœ€ä½³å‚æ•°é›†èƒ½å¤Ÿåœ¨ 273 è½®åŽè§£å†³æ¸¸æˆé—®é¢˜ï¼Œç›¸æ¯”åŸºå‡†æ–¹æ³•æœ‰äº†æ”¹è¿›ï¼š

```py
 learning_rate=7.142520950425814e-05, 
    gamma=0.99,
```

ä»¥ä¸‹æ˜¯è°ƒä¼˜åŽçš„åŸºå‡† DQN ä¸Žè°ƒä¼˜åŽçš„å™ªå£°ç½‘ç»œå¥–åŠ±åŠ¨æ€å’Œæ­¥æ•°çš„æ¯”è¾ƒå›¾ï¼š

![PIC](img/B22150_08_12.png)

å›¾ 8.12ï¼šè°ƒä¼˜åŽçš„åŸºå‡† DQN ä¸Žè°ƒä¼˜åŽçš„å™ªå£°ç½‘ç»œæ¯”è¾ƒ

åœ¨ä¸¤å¼ å›¾ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°å™ªå£°ç½‘ç»œå¸¦æ¥çš„æ”¹è¿›ï¼šè¾¾åˆ° 21 åˆ†æ‰€éœ€çš„æ¸¸æˆæ¬¡æ•°å‡å°‘ï¼Œå¹¶ä¸”åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæ¸¸æˆçš„æ­¥æ•°å‡å°‘ã€‚

# ä¼˜å…ˆçº§å›žæ”¾ç¼“å†²åŒº

ä¸‹ä¸€é¡¹å…³äºŽå¦‚ä½•æ”¹è¿› DQN è®­ç»ƒçš„éžå¸¸æœ‰ç”¨çš„æƒ³æ³•æ˜¯åœ¨ 2015 å¹´æå‡ºçš„ï¼Œå‡ºçŽ°åœ¨è®ºæ–‡ã€Šä¼˜å…ˆç»éªŒå›žæ”¾ã€‹[Sch+15]ä¸­ã€‚è¿™ç§æ–¹æ³•å°è¯•é€šè¿‡æ ¹æ®è®­ç»ƒæŸå¤±å¯¹å›žæ”¾ç¼“å†²åŒºä¸­çš„æ ·æœ¬è¿›è¡Œä¼˜å…ˆçº§æŽ’åºï¼Œä»Žè€Œæé«˜æ ·æœ¬çš„æ•ˆçŽ‡ã€‚

åŸºæœ¬çš„ DQN ä½¿ç”¨å›žæ”¾ç¼“å†²åŒºæ¥æ‰“ç ´æˆ‘ä»¬å›žåˆä¸­å³æ—¶è½¬ç§»ä¹‹é—´çš„ç›¸å…³æ€§ã€‚æ­£å¦‚æˆ‘ä»¬åœ¨ç¬¬å…­ç« è®¨è®ºçš„é‚£æ ·ï¼Œæˆ‘ä»¬åœ¨å›žåˆä¸­ç»åŽ†çš„ç¤ºä¾‹ä¼šé«˜åº¦ç›¸å…³ï¼Œå› ä¸ºå¤§å¤šæ•°æ—¶å€™ï¼ŒçŽ¯å¢ƒæ˜¯â€œå¹³æ»‘â€çš„ï¼Œå¹¶ä¸”æ ¹æ®æˆ‘ä»¬çš„è¡ŒåŠ¨å˜åŒ–ä¸å¤§ã€‚ç„¶è€Œï¼Œéšæœºæ¢¯åº¦ä¸‹é™ï¼ˆSGDï¼‰æ–¹æ³•å‡è®¾æˆ‘ä»¬ç”¨äºŽè®­ç»ƒçš„æ•°æ®å…·æœ‰ç‹¬ç«‹åŒåˆ†å¸ƒï¼ˆiidï¼‰ç‰¹æ€§ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç»å…¸ DQN æ–¹æ³•ä½¿ç”¨äº†ä¸€ä¸ªå¤§å®¹é‡çš„è½¬ç§»ç¼“å†²åŒºï¼Œå¹¶é€šè¿‡éšæœºå‡åŒ€é‡‡æ ·æ¥èŽ·å–ä¸‹ä¸€ä¸ªè®­ç»ƒæ‰¹æ¬¡ã€‚

è®ºæ–‡çš„ä½œè€…è´¨ç–‘äº†è¿™ç§å‡åŒ€éšæœºé‡‡æ ·ç­–ç•¥ï¼Œå¹¶è¯æ˜Žé€šè¿‡æ ¹æ®è®­ç»ƒæŸå¤±ç»™ç¼“å†²åŒºæ ·æœ¬åˆ†é…ä¼˜å…ˆçº§ï¼Œå¹¶æŒ‰ä¼˜å…ˆçº§æ¯”ä¾‹é‡‡æ ·ç¼“å†²åŒºæ ·æœ¬ï¼Œæˆ‘ä»¬å¯ä»¥æ˜¾è‘—æé«˜ DQN çš„æ”¶æ•›æ€§å’Œç­–ç•¥è´¨é‡ã€‚è¯¥æ–¹æ³•çš„åŸºæœ¬æ€æƒ³å¯ä»¥ç”¨â€œå¯¹ä»¤ä½ æ„Ÿåˆ°æƒŠè®¶çš„æ•°æ®è¿›è¡Œæ›´å¤šè®­ç»ƒâ€æ¥è§£é‡Šã€‚è¿™é‡Œçš„å…³é”®ç‚¹æ˜¯ä¿æŒåœ¨â€œå¼‚å¸¸â€æ ·æœ¬ä¸Šè¿›è¡Œè®­ç»ƒä¸Žåœ¨ç¼“å†²åŒºå…¶ä½™éƒ¨åˆ†ä¸Šè®­ç»ƒä¹‹é—´çš„å¹³è¡¡ã€‚å¦‚æžœæˆ‘ä»¬ä»…å…³æ³¨ç¼“å†²åŒºçš„ä¸€å°éƒ¨åˆ†æ ·æœ¬ï¼Œå¯èƒ½ä¼šä¸§å¤±ç‹¬ç«‹åŒåˆ†å¸ƒï¼ˆi.i.d.ï¼‰ç‰¹æ€§ï¼Œç®€å•åœ°åœ¨è¿™ä¸ªå­é›†ä¸Šè¿‡æ‹Ÿåˆã€‚

ä»Žæ•°å­¦è§’åº¦æ¥çœ‹ï¼Œç¼“å†²åŒºä¸­æ¯ä¸ªæ ·æœ¬çš„ä¼˜å…ˆçº§è®¡ç®—å…¬å¼ä¸º ![ pÎ± âˆ‘kipÎ±- k](img/eq35.png)ï¼Œå…¶ä¸­ p[i] æ˜¯ç¼“å†²åŒºä¸­ç¬¬ i ä¸ªæ ·æœ¬çš„ä¼˜å…ˆçº§ï¼ŒÎ± æ˜¯è¡¨ç¤ºæˆ‘ä»¬å¯¹ä¼˜å…ˆçº§ç»™äºˆå¤šå°‘é‡è§†çš„å‚æ•°ã€‚å¦‚æžœ Î± = 0ï¼Œæˆ‘ä»¬çš„é‡‡æ ·å°†åƒç»å…¸çš„ DQN æ–¹æ³•ä¸€æ ·å˜å¾—å‡åŒ€ã€‚è¾ƒå¤§çš„ Î± å€¼åˆ™ä¼šæ›´åŠ å¼ºè°ƒé«˜ä¼˜å…ˆçº§çš„æ ·æœ¬ã€‚å› æ­¤ï¼Œè¿™æ˜¯å¦ä¸€ä¸ªéœ€è¦è°ƒèŠ‚çš„è¶…å‚æ•°ï¼Œè®ºæ–‡ä¸­å»ºè®®çš„ Î± åˆå§‹å€¼ä¸º 0.6ã€‚

è®ºæ–‡ä¸­æå‡ºäº†å‡ ç§å®šä¹‰ä¼˜å…ˆçº§çš„é€‰é¡¹ï¼Œå…¶ä¸­æœ€æµè¡Œçš„æ˜¯å°†å…¶ä¸Žè¿™ä¸ªç‰¹å®šæ ·æœ¬åœ¨è´å°”æ›¼æ›´æ–°ä¸­çš„æŸå¤±æˆæ¯”ä¾‹ã€‚æ–°åŠ å…¥ç¼“å†²åŒºçš„æ ·æœ¬éœ€è¦è¢«èµ‹äºˆä¸€ä¸ªæœ€å¤§ä¼˜å…ˆçº§å€¼ï¼Œä»¥ç¡®ä¿å®ƒä»¬èƒ½å°½å¿«è¢«é‡‡æ ·ã€‚

é€šè¿‡è°ƒæ•´æ ·æœ¬çš„ä¼˜å…ˆçº§ï¼Œæˆ‘ä»¬å®žé™…ä¸Šæ˜¯åœ¨æ•°æ®åˆ†å¸ƒä¸­å¼•å…¥åå·®ï¼ˆæˆ‘ä»¬æ¯”å…¶ä»–è½¬æ¢æ›´é¢‘ç¹åœ°é‡‡æ ·æŸäº›è½¬æ¢ï¼‰ï¼Œå¦‚æžœå¸Œæœ› SGD èƒ½å¤Ÿæœ‰æ•ˆå·¥ä½œï¼Œæˆ‘ä»¬éœ€è¦å¯¹è¿™ç§åå·®è¿›è¡Œè¡¥å¿ã€‚ä¸ºäº†å¾—åˆ°è¿™ä¸ªç»“æžœï¼Œç ”ç©¶çš„ä½œè€…ä½¿ç”¨äº†æ ·æœ¬æƒé‡ï¼Œè¿™äº›æƒé‡éœ€è¦ä¸Žå•ä¸ªæ ·æœ¬çš„æŸå¤±ç›¸ä¹˜ã€‚æ¯ä¸ªæ ·æœ¬çš„æƒé‡å€¼å®šä¹‰ä¸º w[i] = (N â‹…P(i))^(âˆ’Î²)ï¼Œå…¶ä¸­ Î² æ˜¯å¦ä¸€ä¸ªè¶…å‚æ•°ï¼Œåº”è¯¥åœ¨ 0 å’Œ 1 ä¹‹é—´ã€‚

å½“ Î² = 1 æ—¶ï¼Œé‡‡æ ·å¼•å…¥çš„åå·®å¾—åˆ°äº†å®Œå…¨è¡¥å¿ï¼Œä½†ä½œè€…è¡¨æ˜Žï¼Œå¼€å§‹æ—¶å°† Î² è®¾ç½®åœ¨ 0 åˆ° 1 ä¹‹é—´ï¼Œå¹¶åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­é€æ¸å¢žåŠ åˆ° 1ï¼Œæœ‰åˆ©äºŽæ”¶æ•›ã€‚

## å®žçŽ°

ä¸ºäº†å®žçŽ°è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨ä»£ç ä¸­åšå‡ºä¸€äº›ç‰¹å®šçš„ä¿®æ”¹ï¼š

+   é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ–°çš„é‡æ”¾ç¼“å†²åŒºï¼Œå®ƒå°†è·Ÿè¸ªä¼˜å…ˆçº§ã€æ ¹æ®ä¼˜å…ˆçº§é‡‡æ ·æ‰¹æ¬¡ã€è®¡ç®—æƒé‡ï¼Œå¹¶åœ¨æŸå¤±å€¼å·²çŸ¥åŽè®©æˆ‘ä»¬æ›´æ–°ä¼˜å…ˆçº§ã€‚

+   ç¬¬äºŒä¸ªå˜åŒ–å°†æ˜¯æŸå¤±å‡½æ•°æœ¬èº«ã€‚çŽ°åœ¨æˆ‘ä»¬ä¸ä»…éœ€è¦ä¸ºæ¯ä¸ªæ ·æœ¬å¼•å…¥æƒé‡ï¼Œè¿˜éœ€è¦å°†æŸå¤±å€¼å›žä¼ åˆ°é‡æ”¾ç¼“å†²åŒºï¼Œä»¥è°ƒæ•´é‡‡æ ·è½¬æ¢çš„ä¼˜å…ˆçº§ã€‚

åœ¨ä¸»æ¨¡å— Chapter08/05_dqn_prio_replay.py ä¸­ï¼Œæˆ‘ä»¬å·²ç»å®žçŽ°äº†æ‰€æœ‰è¿™äº›ä¿®æ”¹ã€‚ä¸ºäº†ç®€åŒ–ï¼Œæ–°çš„ä¼˜å…ˆçº§é‡æ”¾ç¼“å†²åŒºç±»ä½¿ç”¨ä¸Žæˆ‘ä»¬ä¹‹å‰çš„é‡æ”¾ç¼“å†²åŒºéžå¸¸ç›¸ä¼¼çš„å­˜å‚¨æ–¹æ¡ˆã€‚ä¸å¹¸çš„æ˜¯ï¼Œæ–°çš„ä¼˜å…ˆçº§è¦æ±‚ä½¿å¾—æ— æ³•ä»¥ ð’ª(1) æ—¶é—´å¤æ‚åº¦å®žçŽ°é‡‡æ ·ï¼ˆæ¢å¥è¯è¯´ï¼Œé‡‡æ ·æ—¶é—´å°†éšç€ç¼“å†²åŒºå¤§å°çš„å¢žåŠ è€Œå¢žé•¿ï¼‰ã€‚å¦‚æžœæˆ‘ä»¬ä½¿ç”¨ç®€å•çš„åˆ—è¡¨ï¼Œæ¯æ¬¡é‡‡æ ·æ–°çš„ä¸€æ‰¹æ ·æœ¬æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å¤„ç†æ‰€æœ‰ä¼˜å…ˆçº§ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬çš„é‡‡æ ·æ—¶é—´å¤æ‚åº¦ä¸Žç¼“å†²åŒºå¤§å°æˆæ­£æ¯”ï¼Œè¾¾åˆ° ð’ª(N)ã€‚å¦‚æžœæˆ‘ä»¬çš„ç¼“å†²åŒºå¾ˆå°ï¼Œæ¯”å¦‚ 100k æ ·æœ¬ï¼Œè¿™å¹¶ä¸æ˜¯ä»€ä¹ˆå¤§é—®é¢˜ï¼Œä½†å¯¹äºŽçŽ°å®žä¸­çš„å¤§åž‹ç¼“å†²åŒºï¼Œæ ·æœ¬æ•°é‡è¾¾åˆ°æ•°ç™¾ä¸‡æ—¶ï¼Œè¿™å¯èƒ½æˆä¸ºä¸€ä¸ªé—®é¢˜ã€‚æœ‰å…¶ä»–æ”¯æŒåœ¨ ð’ª(log N) æ—¶é—´å†…è¿›è¡Œé«˜æ•ˆé‡‡æ ·çš„å­˜å‚¨æ–¹æ¡ˆï¼Œä¾‹å¦‚ï¼Œä½¿ç”¨çº¿æ®µæ ‘æ•°æ®ç»“æž„ã€‚å„ç§åº“ä¸­éƒ½æœ‰è¿™äº›ä¼˜åŒ–åŽçš„ç¼“å†²åŒºç‰ˆæœ¬â€”â€”ä¾‹å¦‚ï¼ŒTorchRL ä¸­å°±æœ‰ã€‚

PTAN åº“è¿˜æä¾›äº†ä¸€ä¸ªé«˜æ•ˆçš„ä¼˜å…ˆçº§é‡æ”¾ç¼“å†²åŒºï¼Œä½äºŽç±» ptan.experience.PrioritizedReplayBuffer ä¸­ã€‚æ‚¨å¯ä»¥æ›´æ–°ç¤ºä¾‹ï¼Œä½¿ç”¨æ›´é«˜æ•ˆçš„ç‰ˆæœ¬ï¼Œå¹¶æ£€æŸ¥å…¶å¯¹è®­ç»ƒæ€§èƒ½çš„å½±å“ã€‚

ä½†æ˜¯ï¼ŒçŽ°åœ¨è®©æˆ‘ä»¬å…ˆçœ‹çœ‹æœ´ç´ ç‰ˆæœ¬ï¼Œå…¶æºä»£ç å¯ä»¥åœ¨ lib/dqn_extra.py ä¸­æ‰¾åˆ°ã€‚

åœ¨å¼€å§‹æ—¶ï¼Œæˆ‘ä»¬å®šä¹‰äº†Î²å¢žåŠ çŽ‡çš„å‚æ•°ï¼š

```py
BETA_START = 0.4 
BETA_FRAMES = 100_000
```

æˆ‘ä»¬çš„Î²å°†åœ¨å‰ 100k å¸§ä¸­ä»Ž 0.4 å˜åŒ–åˆ° 1.0ã€‚

æŽ¥ä¸‹æ¥æ˜¯ä¼˜å…ˆçº§é‡æ”¾ç¼“å†²åŒºç±»ï¼š

```py
class PrioReplayBuffer(ExperienceReplayBuffer): 
    def __init__(self, exp_source: ExperienceSource, buf_size: int, 
                 prob_alpha: float = 0.6): 
        super().__init__(exp_source, buf_size) 
        self.experience_source_iter = iter(exp_source) 
        self.capacity = buf_size 
        self.pos = 0 
        self.buffer = [] 
        self.prob_alpha = prob_alpha 
        self.priorities = np.zeros((buf_size, ), dtype=np.float32) 
        self.beta = BETA_START
```

ä¼˜å…ˆçº§é‡æ”¾ç¼“å†²åŒºçš„ç±»ç»§æ‰¿è‡ª PTAN ä¸­çš„ç®€å•é‡æ”¾ç¼“å†²åŒºï¼Œè¯¥ç¼“å†²åŒºå°†æ ·æœ¬å­˜å‚¨åœ¨ä¸€ä¸ªå¾ªçŽ¯ç¼“å†²åŒºä¸­ï¼ˆå®ƒå…è®¸æˆ‘ä»¬ä¿æŒå›ºå®šæ•°é‡çš„æ¡ç›®ï¼Œè€Œæ— éœ€é‡æ–°åˆ†é…åˆ—è¡¨ï¼‰ã€‚æˆ‘ä»¬çš„å­ç±»ä½¿ç”¨ NumPy æ•°ç»„æ¥ä¿æŒä¼˜å…ˆçº§ã€‚

éœ€è¦å®šæœŸè°ƒç”¨ update_beta()æ–¹æ³•ï¼Œä»¥æ ¹æ®è®¡åˆ’å¢žåŠ Î²å€¼ã€‚populate()æ–¹æ³•éœ€è¦ä»Ž ExperienceSource å¯¹è±¡ä¸­æå–ç»™å®šæ•°é‡çš„è½¬æ¢å¹¶å°†å…¶å­˜å‚¨åœ¨ç¼“å†²åŒºä¸­ï¼š

```py
 def update_beta(self, idx: int) -> float: 
        v = BETA_START + idx * (1.0 - BETA_START) / BETA_FRAMES 
        self.beta = min(1.0, v) 
        return self.beta 

    def populate(self, count: int): 
        max_prio = self.priorities.max(initial=1.0) 
        for _ in range(count): 
            sample = next(self.experience_source_iter) 
            if len(self.buffer) < self.capacity: 
                self.buffer.append(sample) 
            else: 
                self.buffer[self.pos] = sample 
            self.priorities[self.pos] = max_prio 
            self.pos = (self.pos + 1) % self.capacity
```

ç”±äºŽæˆ‘ä»¬çš„è½¬æ¢å­˜å‚¨å®žçŽ°ä¸ºå¾ªçŽ¯ç¼“å†²åŒºï¼Œå› æ­¤æˆ‘ä»¬åœ¨æ­¤ç¼“å†²åŒºä¸­æœ‰ä¸¤ç§ä¸åŒçš„æƒ…å†µï¼š

+   å½“æˆ‘ä»¬çš„ç¼“å†²åŒºå°šæœªè¾¾åˆ°æœ€å¤§å®¹é‡æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦å°†æ–°çš„è½¬æ¢è¿½åŠ åˆ°ç¼“å†²åŒºä¸­ã€‚

+   å¦‚æžœç¼“å†²åŒºå·²ç»æ»¡äº†ï¼Œæˆ‘ä»¬éœ€è¦è¦†ç›–æœ€æ—§çš„è½¬æ¢ï¼Œè¯¥è½¬æ¢ç”± pos ç±»å­—æ®µè·Ÿè¸ªï¼Œå¹¶è°ƒæ•´è¯¥ä½ç½®ä¸ºç¼“å†²åŒºå¤§å°çš„æ¨¡ã€‚

åœ¨ç¤ºä¾‹æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨æˆ‘ä»¬çš„Î±è¶…å‚æ•°å°†ä¼˜å…ˆçº§è½¬æ¢ä¸ºæ¦‚çŽ‡ï¼š

```py
 def sample(self, batch_size: int) -> tt.Tuple[ 
        tt.List[ExperienceFirstLast], np.ndarray, np.ndarray 
    ]: 
        if len(self.buffer) == self.capacity: 
            prios = self.priorities 
        else: 
            prios = self.priorities[:self.pos] 
        probs = prios ** self.prob_alpha 
        probs /= probs.sum()
```

ç„¶åŽï¼Œä½¿ç”¨è¿™äº›æ¦‚çŽ‡ï¼Œæˆ‘ä»¬ä»Žç¼“å†²åŒºä¸­é‡‡æ ·ï¼Œä»¥èŽ·å¾—ä¸€æ‰¹æ ·æœ¬ï¼š

```py
 indices = np.random.choice(len(self.buffer), batch_size, p=probs) 
        samples = [self.buffer[idx] for idx in indices]
```

æœ€åŽä¸€æ­¥ï¼Œæˆ‘ä»¬è®¡ç®—æ‰¹å¤„ç†ä¸­æ ·æœ¬çš„æƒé‡ï¼š

```py
 total = len(self.buffer) 
        weights = (total * probs[indices]) ** (-self.beta) 
        weights /= weights.max() 
        return samples, indices, np.array(weights, dtype=np.float32)
```

è¯¥å‡½æ•°è¿”å›žä¸‰ä¸ªå¯¹è±¡ï¼šæ‰¹å¤„ç†ã€ç´¢å¼•å’Œæƒé‡ã€‚æ‰¹å¤„ç†æ ·æœ¬çš„ç´¢å¼•æ˜¯æ›´æ–°é‡‡æ ·é¡¹ç›®ä¼˜å…ˆçº§æ‰€å¿…éœ€çš„ã€‚

ä¼˜å…ˆçº§é‡æ”¾ç¼“å†²åŒºçš„æœ€åŽä¸€ä¸ªå‡½æ•°å…è®¸æˆ‘ä»¬æ›´æ–°å¤„ç†è¿‡çš„æ‰¹æ¬¡çš„æ–°ä¼˜å…ˆçº§ï¼š

```py
 def update_priorities(self, batch_indices: np.ndarray, batch_priorities: np.ndarray): 
        for idx, prio in zip(batch_indices, batch_priorities): 
            self.priorities[idx] = prio
```

è°ƒç”¨è€…æœ‰è´£ä»»åœ¨æ‰¹å¤„ç†çš„æŸå¤±è®¡ç®—åŽä½¿ç”¨æ­¤å‡½æ•°ã€‚

æˆ‘ä»¬ç¤ºä¾‹ä¸­çš„ä¸‹ä¸€ä¸ªè‡ªå®šä¹‰å‡½æ•°æ˜¯æŸå¤±è®¡ç®—ã€‚ç”±äºŽ PyTorch ä¸­çš„ MSELoss ç±»ä¸æ”¯æŒæƒé‡ï¼ˆè¿™æ˜¯å¯ä»¥ç†è§£çš„ï¼Œå› ä¸º MSE æ˜¯å›žå½’é—®é¢˜ä¸­ä½¿ç”¨çš„æŸå¤±ï¼Œä½†æ ·æœ¬åŠ æƒé€šå¸¸ç”¨äºŽåˆ†ç±»æŸå¤±ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦è®¡ç®— MSE å¹¶æ˜¾å¼åœ°å°†ç»“æžœä¸Žæƒé‡ç›¸ä¹˜ï¼š

```py
def calc_loss(batch: tt.List[ExperienceFirstLast], batch_weights: np.ndarray, 
              net: nn.Module, tgt_net: nn.Module, gamma: float, 
              device: torch.device) -> tt.Tuple[torch.Tensor, np.ndarray]: 
    states, actions, rewards, dones, next_states = common.unpack_batch(batch) 

    states_v = torch.as_tensor(states).to(device) 
    actions_v = torch.tensor(actions).to(device) 
    rewards_v = torch.tensor(rewards).to(device) 
    done_mask = torch.BoolTensor(dones).to(device) 
    batch_weights_v = torch.tensor(batch_weights).to(device) 

    actions_v = actions_v.unsqueeze(-1) 
    state_action_vals = net(states_v).gather(1, actions_v) 
    state_action_vals = state_action_vals.squeeze(-1) 
    with torch.no_grad(): 
        next_states_v = torch.as_tensor(next_states).to(device) 
        next_s_vals = tgt_net(next_states_v).max(1)[0] 
        next_s_vals[done_mask] = 0.0 
        exp_sa_vals = next_s_vals.detach() * gamma + rewards_v 
    l = (state_action_vals - exp_sa_vals) ** 2 
    losses_v = batch_weights_v * l 
    return losses_v.mean(), (losses_v + 1e-5).data.cpu().numpy()
```

åœ¨æŸå¤±è®¡ç®—çš„æœ€åŽéƒ¨åˆ†ï¼Œæˆ‘ä»¬å®žçŽ°äº†ç›¸åŒçš„ MSE æŸå¤±ï¼Œä½†æ˜¾å¼åœ°å†™å‡ºäº†æˆ‘ä»¬çš„è¡¨è¾¾å¼ï¼Œè€Œä¸æ˜¯ä½¿ç”¨åº“å‡½æ•°ã€‚è¿™æ ·å¯ä»¥è€ƒè™‘æ ·æœ¬çš„æƒé‡ï¼Œå¹¶ä¸ºæ¯ä¸ªæ ·æœ¬ä¿æŒå•ç‹¬çš„æŸå¤±å€¼ã€‚è¿™äº›å€¼å°†ä¼ é€’ç»™ä¼˜å…ˆçº§é‡æ”¾ç¼“å†²åŒºä»¥æ›´æ–°ä¼˜å…ˆçº§ã€‚æ¯ä¸ªæŸå¤±å€¼éƒ½ä¼šåŠ ä¸Šä¸€ä¸ªå°å€¼ï¼Œä»¥å¤„ç†æŸå¤±å€¼ä¸ºé›¶çš„æƒ…å†µï¼Œè¿™ç§æƒ…å†µä¼šå¯¼è‡´é‡æ”¾ç¼“å†²åŒºä¸­æ¡ç›®çš„ä¼˜å…ˆçº§ä¸ºé›¶ã€‚

åœ¨æˆ‘ä»¬ç¨‹åºçš„ä¸»è¦éƒ¨åˆ†ï¼Œåªæœ‰ä¸¤ä¸ªæ›´æ–°ï¼šå›žæ”¾ç¼“å†²åŒºçš„åˆ›å»ºå’Œæˆ‘ä»¬çš„å¤„ç†å‡½æ•°ã€‚ç¼“å†²åŒºåˆ›å»ºå¾ˆç®€å•ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦çœ‹ä¸€ä¸‹æ–°çš„å¤„ç†å‡½æ•°ï¼š

```py
 def process_batch(engine, batch_data): 
        batch, batch_indices, batch_weights = batch_data 
        optimizer.zero_grad() 
        loss_v, sample_prios = calc_loss( 
            batch, batch_weights, net, tgt_net.target_model, 
            gamma=params.gamma, device=device) 
        loss_v.backward() 
        optimizer.step() 
        buffer.update_priorities(batch_indices, sample_prios) 
        epsilon_tracker.frame(engine.state.iteration) 
        if engine.state.iteration % params.target_net_sync == 0: 
            tgt_net.sync() 
        return { 
            "loss": loss_v.item(), 
            "epsilon": selector.epsilon, 
            "beta": buffer.update_beta(engine.state.iteration), 
        }
```

è¿™é‡Œæœ‰å‡ ä¸ªå˜åŒ–ï¼š

+   çŽ°åœ¨æˆ‘ä»¬çš„æ‰¹æ¬¡åŒ…å«ä¸‰ç§å®žä½“ï¼šæ•°æ®æ‰¹æ¬¡ã€é‡‡æ ·é¡¹çš„ç´¢å¼•å’Œæ ·æœ¬çš„æƒé‡ã€‚

+   æˆ‘ä»¬ç§°ä¹‹ä¸ºæ–°çš„æŸå¤±å‡½æ•°ï¼Œå®ƒæŽ¥å—æƒé‡å¹¶è¿”å›žé¢å¤–é¡¹çš„ä¼˜å…ˆçº§ã€‚è¿™äº›ä¼˜å…ˆçº§ä¼šä¼ é€’ç»™ `buffer.update_priorities()` å‡½æ•°ï¼Œä»¥ä¾¿é‡æ–°è°ƒæ•´æˆ‘ä»¬é‡‡æ ·çš„é¡¹çš„ä¼˜å…ˆçº§ã€‚

+   æˆ‘ä»¬è°ƒç”¨ç¼“å†²åŒºçš„ `update_beta()` æ–¹æ³•ï¼Œæ ¹æ®è®¡åˆ’æ”¹å˜ beta å‚æ•°ã€‚

## ç»“æžœ

è¿™ä¸ªä¾‹å­å¯ä»¥åƒå¾€å¸¸ä¸€æ ·è®­ç»ƒã€‚æ ¹æ®æˆ‘çš„å®žéªŒï¼Œä¼˜å…ˆçº§å›žæ”¾ç¼“å†²åŒºå‡ ä¹ŽèŠ±è´¹äº†ç›¸åŒçš„æ—¶é—´æ¥è§£å†³çŽ¯å¢ƒï¼šå·®ä¸å¤šä¸€ä¸ªå°æ—¶ã€‚ä½†å®ƒèŠ±è´¹äº†æ›´å°‘çš„è®­ç»ƒè¿­ä»£å’Œå›žåˆã€‚å› æ­¤ï¼Œå¢™æ—¶é’Ÿæ—¶é—´å‡ ä¹Žç›¸åŒï¼Œä¸»è¦æ˜¯ç”±äºŽå›žæ”¾ç¼“å†²åŒºæ•ˆçŽ‡è¾ƒä½Žï¼Œå½“ç„¶ï¼Œè¿™å¯ä»¥é€šè¿‡é€‚å½“çš„ ð’ª(log N) å®žçŽ°æ¥è§£å†³ç¼“å†²åŒºçš„é—®é¢˜ã€‚

è¿™é‡Œæ˜¯åŸºçº¿ä¸Žä¼˜å…ˆçº§å›žæ”¾ç¼“å†²åŒºï¼ˆå³ä¾§ï¼‰å¥–åŠ±åŠ¨æ€çš„æ¯”è¾ƒã€‚æ¨ªåæ ‡æ˜¯æ¸¸æˆå›žåˆï¼š

![å›¾ç‰‡](img/B22150_08_13.png)

å›¾ 8.13ï¼šä¸ŽåŸºç¡€ DQN æ¯”è¾ƒçš„ä¼˜å…ˆçº§å›žæ”¾ç¼“å†²åŒºå¥–åŠ±åŠ¨æ€

åœ¨ TensorBoard å›¾è¡¨ä¸­è¿˜å¯ä»¥çœ‹åˆ°å¦ä¸€ä¸ªä¸åŒä¹‹å¤„ï¼Œå°±æ˜¯ä¼˜å…ˆçº§å›žæ”¾ç¼“å†²åŒºçš„æŸå¤±å€¼æ˜Žæ˜¾è¾ƒä½Žã€‚ä»¥ä¸‹å›¾è¡¨å±•ç¤ºäº†è¿™ä¸€æ¯”è¾ƒï¼š

![å›¾ç‰‡](img/B22150_08_14.png)

å›¾ 8.14ï¼šè®­ç»ƒè¿‡ç¨‹ä¸­æŸå¤±çš„æ¯”è¾ƒ

è¾ƒä½Žçš„æŸå¤±å€¼ä¹Ÿæ˜¯å¯ä»¥é¢„æœŸçš„ï¼Œå¹¶ä¸”æ˜¯æˆ‘ä»¬å®žçŽ°æœ‰æ•ˆçš„è‰¯å¥½è¿¹è±¡ã€‚ä¼˜å…ˆçº§çš„æ ¸å¿ƒæ€æƒ³æ˜¯æ›´å¤šåœ°è®­ç»ƒé‚£äº›æŸå¤±å€¼è¾ƒé«˜çš„æ ·æœ¬ï¼Œä½¿å¾—è®­ç»ƒæ›´åŠ é«˜æ•ˆã€‚ä½†è¿™é‡Œæœ‰ä¸€ä¸ªé£Žé™©ï¼šè®­ç»ƒä¸­çš„æŸå¤±å€¼å¹¶ä¸æ˜¯ä¼˜åŒ–çš„ä¸»è¦ç›®æ ‡ï¼›æˆ‘ä»¬å¯ä»¥æœ‰éžå¸¸ä½Žçš„æŸå¤±å€¼ï¼Œä½†ç”±äºŽç¼ºä¹æŽ¢ç´¢ï¼Œæœ€ç»ˆå­¦ä¹ åˆ°çš„ç­–ç•¥å¯èƒ½è¿œæœªè¾¾åˆ°æœ€ä¼˜ã€‚

## è¶…å‚æ•°è°ƒä¼˜

å¯¹ä¼˜å…ˆçº§å›žæ”¾ç¼“å†²åŒºçš„è¶…å‚æ•°è°ƒä¼˜æ˜¯é€šè¿‡ä¸º Î± å¼•å…¥ä¸€ä¸ªé¢å¤–çš„å‚æ•°è¿›è¡Œçš„ï¼ŒÎ± çš„å€¼ä»Ž 0.3 åˆ° 0.9ï¼ˆæ­¥é•¿ä¸º 0.1ï¼‰ä¹‹é—´çš„å›ºå®šåˆ—è¡¨ä¸­é‡‡æ ·ã€‚æœ€ä½³ç»„åˆèƒ½å¤Ÿåœ¨ 330 ä¸ªå›žåˆåŽè§£å†³ Pong é—®é¢˜ï¼Œå¹¶ä¸” Î± = 0.6ï¼ˆä¸Žè®ºæ–‡ä¸­çš„ç›¸åŒï¼‰ï¼š

```py
 learning_rate=8.839010139505506e-05, 
    gamma=0.99,
```

ä»¥ä¸‹æ˜¯æ¯”è¾ƒè°ƒæ•´åŽçš„åŸºçº¿ DQN ä¸Žè°ƒæ•´åŽçš„ä¼˜å…ˆçº§å›žæ”¾ç¼“å†²åŒºçš„å›¾è¡¨ï¼š

![å›¾ç‰‡](img/B22150_08_15.png)

å›¾ 8.15ï¼šè°ƒæ•´åŽçš„åŸºçº¿ DQN å’Œè°ƒæ•´åŽçš„ä¼˜å…ˆçº§å›žæ”¾ç¼“å†²åŒºæ¯”è¾ƒ

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬çœ‹åˆ°ä¼˜å…ˆçº§å›žæ”¾ç¼“å†²åŒºçš„æ¸¸æˆçŽ©æ³•æ”¹è¿›æ›´å¿«ï¼Œä½†è¾¾åˆ° 21 åˆ†æ‰€éœ€çš„æ¸¸æˆæ•°é‡å‡ ä¹Žç›¸åŒã€‚åœ¨å³è¾¹çš„å›¾è¡¨ï¼ˆä»¥æ¸¸æˆæ­¥éª¤ä¸ºå•ä½ï¼‰ä¸­ï¼Œä¼˜å…ˆçº§å›žæ”¾ç¼“å†²åŒºçš„è¡¨çŽ°ä¹Ÿç•¥ä¼˜ã€‚

# å¯¹æŠ— DQN

è¿™ä¸€æ”¹è¿›äºŽ 2015 å¹´åœ¨è®ºæ–‡ã€ŠDueling Network Architectures for Deep Reinforcement Learningã€‹ä¸­æå‡º [Wan+16]ã€‚è¿™ç¯‡è®ºæ–‡çš„æ ¸å¿ƒè§‚ç‚¹æ˜¯ï¼Œç½‘ç»œè¯•å›¾è¿‘ä¼¼çš„ Q å€¼ Q(s,a) å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šçŠ¶æ€çš„å€¼ V (s) å’Œè¯¥çŠ¶æ€ä¸‹åŠ¨ä½œçš„ä¼˜åŠ¿ A(s,a)ã€‚

ä½ ä¹‹å‰è§è¿‡ V (s) è¿™ä¸€é‡ï¼Œå®ƒæ˜¯ç¬¬äº”ç« ä¸­å€¼è¿­ä»£æ–¹æ³•çš„æ ¸å¿ƒã€‚å®ƒç­‰äºŽä»Žè¯¥çŠ¶æ€å‡ºå‘å¯ä»¥èŽ·å¾—çš„æŠ˜æ‰£é¢„æœŸå¥–åŠ±ã€‚ä¼˜åŠ¿ A(s,a) æ—¨åœ¨å¼¥åˆ V (s) å’Œ Q(s,a) ä¹‹é—´çš„å·®è·ï¼Œå› ä¸ºæ ¹æ®å®šä¹‰ï¼ŒQ(s,a) = V (s) + A(s,a)ã€‚æ¢å¥è¯è¯´ï¼Œä¼˜åŠ¿ A(s,a) åªæ˜¯å¢žé‡ï¼Œè¡¨ç¤ºä»Žè¯¥çŠ¶æ€é‡‡å–æŸä¸€ç‰¹å®šåŠ¨ä½œå¸¦æ¥çš„é¢å¤–å¥–åŠ±ã€‚ä¼˜åŠ¿å¯ä»¥æ˜¯æ­£å€¼ä¹Ÿå¯ä»¥æ˜¯è´Ÿå€¼ï¼Œé€šå¸¸å¯ä»¥å…·æœ‰ä»»ä½•å¤§å°ã€‚ä¾‹å¦‚ï¼Œåœ¨æŸä¸ªä¸´ç•Œç‚¹ï¼Œé€‰æ‹©æŸä¸€åŠ¨ä½œè€Œéžå¦ä¸€åŠ¨ä½œå¯èƒ½ä¼šè®©æˆ‘ä»¬å¤±åŽ»å¾ˆå¤šæ€»å¥–åŠ±ã€‚

Dueling è®ºæ–‡çš„è´¡çŒ®åœ¨äºŽæ˜Žç¡®åŒºåˆ†äº†ç½‘ç»œæž¶æž„ä¸­çš„ä»·å€¼å’Œä¼˜åŠ¿ï¼Œè¿™å¸¦æ¥äº†æ›´å¥½çš„è®­ç»ƒç¨³å®šæ€§ã€æ›´å¿«çš„æ”¶æ•›é€Ÿåº¦ä»¥åŠåœ¨ Atari åŸºå‡†æµ‹è¯•ä¸­æ›´å¥½çš„ç»“æžœã€‚ä¸Žç»å…¸ DQN ç½‘ç»œçš„æž¶æž„å·®å¼‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ç»å…¸çš„ DQN ç½‘ç»œï¼ˆä¸Šå›¾ï¼‰ä»Žå·ç§¯å±‚æå–ç‰¹å¾ï¼Œå¹¶é€šè¿‡å…¨è¿žæŽ¥å±‚å°†å…¶è½¬æ¢ä¸º Q å€¼å‘é‡ï¼Œæ¯ä¸ªåŠ¨ä½œå¯¹åº”ä¸€ä¸ª Q å€¼ã€‚å¦ä¸€æ–¹é¢ï¼ŒDueling DQNï¼ˆä¸‹å›¾ï¼‰ä»Žå·ç§¯å±‚æå–ç‰¹å¾ï¼Œå¹¶é€šè¿‡ä¸¤æ¡ç‹¬ç«‹çš„è·¯å¾„å¤„ç†å®ƒä»¬ï¼šä¸€æ¡è·¯å¾„è´Ÿè´£é¢„æµ‹ V (s)ï¼Œå³ä¸€ä¸ªå•ä¸€çš„æ•°å€¼ï¼Œå¦ä¸€æ¡è·¯å¾„é¢„æµ‹å„ä¸ªåŠ¨ä½œçš„ä¼˜åŠ¿å€¼ï¼Œç»´åº¦ä¸Žç»å…¸æƒ…å†µä¸‹çš„ Q å€¼ç›¸åŒã€‚ä¹‹åŽï¼Œæˆ‘ä»¬å°† V (s) åŠ åˆ°æ¯ä¸ª A(s,a) çš„å€¼ä¸Šï¼Œä»Žè€Œå¾—åˆ° Q(s,a)ï¼Œè¿™ä¸ªå€¼åƒé€šå¸¸çš„ Q å€¼ä¸€æ ·è¢«ä½¿ç”¨å¹¶è®­ç»ƒã€‚å›¾ 8.16ï¼ˆæ¥è‡ªè®ºæ–‡ï¼‰æ¯”è¾ƒäº†åŸºæœ¬çš„ DQN å’Œ Dueling DQNï¼š

![PIC](img/file58.png)

å›¾ 8.16ï¼šåŸºæœ¬çš„ DQNï¼ˆä¸Šå›¾ï¼‰å’Œ Dueling æž¶æž„ï¼ˆä¸‹å›¾ï¼‰

è¿™äº›æž¶æž„çš„å˜åŒ–å¹¶ä¸è¶³ä»¥ç¡®ä¿ç½‘ç»œæŒ‰æˆ‘ä»¬å¸Œæœ›çš„æ–¹å¼å­¦ä¹  V (s) å’Œ A(s,a)ã€‚ä¾‹å¦‚ï¼Œç½‘ç»œå¯èƒ½é¢„æµ‹æŸä¸ªçŠ¶æ€çš„ V (s) = 0 å’Œ A(s) = [1,2,3,4]ï¼Œè¿™ç§æƒ…å†µæ˜¯å®Œå…¨é”™è¯¯çš„ï¼Œå› ä¸ºé¢„æµ‹çš„ V (s) ä¸æ˜¯è¯¥çŠ¶æ€çš„æœŸæœ›å€¼ã€‚æˆ‘ä»¬è¿˜éœ€è¦è®¾å®šä¸€ä¸ªé¢å¤–çš„çº¦æŸï¼šæˆ‘ä»¬å¸Œæœ›ä»»ä½•çŠ¶æ€ä¸‹ä¼˜åŠ¿çš„å‡å€¼ä¸ºé›¶ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå‰è¿°ä¾‹å­çš„æ­£ç¡®é¢„æµ‹åº”è¯¥æ˜¯ V (s) = 2.5 å’Œ A(s) = [âˆ’1.5,âˆ’0.5,0.5,1.5]ã€‚

è¿™ä¸ªçº¦æŸå¯ä»¥é€šè¿‡å¤šç§æ–¹å¼å¼ºåˆ¶æ‰§è¡Œï¼Œä¾‹å¦‚é€šè¿‡æŸå¤±å‡½æ•°ï¼›ä½†åœ¨ Dueling è®ºæ–‡ä¸­ï¼Œä½œè€…æå‡ºäº†ä¸€ç§éžå¸¸ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆï¼šä»Žç½‘ç»œçš„ Q è¡¨è¾¾å¼ä¸­å‡åŽ»ä¼˜åŠ¿çš„å‡å€¼ï¼Œè¿™æ ·å¯ä»¥æœ‰æ•ˆåœ°å°†ä¼˜åŠ¿çš„å‡å€¼æ‹‰è‡³é›¶ï¼š

![Ï€ (a |s) = P[At = a|St = s] ](img/eq36.png)

è¿™ä½¿å¾—å°†ç»å…¸ DQN è½¬å˜ä¸ºåŒ DQN çš„ä¿®æ”¹éžå¸¸ç®€å•ï¼šåªéœ€è¦æ”¹å˜ç½‘ç»œæž¶æž„ï¼Œè€Œä¸å½±å“å®žçŽ°çš„å…¶ä»–éƒ¨åˆ†ã€‚

## å®žçŽ°

å®Œæ•´çš„ç¤ºä¾‹å¯ä»¥åœ¨ Chapter08/06_dqn_dueling.py ä¸­æ‰¾åˆ°ã€‚æ‰€æœ‰çš„æ”¹åŠ¨éƒ½åœ¨ç½‘ç»œæž¶æž„ä¸­ï¼Œå› æ­¤è¿™é‡Œæˆ‘åªå±•ç¤ºç½‘ç»œç±»ï¼ˆä½äºŽ lib/dqn_extra.py æ¨¡å—ä¸­ï¼‰ã€‚

å·ç§¯éƒ¨åˆ†ä¸Žä¹‹å‰å®Œå…¨ç›¸åŒï¼š

```py
class DuelingDQN(nn.Module): 
    def __init__(self, input_shape: tt.Tuple[int, ...], n_actions: int): 
        super(DuelingDQN, self).__init__() 

        self.conv = nn.Sequential( 
            nn.Conv2d(input_shape[0], 32, kernel_size=8, stride=4), 
            nn.ReLU(), 
            nn.Conv2d(32, 64, kernel_size=4, stride=2), 
            nn.ReLU(), 
            nn.Conv2d(64, 64, kernel_size=3, stride=1), 
            nn.ReLU(), 
            nn.Flatten() 
        )
```

æˆ‘ä»¬æ²¡æœ‰å®šä¹‰ä¸€ä¸ªå•ä¸€çš„å®Œå…¨è¿žæŽ¥å±‚è·¯å¾„ï¼Œè€Œæ˜¯åˆ›å»ºäº†ä¸¤ç§ä¸åŒçš„å˜æ¢ï¼šä¸€ç§ç”¨äºŽä¼˜åŠ¿ï¼Œå¦ä¸€ç§ç”¨äºŽä»·å€¼é¢„æµ‹ï¼š

```py
 size = self.conv(torch.zeros(1, *input_shape)).size()[-1] 
        self.fc_adv = nn.Sequential( 
            nn.Linear(size, 256), 
            nn.ReLU(), 
            nn.Linear(256, n_actions) 
        ) 
        self.fc_val = nn.Sequential( 
            nn.Linear(size, 256), 
            nn.ReLU(), 
            nn.Linear(256, 1) 
        )
```

æ­¤å¤–ï¼Œä¸ºäº†ä¿æŒæ¨¡åž‹ä¸­çš„å‚æ•°æ•°é‡ä¸ŽåŽŸå§‹ç½‘ç»œç›¸å½“ï¼Œä¸¤æ¡è·¯å¾„ä¸­çš„å†…éƒ¨ç»´åº¦ä»Ž 512 å‡å°‘åˆ° 256ã€‚å¾—ç›ŠäºŽ PyTorch çš„è¡¨è¾¾èƒ½åŠ›ï¼Œforward()å‡½æ•°ä¸­çš„å˜åŒ–ä¹Ÿéžå¸¸ç®€å•ï¼š

```py
 def forward(self, x: torch.ByteTensor): 
        adv, val = self.adv_val(x) 
        return val + (adv - adv.mean(dim=1, keepdim=True)) 

    def adv_val(self, x: torch.ByteTensor): 
        xx = x / 255.0 
        conv_out = self.conv(xx) 
        return self.fc_adv(conv_out), self.fc_val(conv_out)
```

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬è®¡ç®—æ‰¹æ¬¡æ ·æœ¬çš„ä»·å€¼å’Œä¼˜åŠ¿å¹¶å°†å®ƒä»¬åŠ åœ¨ä¸€èµ·ï¼Œå‡åŽ»ä¼˜åŠ¿çš„å‡å€¼ä»¥èŽ·å¾—æœ€ç»ˆçš„ Q å€¼ã€‚ä¸€ä¸ªå¾®å¦™ä½†é‡è¦çš„åŒºåˆ«æ˜¯åœ¨è®¡ç®—å¼ é‡çš„ç¬¬äºŒç»´åº¦ä¸Šçš„å‡å€¼ï¼Œè¿™ä¼šä¸ºæˆ‘ä»¬æ‰¹æ¬¡ä¸­çš„æ¯ä¸ªæ ·æœ¬ç”Ÿæˆä¸€ä¸ªå‡å€¼ä¼˜åŠ¿çš„å‘é‡ã€‚

## ç»“æžœ

è®­ç»ƒä¸€ä¸ªå¯¹æŠ— DQN åŽï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶ä¸Žç»å…¸ DQN åœ¨ Pong åŸºå‡†æµ‹è¯•ä¸­çš„æ”¶æ•›æ€§è¿›è¡Œæ¯”è¾ƒã€‚ä¸ŽåŸºç¡€ DQN ç‰ˆæœ¬ç›¸æ¯”ï¼Œå¯¹æŠ—æž¶æž„çš„æ”¶æ•›é€Ÿåº¦æ›´å¿«ï¼š

![å›¾ç‰‡](img/B22150_08_17.png)

å›¾ 8.17ï¼šå¯¹æŠ— DQN ä¸ŽåŸºçº¿ç‰ˆæœ¬çš„å¥–åŠ±åŠ¨æ€æ¯”è¾ƒ

æˆ‘ä»¬çš„ç¤ºä¾‹è¿˜è¾“å‡ºäº†å¯¹äºŽä¸€ç»„å›ºå®šçŠ¶æ€çš„ä¼˜åŠ¿å’Œä»·å€¼ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚å®ƒä»¬ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸï¼šä¼˜åŠ¿ä¸Žé›¶å·®å¼‚ä¸å¤§ï¼Œä½†éšç€æ—¶é—´æŽ¨ç§»ï¼Œä»·å€¼åœ¨ä¸æ–­æé«˜ï¼ˆå¹¶ä¸”ç±»ä¼¼äºŽ Double DQN éƒ¨åˆ†ä¸­çš„å€¼ï¼‰ï¼š

![å›¾ç‰‡](img/B22150_08_18.png)

å›¾ 8.18ï¼šå›ºå®šçŠ¶æ€é›†ä¸Šçš„å‡å€¼ä¼˜åŠ¿ï¼ˆå·¦ï¼‰å’Œä»·å€¼ï¼ˆå³ï¼‰

## è¶…å‚æ•°è°ƒæ•´

è¶…å‚æ•°çš„è°ƒæ•´å¹¶æœªå¸¦æ¥å¾ˆå¤§æ”¶èŽ·ã€‚åœ¨ 30 æ¬¡è°ƒæ•´è¿­ä»£åŽï¼Œæ²¡æœ‰ä»»ä½•å­¦ä¹ çŽ‡å’Œ gamma çš„ç»„åˆèƒ½å¤Ÿæ¯”å¸¸ç”¨å‚æ•°ç»„åˆæ›´å¿«æ”¶æ•›ã€‚

# ç±»åˆ«åŒ– DQN

æˆ‘ä»¬çš„ DQN æ”¹è¿›å·¥å…·ç®±ä¸­çš„æœ€åŽä¸€ç§æ–¹æ³•ï¼Œä¹Ÿæ˜¯æœ€å¤æ‚çš„ä¸€ç§ï¼Œæ¥è‡ª DeepMind äºŽ 2017 å¹´ 6 æœˆå‘è¡¨çš„è®ºæ–‡ã€Šå¼ºåŒ–å­¦ä¹ çš„åˆ†å¸ƒå¼è§†è§’ã€‹[BDM17]ã€‚å°½ç®¡è¿™ç¯‡è®ºæ–‡å·²ç»æœ‰å‡ å¹´åŽ†å²ï¼Œä½†å®ƒä»ç„¶éžå¸¸ç›¸å…³ï¼Œä¸”è¿™ä¸€é¢†åŸŸçš„ç ”ç©¶ä»åœ¨æŒç»­è¿›è¡Œä¸­ã€‚2023 å¹´å‡ºç‰ˆçš„ã€Šåˆ†å¸ƒå¼å¼ºåŒ–å­¦ä¹ ã€‹ä¸€ä¹¦ä¸­ï¼Œä½œè€…ä»¬æ›´è¯¦ç»†åœ°æè¿°äº†è¯¥æ–¹æ³•[BDR23]ã€‚

åœ¨è®ºæ–‡ä¸­ï¼Œä½œè€…è´¨ç–‘äº† Q å­¦ä¹ ä¸­çš„åŸºæœ¬å…ƒç´ â€”â€”Q å€¼â€”â€”å¹¶å°è¯•ç”¨æ›´é€šç”¨çš„ Q å€¼æ¦‚çŽ‡åˆ†å¸ƒæ¥æ›¿ä»£å®ƒä»¬ã€‚è®©æˆ‘ä»¬æ¥ç†è§£è¿™ä¸ªæ¦‚å¿µã€‚Q å­¦ä¹ å’Œä»·å€¼è¿­ä»£æ–¹æ³•éƒ½ä½¿ç”¨è¡¨ç¤ºåŠ¨ä½œæˆ–çŠ¶æ€çš„æ•°å€¼ï¼Œå±•ç¤ºä»ŽæŸä¸ªçŠ¶æ€æˆ–æŸä¸ªåŠ¨ä½œå’ŒçŠ¶æ€ç»„åˆä¸­èƒ½å¤ŸèŽ·å¾—å¤šå°‘æ€»å¥–åŠ±ã€‚ç„¶è€Œï¼Œå°†æ‰€æœ‰æœªæ¥å¯èƒ½çš„å¥–åŠ±åŽ‹ç¼©æˆä¸€ä¸ªæ•°å­—ï¼Œå®žé™…å¯è¡Œå—ï¼Ÿåœ¨å¤æ‚çš„çŽ¯å¢ƒä¸­ï¼Œæœªæ¥å¯èƒ½æ˜¯éšæœºçš„ï¼Œä¼šç»™æˆ‘ä»¬å¸¦æ¥ä¸åŒçš„å€¼å’Œä¸åŒçš„æ¦‚çŽ‡ã€‚

æ¯”å¦‚ï¼Œæƒ³è±¡ä¸€ä¸‹ä½ æ¯å¤©ä»Žå®¶é‡Œå¼€è½¦åŽ»ä¸Šç­çš„é€šå‹¤æƒ…å¢ƒã€‚å¤§å¤šæ•°æ—¶å€™ï¼Œäº¤é€šä¸ç®—å¤ªå µï¼Œé€šå¸¸ä½ èƒ½åœ¨å¤§çº¦ 30 åˆ†é’Ÿå†…åˆ°è¾¾ç›®çš„åœ°ã€‚è¿™å¹¶ä¸ä¸€å®šæ˜¯å‡†ç¡®çš„ 30 åˆ†é’Ÿï¼Œä½†å¹³å‡ä¸‹æ¥æ˜¯ 30 åˆ†é’Ÿã€‚å¶å°”ï¼Œä¹Ÿä¼šå‘ç”Ÿä¸€äº›æƒ…å†µï¼Œæ¯”å¦‚é“è·¯ç»´ä¿®æˆ–äº‹æ•…ï¼Œå¯¼è‡´äº¤é€šå µå¡žï¼Œä½ çš„é€šå‹¤æ—¶é—´å¯èƒ½æ˜¯å¹³å¸¸çš„ä¸‰å€ã€‚ä½ çš„é€šå‹¤æ—¶é—´çš„æ¦‚çŽ‡å¯ä»¥ç”¨â€œé€šå‹¤æ—¶é—´â€è¿™ä¸€éšæœºå˜é‡çš„åˆ†å¸ƒæ¥è¡¨ç¤ºï¼Œåˆ†å¸ƒå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![PIC](img/B22150_08_19.png)

å›¾ 8.19ï¼šé€šå‹¤æ—¶é—´çš„æ¦‚çŽ‡åˆ†å¸ƒ

çŽ°åœ¨ï¼Œå‡è®¾ä½ æœ‰å¦ä¸€ç§ä¸Šç­çš„æ–¹å¼ï¼šåç«è½¦ã€‚è™½ç„¶éœ€è¦ç¨å¾®å¤šèŠ±ç‚¹æ—¶é—´ï¼Œå› ä¸ºä½ éœ€è¦ä»Žå®¶é‡Œåˆ°ç«è½¦ç«™ï¼Œå†ä»Žç«è½¦ç«™åˆ°åŠžå…¬å®¤ï¼Œä½†ç›¸æ¯”å¼€è½¦ï¼Œç«è½¦æ›´å¯é ï¼ˆåœ¨ä¸€äº›å›½å®¶ï¼Œå¦‚å¾·å›½ï¼Œæƒ…å†µå¯èƒ½ä¸åŒï¼Œä½†æˆ‘ä»¬å‡è®¾ä½¿ç”¨ç‘žå£«çš„ç«è½¦ä½œä¸ºä¾‹å­ï¼‰ã€‚æ¯”å¦‚è¯´ï¼Œç«è½¦çš„é€šå‹¤æ—¶é—´å¹³å‡æ˜¯ 40 åˆ†é’Ÿï¼Œå¶å°”ä¼šæœ‰ç«è½¦å»¶è¯¯çš„æƒ…å†µï¼Œé€šå¸¸ä¼šå¢žåŠ  20 åˆ†é’Ÿçš„é¢å¤–æ—¶é—´ã€‚ç«è½¦é€šå‹¤æ—¶é—´çš„åˆ†å¸ƒå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![PIC](img/B22150_08_20.png)

å›¾ 8.20ï¼šå¼€è½¦é€šå‹¤æ—¶é—´çš„æ¦‚çŽ‡åˆ†å¸ƒ

å‡è®¾çŽ°åœ¨æˆ‘ä»¬è¦åšå‡ºé€šå‹¤æ–¹å¼çš„é€‰æ‹©ã€‚å¦‚æžœæˆ‘ä»¬åªçŸ¥é“å¼€è½¦å’Œç«è½¦çš„å¹³å‡é€šå‹¤æ—¶é—´ï¼Œé‚£ä¹ˆå¼€è½¦çœ‹èµ·æ¥æ›´æœ‰å¸å¼•åŠ›ï¼Œå› ä¸ºå¼€è½¦çš„å¹³å‡é€šå‹¤æ—¶é—´æ˜¯ 35.43 åˆ†é’Ÿï¼Œæ¯”ç«è½¦çš„ 40.54 åˆ†é’Ÿè¦çŸ­ã€‚

ç„¶è€Œï¼Œå¦‚æžœæˆ‘ä»¬çœ‹å®Œæ•´çš„åˆ†å¸ƒå›¾ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šé€‰æ‹©åç«è½¦ï¼Œå› ä¸ºå³ä½¿åœ¨æœ€åçš„æƒ…å†µä¸‹ï¼Œç«è½¦çš„é€šå‹¤æ—¶é—´ä¹Ÿåªæœ‰ä¸€ä¸ªå°æ—¶ï¼Œè€Œå¼€è½¦åˆ™æ˜¯ä¸€ä¸ªå°æ—¶ 30 åˆ†é’Ÿã€‚æ¢æˆç»Ÿè®¡è¯­è¨€ï¼Œå¼€è½¦çš„åˆ†å¸ƒå…·æœ‰æ›´é«˜çš„æ–¹å·®ï¼Œå› æ­¤åœ¨ä½ å¿…é¡»åœ¨ 60 åˆ†é’Ÿå†…åˆ°è¾¾åŠžå…¬å®¤çš„æƒ…å†µä¸‹ï¼Œç«è½¦æ›´ä¸ºåˆé€‚ã€‚

åœ¨é©¬å°”å¯å¤«å†³ç­–è¿‡ç¨‹ï¼ˆMDPï¼‰åœºæ™¯ä¸­ï¼Œæƒ…å†µå˜å¾—æ›´åŠ å¤æ‚ï¼Œå› ä¸ºå†³ç­–éœ€è¦æŒ‰é¡ºåºè¿›è¡Œï¼Œè€Œä¸”æ¯ä¸ªå†³ç­–å¯èƒ½ä¼šå½±å“æœªæ¥çš„æƒ…å†µã€‚æ¯”å¦‚åœ¨é€šå‹¤ä¾‹å­ä¸­ï¼Œå¯èƒ½æ˜¯ä½ éœ€è¦å®‰æŽ’ä¸€ä¸ªé‡è¦ä¼šè®®çš„æ—¶é—´ï¼Œè€Œè¿™ä¸ªå®‰æŽ’å¯èƒ½ä¼šå—åˆ°ä½ é€‰æ‹©çš„é€šå‹¤æ–¹å¼çš„å½±å“ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½¿ç”¨å‡å€¼å¥–åŠ±å€¼å¯èƒ½ä¼šä¸§å¤±å…³äºŽçŽ¯å¢ƒåŠ¨æ€çš„å¾ˆå¤šä¿¡æ¯ã€‚

å®Œå…¨ç›¸åŒçš„è§‚ç‚¹æ˜¯ç”±ã€Šå¼ºåŒ–å­¦ä¹ çš„åˆ†å¸ƒå¼è§†è§’ã€‹ä¸€æ–‡çš„ä½œè€…æå‡ºçš„[9]ã€‚ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦é™åˆ¶è‡ªå·±ï¼Œè¯•å›¾ä¸ºä¸€ä¸ªåŠ¨ä½œé¢„æµ‹ä¸€ä¸ªå¹³å‡å€¼ï¼Œè€Œå¿½ç•¥äº†å…¶æ½œåœ¨å€¼å¯èƒ½å…·æœ‰å¤æ‚çš„åˆ†å¸ƒï¼Ÿä¹Ÿè®¸ç›´æŽ¥å¤„ç†åˆ†å¸ƒä¼šå¯¹æˆ‘ä»¬æœ‰æ‰€å¸®åŠ©ã€‚è®ºæ–‡ä¸­å±•ç¤ºçš„ç»“æžœè¡¨æ˜Žï¼Œäº‹å®žä¸Šï¼Œè¿™ä¸ªæƒ³æ³•å¯èƒ½æ˜¯æœ‰å¸®åŠ©çš„ï¼Œä½†ä»£ä»·æ˜¯å¼•å…¥äº†æ›´å¤æ‚çš„æ–¹æ³•ã€‚æˆ‘åœ¨è¿™é‡Œä¸ä¼šç»™å‡ºä¸¥æ ¼çš„æ•°å­¦å®šä¹‰ï¼Œä½†æ€»ä½“æ€è·¯æ˜¯ä¸ºæ¯ä¸ªåŠ¨ä½œé¢„æµ‹å€¼çš„åˆ†å¸ƒï¼Œç±»ä¼¼äºŽæˆ‘ä»¬æ±½è½¦/ç«è½¦ä¾‹å­ä¸­çš„åˆ†å¸ƒã€‚ä½œä¸ºä¸‹ä¸€æ­¥ï¼Œä½œè€…ä»¬å±•ç¤ºäº†è´å°”æ›¼æ–¹ç¨‹å¯ä»¥æŽ¨å¹¿åˆ°åˆ†å¸ƒçš„æƒ…å†µï¼Œå¹¶ä¸”å®ƒçš„å½¢å¼ä¸º Z(x,a)![D =](img/eq37.png)R(x,a) + Î³Z(xâ€²,aâ€²)ï¼Œè¿™ä¸Žæˆ‘ä»¬ç†Ÿæ‚‰çš„è´å°”æ›¼æ–¹ç¨‹éžå¸¸ç›¸ä¼¼ï¼Œä½†çŽ°åœ¨ Z(x,a)å’Œ R(x,a)æ˜¯æ¦‚çŽ‡åˆ†å¸ƒï¼Œè€Œä¸æ˜¯å•ä¸€æ•°å€¼ã€‚ç¬¦å· A![ D =](img/eq37.png)B è¡¨ç¤ºåˆ†å¸ƒ A å’Œ B çš„ç›¸ç­‰ã€‚

å¾—åˆ°çš„åˆ†å¸ƒå¯ä»¥ç”¨æ¥è®­ç»ƒæˆ‘ä»¬çš„ç½‘ç»œï¼Œä»¥ä¾¿ä¸ºç»™å®šçŠ¶æ€ä¸‹çš„æ¯ä¸ªåŠ¨ä½œæä¾›æ›´å¥½çš„å€¼åˆ†å¸ƒé¢„æµ‹ï¼Œæ–¹æ³•ä¸Ž Q å­¦ä¹ å®Œå…¨ç›¸åŒã€‚å”¯ä¸€çš„åŒºåˆ«åœ¨äºŽæŸå¤±å‡½æ•°ï¼ŒçŽ°åœ¨å¿…é¡»ç”¨é€‚åˆåˆ†å¸ƒæ¯”è¾ƒçš„å†…å®¹æ›¿ä»£å®ƒã€‚è¿™é‡Œæœ‰å‡ ä¸ªå¯ç”¨çš„æ›¿ä»£æ–¹æ³•ï¼Œä¾‹å¦‚ï¼ŒKullback-Leiblerï¼ˆKLï¼‰æ•£åº¦ï¼ˆæˆ–äº¤å‰ç†µæŸå¤±ï¼‰ï¼Œå®ƒé€šå¸¸ç”¨äºŽåˆ†ç±»é—®é¢˜ï¼Œæˆ–è€… Wasserstein åº¦é‡ã€‚åœ¨è®ºæ–‡ä¸­ï¼Œä½œè€…ä¸º Wasserstein åº¦é‡æä¾›äº†ç†è®ºä¾æ®ï¼Œä½†åœ¨å®žè·µä¸­å°è¯•åº”ç”¨æ—¶ï¼Œé‡åˆ°äº†ä¸€äº›é™åˆ¶ã€‚æ‰€ä»¥ï¼Œæœ€ç»ˆè®ºæ–‡ä¸­ä½¿ç”¨äº† KL æ•£åº¦ã€‚

## å®žçŽ°

å¦‚å‰æ‰€è¿°ï¼Œè¿™ä¸ªæ–¹æ³•ç›¸å½“å¤æ‚ï¼Œæ‰€ä»¥æˆ‘èŠ±äº†ä¸€äº›æ—¶é—´æ¥å®žçŽ°å®ƒå¹¶ç¡®ä¿å…¶æ­£å¸¸å·¥ä½œã€‚å®Œæ•´ä»£ç åœ¨ Chapter08/07_dqn_distrib.py ä¸­ï¼Œå…¶ä¸­ä½¿ç”¨äº† lib/dqn_extra.py ä¸­çš„ distr_projection å‡½æ•°æ¥æ‰§è¡Œåˆ†å¸ƒæŠ•å½±ã€‚åœ¨æ£€æŸ¥ä¹‹å‰ï¼Œæˆ‘éœ€è¦å…ˆç®€å•è¯´æ˜Žä¸€ä¸‹å®žçŽ°é€»è¾‘ã€‚

æ–¹æ³•çš„æ ¸å¿ƒéƒ¨åˆ†æ˜¯æˆ‘ä»¬æ­£åœ¨é€¼è¿‘çš„æ¦‚çŽ‡åˆ†å¸ƒã€‚æœ‰å¾ˆå¤šæ–¹æ³•å¯ä»¥è¡¨ç¤ºè¿™ä¸ªåˆ†å¸ƒï¼Œä½†è®ºæ–‡çš„ä½œè€…é€‰æ‹©äº†ä¸€ä¸ªç›¸å½“é€šç”¨çš„å‚æ•°åŒ–åˆ†å¸ƒï¼ŒåŸºæœ¬ä¸Šæ˜¯å°†ä¸€ç»„å›ºå®šæ•°å€¼å‡åŒ€åˆ†å¸ƒåœ¨ä¸€ä¸ªæ•°å€¼èŒƒå›´ä¸Šã€‚è¿™ä¸ªæ•°å€¼èŒƒå›´åº”è¯¥è¦†ç›–å¯èƒ½çš„ç´¯è®¡æŠ˜æ‰£å¥–åŠ±èŒƒå›´ã€‚åœ¨è®ºæ–‡ä¸­ï¼Œä½œè€…åšäº†å¤šä¸ªä¸åŒæ•°é‡çš„åŽŸå­å®žéªŒï¼Œä½†æœ€ä½³ç»“æžœæ˜¯åœ¨å€¼çš„èŒƒå›´ä»Ž Vmin=-10 åˆ° Vmax=10 ä¸­å°†èŒƒå›´åˆ’åˆ†ä¸º N_ATOMS=51 ä¸ªåŒºé—´æ—¶èŽ·å¾—çš„ã€‚

å¯¹äºŽæ¯ä¸ªåŽŸå­ï¼ˆæˆ‘ä»¬æœ‰ 51 ä¸ªï¼‰ï¼Œæˆ‘ä»¬çš„ç½‘ç»œé¢„æµ‹æœªæ¥æŠ˜æ‰£å€¼è½åœ¨æ­¤åŽŸå­èŒƒå›´å†…çš„æ¦‚çŽ‡ã€‚æ–¹æ³•çš„æ ¸å¿ƒéƒ¨åˆ†æ˜¯ä»£ç ï¼Œå®ƒæ‰§è¡Œä¸‹ä¸€ä¸ªçŠ¶æ€æœ€ä½³åŠ¨ä½œçš„åˆ†å¸ƒæ”¶ç¼©ï¼Œä½¿ç”¨ gammaï¼Œå‘åˆ†å¸ƒä¸­æ·»åŠ å±€éƒ¨å¥–åŠ±ï¼Œå¹¶å°†ç»“æžœæŠ•å½±å›žåˆ°åŽŸå§‹åŽŸå­ä¸­ã€‚è¿™ä¸ªé€»è¾‘åœ¨ dqn_extra.distr_projection å‡½æ•°ä¸­å®žçŽ°ã€‚ä¸€å¼€å§‹ï¼Œæˆ‘ä»¬åˆ†é…äº†ä¸€ä¸ªæ•°ç»„æ¥ä¿å­˜æŠ•å½±ç»“æžœï¼š

```py
def distr_projection(next_distr: np.ndarray, rewards: np.ndarray, 
                     dones: np.ndarray, gamma: float): 
    batch_size = len(rewards) 
    proj_distr = np.zeros((batch_size, N_ATOMS), dtype=np.float32) 
    delta_z = (Vmax - Vmin) / (N_ATOMS - 1)
```

è¿™ä¸ªå‡½æ•°æŽ¥å—å½¢çŠ¶ä¸º(batch_size, N_ATOMS)çš„åˆ†å¸ƒæ‰¹æ¬¡ï¼Œå¥–åŠ±æ•°ç»„ï¼Œå·²å®Œæˆå›žåˆçš„æ ‡å¿—ä»¥åŠæˆ‘ä»¬çš„è¶…å‚æ•°ï¼šVmin, Vmax, N_ATOMS å’Œ gammaã€‚delta_z å˜é‡è¡¨ç¤ºæˆ‘ä»¬å€¼èŒƒå›´ä¸­æ¯ä¸ªåŽŸå­çš„å®½åº¦ã€‚

åœ¨ä»¥ä¸‹ä»£ç ä¸­ï¼Œæˆ‘ä»¬éåŽ†åŽŸå§‹åˆ†å¸ƒä¸­çš„æ¯ä¸ªåŽŸå­ï¼Œå¹¶è®¡ç®—è¯¥åŽŸå­å°†ç”± Bellman æ“ä½œç¬¦æŠ•å½±åˆ°çš„ä½ç½®ï¼ŒåŒæ—¶è€ƒè™‘æˆ‘ä»¬çš„å€¼èŒƒå›´ï¼š

```py
 for atom in range(N_ATOMS): 
        v = rewards + (Vmin + atom * delta_z) * gamma 
        tz_j = np.minimum(Vmax, np.maximum(Vmin, v))
```

ä¾‹å¦‚ï¼Œç¬¬ä¸€ä¸ªåŽŸå­ï¼Œç´¢å¼•ä¸º 0ï¼Œå¯¹åº”çš„å€¼ä¸º Vmin=-10ï¼Œä½†å¯¹äºŽå¥–åŠ± +1 çš„æ ·æœ¬ï¼Œå°†æŠ•å½±åˆ°å€¼ âˆ’10 â‹… 0.99 + 1 = âˆ’8.9ã€‚æ¢å¥è¯è¯´ï¼Œå®ƒå°†å‘å³ç§»åŠ¨ï¼ˆå‡è®¾ gamma=0.99ï¼‰ã€‚å¦‚æžœè¯¥å€¼è¶…å‡ºäº†ç”± Vmin å’Œ Vmax ç»™å‡ºçš„å€¼èŒƒå›´ï¼Œæˆ‘ä»¬ä¼šå°†å…¶è£å‰ªåˆ°è¾¹ç•Œå†…ã€‚

åœ¨ä¸‹ä¸€è¡Œï¼Œæˆ‘ä»¬è®¡ç®—æ ·æœ¬æŠ•å½±åˆ°çš„åŽŸå­ç¼–å·ï¼š

```py
 b_j = (tz_j - Vmin) / delta_z
```

å½“ç„¶ï¼Œæ ·æœ¬å¯ä»¥æŠ•å½±åˆ°åŽŸå­ä¹‹é—´ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†æºåŽŸå­ä¸­çš„å€¼åˆ†é…åˆ°å…¶ä¹‹é—´çš„ä¸¤ä¸ªåŽŸå­ä¸­ã€‚è¿™ä¸ªåˆ†é…éœ€è¦å°å¿ƒå¤„ç†ï¼Œå› ä¸ºç›®æ ‡åŽŸå­å¯èƒ½æ°å¥½è½åœ¨æŸä¸ªåŽŸå­çš„ä½ç½®ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åªéœ€è¦å°†æºåˆ†å¸ƒå€¼æ·»åŠ åˆ°ç›®æ ‡åŽŸå­ã€‚

ä»¥ä¸‹ä»£ç å¤„ç†å½“æŠ•å½±åŽŸå­æ­£å¥½è½åœ¨ç›®æ ‡åŽŸå­ä¸Šçš„æƒ…å†µã€‚å¦åˆ™ï¼Œb_j å°†ä¸æ˜¯æ•´æ•°å€¼ï¼Œå˜é‡ l å’Œ uï¼ˆåˆ†åˆ«å¯¹åº”æŠ•å½±ç‚¹ä¸‹æ–¹å’Œä¸Šæ–¹çš„åŽŸå­ç´¢å¼•ï¼‰ï¼š

```py
 l = np.floor(b_j).astype(np.int64) 
        u = np.ceil(b_j).astype(np.int64) 
        eq_mask = u == l 
        proj_distr[eq_mask, l[eq_mask]] += next_distr[eq_mask, atom]
```

å½“æŠ•å½±ç‚¹è½åœ¨åŽŸå­ä¹‹é—´æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å°†æºåŽŸå­çš„æ¦‚çŽ‡åˆ†é…åˆ°ä¸‹æ–¹å’Œä¸Šæ–¹çš„åŽŸå­ä¹‹é—´ã€‚è¿™é€šè¿‡ä»¥ä¸‹ä»£ç ä¸­çš„ä¸¤è¡Œæ¥å®žçŽ°ï¼š

```py
 ne_mask = u != l 
        proj_distr[ne_mask, l[ne_mask]] += next_distr[ne_mask, atom] * (u - b_j)[ne_mask] 
        proj_distr[ne_mask, u[ne_mask]] += next_distr[ne_mask, atom] * (b_j - l)[ne_mask]
```

å½“ç„¶ï¼Œæˆ‘ä»¬éœ€è¦æ­£ç¡®å¤„ç†å›žåˆçš„æœ€ç»ˆè¿‡æ¸¡ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„æŠ•å½±ä¸åº”è€ƒè™‘ä¸‹ä¸€ä¸ªåˆ†å¸ƒï¼Œè€Œåº”ä»…å…·æœ‰ä¸ŽèŽ·å¾—çš„å¥–åŠ±å¯¹åº”çš„ 1 çš„æ¦‚çŽ‡ã€‚

ç„¶è€Œï¼Œæˆ‘ä»¬éœ€è¦å†æ¬¡è€ƒè™‘åŽŸå­ï¼Œå¹¶åœ¨å¥–åŠ±å€¼è½åœ¨åŽŸå­ä¹‹é—´æ—¶ï¼Œæ­£ç¡®åœ°åˆ†é…æ¦‚çŽ‡ã€‚æ­¤æƒ…å†µç”±ä»¥ä¸‹ä»£ç åˆ†æ”¯å¤„ç†ï¼Œè¯¥åˆ†æ”¯ä¼šä¸ºå·²è®¾ç½®â€œdoneâ€æ ‡å¿—çš„æ ·æœ¬å°†ç»“æžœåˆ†å¸ƒå½’é›¶ï¼Œç„¶åŽè®¡ç®—æœ€ç»ˆçš„æŠ•å½±ç»“æžœï¼š

```py
 if dones.any(): 
        proj_distr[dones] = 0.0 
        tz_j = np.minimum(Vmax, np.maximum(Vmin, rewards[dones])) 
        b_j = (tz_j - Vmin) / delta_z 
        l = np.floor(b_j).astype(np.int64) 
        u = np.ceil(b_j).astype(np.int64) 
        eq_mask = u == l 
        eq_dones = dones.copy() 
        eq_dones[dones] = eq_mask 
        if eq_dones.any(): 
            proj_distr[eq_dones, l[eq_mask]] = 1.0 
        ne_mask = u != l 
        ne_dones = dones.copy() 
        ne_dones[dones] = ne_mask 
        if ne_dones.any(): 
            proj_distr[ne_dones, l[ne_mask]] = (u - b_j)[ne_mask] 
            proj_distr[ne_dones, u[ne_mask]] = (b_j - l)[ne_mask] 
    return proj_distr
```

ä¸ºäº†ç»™ä½ æ¼”ç¤ºè¿™ä¸ªå‡½æ•°çš„ä½œç”¨ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹é€šè¿‡è¯¥å‡½æ•°å¤„ç†çš„äººå·¥åˆ¶ä½œçš„åˆ†å¸ƒå›¾ï¼ˆå›¾è¡¨ 8.21ï¼‰ã€‚æˆ‘ç”¨å®ƒä»¬æ¥è°ƒè¯•å‡½æ•°å¹¶ç¡®ä¿å…¶æŒ‰é¢„æœŸå·¥ä½œã€‚è¿™äº›æ£€æŸ¥çš„ä»£ç åœ¨ Chapter08/adhoc/distr_test.py ä¸­ã€‚

![PIC](img/B22150_08_21.png)

å›¾è¡¨ 8.21ï¼šåº”ç”¨äºŽæ­£æ€åˆ†å¸ƒçš„æ¦‚çŽ‡åˆ†å¸ƒå˜æ¢çš„æ ·æœ¬

å›¾è¡¨é¡¶éƒ¨çš„ 8.21ï¼ˆåä¸ºæºï¼‰æ˜¯ä¸€ä¸ªæ­£æ€åˆ†å¸ƒï¼Œå…¶ä¸­Î¼ = 0ï¼ŒÏƒ = 3ã€‚ç¬¬äºŒå¼ å›¾ï¼ˆåä¸ºæŠ•å½±ï¼‰æ˜¯ä»Žåˆ†å¸ƒæŠ•å½±å¾—åˆ°çš„ï¼ŒÎ³ = 0.9ï¼Œå¹¶ä¸”å‘å³åç§»ï¼Œreward=2ã€‚

åœ¨æˆ‘ä»¬ä¼ é€’ done=True çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ç›¸åŒæ•°æ®ï¼Œç»“æžœå°†ä¼šæœ‰æ‰€ä¸åŒï¼Œå¹¶æ˜¾ç¤ºåœ¨å›¾è¡¨ 8.22 ä¸­ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæºåˆ†å¸ƒå°†è¢«å®Œå…¨å¿½ç•¥ï¼Œç»“æžœå°†åªæœ‰é¢„æœŸå¥–åŠ±ã€‚

![PIC](img/B22150_08_22.png)

å›¾è¡¨ 8.22ï¼šåœ¨å‰§é›†æœ€åŽä¸€æ­¥çš„åˆ†å¸ƒæŠ•å½±

è¯¥æ–¹æ³•çš„å®žçŽ°ä½äºŽ Chapter08/07_dqn_distrib.py ä¸­ï¼Œå®ƒå…·æœ‰ä¸€ä¸ªå¯é€‰çš„å‘½ä»¤è¡Œå‚æ•°--img-pathã€‚å¦‚æžœç»™å‡ºæ­¤é€‰é¡¹ï¼Œå®ƒå¿…é¡»æ˜¯ä¸€ä¸ªç›®å½•ï¼Œåœ¨è®­ç»ƒæœŸé—´å°†ä»¥å›ºå®šçŠ¶æ€çš„æ¦‚çŽ‡åˆ†å¸ƒå­˜å‚¨å›¾åƒã€‚è¿™å¯¹äºŽç›‘è§†æ¨¡åž‹å¦‚ä½•ä»Žå¼€å§‹çš„å‡åŒ€æ¦‚çŽ‡æ”¶æ•›åˆ°æ›´å¤šå°–å³°æ¦‚çŽ‡è´¨é‡å¾ˆæœ‰ç”¨ã€‚æˆ‘çš„å®žéªŒä¸­çš„ç¤ºä¾‹å›¾åƒæ˜¾ç¤ºåœ¨å›¾è¡¨ 8.24 å’Œå›¾è¡¨ 8.25 ä¸­ã€‚

æˆ‘è¿™é‡Œåªå±•ç¤ºå®žçŽ°çš„åŸºæœ¬éƒ¨åˆ†ã€‚æ–¹æ³•çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œdistr_projection å‡½æ•°å·²ç»è¦†ç›–è¿‡äº†ï¼Œå®ƒæ˜¯æœ€å¤æ‚çš„éƒ¨åˆ†ã€‚çŽ°åœ¨ç¼ºå¤±çš„æ˜¯ç½‘ç»œæž¶æž„å’Œä¿®æ”¹çš„æŸå¤±å‡½æ•°ï¼Œæˆ‘ä»¬å°†åœ¨è¿™é‡Œæè¿°å®ƒä»¬ã€‚

è®©æˆ‘ä»¬ä»Žç½‘ç»œå¼€å§‹ï¼Œè¯¥ç½‘ç»œä½äºŽ lib/dqn_extra.py ä¸­ï¼Œåœ¨ DistributionalDQN ç±»ä¸­ï¼š

```py
Vmax = 10 
Vmin = -10 
N_ATOMS = 51 
DELTA_Z = (Vmax - Vmin) / (N_ATOMS - 1) 

class DistributionalDQN(nn.Module): 
    def __init__(self, input_shape: tt.Tuple[int, ...], n_actions: int): 
        super(DistributionalDQN, self).__init__() 

        self.conv = nn.Sequential( 
            nn.Conv2d(input_shape[0], 32, kernel_size=8, stride=4), 
            nn.ReLU(), 
            nn.Conv2d(32, 64, kernel_size=4, stride=2), 
            nn.ReLU(), 
            nn.Conv2d(64, 64, kernel_size=3, stride=1), 
            nn.ReLU(), 
            nn.Flatten() 
        ) 
        size = self.conv(torch.zeros(1, *input_shape)).size()[-1] 
        self.fc = nn.Sequential( 
            nn.Linear(size, 512), 
            nn.ReLU(), 
            nn.Linear(512, n_actions * N_ATOMS) 
        ) 

        sups = torch.arange(Vmin, Vmax + DELTA_Z, DELTA_Z) 
        self.register_buffer("supports", sups) 
        self.softmax = nn.Softmax(dim=1)
```

ä¸»è¦åŒºåˆ«åœ¨äºŽå…¨è¿žæŽ¥å±‚çš„è¾“å‡ºã€‚çŽ°åœ¨å®ƒè¾“å‡º n_actions * N_ATOMS å€¼çš„å‘é‡ï¼Œå³ 6Ã—51 = 306 å¯¹äºŽ Pongã€‚å¯¹äºŽæ¯ä¸ªåŠ¨ä½œï¼Œå®ƒéœ€è¦é¢„æµ‹ 51 ä¸ªåŽŸå­ä¸Šçš„æ¦‚çŽ‡åˆ†å¸ƒã€‚æ¯ä¸ªåŽŸå­ï¼ˆç§°ä¸ºæ”¯æŒï¼‰å…·æœ‰ä¸€ä¸ªå€¼ï¼Œè¯¥å€¼å¯¹åº”äºŽç‰¹å®šçš„å¥–åŠ±ã€‚è¿™äº›åŽŸå­çš„å¥–åŠ±å‡åŒ€åˆ†å¸ƒåœ¨-10 åˆ° 10 ä¹‹é—´ï¼Œè¿™ç»™å‡ºäº†æ­¥é•¿ä¸º 0.4 çš„ç½‘æ ¼ã€‚è¿™äº›æ”¯æŒå­˜å‚¨åœ¨ç½‘ç»œçš„ç¼“å†²åŒºä¸­ã€‚

forward()æ–¹æ³•å°†é¢„æµ‹çš„æ¦‚çŽ‡åˆ†å¸ƒä½œä¸º 3D å¼ é‡ï¼ˆæ‰¹æ¬¡ï¼ŒåŠ¨ä½œå’Œæ”¯æŒï¼‰è¿”å›žï¼š

```py
 def forward(self, x: torch.ByteTensor) -> torch.Tensor: 
        batch_size = x.size()[0] 
        xx = x / 255 
        fc_out = self.fc(self.conv(xx)) 
        return fc_out.view(batch_size, -1, N_ATOMS) 

    def both(self, x: torch.ByteTensor) -> tt.Tuple[torch.Tensor, torch.Tensor]: 
        cat_out = self(x) 
        probs = self.apply_softmax(cat_out) 
        weights = probs * self.supports 
        res = weights.sum(dim=2) 
        return cat_out, res
```

é™¤äº† forward()ï¼Œæˆ‘ä»¬è¿˜å®šä¹‰äº† both()æ–¹æ³•ï¼Œå®ƒä¸€æ¬¡è®¡ç®—åŽŸå­å’Œ Q å€¼çš„æ¦‚çŽ‡åˆ†å¸ƒã€‚

ç½‘ç»œè¿˜å®šä¹‰äº†å‡ ä¸ªè¾…åŠ©å‡½æ•°ï¼Œä»¥ç®€åŒ– Q å€¼çš„è®¡ç®—å¹¶åœ¨æ¦‚çŽ‡åˆ†å¸ƒä¸Šåº”ç”¨ softmaxï¼š

```py
 def qvals(self, x: torch.ByteTensor) -> torch.Tensor: 
        return self.both(x)[1] 

    def apply_softmax(self, t: torch.Tensor) -> torch.Tensor: 
        return self.softmax(t.view(-1, N_ATOMS)).view(t.size())
```

æœ€åŽçš„å˜åŒ–æ˜¯æ–°çš„æŸå¤±å‡½æ•°ï¼Œå®ƒå¿…é¡»åº”ç”¨åˆ†å¸ƒæŠ•å½±ï¼Œè€Œä¸æ˜¯è´å°”æ›¼æ–¹ç¨‹ï¼Œå¹¶è®¡ç®—é¢„æµ‹åˆ†å¸ƒä¸ŽæŠ•å½±åˆ†å¸ƒä¹‹é—´çš„ KL æ•£åº¦ï¼š

```py
def calc_loss(batch: tt.List[ExperienceFirstLast], net: dqn_extra.DistributionalDQN, 
              tgt_net: dqn_extra.DistributionalDQN, gamma: float, 
              device: torch.device) -> torch.Tensor: 
    states, actions, rewards, dones, next_states = common.unpack_batch(batch) 
    batch_size = len(batch) 

    states_v = torch.as_tensor(states).to(device) 
    actions_v = torch.tensor(actions).to(device) 
    next_states_v = torch.as_tensor(next_states).to(device) 

    # next state distribution 
    next_distr_v, next_qvals_v = tgt_net.both(next_states_v) 
    next_acts = next_qvals_v.max(1)[1].data.cpu().numpy() 
    next_distr = tgt_net.apply_softmax(next_distr_v) 
    next_distr = next_distr.data.cpu().numpy() 

    next_best_distr = next_distr[range(batch_size), next_acts] 
    proj_distr = dqn_extra.distr_projection(next_best_distr, rewards, dones, gamma) 

    distr_v = net(states_v) 
    sa_vals = distr_v[range(batch_size), actions_v.data] 
    state_log_sm_v = F.log_softmax(sa_vals, dim=1) 
    proj_distr_v = torch.tensor(proj_distr).to(device) 

    loss_v = -state_log_sm_v * proj_distr_v 
    return loss_v.sum(dim=1).mean()
```

ä¸Šé¢çš„ä»£ç å¹¶ä¸å¤æ‚ï¼›å®ƒåªæ˜¯å‡†å¤‡è°ƒç”¨ distr_projection å’Œ KL æ•£åº¦ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š

![Ï€ (a |s) = P[At = a|St = s] ](img/eq38.png)

ä¸ºäº†è®¡ç®—æ¦‚çŽ‡çš„å¯¹æ•°ï¼Œæˆ‘ä»¬ä½¿ç”¨ PyTorch çš„ log_softmax å‡½æ•°ï¼Œå®ƒä»¥æ•°å€¼ç¨³å®šçš„æ–¹å¼å°†å¯¹æ•°å’Œ softmax ç»“åˆåœ¨ä¸€èµ·ã€‚

## ç»“æžœ

æ ¹æ®æˆ‘çš„å®žéªŒï¼Œåˆ†å¸ƒå¼ç‰ˆæœ¬çš„ DQN æ”¶æ•›é€Ÿåº¦ç¨æ…¢ä¸”ä¸å¤ªç¨³å®šï¼Œä½ŽäºŽåŽŸå§‹çš„ DQNï¼Œè¿™å¹¶ä¸ä»¤äººæƒŠè®¶ï¼Œå› ä¸ºç½‘ç»œè¾“å‡ºçŽ°åœ¨å¤§äº† 51 å€ï¼Œä¸”æŸå¤±å‡½æ•°å‘ç”Ÿäº†å˜åŒ–ã€‚å¦‚æžœæ²¡æœ‰è¿›è¡Œè¶…å‚æ•°è°ƒä¼˜ï¼ˆå°†åœ¨ä¸‹ä¸€å°èŠ‚ä¸­æè¿°ï¼‰ï¼Œåˆ†å¸ƒå¼ç‰ˆæœ¬éœ€è¦å¤š 20% çš„å›žåˆæ•°æ‰èƒ½è§£å†³æ¸¸æˆã€‚

å¦ä¸€ä¸ªå¯èƒ½é‡è¦çš„å› ç´ æ˜¯ï¼ŒPong æ¸¸æˆå¤ªç®€å•ï¼Œéš¾ä»¥å¾—å‡ºç»“è®ºã€‚åœ¨ã€ŠA Distributional Perspectiveã€‹ä¸€æ–‡ä¸­ï¼Œä½œè€…æŠ¥å‘Šäº†å½“æ—¶ï¼ˆ2017 å¹´å‡ºç‰ˆï¼‰å¤§éƒ¨åˆ† Atari åŸºå‡†æ¸¸æˆçš„æœ€å…ˆè¿›å¾—åˆ†ï¼ˆPong å¹¶ä¸åœ¨å…¶ä¸­ï¼‰ã€‚

ä»¥ä¸‹æ˜¯æ¯”è¾ƒåˆ†å¸ƒå¼ DQN å¥–åŠ±åŠ¨æ€å’ŒæŸå¤±çš„å›¾è¡¨ã€‚æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œåˆ†å¸ƒå¼æ–¹æ³•çš„å¥–åŠ±åŠ¨æ€æ¯”åŸºå‡† DQN å·®ï¼š

![å›¾ç‰‡](img/B22150_08_23.png)

å›¾ 8.23ï¼šå¥–åŠ±åŠ¨æ€ï¼ˆå·¦ï¼‰å’ŒæŸå¤±ä¸‹é™ï¼ˆå³ï¼‰

å¯èƒ½æœ‰è¶£çš„æ˜¯ï¼Œè§‚å¯Ÿè®­ç»ƒè¿‡ç¨‹ä¸­æ¦‚çŽ‡åˆ†å¸ƒçš„åŠ¨æ€ã€‚å¦‚æžœä½ ä½¿ç”¨`--img-path`å‚æ•°ï¼ˆæä¾›ç›®å½•åï¼‰å¼€å§‹è®­ç»ƒï¼Œè®­ç»ƒè¿‡ç¨‹å°†ä¼šä¿å­˜ä¸€ä¸ªå›ºå®šçŠ¶æ€é›†çš„æ¦‚çŽ‡åˆ†å¸ƒå›¾ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹å›¾ç¤ºå±•ç¤ºäº†è®­ç»ƒå¼€å§‹æ—¶ï¼ˆç»è¿‡ 30k å¸§ï¼‰ä¸€ä¸ªçŠ¶æ€ä¸‹æ‰€æœ‰å…­ä¸ªåŠ¨ä½œçš„æ¦‚çŽ‡åˆ†å¸ƒï¼š

![å›¾ç‰‡](img/file68.png)

å›¾ 8.24ï¼šè®­ç»ƒå¼€å§‹æ—¶çš„æ¦‚çŽ‡åˆ†å¸ƒ

æ‰€æœ‰çš„åˆ†å¸ƒéƒ½å¾ˆå®½ï¼ˆå› ä¸ºç½‘ç»œè¿˜æœªæ”¶æ•›ï¼‰ï¼Œä¸­é—´çš„å³°å€¼å¯¹åº”äºŽç½‘ç»œæœŸæœ›ä»Žå…¶åŠ¨ä½œä¸­èŽ·å¾—çš„è´Ÿå¥–åŠ±ã€‚ç»è¿‡ 500k å¸§è®­ç»ƒåŽçš„ç›¸åŒçŠ¶æ€å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![å›¾ç‰‡](img/file69.png)

å›¾ 8.25ï¼šè®­ç»ƒç½‘ç»œäº§ç”Ÿçš„æ¦‚çŽ‡åˆ†å¸ƒ

çŽ°åœ¨æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¸åŒçš„åŠ¨ä½œæœ‰ä¸åŒçš„åˆ†å¸ƒã€‚ç¬¬ä¸€ä¸ªåŠ¨ä½œï¼ˆå¯¹åº”äºŽ NOOPï¼Œå³ä¸åšä»»ä½•åŠ¨ä½œï¼‰å…¶åˆ†å¸ƒå‘å·¦åç§»ï¼Œå› æ­¤åœ¨è¯¥çŠ¶æ€ä¸‹é€šå¸¸ä»€ä¹ˆä¹Ÿä¸åšä¼šå¯¼è‡´å¤±è´¥ã€‚ç¬¬äº”ä¸ªåŠ¨ä½œï¼Œå³ RIGHTFIREï¼Œå…¶å‡å€¼å‘å³åç§»ï¼Œå› æ­¤è¿™ä¸ªåŠ¨ä½œä¼šå¸¦æ¥æ›´å¥½çš„å¾—åˆ†ã€‚

## è¶…å‚æ•°è°ƒä¼˜

è¶…å‚æ•°è°ƒä¼˜çš„æ•ˆæžœå¹¶ä¸æ˜¾è‘—ã€‚ç»è¿‡ 30 æ¬¡è°ƒä¼˜è¿­ä»£åŽï¼Œæ²¡æœ‰ä»»ä½•å­¦ä¹ çŽ‡å’Œ gamma çš„ç»„åˆèƒ½å¤Ÿæ¯”å¸¸è§„çš„å‚æ•°é›†æ›´å¿«åœ°æ”¶æ•›ã€‚

# ç»¼åˆæ‰€æœ‰å†…å®¹

ä½ çŽ°åœ¨å·²ç»çœ‹åˆ°äº†è®ºæ–‡ã€ŠRainbow: Combining Improvements in Deep Reinforcement Learningã€‹ä¸­æåˆ°çš„æ‰€æœ‰ DQN æ”¹è¿›ï¼Œä½†è¿™äº›æ”¹è¿›æ˜¯ä»¥é€’å¢žæ–¹å¼å®Œæˆçš„ï¼Œï¼ˆæˆ‘å¸Œæœ›ï¼‰è¿™ç§æ–¹å¼æœ‰åŠ©äºŽç†è§£æ¯ä¸ªæ”¹è¿›çš„æ€è·¯å’Œå®žçŽ°ã€‚è®ºæ–‡çš„ä¸»è¦å†…å®¹æ˜¯å°†è¿™äº›æ”¹è¿›ç»“åˆèµ·æ¥å¹¶æ£€æŸ¥ç»“æžœã€‚åœ¨æœ€ç»ˆçš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘å†³å®šå°†ç±»åˆ« DQN å’ŒåŒé‡ DQN ä»Žæœ€ç»ˆç³»ç»Ÿä¸­æŽ’é™¤ï¼Œå› ä¸ºå®ƒä»¬åœ¨æˆ‘ä»¬çš„è¯•éªŒçŽ¯å¢ƒä¸­å¹¶æœªå¸¦æ¥å¤ªå¤§çš„æ”¹è¿›ã€‚å¦‚æžœä½ æ„¿æ„ï¼Œä½ å¯ä»¥å°†å®ƒä»¬æ·»åŠ è¿›æ¥å¹¶å°è¯•ä½¿ç”¨ä¸åŒçš„æ¸¸æˆã€‚å®Œæ•´çš„ç¤ºä¾‹ä»£ç å¯ä»¥åœ¨ Chapter08/08_dqn_rainbow.py ä¸­æ‰¾åˆ°ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰æˆ‘ä»¬çš„ç½‘ç»œæž¶æž„ä»¥åŠä¸ºå…¶åšå‡ºè´¡çŒ®çš„æ–¹æ³•ï¼š

+   å¯¹æŠ— DQNï¼šæˆ‘ä»¬çš„ç½‘ç»œå°†æœ‰ä¸¤ä¸ªç‹¬ç«‹çš„è·¯å¾„ï¼Œä¸€ä¸ªç”¨äºŽçŠ¶æ€åˆ†å¸ƒçš„ä»·å€¼ï¼Œå¦ä¸€ä¸ªç”¨äºŽä¼˜åŠ¿åˆ†å¸ƒã€‚åœ¨è¾“å‡ºç«¯ï¼Œè¿™ä¸¤ä¸ªè·¯å¾„å°†ç›¸åŠ ï¼Œä»Žè€Œæä¾›åŠ¨ä½œçš„æœ€ç»ˆä»·å€¼æ¦‚çŽ‡åˆ†å¸ƒã€‚ä¸ºäº†å¼ºåˆ¶ä¼˜åŠ¿åˆ†å¸ƒå…·æœ‰é›¶å‡å€¼ï¼Œæˆ‘ä»¬å°†åœ¨æ¯ä¸ªåŽŸå­ä¸­å‡åŽ»å…·æœ‰å‡å€¼ä¼˜åŠ¿çš„åˆ†å¸ƒã€‚

+   å™ªå£°ç½‘ç»œï¼šæˆ‘ä»¬åœ¨ä»·å€¼å’Œä¼˜åŠ¿è·¯å¾„ä¸­çš„çº¿æ€§å±‚å°†æ˜¯ nn.Linear çš„å™ªå£°å˜ä½“ã€‚

é™¤äº†ç½‘ç»œæž¶æž„çš„å˜åŒ–ï¼Œæˆ‘ä»¬è¿˜å°†ä½¿ç”¨ä¼˜å…ˆå›žæ”¾ç¼“å†²åŒºæ¥ä¿æŒçŽ¯å¢ƒè½¬ç§»ï¼Œå¹¶æŒ‰æ¯”ä¾‹ä»Ž MSE æŸå¤±ä¸­é‡‡æ ·ã€‚

æœ€åŽï¼Œæˆ‘ä»¬å°†å±•å¼€ Bellman æ–¹ç¨‹ï¼Œä½¿ç”¨ n æ­¥æ³•ã€‚

æˆ‘ä¸æ‰“ç®—é‡å¤æ‰€æœ‰çš„ä»£ç ï¼Œå› ä¸ºå‰é¢çš„ç« èŠ‚å·²ç»ç»™å‡ºäº†å„ä¸ªæ–¹æ³•ï¼Œè€Œä¸”ç»“åˆè¿™äº›æ–¹æ³•çš„æœ€ç»ˆç»“æžœåº”è¯¥æ˜¯æ˜¾è€Œæ˜“è§çš„ã€‚å¦‚æžœä½ é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œå¯ä»¥åœ¨ GitHub ä¸Šæ‰¾åˆ°ä»£ç ã€‚

## ç»“æžœ

ä»¥ä¸‹æ˜¯ä¸ŽåŸºå‡† DQN æ¯”è¾ƒçš„å¹³æ»‘å¥–åŠ±å’Œæ­¥éª¤è®¡æ•°å›¾è¡¨ã€‚åœ¨è¿™ä¸¤è€…ä¸­ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥çœ‹åˆ°æ¸¸æˆæ•°é‡æ–¹é¢çš„æ˜¾è‘—æ”¹å–„ï¼š

![PIC](img/B22150_08_26.png)

å›¾ 8.26ï¼šåŸºå‡† DQN ä¸Žç»„åˆç³»ç»Ÿçš„æ¯”è¾ƒ

é™¤äº†å¹³å‡å¥–åŠ±ï¼Œå€¼å¾—æ£€æŸ¥ä¸€ä¸‹åŽŸå§‹å¥–åŠ±å›¾è¡¨ï¼Œç»“æžœæ¯”å¹³æ»‘å¥–åŠ±æ›´ä¸ºæˆå‰§åŒ–ã€‚å®ƒæ˜¾ç¤ºæˆ‘ä»¬çš„ç³»ç»Ÿèƒ½å¤Ÿéžå¸¸è¿…é€Ÿåœ°ä»Žè´Ÿé¢ç»“æžœè·³è·ƒåˆ°æ­£é¢â€”â€”ä»…ä»…ç»è¿‡ 100 åœºæ¸¸æˆï¼Œå®ƒå‡ ä¹Žèµ¢å¾—äº†æ¯ä¸€åœºæ¯”èµ›ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åˆèŠ±äº† 100 åœºæ¯”èµ›æ‰ä½¿å¹³æ»‘å¥–åŠ±è¾¾åˆ° +18ï¼š

![PIC](img/B22150_08_27.png)

å›¾ 8.27ï¼šç»„åˆç³»ç»Ÿçš„åŽŸå§‹å¥–åŠ±

ä½œä¸ºä¸€ä¸ªç¼ºç‚¹ï¼Œç»„åˆç³»ç»Ÿçš„é€Ÿåº¦æ¯”åŸºå‡†ç³»ç»Ÿæ…¢ï¼Œå› ä¸ºæˆ‘ä»¬é‡‡ç”¨äº†æ›´å¤æ‚çš„ç¥žç»ç½‘ç»œæž¶æž„å’Œä¼˜å…ˆå›žæ”¾ç¼“å†²åŒºã€‚FPS å›¾è¡¨æ˜¾ç¤ºï¼Œç»„åˆç³»ç»Ÿä»Ž 170 FPS å¼€å§‹ï¼Œå› ð’ª(n)ç¼“å†²åŒºå¤æ‚æ€§è€Œé™è‡³ 130 FPSï¼š

![PIC](img/B22150_08_28.png)

å›¾ 8.28ï¼šæ€§èƒ½æ¯”è¾ƒï¼ˆä»¥æ¯ç§’å¸§æ•°è®¡ï¼‰

## è¶…å‚æ•°è°ƒä¼˜

è°ƒä¼˜ä»ç„¶åƒä¹‹å‰é‚£æ ·è¿›è¡Œï¼Œä¸”åœ¨â€œè§£å†³æ¸¸æˆå‰çŽ©è¿‡çš„æ¸¸æˆæ•°â€æ–¹é¢ï¼Œèƒ½å¤Ÿè¿›ä¸€æ­¥æå‡ç»„åˆç³»ç»Ÿçš„è®­ç»ƒæ•ˆæžœã€‚ä»¥ä¸‹æ˜¯è°ƒä¼˜åŽçš„åŸºçº¿ DQN ä¸Žè°ƒä¼˜åŽçš„ç»„åˆç³»ç»Ÿçš„æ¯”è¾ƒå›¾è¡¨ï¼š

![PIC](img/B22150_08_29.png)

å›¾ 8.29ï¼šå·²è°ƒä¼˜åŸºçº¿ DQN ä¸Žå·²è°ƒä¼˜ç»„åˆç³»ç»Ÿçš„å¯¹æ¯”

å¦ä¸€ä¸ªæ˜¾ç¤ºè°ƒä¼˜æ•ˆæžœçš„å›¾è¡¨æ˜¯å¯¹æ¯”è°ƒä¼˜å‰åŽçš„åŽŸå§‹æ¸¸æˆå¥–åŠ±ã€‚è°ƒä¼˜åŽçš„ç³»ç»Ÿå¼€å§‹åœ¨ 40 å±€æ¸¸æˆåŽå°±èŽ·å¾—æœ€é«˜åˆ†ï¼Œè¿™éžå¸¸ä»¤äººå°è±¡æ·±åˆ»ï¼š

![PIC](img/B22150_08_30.png)

å›¾ 8.30ï¼šæœªè°ƒä¼˜å’Œå·²è°ƒä¼˜ç»„åˆ DQN çš„åŽŸå§‹å¥–åŠ±

# æ€»ç»“

åœ¨æœ¬ç« ä¸­ï¼Œæˆ‘ä»¬å›žé¡¾å¹¶å®žçŽ°äº†è‡ª 2015 å¹´é¦–æ¬¡å‘å¸ƒ DQN è®ºæ–‡ä»¥æ¥ï¼Œç ”ç©¶äººå‘˜å‘çŽ°çš„è®¸å¤š DQN æ”¹è¿›ã€‚è¿™ä»½æ¸…å•è¿œæœªå®Œæ•´ã€‚é¦–å…ˆï¼Œå…³äºŽæ–¹æ³•åˆ—è¡¨ï¼Œæˆ‘ä½¿ç”¨äº† DeepMind å‘å¸ƒçš„è®ºæ–‡ã€ŠRainbowï¼šç»“åˆæ·±åº¦å¼ºåŒ–å­¦ä¹ çš„æ”¹è¿›ã€‹[Hes+18]ï¼Œå› æ­¤æ–¹æ³•åˆ—è¡¨æ— ç–‘åå‘äºŽ DeepMind çš„è®ºæ–‡ã€‚å…¶æ¬¡ï¼Œå¼ºåŒ–å­¦ä¹ å¦‚ä»Šå‘å±•éžå¸¸è¿…é€Ÿï¼Œå‡ ä¹Žæ¯å¤©éƒ½æœ‰æ–°è®ºæ–‡å‘å¸ƒï¼Œå³ä½¿æˆ‘ä»¬åªå±€é™äºŽä¸€ç§å¼ºåŒ–å­¦ä¹ æ¨¡åž‹ï¼Œæ¯”å¦‚ DQNï¼Œä¹Ÿå¾ˆéš¾è·Ÿä¸Šè¿›å±•ã€‚æœ¬ç« çš„ç›®æ ‡æ˜¯è®©ä½ äº†è§£è¯¥é¢†åŸŸå·²ç»å‘å±•å‡ºçš„ä¸€äº›ä¸åŒçš„å®žé™…æ–¹æ³•ã€‚

åœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å°†ç»§ç»­ä»Žå·¥ç¨‹è§’åº¦è®¨è®º DQN çš„å®žé™…åº”ç”¨ï¼Œè°ˆè®ºå¦‚ä½•åœ¨ä¸è§¦åŠåº•å±‚æ–¹æ³•çš„æƒ…å†µä¸‹æå‡ DQN çš„æ€§èƒ½ã€‚

# åŠ å…¥æˆ‘ä»¬çš„ Discord ç¤¾åŒº

ä¸Žå…¶ä»–ç”¨æˆ·ã€æ·±åº¦å­¦ä¹ ä¸“å®¶ä»¥åŠä½œè€…æœ¬äººä¸€èµ·é˜…è¯»æœ¬ä¹¦ã€‚æé—®ã€ä¸ºå…¶ä»–è¯»è€…æä¾›è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡â€œé—®æˆ‘ä»»ä½•é—®é¢˜â€çŽ¯èŠ‚ä¸Žä½œè€…èŠå¤©ï¼Œæ›´å¤šå†…å®¹å°½åœ¨å…¶ä¸­ã€‚æ‰«æäºŒç»´ç æˆ–è®¿é—®é“¾æŽ¥åŠ å…¥ç¤¾åŒºã€‚[`packt.link/rl`](https://packt.link/rl)

![PIC](img/file1.png)
