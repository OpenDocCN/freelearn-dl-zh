["```py\nimport numpy as np\n# Your user-movie rating matrix (replace with your actual data)\nuser_movie_matrix = np.array([\n    [4, 0, 5, 0],\n    [0, 3, 0, 2],\n    [5, 4, 0, 3]\n])\n# Apply SVD\nU, s, V = np.linalg.svd(user_movie_matrix, full_matrices=False)\n# Number of latent factors (you can choose this based on your preference)\nnum_latent_factors = 2\n# Reconstruct the original matrix using the selected latent factors\nreconstructed_matrix = U[:, :num_latent_factors] @ np.diag(s[:num_latent_factors]) @ V[:num_latent_factors, :]\n# Replace negative values with 0\nreconstructed_matrix = np.maximum(reconstructed_matrix, 0)\nprint(\"Reconstructed Matrix:\")\nprint(reconstructed_matrix) \n```", "```py\nReconstructed Matrix:\n[[4.2972542  0\\.         4.71897811 0\\.        ]\n [1.08572801 2.27604748 0\\.         1.64449028]\n [4.44777253 4.36821972 0.52207171 3.18082082]] \n```", "```py\n    import pandas as pd\n    import ast\n    # Convert string representation of dictionaries to actual dictionaries\n    md['genres'] = md['genres'].apply(ast.literal_eval)\n    # Transforming the 'genres' column\n    md['genres'] = md['genres'].apply(lambda x: [genre['name'] for genre in x]) \n    ```", "```py\n    # Calculate weighted rate (IMDb formula)\n    def calculate_weighted_rate(vote_average, vote_count, min_vote_count=10):\n        return (vote_count / (vote_count + min_vote_count)) * vote_average + (min_vote_count / (vote_count + min_vote_count)) * 5.0\n    # Minimum vote count to prevent skewed results\n    vote_counts = md[md['vote_count'].notnull()]['vote_count'].astype('int')\n    min_vote_count = vote_counts.quantile(0.95)\n    # Create a new column 'weighted_rate'\n    md['weighted_rate'] = md.apply(lambda row: calculate_weighted_rate(row['vote_average'], row['vote_count'], min_vote_count), axis=1) \n    ```", "```py\n    md_final['combined_info'] = md_final.apply(lambda row: f\"Title: {row['title']}. Overview: {row['overview']} Genres: {', '.join(row['genres'])}. Rating: {row['weighted_rate']}\", axis=1).astype(str) \n    ```", "```py\n    import pandas as pd\n    import tiktoken\n    import os\n    import openai\n    openai.api_key = os.environ[\"OPENAI_API_KEY\"]\n    from openai.embeddings_utils import get_embedding\n    embedding_encoding = \"cl100k_base\" # this the encoding for text-embedding-ada-002\n    max_tokens = 8000 # the maximum for text-embedding-ada-002 is 8191\n    encoding = tiktoken.get_encoding(embedding_encoding)\n    # omit reviews that are too long to embed\n    md_final[\"n_tokens\"] = md_final.combined_info.apply(lambda x: len(encoding.encode(x)))\n    md_final = md_final[md_final.n_tokens <= max_tokens] \n    ```", "```py\n    md_final[\"embedding\"] = md_final.overview.apply(lambda x: get_embedding(x, engine=embedding_model)) \n    ```", "```py\nmd['text'][0] \n```", "```py\n'Title: GoldenEye. Overview: James Bond must unmask the mysterious head of the Janus Syndicate and prevent the leader from utilizing the GoldenEye weapons system to inflict devastating revenge on Britain. Genres: Adventure, Action, Thriller. Rating: 6.173464373464373' \n```", "```py\nmd_final.rename(columns = {'embedding': 'vector'}, inplace = True)\nmd_final.rename(columns = {'combined_info': 'text'}, inplace = True)\nmd_final.to_pickle('movies.pkl') \n```", "```py\n    import lancedb\n    uri = \"data/sample-lancedb\"\n    db = lancedb.connect(uri)\n    table = db.create_table(\"movies\", md) \n    ```", "```py\n    from langchain.embeddings import OpenAIEmbeddings\n    from langchain.vectorstores import LanceDB\n    os.environ[\"OPENAI_API_KEY\"]\n    embeddings = OpenAIEmbeddings()\n    docsearch = LanceDB(connection = table, embedding = embeddings)\n    query = \"I'm looking for an animated action movie. What could you suggest to me?\"\n    docs = docsearch.similarity_search(query)\n    docs \n    ```", "```py\n[Document(page_content='Title: Hitman: Agent 47\\. Overview: An assassin teams up with a woman to help her find her father and uncover the mysteries of her ancestry. Genres: Action, Crime, Thriller. Rating: 5.365800865800866', metadata={'genres': array(['Action', 'Crime', 'Thriller'], dtype=object), 'title': 'Hitman: Agent 47', 'overview': 'An assassin teams up with a woman to help her find her father and uncover the mysteries of her ancestry.', 'weighted_rate': 5.365800865800866, 'n_tokens': 52, 'vector': array([-0.00566491, -0.01658553, […] \n```", "```py\n    qa = RetrievalQA.from_chain_type(llm=OpenAI(), chain_type=\"stuff\", retriever=docsearch.as_retriever(), return_source_documents=True)\n    query = \"I'm looking for an animated action movie. What could you suggest to me?\"\n    result = qa({\"query\": query})\n    result['result'] \n    ```", "```py\n' I would suggest Transformers. It is an animated action movie with genres of Adventure, Science Fiction, and Action, and a rating of 6.' \n```", "```py\n    result['source_documents'][0] \n    ```", "```py\nDocument(page_content='Title: Hitman: Agent 47\\. Overview: An assassin teams up with a woman to help her find her father and uncover the mysteries of her ancestry. Genres: Action, Crime, Thriller. Rating: 5.365800865800866', metadata={'genres': array(['Action', 'Crime', 'Thriller'], dtype=object), 'title': 'Hitman: Agent 47', 'overview': 'An assassin teams up with a woman to help her find her father and uncover the mysteries of her ancestry.', 'weighted_rate': 5.365800865800866, 'n_tokens': 52, 'vector': array([-0.00566491, -0.01658553, -0.02255735, ..., -0.01242317,\n       -0.01303058, -0.00709073], dtype=float32), '_distance': 0.42414575815200806}) \n```", "```py\n    df_filtered = md[md['genres'].apply(lambda x: 'Comedy' in x)]\n    qa = RetrievalQA.from_chain_type(llm=OpenAI(), chain_type=\"stuff\",\n        retriever=docsearch.as_retriever(search_kwargs={'data': df_filtered}), return_source_documents=True)\n    query = \"I'm looking for a movie with animals and an adventurous plot.\"\n    result = qa({\"query\": query}) \n    ```", "```py\n    qa = RetrievalQA.from_chain_type(llm=OpenAI(), chain_type=\"stuff\",\n        retriever=docsearch.as_retriever(search_kwargs={'filter': {weighted_rate__gt:7}}), return_source_documents=True) \n    ```", "```py\n    from langchain.agents.agent_toolkits import create_retriever_tool\n    from langchain.agents.agent_toolkits import create_conversational_retrieval_agent\n    from langchain.chat_models import ChatOpenAI\n    llm = ChatOpenAI(temperature = 0)\n    retriever = docsearch.as_retriever(return_source_documents = True)\n    tool = create_retriever_tool(\n        retriever,\n        \"movies\",\n        \"Searches and returns recommendations about movies.\"\n    )\n    tools = [tool]\n    agent_executor = create_conversational_retrieval_agent(llm, tools, verbose=True)\n    result = agent_executor({\"input\": \"suggest me some action movies\"}) \n    ```", "```py\n> Entering new AgentExecutor chain...\nInvoking: `movies` with `{'genre': 'action'}`\n[Document(page_content='The action continues from [REC], […]\nHere are some action movies that you might enjoy:\n1\\. [REC]² - The action continues from [REC], with a medical officer and a SWAT team sent into a sealed-off apartment to control the situation. It is a thriller/horror movie.\n2\\. The Boondock Saints - Twin brothers Conner and Murphy take swift retribution into their own hands to rid Boston of criminals. It is an action/thriller/crime movie.\n3\\. The Gamers - Four clueless players are sent on a quest to rescue a princess and must navigate dangerous forests, ancient ruins, and more. It is an action/comedy/thriller/foreign movie.\n4\\. Atlas Shrugged Part III: Who is John Galt? - In a collapsing economy, one man has the answer while others try to control or save him. It is a drama/science fiction/mystery movie.\nPlease note that these recommendations are based on the genre \"action\" and may vary in terms of availability and personal preferences.\n> Finished chain. \n```", "```py\nprint(qa.combine_documents_chain.llm_chain.prompt.template) \n```", "```py\nUse the following pieces of context to answer the question at the end. If you don't know the answer, just say that you don't know, don't try to make up an answer.\n{context}\nQuestion: {question}\nHelpful Answer: \n```", "```py\nfrom langchain.prompts import PromptTemplate\ntemplate = \"\"\"You are a movie recommender system that help users to find movies that match their preferences.\nUse the following pieces of context to answer the question at the end.\nFor each question, suggest three movies, with a short description of the plot and the reason why the user migth like it.\nIf you don't know the answer, just say that you don't know, don't try to make up an answer.\n{context}\nQuestion: {question}\nYour response:\"\"\"\n\nPROMPT = PromptTemplate(\n    template=template, input_variables=[\"context\", \"question\"]) \n```", "```py\n    PROMPT = PromptTemplate(\n        template=template, input_variables=[\"context\", \"question\"])\n    chain_type_kwargs = {\"prompt\": PROMPT}\n    qa = RetrievalQA.from_chain_type(llm=OpenAI(),\n        chain_type=\"stuff\",\n        retriever=docsearch.as_retriever(),\n        return_source_documents=True,\n        chain_type_kwargs=chain_type_kwargs)\n    query = \"I'm looking for a funny action movie, any suggestion?\"\n    result = qa({'query':query})\n    print(result['result']) \n    ```", "```py\n1\\. A Good Day to Die Hard: An action-packed comedy directed by John Moore, this movie follows Iconoclastic, take-no-prisoners cop John McClane as he travels to Moscow to help his wayward son Jack. With the Russian underworld in pursuit, and battling a countdown to war, the two McClanes discover that their opposing methods make them unstoppable heroes.\n2\\. The Hidden: An alien is on the run in America and uses the bodies of anyone in its way as a hiding place. With lots of innocent people dying in the chase, this action-packed horror movie is sure to keep you laughing.\n3\\. District B13: Set in the ghettos of Paris in 2010, this action-packed science fiction movie follows an undercover cop and ex-thug as they try to infiltrate a gang in order to defuse a neutron bomb. A thrilling comedy that will keep you laughing. \n```", "```py\n    from langchain.prompts import PromptTemplate\n    template_prefix = \"\"\"You are a movie recommender system that help users to find movies that match their preferences.\n    Use the following pieces of context to answer the question at the end.\n    If you don't know the answer, just say that you don't know, don't try to make up an answer.\n    {context}\"\"\"\n    user_info = \"\"\"This is what we know about the user, and you can use this information to better tune your research:\n    Age: {age}\n    Gender: {gender}\"\"\"\n    template_suffix= \"\"\"Question: {question}\n    Your response:\"\"\"\n    user_info = user_info.format(age = 18, gender = 'female')\n    COMBINED_PROMPT = template_prefix +'\\n'+ user_info +'\\n'+ template_suffix\n    print(COMBINED_PROMPT) \n    ```", "```py\nYou are a movie recommender system that help users to find movies that match their preferences.\nUse the following pieces of context to answer the question at the end.\nIf you don't know the answer, just say that you don't know, don't try to make up an answer.\n{context}\nThis is what we know about the user, and you can use this information to better tune your research:\nAge: 18\nGender: female\nQuestion: {question}\nYour response: \n```", "```py\n    PROMPT = PromptTemplate(\n        template=COMBINED_PROMPT, input_variables=[\"context\", \"question\"])\n    chain_type_kwargs = {\"prompt\": PROMPT}\n    qa = RetrievalQA.from_chain_type(llm=OpenAI(),\n        chain_type=\"stuff\",\n        retriever=docsearch.as_retriever(),\n        return_source_documents=True,\n        chain_type_kwargs=chain_type_kwargs)\n    result = qa({'query':query})\n    result['result'] \n    ```", "```py\n' Sure, I can suggest some action movies for you. Here are a few examples: A Good Day to Die Hard, Goldfinger, Ong Bak 2, and The Raid 2\\. All of these movies have high ratings and feature thrilling action elements. I hope you find something that you enjoy!' \n```", "```py\n    import pandas as pd\n    data = {\n        \"username\": [\"Alice\", \"Bob\"],\n        \"age\": [25, 32],\n        \"gender\": [\"F\", \"M\"],\n        \"movies\": [\n            [(\"Transformers: The Last Knight\", 7), (\"Pokémon: Spell of the Unknown\", 5)],\n            [(\"Bon Cop Bad Cop 2\", 8), (\"Goon: Last of the Enforcers\", 9)]\n        ]\n    }\n    # Convert the \"movies\" column into dictionaries\n    for i, row_movies in enumerate(data[\"movies\"]):\n        movie_dict = {}\n        for movie, rating in row_movies:\n            movie_dict[movie] = rating\n        data[\"movies\"][i] = movie_dict\n    # Create a pandas DataFrame\n    df = pd.DataFrame(data)\n    df.head() \n    ```", "```py\n    template_prefix = \"\"\"You are a movie recommender system that help users to find movies that match their preferences.\n    Use the following pieces of context to answer the question at the end.\n    If you don't know the answer, just say that you don't know, don't try to make up an answer.\n    {context}\"\"\"\n    user_info = \"\"\"This is what we know about the user, and you can use this information to better tune your research:\n    Age: {age}\n    Gender: {gender}\n    Movies already seen alongside with rating: {movies}\"\"\"\n    template_suffix= \"\"\"Question: {question}\n    Your response:\"\"\" \n    ```", "```py\n    age = df.loc[df['username']=='Alice']['age'][0]\n    gender = df.loc[df['username']=='Alice']['gender'][0]\n    movies = ''\n    # Iterate over the dictionary and output movie name and rating\n    for movie, rating in df['movies'][0].items():\n        output_string = f\"Movie: {movie}, Rating: {rating}\" + \"\\n\"\n        movies+=output_string\n        #print(output_string)\n    user_info = user_info.format(age = age, gender = gender, movies = movies)\n    COMBINED_PROMPT = template_prefix +'\\n'+ user_info +'\\n'+ template_suffix\n    print(COMBINED_PROMPT) \n    ```", "```py\nYou are a movie recommender system that help users to find movies that match their preferences.\nUse the following pieces of context to answer the question at the end.\nIf you don't know the answer, just say that you don't know, don't try to make up an answer.\n{context}\nThis is what we know about the user, and you can use this information to better tune your research:\nAge: 25\nGender: F\nMovies already seen alongside with rating: Movie: Transformers: The Last Knight, Rating: 7\nMovie: Pokémon: Spell of the Unknown, Rating: 5\nQuestion: {question}\nYour response: \n```", "```py\n    PROMPT = PromptTemplate(\n        template=COMBINED_PROMPT, input_variables=[\"context\", \"question\"])\n    chain_type_kwargs = {\"prompt\": PROMPT}\n    qa = RetrievalQA.from_chain_type(llm=OpenAI(),\n        chain_type=\"stuff\",\n        retriever=docsearch.as_retriever(),\n        return_source_documents=True,\n        chain_type_kwargs=chain_type_kwargs)\n    query = \"Can you suggest me some action movie based on my background?\"\n    result = qa({'query':query})\n    result['result'] \n    ```", "```py\n\" Based on your age, gender, and the movies you've already seen, I would suggest the following action movies: The Raid 2 (Action, Crime, Thriller; Rating: 6.71), Ong Bak 2 (Adventure, Action, Thriller; Rating: 5.24), Hitman: Agent 47 (Action, Crime, Thriller; Rating: 5.37), and Kingsman: The Secret Service (Crime, Comedy, Action, Adventure; Rating: 7.43).\"\n' \n```", "```py\n    import streamlit as st\n    st.set_page_config(page_title=\"GlobeBotter\", page_icon=\"![](img/Icon.png)\")\n    st.header('![](img/Icon.png) Welcome to MovieHarbor, your favourite movie recommender') \n    ```", "```py\n    load_dotenv()\n    #os.environ[\"HUGGINGFACEHUB_API_TOKEN\"]\n    openai_api_key = os.environ['OPENAI_API_KEY']\n    embeddings = OpenAIEmbeddings()\n    uri = \"data/sample-lancedb\"\n    db = lancedb.connect(uri)\n    table = db.open_table('movies')\n    docsearch = LanceDB(connection = table, embedding = embeddings)\n    # Import the movie dataset\n    md = pd.read_pickle('movies.pkl') \n    ```", "```py\n    # Create a sidebar for user input\n    st.sidebar.title(\"Movie Recommendation System\")\n    st.sidebar.markdown(\"Please enter your details and preferences below:\")\n    # Ask the user for age, gender and favourite movie genre\n    age = st.sidebar.slider(\"What is your age?\", 1, 100, 25)\n    gender = st.sidebar.radio(\"What is your gender?\", (\"Male\", \"Female\", \"Other\"))\n    genre = st.sidebar.selectbox(\"What is your favourite movie genre?\", md.explode('genres')[\"genres\"].unique())\n    # Filter the movies based on the user input\n    df_filtered = md[md['genres'].apply(lambda x: genre in x)] \n    ```", "```py\n    template_prefix = \"\"\"You are a movie recommender system that help users to find movies that match their preferences.\n    Use the following pieces of context to answer the question at the end.\n    If you don't know the answer, just say that you don't know, don't try to make up an answer.\n    {context}\"\"\"\n    user_info = \"\"\"This is what we know about the user, and you can use this information to better tune your research:\n    Age: {age}\n    Gender: {gender}\"\"\"\n    template_suffix= \"\"\"Question: {question}\n    Your response:\"\"\"\n    user_info = user_info.format(age = age, gender = gender)\n    COMBINED_PROMPT = template_prefix +'\\n'+ user_info +'\\n'+ template_suffix\n    print(COMBINED_PROMPT) \n    ```", "```py\n    #setting up the chain\n    qa = RetrievalQA.from_chain_type(llm=OpenAI(), chain_type=\"stuff\",\n        retriever=docsearch.as_retriever(search_kwargs={'data': df_filtered}), return_source_documents=True) \n    ```", "```py\n    query = st.text_input('Enter your question:', placeholder = 'What action movies do you suggest?')\n    if query:\n        result = qa({\"query\": query})\n        st.write(result['result']) \n    ```"]