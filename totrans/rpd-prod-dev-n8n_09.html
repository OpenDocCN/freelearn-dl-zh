<html><head></head><body>
		<div id="_idContainer095">
			<h1 id="_idParaDest-136"><em class="italic"><a id="_idTextAnchor147"/>Chapter <a id="_idTextAnchor148"/>7</em>: <a id="_idTextAnchor149"/>Transforming Your Data inside a Workflow</h1>
			<p>In this chapter, you will learn how to manipulate data within workflows so that the APIs that you create can return the data in a useful format. You will also learn about sharing data between workflows, working with arrays and JSON objects, merging datasets, and performing analytics and calculations.</p>
			<p>This chapter will cover the following main topics:</p>
			<ul>
				<li>Sharing data between workflows</li>
				<li>Merging datasets</li>
				<li>Performing calculations and analytics</li>
			</ul>
			<h1 id="_idParaDest-137"><a id="_idTextAnchor150"/>Technical requirements</h1>
			<p>The following are the technical requirements that you'll need to prepare before continuing with this chapter:</p>
			<ul>
				<li>You should have created an account on Airtable.</li>
				<li>n8n should be running and the Editor UI should be open.</li>
			</ul>
			<p>You can find the completed code examples for the chapter on GitHub at <a href="https://github.com/PacktPublishing/Rapid-Product-Development-with-n8n/tree/main/Chapter%207">https://github.com/PacktPublishing/Rapid-Product-Development-with-n8n/tree/main/Chapter%207.</a></p>
			<h1 id="_idParaDest-138"><a id="_idTextAnchor151"/>Sharing data between workflows</h1>
			<p>When you're <a id="_idIndexMarker370"/>building workflows with n8n, you may find yourself<a id="_idIndexMarker371"/> repeating certain patterns. Examples of such patterns could be pushing data to Airtable, transforming the data to fit a particular format, or performing checks regarding the validity of the incoming data. At other times, your workflows might grow in size with more than 20 or 30 nodes, and it might become <a id="_idIndexMarker372"/>difficult to manage so many different nodes and logic in a single workflow. </p>
			<p>If you <a id="_idIndexMarker373"/>come from a programming background, you can probably relate this to creating functions or modules so that you can create reusable chunks of code that are modular and easier to manage. n8n allows you to do this using <a id="_idIndexMarker374"/>the <strong class="bold">Execute Workflow</strong> node.</p>
			<p>Let's consider a workflow: we need to get data using<a id="_idIndexMarker375"/> the <strong class="bold">Hacker News</strong> node, filter the data in the workflow to include only the title and the URL of the articles, and insert the data into an Airtable. Let's break this workflow down into two parts for illustration purposes:</p>
			<ul>
				<li>Getting the data from Hacker News</li>
				<li>Filtering the data and inserting it into Airtable</li>
			</ul>
			<p>To do this follow these steps:</p>
			<ol>
				<li>Open the n8n Editor UI and create a new <strong class="bold">Workflow</strong>. Add a <strong class="bold">Hacker News</strong> node and connect it to the <strong class="bold">Start</strong> node. </li>
				<li>Select the <strong class="bold">All</strong> resource for the <strong class="bold">Hacker News</strong> node. Now, add an <strong class="bold">Execute Workflow</strong> node and connect it to the <strong class="bold">Hacker News</strong> node. We'll refer to this workflow as <strong class="bold">Workflow 1</strong> from here on. </li>
				<li>Save this <strong class="bold">Workflow</strong>. It should now look something like this:</li>
			</ol>
			<div>
				<div id="_idContainer082" class="IMG---Figure">
					<img src="image/Figure_7.01_B17493.jpg" alt="Figure 7.1 – A workflow that was created using the Execute Workflow node&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.1 – A workflow that was created using the Execute Workflow node</p>
			<ol>
				<li value="4">In a new tab, create a new <strong class="bold">Workflow</strong>. In this new <strong class="bold">Workflow</strong>, add a <strong class="bold">Set</strong> node and an <strong class="bold">Airtable</strong> node. </li>
				<li>Connect<a id="_idIndexMarker376"/> the <strong class="bold">Set</strong> node to the <strong class="bold">Start</strong> node and the <strong class="bold">Airtable</strong> node to the <strong class="bold">Set</strong> node. Set it up so that only the <strong class="source-inline">title</strong> and <strong class="source-inline">url</strong> properties of the<a id="_idIndexMarker377"/> article get set and inserted into the <strong class="bold">Airtable</strong> node. Since we don't have any data in our <strong class="bold">Workflow</strong>, using expressions might be a bit tricky. You can use the following expressions here:<ul><li><strong class="source-inline">{{$json["title"]}}</strong></li><li><strong class="source-inline">{{$json["url"]}}</strong></li></ul></li>
				<li>Now, configure the <strong class="bold">Airtable</strong> node, save this <strong class="bold">Workflow</strong>, and obtain its ID. We'll refer to this workflow as <strong class="bold">Workflow 2</strong> from here on. You can find the ID of a <strong class="bold">Workflow</strong> using its URL (as shown in <em class="italic">Figure 7.2</em>). For example, the URL of my saved <strong class="bold">Workflow</strong> is <strong class="source-inline">http://localhost:5678/workflow/297</strong>, so the ID would be <strong class="bold">297</strong>. </li>
			</ol>
			<p>Here's what my <strong class="bold">Workflow</strong> and its ID look like:</p>
			<div>
				<div id="_idContainer083" class="IMG---Figure">
					<img src="image/Figure_7.02_B17493.jpg" alt="Figure 7.2 – A workflow for filtering and inserting data into Airtable&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.2 – A workflow for filtering and inserting data into Airtable</p>
			<ol>
				<li value="7">Now, go back to the workflow with the <strong class="bold">Execute Workflow</strong> node and enter the ID of the new workflow. Execute the workflow. </li>
			</ol>
			<p>You will notice that <strong class="bold">Workflow 1</strong> runs <strong class="bold">Workflow 2</strong>, gets the data that's returned by it, and displays it in the output of the <strong class="bold">Execute Workflow</strong> node. This is how you can share data between multiple workflows in n8n and break them into more manageable chunks.</p>
			<p>Let's <a id="_idIndexMarker378"/>understand <a id="_idIndexMarker379"/>how the data passes between the two workflows that we created. The <strong class="bold">Execute Workflow</strong> node in <strong class="bold">Workflow 1</strong> passes the data to the <strong class="bold">Start</strong> node of <strong class="bold">Workflow 2</strong>. Because of this, all the nodes of <strong class="bold">Workflow 2</strong> must be connected to the <strong class="bold">Start</strong> node. The last node of <strong class="bold">Workflow 2</strong> sends the data back to the <strong class="bold">Execute Workflow</strong> node in <strong class="bold">Workflow 1</strong>, as shown here:</p>
			<div>
				<div id="_idContainer084" class="IMG---Figure">
					<img src="image/Figure_7.03_B17493.jpg" alt="Figure 7.3 – Flow of data between the two workflows&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.3 – Flow of data between the two workflows</p>
			<p>Let's take a look at the options provided by the <strong class="bold">Execute Workflow</strong> node. The <strong class="bold">Source </strong>field allows you to specify how the node should look for the workflow:</p>
			<ul>
				<li><strong class="bold">Database</strong>: Loads the workflow from the database by its ID.</li>
				<li><strong class="bold">Local File</strong>: Loads the workflow from a locally saved file. This path must be relative to where n8n is running.</li>
				<li><strong class="bold">Parameter</strong>: Loads the workflow from a parameter. Here, you can provide the workflow JSON.</li>
				<li><strong class="bold">URL</strong>: Loads the workflow from a URL.</li>
			</ul>
			<p>Now, let's look at how we can merge datasets in an n8n workflow using the <strong class="bold">Merge</strong> node. </p>
			<h1 id="_idParaDest-139"><a id="_idTextAnchor152"/>Merging datasets</h1>
			<p>In <a href="B17493_06_Final_PD_ePub.xhtml#_idTextAnchor116"><em class="italic">Chapter 6</em></a>, <em class="italic">Powering Your API with a No Code Database</em>, we learned how to use Airtable as a no-code database for our application. Let's build on that example to visualize <a id="_idIndexMarker380"/>what a database for a newsletter management app could look like. Typically, databases have different tables for different categories of data points, and we can reference data between different tables using unique IDs. Let's understand this with the help of an example:</p>
			<ol>
				<li value="1">Open the Airtable base called <strong class="bold">The n8n book</strong> that you created in <a href="B17493_06_Final_PD_ePub.xhtml#_idTextAnchor116"><em class="italic">Chapter 6</em></a>, <em class="italic">Powering Your API with a No Code Database</em>. Rename <strong class="bold">Table 1</strong> to <strong class="bold">Users</strong>.</li>
				<li>Add two new tables to it called <strong class="bold">Newsletters</strong> and <strong class="bold">Stats</strong>. In the <strong class="bold">Newsletters</strong> table, add the following columns:</li>
			</ol>
			<p><strong class="bold">NewsletterID</strong> (single-line text)</p>
			<p><strong class="bold">Subject</strong> (single-line text)</p>
			<p><strong class="bold">Content</strong> (long text)</p>
			<p><strong class="bold">Clicks</strong> (single-line text)</p>
			<ol>
				<li value="3">Add an entry to the table called <strong class="bold">NewsletterID1</strong>. It should now look like this:</li>
			</ol>
			<div>
				<div id="_idContainer085" class="IMG---Figure">
					<img src="image/Figure_7.04_B17493.jpg" alt="Figure 7.4 – Creating and filling the Newsletters table&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.4 – Creating and filling the Newsletters table</p>
			<ol>
				<li value="4">In the <strong class="bold">Stats</strong> table, add <a id="_idIndexMarker381"/>the following columns:</li>
			</ol>
			<p><strong class="bold">UserID</strong> (single-line text)</p>
			<p><strong class="bold">Clicks</strong> (single-line text)</p>
			<ol>
				<li value="5">Add an entry to the table called <strong class="bold">UserID1</strong>. It should now look like this:</li>
			</ol>
			<div>
				<div id="_idContainer086" class="IMG---Figure">
					<img src="image/Figure_7.05_B17493.jpg" alt="Figure 7.5 – Creating and filling the Stats table&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.5 – Creating and filling the Stats table</p>
			<p>Now, we have three tables with unique IDs that can be used to cross-reference data between the different tables.</p>
			<p>Let's say<a id="_idIndexMarker382"/> that we want to know how many clicks have been made by each user. We want to know this number so that we can send them an email, thanking them for their active engagement if it is greater than 9. To build out a workflow for this, we'd need to have two crucial pieces of information: the user's email address and their number of clicks. Both these details reside in different tables that are linked only by the unique <strong class="bold">UserID</strong>. Let's use the <strong class="bold">Merge</strong> node to get all the information that we need.</p>
			<ol>
				<li value="1">Open the Editor UI and add an <strong class="bold">Airtable</strong> node. Configure it so that it lists all the data from the <strong class="bold">Users</strong> table. The details that we need are nested in the <strong class="source-inline">fields</strong> object. Since we don't need the timestamp and the <strong class="bold">Airtable</strong> node's ID, we can get rid of them. You can use either the <strong class="bold">Set</strong> node or the <strong class="bold">Function</strong>/<strong class="bold">Function Item</strong> nodes to do that. I used the <strong class="bold">Function</strong> node with the following code:<p class="source-code">const newItems = [];</p><p class="source-code">for(let i=0; i&lt;items.length; i++) {</p><p class="source-code">newItems.push({json: items[i].json.fields});</p><p class="source-code">}</p><p class="source-code">return newItems;</p></li>
			</ol>
			<p>The preceding<a id="_idIndexMarker383"/> code ensures that only the <strong class="source-inline">fields</strong> array is returned by this node. The data should now look as follows:</p>
			<div>
				<div id="_idContainer087" class="IMG---Figure">
					<img src="image/Figure_7.06_B17493.jpg" alt="Figure 7.6 – This is what the data from the Function node should look like&#13;&#10;"/>
				</div>
			</div>
			<p>Figure 7.6 – This is what the data from the Function node should look like</p>
			<ol>
				<li value="2">Now, add a <strong class="bold">Merge</strong> node and connect <strong class="bold">Input 1</strong> to the <strong class="bold">Function</strong> node. </li>
				<li>Now, we need to get the data from the <strong class="bold">Stats</strong> table. Perform the same steps that we mentioned at the beginning of this section by adding an <strong class="bold">Airtable</strong> node (which we will call <strong class="bold">Airtable1</strong>), along with a <strong class="bold">Function</strong> (or <strong class="bold">Set</strong>) node (which we will call <strong class="bold">Function1</strong>), and connecting it to <strong class="bold">Input 2</strong> of the <strong class="bold">Merge</strong> node. The workflow should look like this:</li>
			</ol>
			<div>
				<div id="_idContainer088" class="IMG---Figure">
					<img src="image/Figure_7.07_B17493.jpg" alt="Figure 7.7 – This is what the workflow should look like&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.7 – This is what the workflow should look like</p>
			<ol>
				<li value="4">Open the <strong class="bold">Merge</strong> node and set <strong class="bold">Mode</strong> to <strong class="bold">Merge By Key</strong>. </li>
				<li>Enter <strong class="bold">UserID</strong> in the <strong class="bold">Property Input 1</strong> and <strong class="bold">Property Input 2</strong> fields. We are doing this since <strong class="bold">UserID</strong> is the field linking<a id="_idIndexMarker384"/> the two datasets from the two different tables together. </li>
				<li>Execute the workflow; the result of the <strong class="bold">Merge</strong> node should look something like this:</li>
			</ol>
			<div>
				<div id="_idContainer089" class="IMG---Figure">
					<img src="image/Figure_7.08_B17493.jpg" alt="Figure 7.8 – The Merge node merging the data from two different tables&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.8 – The Merge node merging the data from two different tables</p>
			<p class="callout-heading">Note</p>
			<p class="callout">The latest version of n8n also has an Item Lists node that can be used.</p>
			<p>Now that we have the two pieces of data that we need, we can add an <strong class="bold">IF</strong> node and an email node (such as the <strong class="bold">Send Email</strong> or <strong class="bold">Gmail</strong> node) after the <strong class="bold">Merge</strong> node so that we can<a id="_idIndexMarker385"/> thank the engaged readers of the newsletter.</p>
			<p>The <strong class="bold">Merge</strong> node has several different modes that can be used to merge the data in the format that works best for your use case. Now that we know how we can merge datasets inside a workflow using n8n, let's learn how to perform calculations and analytics in n8n using JavaScript.</p>
			<h1 id="_idParaDest-140"><a id="_idTextAnchor153"/>Performing calculations and analytics</h1>
			<p>You can use <a id="_idIndexMarker386"/>JavaScript in n8n within expressions and use the <strong class="bold">Function</strong> nodes to perform mathematical calculations and basic analytics. </p>
			<p>Let's use the newsletter database from the <em class="italic">Merging datasets</em> section to try out some calculations. We have added a few more records to the tables. You can clone the <strong class="bold">Airtable</strong> using <a id="_idIndexMarker387"/>the following link if you'd like to use our records: <a href="https://airtable.com/invite/l?inviteId=invRJMGCMu7HWQzKW&amp;inviteToken=3b6fbc536ccc17cf24fbeb01b5e8a253fe99afd27616f3abaeaffb046cedf8aa&amp;utm_source=email">https://airtable.com/invite/l?inviteId=invRJMGCMu7HWQzKW&amp;inviteToken=3b6fbc536ccc17cf24fbeb01b5e8a253fe99afd27616f3abaeaffb046cedf8aa&amp;utm_source=email</a>.</p>
			<p>Let's calculate a few things from our <strong class="bold">Airtable</strong> database:</p>
			<ul>
				<li>The number of users</li>
				<li>The average number of clicks per newsletter</li>
				<li>The highest number of clicks by a user</li>
			</ul>
			<p>To do this, follow these steps:</p>
			<ol>
				<li value="1">Open <a id="_idIndexMarker388"/>the <strong class="bold">Editor UI</strong> and open a new <strong class="bold">Workflow</strong>. Add an <strong class="bold">Airtable</strong> node and list all the records from the <strong class="bold">Users</strong> table. </li>
				<li>Add a <strong class="bold">Set</strong> node and connect it to the <strong class="bold">Airtable</strong> node. Our <strong class="bold">Workflow</strong> should look like this:</li>
			</ol>
			<div>
				<div id="_idContainer090" class="IMG---Figure">
					<img src="image/Figure_7.09_B17493.jpg" alt="Figure 7.9 – A workflow for calculating the total number of users in the Users table&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.9 – A workflow for calculating the total number of users in the Users table</p>
			<ol>
				<li value="3">Set <strong class="bold">Keep Only Set</strong> to <em class="italic">true</em>. This removes all incoming workflow data and only appends the new values that have been configured in the <strong class="bold">Set</strong> node. </li>
				<li>Add a value of the <strong class="bold">Number</strong> type and name it <strong class="bold">Total Users</strong>. Add an expression for the <strong class="bold">Value</strong> field:<p class="source-code">{{$items.length}}</p></li>
			</ol>
			<p>This will calculate the total number of items that are returned by the <strong class="bold">Airtable</strong> node, which is also the total number of users. Executing this node will cause this value to be returned three times (once for each item). </p>
			<ol>
				<li value="5">In the<a id="_idIndexMarker389"/> node's <strong class="bold">Settings</strong> area, set <strong class="bold">Execute Once</strong> to <em class="italic">true</em>. Your workflow should now calculate the total number of users in the <strong class="bold">Users</strong> table for you. The result from the <strong class="bold">Set</strong> node should look like this:</li>
			</ol>
			<div>
				<div id="_idContainer091" class="IMG---Figure">
					<img src="image/Figure_7.10_B17493.jpg" alt="Figure 7.10 – Output of the Set node&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.10 – Output of the Set node</p>
			<p>Let's calculate the <strong class="bold">Average clicks</strong> value per newsletter. </p>
			<ol>
				<li value="1">Create another <strong class="bold">Workflow</strong> and add an <strong class="bold">Airtable</strong> node that lists all the entries from the <strong class="bold">Newsletters</strong> table. Add a <strong class="bold">Function</strong> node and connect it to the <strong class="bold">Airtable</strong> node. The workflow should look like this:</li>
			</ol>
			<div>
				<div id="_idContainer092" class="IMG---Figure">
					<img src="image/Figure_7.11_B17493.jpg" alt="Figure 7.11 – A workflow for calculating the average clicks per newsletter&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.11 – A workflow for calculating the average clicks per newsletter</p>
			<ol>
				<li value="2">In the <strong class="bold">Function</strong> node, add<a id="_idIndexMarker390"/> the following JavaScript code:<p class="source-code">let total = 0;</p><p class="source-code">let average = 0;</p><p class="source-code">for (let i=0; i&lt;items.length; i++) {</p><p class="source-code">  total = total + parseInt(items[i].json.fields.Clicks);</p><p class="source-code">}</p><p class="source-code">average = total/items.length;</p><p class="source-code">return [{json: {average_clicks: average}}];</p></li>
			</ol>
			<p>In the preceding code, we iterated over all the records that were returned by the <strong class="bold">Airtable</strong> node and added them to the <strong class="source-inline">total</strong> variable. We used the <strong class="source-inline">parseInt()</strong> function because the value of <strong class="source-inline">Clicks</strong> is of the <strong class="source-inline">String</strong> data type and we need to convert it into the <strong class="source-inline">integer</strong> data type. Finally, we calculated the <strong class="source-inline">average</strong> value by dividing the <strong class="source-inline">total</strong> clicks by the number of newsletters, which we calculated with <strong class="source-inline">items.length</strong> (exactly like we did in the preceding workflow). This provides us with the average clicks per newsletter. The following screenshot illustrates this:</p>
			<div>
				<div id="_idContainer093" class="IMG---Figure">
					<img src="image/Figure_7.12_B17493.jpg" alt="Figure 7.12 – Calculating the average clicks per newsletter&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.12 – Calculating the average clicks per newsletter</p>
			<p>Finally, let's calculate <a id="_idIndexMarker391"/>the highest number of clicks by a user. </p>
			<ol>
				<li value="3">Create another workflow and add an <strong class="bold">Airtable</strong> node that lists all the entries from the <strong class="bold">Stats</strong> table. Add a <strong class="bold">Function</strong> node and connect it to the <strong class="bold">Airtable</strong> node. The workflow should look like the one shown in <em class="italic">Figure 7.11</em>.</li>
				<li>In the <strong class="bold">Function</strong> node, add the following JavaScript code:<p class="source-code">const clicks = [];</p><p class="source-code">let highest = 0;</p><p class="source-code">for (let i=0; i&lt;items.length; i++) {</p><p class="source-code">clicks.push(items[i].json.fields.Clicks);</p><p class="source-code">}</p><p class="source-code">highest = Math.max(...clicks);</p><p class="source-code">return [{json: {highest_clicks: highest}}];</p></li>
			</ol>
			<p>In the<a id="_idIndexMarker392"/> preceding code, we added all the number clicks to an array called <strong class="source-inline">clicks</strong>. Then, we used the <strong class="source-inline">Math.max()</strong> function to find the maximum value in that array. This provides us with the highest number of clicks per user. The following screenshot illustrates this:</p>
			<div>
				<div id="_idContainer094" class="IMG---Figure">
					<img src="image/Figure_7.13_B17493.jpg" alt="Figure 7.13 – Calculating the highest number of clicks per user&#13;&#10;"/>
				</div>
			</div>
			<p class="figure-caption">Figure 7.13 – Calculating the highest number of clicks per user</p>
			<p><strong class="source-inline">Math</strong> is a useful built-in object that can be utilized for a lot of these calculations. You can find out <a id="_idIndexMarker393"/>more at <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math</a>. </p>
			<p>These were some basic examples of how you can use JavaScript to perform calculations and create workflows for analytics to gain insights from the data that you accrue through your APIs and apps.</p>
			<h1 id="_idParaDest-141"><a id="_idTextAnchor154"/>Summary</h1>
			<p>In this chapter, we learned about sharing data between multiple workflows in n8n, merging data coming from different sources within a workflow, and using JavaScript to perform calculations and analytics from within a workflow. The concepts we learned in this chapter will help you when you're sending data to other services or no-code tools using our custom API.</p>
			<p>In the next chapter, we are going to introduce the Bubble APIs and integrate them into n8n. We will learn how to work with Bubble data and workflows, along with how to configure n8n to receive events and data initiated by Bubble.</p>
		</div>
	</body></html>