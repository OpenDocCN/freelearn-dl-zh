<html><head></head><body><div id="sbo-rt-content"><div id="_idContainer296">
			<h1 id="_idParaDest-441"><em class="italic"><a id="_idTextAnchor396"/>Chapter 17</em>: Controlling the Robot with a Phone and Python</h1>
			<p>The robot we've been programming has many behaviors, but when you run some of them, they result in the robot stopping on the other side of the room. You could try to write code to return it back to you, but this may be complicated. We've also got a neat camera with some visual feedback available on what the robot is doing. Wouldn't it be neat to take control and drive the robot sometimes? </p>
			<p>We've been launching<a id="_idIndexMarker1124"/> commands to drive our robot from a <strong class="bold">Secure Shell</strong> (<strong class="bold">SSH</strong>) terminal, but the robot will be more exciting and more comfortable to demonstrate if you could start the commands via a menu. We can build upon the<a id="_idIndexMarker1125"/> web <strong class="bold">application programming interface</strong> (<strong class="bold">API</strong>) code you made in <a href="B15660_15_Final_ASB_ePub.xhtml#_idTextAnchor344"><em class="italic">Chapter 15</em></a>, <em class="italic">Voice Communication with a Robot Using Mycroft</em>.</p>
			<p>In this chapter, we will see how to create a menu system to choose behaviors designed for a phone. We will then use the touch surface to build a control system, with the camera in view. You will learn about phone-ready web apps and get control of the robot.</p>
			<p>We will cover the following topics in this chapter:</p>
			<ul>
				<li>When speech control won't work—why we need to drive</li>
				<li>Menu modes—choosing your robot's behavior</li>
				<li>Choosing a controller—how are going to drive the robot, and why</li>
				<li>Preparing the Raspberry Pi for remote driving—get the basic driving system going</li>
				<li>Making the robot fully phone-operable</li>
				<li>Making the menu start when the Pi starts</li>
			</ul>
			<h1 id="_idParaDest-442"><a id="_idTextAnchor397"/>Technical requirements</h1>
			<p>For this chapter, you will need the following items:</p>
			<ul>
				<li>Your Raspberry Pi robot with the camera set up and the code from previous chapters</li>
				<li>A touchscreen device such as a phone with Wi-Fi</li>
				<li>A wireless network</li>
			</ul>
			<p>The GitHub code for this chapter is at <a href="https://github.com/PacktPublishing/Learn-Robotics-Programming-Second-Edition/tree/master/chapter17">https://github.com/PacktPublishing/Learn-Robotics-Programming-Second-Edition/tree/master/chapter17</a>.</p>
			<p>Use the <strong class="source-inline">0_starting_point</strong> folder to find the complete code from the previous chapters and the <strong class="source-inline">full_system</strong> folder on GitHub for this chapter's full code.</p>
			<p>Check out the following video to see the code in action: <a href="https://bit.ly/2Kb7rp8">https://bit.ly/2Kb7rp8</a></p>
			<h1 id="_idParaDest-443"><a id="_idTextAnchor398"/>When speech control won't work – why we need to drive</h1>
			<p>In <a href="B15660_15_Final_ASB_ePub.xhtml#_idTextAnchor344"><em class="italic">Chapter 15</em></a>, <em class="italic">Voice Communication with a Robot Using Mycroft</em>, we built a Mycroft <a id="_idIndexMarker1126"/>system to launch behaviors. If you have tried to build intents to make the robot stop in time or drive left or right, you will have probably noticed that it takes some time to respond even with the clearest speaking.</p>
			<p>Speech control also only really works in a quiet room. If your robot is outside (you would like to drive it somewhere), this is not useful.</p>
			<p>Mycroft is also utterly dependent on having access to the internet. It is one thing to have a small shared network for a robot and a controller; it's another to always require internet access, which can become tricky when not at your home, school, or lab.</p>
			<p>Using an SSH session to log in to a robot, then typing commands to start and stop behaviors works well during testing stages, but it can be slow and cumbersome. In demonstration conditions, mistyping a command or just restarting the SSH session is time-consuming.</p>
			<p>A phone-targeted browser app can be responsive, giving you tight control over the robot's movements. With a local network, it won't need external internet access. You can use this to drive a robot back to you after a behavior has run and you've stopped it, and it can be <a id="_idIndexMarker1127"/>used to halt errant behavior. And with a bit of thought, it can be used to deliver useful—or plain interesting—feedback on what your robot is doing.</p>
			<h1 id="_idParaDest-444"><a id="_idTextAnchor399"/>Menu modes – choosing your robot's behavior</h1>
			<p>Our book has<a id="_idIndexMarker1128"/> introduced quite a collection of robot behaviors and invited you to create more. We've talked about how SSH can be cumbersome to start robot programs—even just remembering the options you have or pressing the <em class="italic">Ctrl</em> + <em class="italic">C</em> combination to stop can be frustrating. </p>
			<p>In this section, we are going to create a menu system to select them. A convenient and phone-friendly way to do this is to serve it to the phone's browser, so we take that approach with our robot. We will also use a desktop browser to test this code.</p>
			<p>We can extend the system we built in the <em class="italic">Starting a behavior remotely</em> section of <a href="B15660_15_Final_ASB_ePub.xhtml#_idTextAnchor344"><em class="italic">Chapter 15</em></a>, <em class="italic">Voice Communication with a Robot Using Mycroft</em>, adding a <strong class="bold">user interface</strong> (<strong class="bold">UI</strong>). We'll make this UI as templates, with some placeholders replaced by code. </p>
			<p>Let's take a look in the following diagram at how this system will work:</p>
			<div>
				<div id="_idContainer286" class="IMG---Figure">
					<img src="Images/B15660_17_01.jpg" alt="" width="650" height="425"/>
				</div>
			</div>
			<p class="figure-caption">Figure 17.1 – How the control server and menu system will work</p>
			<p><em class="italic">Figure 17.1</em> shows an<a id="_idIndexMarker1129"/> overview of the system. Here's how it works:</p>
			<ol>
				<li>The <strong class="bold">client browser</strong> (a phone or computer) makes a page request via <strong class="bold">Wi-Fi</strong> to the <strong class="bold">web server</strong> on the robot for a page to display.</li>
				<li>The <strong class="bold">web server</strong> uses <strong class="bold">robot modes</strong> to get the mode list: a list of scripts it can start.</li>
				<li>The <strong class="bold">web server</strong> sends this mode list to a <strong class="bold">template</strong> to render it into the menu page and send that rendered menu page to the user.</li>
				<li>In the browser, when you touch or click the menu item links in the page, they make control requests to the <strong class="bold">web server</strong>.</li>
				<li>The <strong class="bold">web server</strong> acts on control requests by making control mode calls such as <strong class="source-inline">run</strong> and <strong class="source-inline">stop</strong> to the <strong class="bold">robot modes</strong> system.</li>
				<li>The <strong class="bold">robot modes</strong> system starts/stops the behavior scripts.</li>
				<li>The <strong class="bold">control server</strong> sends a status back to the <strong class="bold">client browser</strong> to say it's been handled.</li>
			</ol>
			<p>Let's start by <a id="_idIndexMarker1130"/>extending the list of scripts (modes) and how the system handles them.</p>
			<h2 id="_idParaDest-445"><a id="_idTextAnchor400"/>Managing robot modes</h2>
			<p>We will revisit<a id="_idIndexMarker1131"/> the code made in <a href="B15660_15_Final_ASB_ePub.xhtml#_idTextAnchor344"><em class="italic">Chapter 15</em></a>, <em class="italic">Voice Communication with a Robot Using Mycroft</em>, extend the list of modes to run, and add a menu configuration.</p>
			<p>Let's expand the number of items our mode system knows about, as follows:</p>
			<ol>
				<li value="1">Open the file called <strong class="source-inline">robot_modes.py</strong>.</li>
				<li>Find the <strong class="source-inline">mode_config</strong> variable in this file. We can extend it with a few more behaviors, as illustrated in the following code snippet:<p class="source-code">    mode_config = {</p><p class="source-code">        "avoid_behavior": "avoid_behavior.py",</p><p class="source-code">        "circle_head": "circle_pan_tilt_behavior.py",</p><p class="source-code">        "test_rainbow": "test_rainbow.py"<strong class="bold">,</strong></p><p class="source-code"><strong class="bold">        "test_leds": "leds_test.py",</strong></p><p class="source-code"><strong class="bold">        "line_following": "line_follow_behavior.py",</strong></p><p class="source-code"><strong class="bold">        "behavior_line": "straight_line_drive.py",</strong></p><p class="source-code"><strong class="bold">        "drive_north": "drive_north.py"</strong></p><p class="source-code">    }</p></li>
				<li>After the <strong class="source-inline">mode_config</strong> variable, we add a list configuring the menu. The order will match menu items on a screen. Each item has a <strong class="source-inline">mode_name</strong> setting<strong class="source-inline">—</strong>matching the short slug in the <strong class="source-inline">mode_config</strong> variable, and <strong class="source-inline">text</strong>—the human-readable label for the menu option, as illustrated in the following code snippet:<p class="source-code">    menu_config = [</p><p class="source-code">        {"mode_name": "avoid_behavior", "text": "Avoid Behavior"},</p><p class="source-code">        {"mode_name": "circle_head", "text": "Circle Head"},</p><p class="source-code">        {"mode_name": "test_leds", "text": "Test LEDs"},</p><p class="source-code">        {"mode_name": "test_rainbow", "text": "LED Rainbow"},</p><p class="source-code">        {"mode_name": "line_following", "text": "Line Following"},</p><p class="source-code">        {"mode_name": "behavior_line", "text": "Drive In A Line"},</p><p class="source-code">        {"mode_name": "drive_north", "text": "Drive North"}</p><p class="source-code">    ]</p><p>If we want to <a id="_idIndexMarker1132"/>add a behavior to the menu, we must add it to both the <strong class="source-inline">menu_config</strong>  and the <strong class="source-inline">mode_config</strong> variables.</p></li>
				<li>To allow a menu user to choose a new mode without pressing a <strong class="bold">Stop</strong> button, we want to make the <strong class="source-inline">run</strong> method cope with this by stopping any existing process, as follows:<p class="source-code">    def run(self, mode_name):</p><p class="source-code"><strong class="bold">        while self.is_running():</strong></p><p class="source-code"><strong class="bold">            self.stop()</strong></p><p class="source-code"><strong class="bold">        script = self.mode_config[mode_name]</strong></p><p class="source-code"><strong class="bold">        self.current_process = subprocess.Popen(["python3", script])</strong></p><p>This file will act as a configuration, and you can expand it to run other code. We can test this now.</p></li>
				<li>Upload <strong class="source-inline">robot_modes.py</strong> to the robot. You should already have the <a href="B15660_15_Final_ASB_ePub.xhtml#_idTextAnchor344"><em class="italic">Chapter 15</em></a>, <em class="italic">Voice Communication with a Robot Using Mycroft</em>, <strong class="source-inline">control_server.py</strong> file uploaded.</li>
				<li>Run this on the Pi with <strong class="source-inline">python3 control_server.py</strong>.</li>
				<li>As we saw in <a href="B15660_15_Final_ASB_ePub.xhtml#_idTextAnchor344"><em class="italic">Chapter 15</em></a>, <em class="italic">Voice Communication with a Robot Using Mycroft</em>, we will use the <strong class="source-inline">curl</strong> command to make a request, like this:<p class="source-code"><strong class="bold">curl -X POST http//myrobot.local:5000/run/test_leds</strong></p><p>This should<a id="_idIndexMarker1133"/> start the <strong class="bold">light-emitting diodes</strong> (<strong class="bold">LEDs</strong>) flashing on the robot.</p></li>
				<li>Let's change behavior—this should stop the current behavior and start a new one. Run<a id="_idIndexMarker1134"/> the following code:<p class="source-code"><strong class="bold">curl -X POST http//myrobot.local:5000/run/circle_head</strong></p><p>The LEDs should stop, and assuming the motors are turned on, the head should start moving.</p></li>
				<li>Let's stop the robot by running the following code:<p class="source-code"><strong class="bold">curl -X POST http//myrobot.local:5000/stop</strong></p></li>
			</ol>
			<p>We have added some further modes and configuration to <strong class="source-inline">robot_modes.py</strong> to describe those modes, and tested them. Let's check for any problems.</p>
			<h2 id="_idParaDest-446"><a id="_idTextAnchor401"/>Troubleshooting</h2>
			<p>When requests<a id="_idIndexMarker1135"/> to the menu sever fail, it can output error codes in the response. There are only three error codes we make use of in our system, as follows:</p>
			<ul>
				<li><strong class="source-inline">200</strong>—This means that the server thinks everything is OK. There may still be a logic problem, but it's not caused a failure.</li>
				<li><strong class="source-inline">404</strong>—This is shown when the server couldn't find a route. This means you may have a typo either in the request you made or in the routers on the server code. Check that they match and try again.</li>
				<li><strong class="source-inline">500</strong>—This means that the server failed in some way. It is usually accompanied by a traceback/exception on the server. This can then be treated as a normal Python error.</li>
			</ul>
			<p>Now that we<a id="_idIndexMarker1136"/> have the mode configuration lists ready, we need the web service to display it.</p>
			<h2 id="_idParaDest-447"><a id="_idTextAnchor402"/>The web service</h2>
			<p>In <a href="B15660_15_Final_ASB_ePub.xhtml#_idTextAnchor344"><em class="italic">Chapter 15</em></a>, <em class="italic">Voice Communication with a Robot Using Mycroft</em>, we'd already wired <strong class="source-inline">robot_modes.py</strong> into<a id="_idIndexMarker1137"/> the <strong class="source-inline">control_server.py</strong> Flask web server. We have used Flask in <a href="B15660_13_Final_ASB_ePub.xhtml#_idTextAnchor283"><em class="italic">Chapter 13</em></a>, <em class="italic">Robot Vision – Using a Pi Camera and OpenCV</em>, to render templates with a video box. In this section, we will make a menu template to show the user their options. </p>
			<p>Let's make the necessary changes to render the template first, as follows:</p>
			<ol>
				<li value="1">Open <strong class="source-inline">control_server.py</strong>.</li>
				<li>Extend the imports of Flask to include <strong class="source-inline">render_template</strong>, as follows:<p class="source-code">from flask import Flask, <strong class="bold">render_template</strong></p><p class="source-code">from robot_modes import RobotModes</p></li>
				<li>As we will have a style sheet we are changing, we need to stop devices holding a stale, cached copy of the sheet. We can do this by adding a header to all responses, like this:<p class="source-code">@app.after_request</p><p class="source-code">def add_header(response):</p><p class="source-code">    response.headers['Cache-Control'] = "no-cache, no-store, must-revalidate"</p><p class="source-code">    return response</p></li>
				<li>We now need to add the route that shows our menu. We will make a template called <strong class="source-inline">menu.html</strong>, which uses the <strong class="source-inline">menu_config</strong> variable to display. Most of our modes need this. Let's add the code to render the template, as follows:<p class="source-code">@app.route("/")</p><p class="source-code">def index():</p><p class="source-code">    return render_template('menu.html', menu=mode_manager.menu_config)</p></li>
			</ol>
			<p>We now have code to render the template building on code we already had to handle <strong class="source-inline">run</strong> and <strong class="source-inline">stop</strong> requests. However, before we can run this service, we need to provide the <a id="_idIndexMarker1138"/>template, <strong class="source-inline">menu.html</strong>. </p>
			<h2 id="_idParaDest-448"><a id="_idTextAnchor403"/>The template</h2>
			<p>Our HTML template <a id="_idIndexMarker1139"/>defines our display and lets us separate how the robot menu looks from how to handle the control system. This template combines HTML (seen in <a href="B15660_13_Final_ASB_ePub.xhtml#_idTextAnchor283"><em class="italic">Chapter 13</em></a>, <em class="italic">Robot Vision – Using a Pi Camera and OpenCV</em>, and <a href="B15660_14_Final_ASB_ePub.xhtml#_idTextAnchor315"><em class="italic">Chapter 14</em></a>, <em class="italic">Line-Following with a Camera in Python</em>) and the <strong class="bold">Jinja2</strong> template system—a way of substituting data. See the <em class="italic">Further reading</em> section to find out more about these systems. We have a <strong class="source-inline">templates</strong> folder from <a href="B15660_15_Final_ASB_ePub.xhtml#_idTextAnchor344"><em class="italic">Chapter 15</em></a>, <em class="italic">Voice Communication with a Robot Using Mycroft</em>—we will add our menu template here. We could add further styling to this template; for now, we'll keep it simple. </p>
			<p>Make a file called <strong class="source-inline">templates</strong>/<strong class="source-inline">menu.html</strong> and then proceed as follows:</p>
			<ol>
				<li value="1">Our template starts with a header that sets the page title and uses the same jQuery tool we saw before, as illustrated in the following code snippet:<p class="source-code"><strong class="bold">&lt;html&gt;</strong></p><p class="source-code"><strong class="bold">&lt;head&gt;</strong></p><p class="source-code"><strong class="bold">    &lt;script src="https://code.jquery.com/jquery-3.5.1.min.js"&gt;&lt;/script&gt;</strong></p><p class="source-code"><strong class="bold">    &lt;title&gt;My Robot Menu&lt;/title&gt;</strong></p><p class="source-code"><strong class="bold">&lt;/head&gt;</strong></p></li>
				<li>The body of our template has the <strong class="source-inline">My Robot Menu</strong> heading. Feel free to change this to your robot's name. The code is shown in the following snippet:<p class="source-code"><strong class="bold">&lt;body&gt;</strong></p><p class="source-code"><strong class="bold">  &lt;h1&gt;My Robot Menu&lt;/h1&gt;</strong></p></li>
				<li>Next, we have a space for a message; it's empty now though, as you can see here:<p class="source-code"><strong class="bold">    &lt;p id="message"&gt;&lt;/p&gt;</strong></p></li>
				<li>The next section is a list—that is the menu itself. We use the <strong class="source-inline">&lt;ul&gt;</strong> tag and then a <strong class="source-inline">for</strong> loop, which creates a list item with a link for each menu item. The double brackets <strong class="source-inline">{{ }}</strong> are used to surround a placeholder, that will be replaced when run. It uses the <strong class="source-inline">mode_name</strong> setting and <strong class="source-inline">text</strong> to make that link, combining <strong class="source-inline">/run</strong> with <a id="_idIndexMarker1140"/>the mode name, as illustrated in the following code snippet:<p class="source-code"><strong class="bold">  &lt;ul&gt;</strong></p><p class="source-code"><strong class="bold">      {% for item in menu %}</strong></p><p class="source-code"><strong class="bold">        &lt;li&gt;</strong></p><p class="source-code"><strong class="bold">            &lt;a href="#" onclick="run('/run/{{ item.mode_name }}')"&gt;</strong></p><p class="source-code"><strong class="bold">                {{ item.text }}</strong></p><p class="source-code"><strong class="bold">            &lt;/a&gt;</strong></p><p class="source-code"><strong class="bold">        &lt;/li&gt;</strong></p><p class="source-code"><strong class="bold">      {% endfor %}</strong></p><p>We are using an onclick handler, so we can handle the <strong class="source-inline">run</strong> action in some code.</p></li>
				<li>Before closing our list, we need to add one more menu item—the <strong class="bold">Stop</strong> button, as follows:<p class="source-code"><strong class="bold">    &lt;li&gt;&lt;a href="#" onclick="run('/stop')"&gt;Stop&lt;/a&gt;&lt;/li&gt;</strong></p><p class="source-code"><strong class="bold">  &lt;/ul&gt;</strong></p></li>
				<li>We talked about handling the <strong class="source-inline">run</strong> action in some JavaScript code. The following code makes POST requests sending data to the web server, and then updates the message from the response. We need to put it in <strong class="source-inline">&lt;script&gt;</strong> tags, as follows:<p class="source-code"><strong class="bold">  &lt;script&gt;</strong></p><p class="source-code"><strong class="bold">    function run(url) {</strong></p><p class="source-code"><strong class="bold">      $.post(url, '', response =&gt; $('#message').html(response))</strong></p><p class="source-code"><strong class="bold">    }</strong></p><p class="source-code"><strong class="bold">  &lt;/script&gt;</strong></p><p>The <strong class="source-inline">run</strong> function calls the .<strong class="source-inline">post</strong> method with the <strong class="bold">Uniform Resource Locator</strong> (<strong class="bold">URL</strong>) and<a id="_idIndexMarker1141"/> empty data. When it receives a response, it will set the content of the message element to it. The <strong class="source-inline">=&gt;</strong> operator is JavaScript shorthand for defining a small function—in this case, one that has the <strong class="source-inline">response</strong> parameter. An important idea in JavaScript is that a function can be a bit of data. In <a id="_idIndexMarker1142"/>JavaScript, passing a function in as a parameter to another function is a common way to do things. Because we often use this, functions used that way are not even given names; they are anonymous functions or lambdas.</p></li>
				<li>Now, we can close our HTML document, like this:<p class="source-code"><strong class="bold">&lt;/body&gt;</strong></p><p class="source-code"><strong class="bold">&lt;/html&gt;</strong></p></li>
			</ol>
			<p>The nice thing with a template such as this is that you can preview this code in a browser without the server and make sense of how it should look. The following screenshot shows it in preview mode:</p>
			<div>
				<div id="_idContainer287" class="IMG---Figure">
					<img src="Images/B15660_17_02.jpg" alt="" width="1137" height="382"/>
				</div>
			</div>
			<p class="figure-caption">Figure 17.2 – Previewing the template</p>
			<p>When you view the preview, as shown in <em class="italic">Figure 17.2</em>, the template placeholders are showing as<a id="_idIndexMarker1143"/> the browser doesn't know how to render them.</p>
			<p>You need to run the app to see it properly rendered.</p>
			<h2 id="_idParaDest-449"><a id="_idTextAnchor404"/>Running it</h2>
			<p>Upload<a id="_idIndexMarker1144"/> the <strong class="source-inline">robot_modes.py</strong> and <strong class="source-inline">control_server.py</strong> files to the robot, and then the <strong class="source-inline">templates</strong> folder. On the Raspberry Pi, via SSH, you can start it with the following command:</p>
			<p class="source-code">pi@myrobot:~ $ <strong class="bold">python3 control_server.py</strong> </p>
			<p class="source-code"> * Serving Flask app "control_server" (lazy loading)</p>
			<p class="source-code"> * Environment: production</p>
			<p class="source-code">   WARNING: This is a development server. Do not use it in a production deployment.</p>
			<p class="source-code">   Use a production WSGI server instead.</p>
			<p class="source-code"> * Debug mode: on</p>
			<p class="source-code"> * Running on http://0.0.0.0:5000/ (Press CTRL+C to quit)</p>
			<p class="source-code"> * Restarting with stat</p>
			<p class="source-code"> * Debugger is active!</p>
			<p class="source-code"> * Debugger PIN: 270-549-285</p>
			<p>You can now point your browser at your robot (<strong class="source-inline">http://myrobot.local:5000/</strong>) to see the menu. The following screenshot shows how it should look:</p>
			<div>
				<div id="_idContainer288" class="IMG---Figure">
					<img src="Images/B15660_17_03.jpg" alt="" width="891" height="392"/>
				</div>
			</div>
			<p class="figure-caption">Figure 17.3 – My Robot Menu in a browser</p>
			<p><em class="italic">Figure 17.3</em> now shows the list rendered. We now see all the menu items instead of the template placeholders. You should be able to click a mode and see the robot start that behavior. Clicking <strong class="bold">Stop</strong> causes the <strong class="source-inline">robot_modes.py</strong> code to send the equivalent of a <em class="italic">Ctrl</em> + <em class="italic">C</em> action to the running behavior script, making it stop.</p>
			<p>When you click a behavior or stop, it shows the output in the message area, as shown in the following<a id="_idIndexMarker1145"/> screenshot:</p>
			<div>
				<div id="_idContainer289" class="IMG---Figure">
					<img src="Images/B15660_17_04.jpg" alt="" width="1093" height="508"/>
				</div>
			</div>
			<p class="figure-caption">Figure 17.4 – The stopped message</p>
			<p><em class="italic">Figure 17.4</em> shows the menu again. I've clicked the <strong class="bold">Stop</strong> button, so the menu shows the <strong class="bold">Stopped</strong> response message.</p>
			<p>Notice in the following code snippet that the behavior's outputs—its <strong class="source-inline">print</strong> statements—are coming out in the web server console:</p>
			<p class="source-code">192.168.1.149 - - [17/Oct/2020 22:42:57] "POST /run/test_leds HTTP/1.1" 200 -</p>
			<p class="source-code">red</p>
			<p class="source-code">blue</p>
			<p class="source-code">red</p>
			<p class="source-code">blue</p>
			<p class="source-code">red</p>
			<p class="source-code">Traceback (most recent call last):</p>
			<p class="source-code">  File "leds_test.py", line 16, in &lt;module&gt;</p>
			<p class="source-code">    sleep(0.5)</p>
			<p class="source-code">KeyboardInterrupt</p>
			<p class="source-code">192.168.1.149 - - [17/Oct/2020 22:43:41] "POST /stop HTTP/1.1" 200 -</p>
			<p>You need to press <em class="italic">Ctrl</em> + <em class="italic">C</em> on the Pi to exit this menu server app. </p>
			<p class="callout-heading">Important note</p>
			<p class="callout">This tiny robot web app has no security mechanism, authentication, or passwords. It is beyond this book's scope but is a serious consideration worth further research if you plan to use this on shared Wi-Fi.</p>
			<p>There are ways<a id="_idIndexMarker1146"/> to get the console output from a script onto the page. I recommend looking at the additional reading recommendations in the <em class="italic">Further reading</em> section for Flask. </p>
			<h2 id="_idParaDest-450"><a id="_idTextAnchor405"/>Troubleshooting</h2>
			<p>Hopefully, this all <a id="_idIndexMarker1147"/>works, but if you have any problems try the following steps:</p>
			<ul>
				<li>The output log shows the return codes from the web system. You can use these status codes—as you've seen before—to troubleshoot.</li>
				<li><strong class="source-inline">200</strong>—The system thinks everything is OK. If it failed to run something, check the <strong class="source-inline">run</strong> function.</li>
				<li><strong class="source-inline">404</strong>—Not found. Have you matched the routes?</li>
				<li><strong class="source-inline">500</strong>—You should see a Python error with this too. </li>
				<li>If the render shows the display <strong class="source-inline">{ item.text }</strong>, this needs double curly brackets for the template system to work.</li>
				<li>If you see an error such as <strong class="source-inline">jinja2.exceptions.TemplateSyntaxError: unexpected '&lt;'</strong>, then you'll need to verify you have typed out the preceding template—you are likely to have missed a closing curly bracket ( <strong class="source-inline">}</strong>).</li>
			</ul>
			<p>You now have a menu system to start different robot behaviors and stop them. You can point your phone at it—although it's not particularly phone-friendly yet. We have only scratched the <a id="_idIndexMarker1148"/>surface of this, and this system is quite rudimentary. </p>
			<p>We'll start looking at a more interesting phone interface for driving the robot, but we can first look at options other than smartphones.</p>
			<h1 id="_idParaDest-451"><a id="_idTextAnchor406"/>Choosing a controller — how we are going to drive the robot, and why</h1>
			<p>We want to be<a id="_idIndexMarker1149"/> able to control our robot with something that is handheld and wireless. Trailing a wire to our robot would make little sense. Having seen how our robot drives in <a href="B15660_07_Final_ASB_ePub.xhtml#_idTextAnchor131"><em class="italic">Chapter 7</em></a>, <em class="italic">Drive and Turn – Moving Motors with Python</em>, we will want a control system that directly affects the wheels.</p>
			<p>One way to do this would be to use a Bluetooth joypad. There are a large number of these on the market, which may require specialist drivers to read. Bluetooth has a habit of dropping pairings at inopportune times. </p>
			<p>Some joypads use a custom wireless dongle; these are far more reliable than Bluetooth but have a dongle that doesn't fit very nicely on the robot.</p>
			<p>However, you already have a handheld device in your pocket: your phone. It has a touchscreen, capable of reading finger movements. With a bit of the right code, you can display the video between controller bars, creating a kind of robotic <em class="italic">periscope</em> you can drive around and see (it's quite tricky to drive on camera—harder than overhead). We've already been building web applications for our robot to access via Wi-Fi, and most phones can connect to that. So, instead of going out and buying a new joypad, we will make a web app that your phone can access to drive the robot and see a robot's-eye view of the world. </p>
			<h2 id="_idParaDest-452"><a id="_idTextAnchor407"/>Design and overview</h2>
			<p>To make<a id="_idIndexMarker1150"/> a <a id="_idIndexMarker1151"/>phone web app, a little bit of design on how we would expect this to work is needed. This design could be as simple as a pen drawing on a scrap of paper or using a drawing tool to get professional-looking results. The next screenshot shows a screen mockup of this:</p>
			<div>
				<div id="_idContainer290" class="IMG---Figure">
					<img src="Images/B15660_17_05.jpg" alt="" width="1377" height="620"/>
				</div>
			</div>
			<p class="figure-caption">Figure 17.5 – Screen mockup of driving web app</p>
			<p>The<a id="_idIndexMarker1152"/> mockup in <em class="italic">Figure 17.5</em> shows a mobile phone screen in landscape mode. The<a id="_idIndexMarker1153"/> top of the screen has an <strong class="bold">Exit</strong> button, and we can set this up to go to our menu after instructing the app to exit.</p>
			<p>The middle of the screen has a video feed from the robot, using the mechanism from the <em class="italic">Building a Raspberry Pi camera stream app</em> in <a href="B15660_13_Final_ASB_ePub.xhtml#_idTextAnchor283"><em class="italic">Chapter 13</em></a>, <em class="italic">Robot Vision – Using a Pi Camera and OpenCV</em>. The left and right have sliders. The next screenshot shows how this works:</p>
			<div>
				<div id="_idContainer291" class="IMG---Figure">
					<img src="Images/B15660_17_06.jpg" alt="" width="1389" height="484"/>
				</div>
			</div>
			<p class="figure-caption">Figure 17.6 – Slider return to middle behavior</p>
			<p><em class="italic">Figure 17.6</em> shows <a id="_idIndexMarker1154"/>the slider mechanism. As with an analog joystick, you can<a id="_idIndexMarker1155"/> drag the sliders to any position on their track with touches, and when let go, they will spring back to the middle.</p>
			<p>Note that they don't immediately drop to the middle when let go but animate back to this over a few frames. We'll need a little math to make that happen in our code. </p>
			<p>These sliders let you drive the robot tank-style (with a joypad, you could use two analog sticks for this). Each slider controls the speed of a motor. While this sounds tricky (not like driving a car), it is an elegant way to drive a two-wheeled robot with a little practice. The further away from the middle you slide a slider, the faster the associated motor will go. We will also ensure that the robot motors will stop after a second if communication is lost. </p>
			<p>This control of left speed and right speed is the same control system your behaviors have been using throughout the book, but has been made interactive. The next diagram shows some of the motions needed for typical moves:</p>
			<div>
				<div id="_idContainer292" class="IMG---Figure">
					<img src="Images/B15660_17_07.jpg" alt="" width="1182" height="1165"/>
				</div>
			</div>
			<p class="figure-caption">Figure 17.7 – Common moves on two sliders</p>
			<p>The red dots<a id="_idIndexMarker1156"/> in <em class="italic">Figure 17.7</em> represent where your thumb is touching the<a id="_idIndexMarker1157"/> screen. By sliding both forward the robot will drive forward, and the further you slide them, the faster it will go. A backward action slides them both back. To spin the robot, slide them in opposite directions. To drive forward and a little left or right, you slide both forward but bring the right slider a little higher than the left. You are also able to compensate for veer this way.</p>
			<p>We have a nice user interface design. To start building this, we will plan the code blocks we will <a id="_idIndexMarker1158"/>need, and <a id="_idIndexMarker1159"/>write the code to make them work in the real world.</p>
			<h1 id="_idParaDest-453"><a id="_idTextAnchor408"/>Preparing the Raspberry Pi for remote driving—get the basic driving system going</h1>
			<p>Our Raspberry <a id="_idIndexMarker1160"/>Pi has already been able to run web services, using Flask to create a menu server and video servers. We can use image and control queues to make a behavior interact with a web server. We are going to reuse these capabilities. In the phone app, the slider controls will need to be smart. The next diagram shows the parts of our manual drive system:</p>
			<div>
				<div id="_idContainer293" class="IMG---Figure">
					<img src="Images/B15660_17_08.jpg" alt="" width="977" height="891"/>
				</div>
			</div>
			<p class="figure-caption">Figure 17.8 – The system overview of a manual drive app</p>
			<p>The dashed boxes in <em class="italic">Figure 17.8</em> show where the code is running, with the top dashed box being code running on the phone, and the lower box being code running on the Raspberry Pi in the robot. Inside the dashed boxes, the boxes with solid outlines are blocks of code or systems our code will need. At the bottom layer of <em class="italic">Figure 17.8</em>, the <strong class="bold">Robot</strong> box accepts the <strong class="bold">stop motors</strong> and <strong class="bold">set motor speed</strong> calls. These are from the <strong class="bold">Behavior</strong> box based on timeouts or the <strong class="bold">control message queue</strong> from the <strong class="bold">Flask Web Server</strong>. Meanwhile, the <strong class="bold">Behavior</strong> loop will also be taking <strong class="bold">image frames</strong> from the <strong class="bold">camera</strong>, encoding them and pushing them onto the <strong class="bold">display frame queue</strong>.</p>
			<p>The next layer up is the <strong class="bold">Flask Web Server</strong>. This server consumes the <strong class="bold">display frame queue</strong> supplying<a id="_idIndexMarker1161"/> frames to the multi-part <strong class="bold">image feed</strong>. The Flask server will handle <strong class="bold">control requests</strong> and push them onto the <strong class="bold">control message queue</strong>. </p>
			<p>A <strong class="bold">Page Script</strong> handles <strong class="bold">slider updates</strong> and turns them into <strong class="bold">control requests</strong> using the jQuery library. The <strong class="bold">Slider Gadget</strong> turns <strong class="bold">touches</strong> into <strong class="bold">slider updates</strong> (it will be doing animation and converting for this). </p>
			<p>The page itself uses an <strong class="source-inline">img</strong> tag to display the <strong class="bold">video</strong> feed, as before, and places the slider widgets. The <strong class="bold">Exit</strong> button makes a control request. </p>
			<p>The <strong class="bold">Page Script</strong> and <strong class="bold">Slider Gadget</strong> will require JavaScript and <strong class="bold">Cascading Style Sheets</strong> (<strong class="bold">CSS</strong>) programming. Before <a id="_idIndexMarker1162"/>we start that, we need to take the image core from <a href="B15660_14_Final_ASB_ePub.xhtml#_idTextAnchor315"><em class="italic">Chapter 14</em></a>, <em class="italic">Line-Following with a Camera in Python</em>, and build more features to deliver the code to the browser.</p>
			<h2 id="_idParaDest-454"><a id="_idTextAnchor409"/>Enhancing the image app core</h2>
			<p>To build this, we<a id="_idIndexMarker1163"/> will start by adding some static file links and reusing the image app core we last used in <a href="B15660_14_Final_ASB_ePub.xhtml#_idTextAnchor315"><em class="italic">Chapter 14</em></a>, <em class="italic">Line-Following with a Camera in Python</em>. </p>
			<p>Static files do not cause the robot to do something; the system passively serves them. We will be serving JavaScript and CSS, along with a local copy of the jQuery library. Flask does this automatically.</p>
			<p>Let's set up the static files folder, as follows:</p>
			<ol>
				<li value="1">Create a <strong class="source-inline">static</strong> folder. We will put JavaScript and CSS code in this <strong class="source-inline">static</strong> folder.</li>
				<li>We will make a local copy of the jQuery library. Make a <strong class="source-inline">lib</strong> directory under <strong class="source-inline">static</strong>.</li>
				<li>Download jQuery from <a href="https://code.jquery.com/jquery-3.5.1.min.js">https://code.jquery.com/jquery-3.5.1.min.js</a>, press the browser <strong class="bold">Save</strong> button, and store it in the <strong class="source-inline">lib</strong> folder. You should have a <strong class="source-inline">static/lib/jquery-3.5.1.min.js</strong> file.</li>
				<li>In the <strong class="source-inline">image_app_core.py</strong> file, we also need to stop it using cached files so that it reloads our CSS and JavaScript files, as follows:<p class="source-code"><strong class="bold">@app.after_request</strong></p><p class="source-code"><strong class="bold">def add_header(response):</strong></p><p class="source-code"><strong class="bold">    response.headers['Cache-Control'] = "no-cache, no-store, must-revalidate"</strong></p><p class="source-code"><strong class="bold">    return response</strong></p></li>
			</ol>
			<p>The app core <a id="_idIndexMarker1164"/>now has a static copy of jQuery we can use offline, so our phone doesn't have to rely on a good signal to talk to the robot.</p>
			<h2 id="_idParaDest-455"><a id="_idTextAnchor410"/>Writing the manual drive behavior</h2>
			<p>The next<a id="_idIndexMarker1165"/> part we will need is the behavior. It builds on concepts from the code seen before in <a href="B15660_14_Final_ASB_ePub.xhtml#_idTextAnchor315"><em class="italic">Chapter 14</em></a>, <em class="italic">Line-Following with a Camera in Python</em>, with control messages changing motor speeds and a plain video output. </p>
			<p>This system will have a timeout—if no control messages arrive for 1 second, it will stop driving. It can be quite frustrating to watch a robot drive off into the distance or off a desk, so it will revert to stopping if nothing is making sense.</p>
			<p>Let's build it, as follows:</p>
			<ol>
				<li value="1">Start a file called <strong class="source-inline">manual_drive.py</strong> with imports for the camera and control, like this:<p class="source-code"><strong class="bold">import time</strong></p><p class="source-code"><strong class="bold">from robot import Robot</strong></p><p class="source-code"><strong class="bold">from image_app_core import start_server_process, get_control_instruction, put_output_image</strong></p><p class="source-code"><strong class="bold">import camera_stream</strong></p></li>
				<li>We can declare what we want the timeout threshold to be in seconds, as illustrated in the following code snippet:<p class="source-code"><strong class="bold">TIMEOUT_IN_SECONDS = 1</strong></p></li>
				<li>We'll make a <strong class="source-inline">ManualDriveBehavior</strong> class. In this, we'll store a <strong class="source-inline">robot</strong> object and track time, as illustrated in the following code snippet:<p class="source-code"><strong class="bold">class ManualDriveBehavior(object):</strong></p><p class="source-code"><strong class="bold">    def __init__(self, robot):</strong></p><p class="source-code"><strong class="bold">        self.robot = robot</strong></p><p class="source-code"><strong class="bold">        self.last_time = time.time()</strong></p></li>
				<li>Next, build <a id="_idIndexMarker1166"/>the control section of this behavior. It resets the last time for every instruction. The code can be seen in the following snippet:<p class="source-code"><strong class="bold">    def process_control(self):</strong></p><p class="source-code"><strong class="bold">        instruction = get_control_instruction()</strong></p><p class="source-code"><strong class="bold">        while instruction:</strong></p><p class="source-code"><strong class="bold">            self.last_time = time.time()</strong></p><p class="source-code"><strong class="bold">            self.handle_instruction(instruction)</strong></p><p class="source-code"><strong class="bold">            instruction = get_control_instruction()</strong></p><p>Notice that this will loop until there are no further instructions, since you could queue more than one while waiting for a camera frame. We prime this with the next instruction. It delegates handling to <strong class="source-inline">self.handle_instruction</strong>.</p></li>
				<li>Our code processes the instruction in <strong class="source-inline">handle_instruction</strong>. This instruction is a dictionary, with an instruction name and parameters as its members. We can check if this command is <strong class="source-inline">set_left</strong> or <strong class="source-inline">set_right</strong>, as illustrated in the following code snippet:<p class="source-code"><strong class="bold">    def handle_instruction(self, instruction):</strong></p><p class="source-code"><strong class="bold">        command = instruction['command']</strong></p><p class="source-code"><strong class="bold">        if command == "set_left":</strong></p><p class="source-code"><strong class="bold">            self.robot.set_left(int(instruction['speed']))</strong></p><p class="source-code"><strong class="bold">        elif command == "set_right":</strong></p><p class="source-code"><strong class="bold">            self.robot.set_right(int(instruction['speed']))</strong></p><p>If it matches, we set the robot motor speed. The speed will currently be a string, so we use <strong class="source-inline">int</strong> to convert it into an integer number for our motors. </p></li>
				<li>We also need to handle the <strong class="source-inline">exit</strong> command, as follows:<p class="source-code"><strong class="bold">        elif command == "exit":</strong></p><p class="source-code"><strong class="bold">            print("stopping")</strong></p><p class="source-code"><strong class="bold">            exit()</strong></p></li>
				<li>It would <a id="_idIndexMarker1167"/>be useful, at least when testing, to know whether we have an unknown instruction. Let's handle that case by raising an exception, as follows:<p class="source-code"><strong class="bold">        else:</strong></p><p class="source-code"><strong class="bold">            raise ValueError(f"Unknown instruction: {instruction}")</strong></p></li>
				<li>Our app also needs to make a display, putting the frame on the server image queue, as follows:<p class="source-code"><strong class="bold">    def make_display(self, frame):</strong></p><p class="source-code"><strong class="bold">        encoded_bytes = camera_stream.get_encoded_bytes_for_frame(frame)</strong></p><p class="source-code"><strong class="bold">        put_output_image(encoded_bytes)</strong></p></li>
				<li>The behavior then has a <strong class="source-inline">run</strong> method to perform the setup and the main loop. We start by setting the pan and tilt to look straight ahead, warm up the camera, and stop the servos, as follows:<p class="source-code"><strong class="bold">    def run(self):</strong></p><p class="source-code"><strong class="bold">        self.robot.set_pan(0)</strong></p><p class="source-code"><strong class="bold">        self.robot.set_tilt(0)</strong></p><p class="source-code"><strong class="bold">        camera = camera_stream.setup_camera()</strong></p><p class="source-code"><strong class="bold">        time.sleep(0.1)</strong></p><p class="source-code"><strong class="bold">        self.robot.servos.stop_all()</strong></p><p class="source-code"><strong class="bold">        print("Setup Complete")</strong></p></li>
				<li>We then loop over frames from the camera and process control instructions, as follows:<p class="source-code"><strong class="bold">        for frame in camera_stream.start_stream(camera):</strong></p><p class="source-code"><strong class="bold">            self.make_display(frame)</strong></p><p class="source-code"><strong class="bold">            self.process_control()</strong></p></li>
				<li>We finally make it auto stop based on the timeout, as follows:<p class="source-code"><strong class="bold">            if time.time() &gt; self.last_time + TIMEOUT_IN_SECONDS:</strong></p><p class="source-code"><strong class="bold">                self.robot.stop_motors()</strong></p></li>
				<li>We add<a id="_idIndexMarker1168"/> the top-level code to create and start the components, as follows:<p class="source-code"><strong class="bold">print("Setting up")</strong></p><p class="source-code"><strong class="bold">behavior = ManualDriveBehavior(Robot())</strong></p><p class="source-code"><strong class="bold">process = start_server_process('manual_drive.html')</strong></p></li>
				<li>We still want to ensure we stop the server when we exit or hit an error, so we run the following code:<p class="source-code"><strong class="bold">try:</strong></p><p class="source-code"><strong class="bold">    behavior.run()</strong></p><p class="source-code"><strong class="bold">except:</strong></p><p class="source-code"><strong class="bold">    process.terminate()</strong></p></li>
			</ol>
			<p>The behavior backend is complete but it needs a template to see it, along with style and code to run on the phone.</p>
			<h2 id="_idParaDest-456"><a id="_idTextAnchor411"/>The template (web page)</h2>
			<p>The template <a id="_idIndexMarker1169"/>is where we will place our sliders and some of the code to handle them. </p>
			<p>Let's get into it, as follows:</p>
			<ol>
				<li value="1">Create a <strong class="source-inline">templates/manual_drive.html</strong> file. Start with the HTML preamble, as follows:<p class="source-code"><strong class="bold">&lt;html&gt;</strong></p><p class="source-code"><strong class="bold">    &lt;head&gt;</strong></p></li>
				<li>We want the display to fit on a phone, adapting to the display size. We also don't want the user's touch interactions to accidentally scale the display. This line of code tells the browser that this is our intention:<p class="source-code"><strong class="bold">        &lt;meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"&gt;</strong></p></li>
				<li>We want to style this (and potentially our other interfaces). For this, we use a  <strong class="source-inline">display.css</strong> style sheet, as illustrated in the following code snippet:<p class="source-code"><strong class="bold">        &lt;link rel="stylesheet" type="text/css" href="/static/display.css?"&gt;</strong></p></li>
				<li>We are going to use the jQuery library to make things interactive, and we'll build a<a id="_idIndexMarker1170"/> touch-slider system. These are the HTML equivalent of imports:<p class="source-code"><strong class="bold">        &lt;script src="/static/lib/jquery-3.5.1.min.js"&gt;&lt;/script&gt;</strong></p><p class="source-code"><strong class="bold">        &lt;script src="/static/touch-slider.js?"&gt;&lt;/script&gt;</strong></p><p>We are going to place a very specific bit of style here in this file. The rest comes from the style sheet. We want this behavior's view to take up the whole screen and not scroll. The code can be seen here:</p><p class="source-code"><strong class="bold">        &lt;style&gt;html, body {margin: 0; height: 100%; overflow: hidden}&lt;/style&gt;</strong></p></li>
				<li>The head ends with a title to go on the top of the tab, as follows:<p class="source-code"><strong class="bold">        &lt;title&gt;Manually Drive The Robot&lt;/title&gt;</strong></p><p class="source-code"><strong class="bold">    &lt;/head&gt;</strong></p></li>
				<li>We now <a id="_idIndexMarker1171"/>start the body with the first slider; we define this with <strong class="bold">Scalable Vector Graphics</strong> (<strong class="bold">SVG</strong>). SVG let us draw things inside a browser. HTML requires us to contain SVG parts in a <strong class="source-inline">svg</strong> tag, which we'll use to make the slider track, as illustrated in the following code snippet:<p class="source-code"><strong class="bold">    &lt;body&gt;</strong></p><p class="source-code"><strong class="bold">        &lt;svg id="left_slider" class="slider_track" viewBox="-10 -100 20 200"&gt;</strong></p><p>The <strong class="source-inline">slider_track</strong> class lets us style both tracks—we use HTML classes to identify multiple objects. The <strong class="source-inline">left_slider</strong> ID will help us position and add touch events to it. IDs in HTML are usually used to reference one object uniquely.</p><p>The <strong class="source-inline">viewBox</strong> attribute defines the dimensions of the drawing internal to <strong class="source-inline">svg</strong> as lower <em class="italic">x</em>, lower <em class="italic">y</em>, width, and height. View box coordinates make sense even if we scale the <strong class="source-inline">svg</strong> element for a different device. The height range is -100/100, equivalent <a id="_idIndexMarker1172"/>to the motor speeds, and the width range is -10 to +10.</p></li>
				<li>Inside the container, we will draw a circle. The circle needs a radius <strong class="source-inline">r</strong>, which we can give in view box units. The center will be 0 in both directions. The code for this is shown here:<p class="source-code"><strong class="bold">            &lt;circle r="18" class="slider_tick"/&gt;</strong></p><p>The circle's color will come from the style sheet.</p></li>
				<li>Next, we need an <strong class="source-inline">Exit</strong> link to finish the behavior. It has a class and ID to style it, as illustrated in the following code snippet:<p class="source-code"><strong class="bold">        &lt;a class="button" id="exitbutton" href="/exit"&gt;Exit&lt;/a&gt;</strong></p><p>We will associate the <strong class="source-inline">button</strong> class with fonts and colors, and we can use the style for other buttons (for example, to enhance the menu app). We'll use the <strong class="source-inline">exitbutton</strong> ID to position this in the place we designed before.</p></li>
				<li>Next, we have our video block. The <strong class="source-inline">img</strong> tag for the video is contained inside a <strong class="source-inline">div</strong> tag to preserve our video ratio on any size screen while letting it resize to fit the space, as illustrated in the following code snippet:<p class="source-code"><strong class="bold">        &lt;div id="video"&gt;&lt;img src="{{ url_for('display') }}" /&gt;&lt;/div&gt;</strong></p></li>
				<li>The right slider is a repeat of the left, with only the ID being different. You could copy and paste the left code, changing the ID. The code can be seen here:<p class="source-code"><strong class="bold">        &lt;svg id="right_slider" class="slider_track" viewBox="-10 -100 20 200"&gt;</strong></p><p class="source-code"><strong class="bold">            &lt;circle r="18" class="slider_tick"/&gt;</strong></p><p class="source-code"><strong class="bold">        &lt;/svg&gt;</strong></p></li>
				<li>We will need some JavaScript code in our HTML for the sliders. The code on the page will link slider code to the graphics we have and to the motors. First, we declare the JavaScript block, as follows:<p class="source-code"><strong class="bold">        &lt;script type="text/javascript"&gt;</strong></p></li>
				<li>Add a<a id="_idIndexMarker1173"/> function to send motor controls to the robot. It takes a name (left or right) and a speed, as illustrated in the following code snippet:<p class="source-code"><strong class="bold">            function set_motor(name, speed) {</strong></p><p class="source-code"><strong class="bold">                $.post('/control', {'command': 'set_' + name, 'speed': speed});</strong></p><p class="source-code"><strong class="bold">            }</strong></p><p>We POST this control instruction to the server.</p></li>
				<li>The next bit of code must only run after the page has completed loading; we want to ensure the preceding JavaScript libraries are fully loaded. jQuery has a special function, <strong class="source-inline">$()</strong>, which will run any function passed to it when the page has completed loading, as illustrated in the following code snippet:<p class="source-code"><strong class="bold">            $(() =&gt; {</strong></p></li>
				<li>We need to link the exit button to a POST request, which forwards to the menu when done, as illustrated in the following code snippet:<p class="source-code"><strong class="bold">                $('#exitbutton').click(function() {</strong></p><p class="source-code"><strong class="bold">                    $.post('/control', {'command': 'exit'});</strong></p><p class="source-code"><strong class="bold">                    window.location.replace('//' + window.location.hostname + ":5000");</strong></p><p class="source-code"><strong class="bold">                });</strong></p></li>
				<li>We set up the sliders and link them with their <strong class="source-inline">svg</strong> element IDs and <strong class="source-inline">set_motor</strong> so that they will update this every time they change, as illustrated<a id="_idIndexMarker1174"/> in the following code snippet:<p class="source-code"><strong class="bold">                makeSlider('left_slider', speed =&gt; set_motor('left', speed));</strong></p><p class="source-code"><strong class="bold">                makeSlider('right_slider', speed =&gt; set_motor('right', speed));</strong></p><p class="source-code"><strong class="bold">            });</strong></p><p>For each side, we use <strong class="source-inline">makeSlider</strong>, which uses <strong class="source-inline">id</strong> for the ID of the object we are turning into a slider (a <strong class="source-inline">svg</strong> track), and a function to call when the slider has changed.</p></li>
				<li>We now end our page by closing all the tags, as follows:<p class="source-code"><strong class="bold">        &lt;/script&gt;</strong></p><p class="source-code"><strong class="bold">    &lt;/body&gt;</strong></p><p class="source-code"><strong class="bold">&lt;/html&gt;</strong></p></li>
			</ol>
			<p>This page has no style; by default, the video and sliders have no shape, size, or color—so, if you try to load this, it will show a blank page. We've yet to tell the browser where we want things on the page or which colors to make them. We also don't have the slider code yet. </p>
			<p>We've made the code to send the exit button and link sliders with tags. In the next section, we'll add a style sheet to make things visible.</p>
			<h2 id="_idParaDest-457"><a id="_idTextAnchor412"/>The style sheet</h2>
			<p>We can now <a id="_idIndexMarker1175"/>give our app some style. Style sheets take time to tune and get just right, so this is just a taste of what it can do. If you think my color choices are terrible, please feel free to substitute your own; I suggest using w3c colors at <a href="https://www.w3schools.com/colors/default.asp">https://www.w3schools.com/colors/default.asp</a>. You can use named or hex (<strong class="source-inline">#1ab3c5</strong>) colors. </p>
			<p>The essence of CSS is to select elements on the page and associate style attributes with them. CSS style sections start with a <strong class="bold">selector</strong> to match HTML page objects. Some examples are tag names, class names prefixed with a full stop, or IDs prefixed with a <strong class="source-inline">#</strong> mark. For a comprehensive look at CSS selectors, see the <em class="italic">Further reading</em> section. Each section uses braces <strong class="source-inline">{}</strong> to delimit a section of style. A section's styles consist of a property name, a colon <strong class="source-inline">:</strong>, and a setting. A semicolon <strong class="source-inline">;</strong> follows these to end each setting.</p>
			<p>Let's make the style, as follows:</p>
			<ol>
				<li value="1">Create a <strong class="source-inline">static/display.css</strong> file to hold this style information.<p>We can set our slider track to 10% of the viewport width—that is, 10% as big as the screen. CSS has a special unit, <strong class="source-inline">vw</strong>, for this, along with <strong class="source-inline">vh</strong> for percentage of the viewport height. See the <em class="italic">Further reading</em> section for notes on CSS units. This code uses the <strong class="source-inline">.slider_track</strong> CSS selector, which applies to all objects with that class. Both sliders have this class, so changes here affect both of them. The code can be seen here:</p><p class="source-code"><strong class="bold">.slider_track {</strong></p><p class="source-code"><strong class="bold">    width: 10vw;</strong></p><p class="source-code"><strong class="bold">    height: 90vh;</strong></p></li>
				<li>We'll give the slider track a solid blue border and a light blue background to match our mockups, as follows: <p class="source-code"><strong class="bold">    border: 1px solid blue;</strong></p><p class="source-code"><strong class="bold">    background-color: lightblue;</strong></p><p class="source-code"><strong class="bold">}</strong></p></li>
				<li>To style the tick, the circle we see on the sliders, we can add a light pinkish fill color, like our mockups, as follows:<p class="source-code"><strong class="bold">.slider_tick {</strong></p><p class="source-code"><strong class="bold">    fill: mistyrose;</strong></p><p class="source-code"><strong class="bold">}</strong></p></li>
				<li>Next, we want to position the sliders (by their IDs) to the left and right. When making a display match closely to the screen mockup, we can use <strong class="bold">absolute positioning</strong> with viewport percentages to say exactly where things should be, as follows:<p class="source-code"><strong class="bold">#left_slider {</strong></p><p class="source-code"><strong class="bold">    position: absolute;</strong></p><p class="source-code"><strong class="bold">    left: 5vw;</strong></p><p class="source-code"><strong class="bold">    top: 5vh;</strong></p><p class="source-code"><strong class="bold">}</strong></p><p class="source-code"><strong class="bold">#right_slider {</strong></p><p class="source-code"><strong class="bold">    position: absolute;</strong></p><p class="source-code"><strong class="bold">    right: 5vw;</strong></p><p class="source-code"><strong class="bold">    top: 5vh;</strong></p><p class="source-code"><strong class="bold">}</strong></p></li>
				<li>You can try<a id="_idIndexMarker1176"/> this now by uploading it, stopping the running behavior, starting it again, and then reloading. The sliders look better, but the exit button and video are in the wrong place. </li>
				<li>Let's make the exit button more like a button. Styles under <strong class="source-inline">.button</strong> will apply to all buttons with the same class. We will make it a block—an element that uses width and height properties. This block is 10% of the viewport height. The code can be seen here:<p class="source-code"><strong class="bold">.button {</strong></p><p class="source-code"><strong class="bold">    display: block;</strong></p><p class="source-code"><strong class="bold">    height: 10vh;</strong></p></li>
				<li>Then, we align the text in the middle with <strong class="source-inline">line-height</strong> and <strong class="source-inline">text-align</strong>, then use <strong class="source-inline">2em</strong> to mean twice normal text size, as follows:<p class="source-code"><strong class="bold">    text-align: center;</strong></p><p class="source-code"><strong class="bold">    font-size: 2em;</strong></p><p class="source-code"><strong class="bold">    line-height: 10vh;</strong></p></li>
				<li>We want to take the underline off the button text, which you normally get with a link. We'll also give it some color, a blue background with white text, as follows:<p class="source-code"><strong class="bold">    text-decoration: none;</strong></p><p class="source-code"><strong class="bold">    background-color: blue;</strong></p><p class="source-code"><strong class="bold">    color: white;</strong></p><p class="source-code"><strong class="bold">}</strong></p></li>
				<li>We specify more about the exit button using its ID. We will set its width and the top but <a id="_idIndexMarker1177"/>use <strong class="source-inline">auto</strong> margins to center it, as follows:<p class="source-code"><strong class="bold">#exitbutton {</strong></p><p class="source-code"><strong class="bold">    width: 40vh;</strong></p><p class="source-code"><strong class="bold">    margin-top: 5vh;</strong></p><p class="source-code"><strong class="bold">    margin-left: auto;</strong></p><p class="source-code"><strong class="bold">    margin-right: auto;</strong></p><p class="source-code"><strong class="bold">}</strong></p><p>Trying this out, you should now see the exit button in the right place.</p></li>
				<li>Next, we style the video. We want to center the video on the screen. The outer video element can do that for us, like this:<p class="source-code"><strong class="bold">.video {</strong></p><p class="source-code"><strong class="bold">  text-align: center;</strong></p><p class="source-code"><strong class="bold">}</strong></p></li>
				<li>We can then specify the position and size of the inner image block. We want it to be 20% from the top of the screen using a <strong class="source-inline">vh</strong> measurement. The <strong class="source-inline">vmin</strong> unit is a percentage of the screen's minimum dimension; it ensures that this block is never so large that it would obscure the two slider bars. We make the height automatically scale. We select <strong class="source-inline">#video img</strong> to apply this style to the <strong class="source-inline">img</strong> object contained in the <strong class="source-inline">video</strong> object, as illustrated in the following code snippet:<p class="source-code"><strong class="bold">#video img {</strong></p><p class="source-code"><strong class="bold">    margin-top: 20vh;</strong></p><p class="source-code"><strong class="bold">    width: 80vmin;</strong></p><p class="source-code"><strong class="bold">    height: auto;</strong></p><p class="source-code"><strong class="bold">}</strong></p></li>
			</ol>
			<p>Our page is fully styled. You can try this now to see how it looks. Upload the whole folder (including templates) to the robot, and then run <strong class="source-inline">python3 manual_drive.py</strong>. Point a desktop browser at <strong class="source-inline">http://myrobot.local:5001/</strong>, substituting your robot's hostname or address to see it. A desktop browser is good to discover errors in the HTML or JavaScript code. At the time of writing, Firefox and Chrome support emulating mobile devices in the browser and touch events. It should look like the mockup with real video, as illustrated in the<a id="_idIndexMarker1178"/> following screenshot:</p>
			<div>
				<div id="_idContainer294" class="IMG---Figure">
					<img src="Images/B15660_17_09.jpg" alt="" width="1345" height="677"/>
				</div>
			</div>
			<p class="figure-caption">Figure 17.9 – Screenshot of app running on the phone</p>
			<p><em class="italic">Figure 17.9</em> shows the app running on a real phone. The slider bars still don't do anything yet. Note that you may need to force your browser to reload the style sheet. </p>
			<p>We now need to add the slider code.</p>
			<h2 id="_idParaDest-458"><a id="_idTextAnchor413"/>Creating the code for the sliders</h2>
			<p>The sliders<a id="_idIndexMarker1179"/> need to respond to touch events, moving the circle to match the touch location and sending an update message to show how far this movement is from the middle. The sliders will automatically return to the center when the touch events stop. JavaScript lets us run code in the browser, so we'll create a JavaScript <strong class="source-inline">makeSlider</strong> function.</p>
			<p>First, we want to see how touches translate to slider positions and motor speeds. This is illustrated in the following diagram:</p>
			<div>
				<div id="_idContainer295" class="IMG---Figure">
					<img src="Images/B15660_17_10.jpg" alt="" width="711" height="261"/>
				</div>
			</div>
			<p class="figure-caption">Figure 17.10 – Going from touch events to motor positions</p>
			<p>Our sliders have some complexity in their positions, shown in <em class="italic">Figure 17.10</em>. When a user touches a screen, the position arrives in terms of screen coordinates. We first need to find where it is in the slider by taking away the slider's top coordinates. We will need to divide that result by the slider height, multiply by 200, and then subtract 100 to give us the viewbox position (the same system used to draw the SVG). In viewbox coordinates, the top is -100, but for our motors to go forward we need +100, so we must negate the viewbox position to get the motor speed.</p>
			<p>Our script will set up the data needed to move the slider and internal functions to map to the slider events, manage the slider's movement, and call back the <strong class="source-inline">manual_drive.html</strong> code (or any other code) when we move the sliders. Let's make the slider code, as follows:</p>
			<ol>
				<li value="1">We will put this in <strong class="source-inline">static/touch-slider.js</strong>. As we are in a <strong class="source-inline">.js</strong> file, the <strong class="source-inline">&lt;script&gt;</strong> tags are not needed. </li>
				<li>We create the <strong class="source-inline">makeSlider</strong>, function, a factory function to make everything the sliders need, as follows:<p class="source-code"><strong class="bold">function makeSlider(id, when_changed) {</strong></p></li>
				<li>The first thing we need is some internal data. The code needs to know if we are touching the slider so that it won't try to move back while we're still touching it. We need to know if the touch position has changed and keep track of its position. Finally, we'll find our slider by its ID and keep the found object to use, as<a id="_idIndexMarker1180"/> follows:<p class="source-code"><strong class="bold">    let touched = false;</strong></p><p class="source-code"><strong class="bold">    let changed = false;</strong></p><p class="source-code"><strong class="bold">    let position = 0;</strong></p><p class="source-code"><strong class="bold">    const slider = $('#' + id);</strong></p></li>
				<li>We then need some functions to deal with the slider. We'll start with a function to update the position, ensuring the tick is updated, that we only use whole numbers (because the browser won't accept decimal points here), and that we update the <strong class="source-inline">changed</strong> flag, as illustrated in the following code snippet:<p class="source-code"><strong class="bold">    const set_position = function(new_position) {</strong></p><p class="source-code"><strong class="bold">        position = Math.round(new_position);</strong></p><p class="source-code"><strong class="bold">        slider.find('.slider_tick')[0].setAttribute('cy', position);</strong></p><p class="source-code"><strong class="bold">        changed = true;</strong></p><p class="source-code"><strong class="bold">    };</strong></p></li>
				<li>The next thing is handling touch events. Event handlers are functions that get called when something happens (such as the exit button handler). Touch events have three events: <strong class="source-inline">touchstart</strong>—when someone starts touching a screen, <strong class="source-inline">touchmove</strong>—when a touch moves to another area, and <strong class="source-inline">touchend</strong>—when the touch stops. We won't use <strong class="source-inline">touchstart</strong>, so we'll start with making an anonymous <strong class="source-inline">touchmove</strong> function, as follows:<p class="source-code"><strong class="bold">    slider.on('touchmove', event =&gt; {</strong></p><p class="source-code"><strong class="bold">        let touch = event.targetTouches[0];</strong></p><p>Notice we immediately get a <strong class="source-inline">touch</strong> variable from the event data. We get a list of touches, but we are only using the first one.</p></li>
				<li>We then get the relative position of this touch from the top of the slider, as follows:<p class="source-code"><strong class="bold">        let from_top = touch.pageY - slider.offset().top;</strong></p></li>
				<li>We can use this with the height to convert the touch position into a number from -100<a id="_idIndexMarker1181"/> to +100, matching the SVG viewbox coordinates, as follows:<p class="source-code"><strong class="bold">        let relative_touch = (from_top / slider.height()) * 200;</strong></p><p class="source-code"><strong class="bold">        set_position(relative_touch - 100);</strong></p></li>
				<li>Since the code has received a touch event, we should set the <strong class="source-inline">touched</strong> flag to <strong class="source-inline">true</strong>. We must also prevent the touch event from having any other effects, as illustrated in the following code snippet:<p class="source-code"><strong class="bold">        touched = true;</strong></p><p class="source-code"><strong class="bold">        event.preventDefault();</strong></p><p class="source-code"><strong class="bold">    });</strong></p></li>
				<li>Since we've set a flag to say that the touch event is occurring, we should also clear it (set it to <strong class="source-inline">false</strong>) when the touch event ends, as follows:<p class="source-code"><strong class="bold">    slider.on('touchend', event =&gt; touched = false);</strong></p></li>
				<li>Our system is animated, so it needs to have an update cycle to return to the middle. The update should only move the tick if we are not touching the slider, so it stays where you keep your thumb. When the touch has stopped and it's still not at the zero position, we should update the position, as follows:<p class="source-code"><strong class="bold">    const update = function() {</strong></p><p class="source-code"><strong class="bold">        if(!touched &amp;&amp; Math.abs(position) &gt; 0) {</strong></p></li>
				<li>This next part<a id="_idIndexMarker1182"/> looks a bit like the <strong class="bold">Proportional-Integral-Derivative</strong> (<strong class="bold">PID</strong>) controller code in that there's an error multiplied by a proportional component. We scale the error by a factor of 0.3 and add/subtract an extra 0.5 to get it closer to a 1% minimum. Every time this is updated, it moves the slider closer to the middle. The code can be seen here:<p class="source-code"><strong class="bold">            let error = 0 - position;</strong></p><p class="source-code"><strong class="bold">            let change = (0.3 * error) + (Math.sign(error) * 0.5);</strong></p><p class="source-code"><strong class="bold">            set_position(position + change);</strong></p><p class="source-code"><strong class="bold">            // console.log(id + ": " + position);</strong></p><p class="source-code"><strong class="bold">        }</strong></p><p class="source-code"><strong class="bold">    };</strong></p><p>This code is<a id="_idIndexMarker1183"/> also a great place to log the position—something we can use when it goes wrong.</p></li>
				<li>To run this <strong class="source-inline">update</strong> function frequently, we can use the <strong class="source-inline">setInterval</strong> built-in function, which runs a function repeatedly on every interval. This display update should be short to keep it responsive. The timings are in milliseconds. The code can be seen here:<p class="source-code"><strong class="bold">    setInterval(update, 50);</strong></p></li>
				<li>Besides updating the image, we also need to call the <strong class="source-inline">when_changed</strong> function. We only want to do so when something has changed and then reset the <strong class="source-inline">changed</strong> flag, so we don't call it when idle. We'll call this <strong class="source-inline">update_when_changed</strong>. This checks for changes and runs less frequently than the display update, so it doesn't flood the <strong class="source-inline">when_changed</strong> handler and the queue on the robot. The code can be seen here:<p class="source-code"><strong class="bold">    const update_if_changed = function() {</strong></p><p class="source-code"><strong class="bold">        if(changed) {</strong></p><p class="source-code"><strong class="bold">            changed = false;</strong></p><p class="source-code"><strong class="bold">            when_changed(-position);</strong></p><p class="source-code"><strong class="bold">        }</strong></p><p class="source-code"><strong class="bold">    };</strong></p><p class="source-code"><strong class="bold">    setInterval(update_if_changed, 200);</strong></p><p class="source-code"><strong class="bold">}</strong></p><p>Note that we negate the position; this is so the top of the screen (-100) will become motors going full forward (+100). Don't forget the closing bracket for the <strong class="source-inline">makeSlider</strong> function. </p></li>
			</ol>
			<p>You should <a id="_idIndexMarker1184"/>now be ready to run the whole system.</p>
			<h2 id="_idParaDest-459"><a id="_idTextAnchor414"/>Running this</h2>
			<p>You can now<a id="_idIndexMarker1185"/> upload the entire set of files to a folder on your robot. As before, you can use <strong class="source-inline">python3 manual_drive.py</strong> to run this. </p>
			<p>You can use developer mode on a browser to view the web page before trying it on a phone, as follows:</p>
			<ol>
				<li value="1">Point your browser (Chrome or Firefox) at <strong class="source-inline">http://myrobot.local:5001</strong> (using your robot's hostname or address).</li>
				<li>Right-click on your page and click the menu item labeled <strong class="bold">Inspect or Inspect Element</strong>. </li>
				<li>In the developer tools, there will be buttons for emulating phone devices and touch events. Enable the phone emulation.</li>
				<li>Try to shake out any problems in a desktop browser first. Check that dragging the sliders has the desired results and click on the <strong class="bold">Console</strong> button to see if there are errors from the JavaScript. <p>Common problems in JavaScript and CSS are missing punctuation such as semicolons, commas, or brackets. Having class or ID selectors that do not match (or are missing the required dot/hash mark syntax) will make styles fail to apply or element lookups in JavaScript produce no results.</p></li>
				<li>To use on the phone, you will need to use your robot's IP address, as major smartphone brands do not support <strong class="source-inline">.local</strong> addresses. You can find this from your desktop with <strong class="source-inline">ping myrobot.local</strong>, as illustrated in the following code snippet:<p class="source-code"><strong class="bold">$ ping myrobot.local</strong></p><p class="source-code"><strong class="bold">PING myrobot.local (192.168.1.107): 56 data bytes</strong></p><p class="source-code"><strong class="bold">64 bytes from 192.168.1.107: icmp_seq=0 ttl=64 time=5.156 ms</strong></p><p>This example shows the robot's IP address to be <strong class="source-inline">192.168.1.107</strong>. Your address will be different; note that down, and put that in the phone browser with the port. An example for my robot is <strong class="source-inline">http://192.168.1.107:5000</strong>.</p></li>
				<li>With the phone, you should be able to use your thumbs to drive the robot.</li>
			</ol>
			<p>It will take some<a id="_idIndexMarker1186"/> practice to drive the robot manually. I suggest practicing overhead driving first, and when you have got the hang of that, try navigating through the camera. The camera frame rate is not very high, and this frame rate currently constrains the driving loop. </p>
			<h2 id="_idParaDest-460"><a id="_idTextAnchor415"/>Troubleshooting</h2>
			<p>This is a fairly <a id="_idIndexMarker1187"/>complex combination of Python, HTML, JavaScript, and CSS. Try these if you've run into trouble:</p>
			<ul>
				<li>If you see errors from Python, verify the line of code against the preceding code. </li>
				<li>If things are not working on the web page, try out the phone emulation in browser mode, as suggested previously, then select the inspector <strong class="bold">Console</strong> tab and try the operation again. This will show JavaScript errors.</li>
				<li>If the display appears wrong, with parts out of place or in the wrong color, verify that the CSS/style sheet sections and the HTML are correct.</li>
				<li>If you receive <strong class="source-inline">404</strong> errors, ensure that the URLs in the HTML match the routes in the Flask/Python code.</li>
				<li>If your robot seems to be pausing and then spending a while catching up with your events, you could adjust the <strong class="source-inline">update_if_changed</strong> interval time to something longer.</li>
			</ul>
			<p>You now have a robot you can drive remotely with the phone while seeing through its camera. You've seen how to handle touch events and use style sheets with SVG to make custom widgets. You've used JavaScript to bring the widget to life with animation and send control<a id="_idIndexMarker1188"/> messages back to the robot.</p>
			<p>In our next section, we'll make the menu more touch-friendly so that we can control the robot mostly from the phone.</p>
			<h1 id="_idParaDest-461"><a id="_idTextAnchor416"/>Making the robot fully phone-operable</h1>
			<p>The goal here <a id="_idIndexMarker1189"/>is to make it so that we can drive the robot completely from the phone. We need to ensure that the robot is ready to run when we turn it on, and make sure that the menu is usable from a phone. The menu we made earlier doesn't seem very touch-friendly. It also will not successfully run any of the behaviors with displays using Flask. We will make the menu buttons bigger and more touch-friendly, using styles similar to our manual drive behavior. The menu will also load our server page after clicking a behavior with a server such as this one or the last chapter's visual tracking behaviors.</p>
			<p>Let's fix the Flask behaviors first.</p>
			<h2 id="_idParaDest-462"><a id="_idTextAnchor417"/>Making menu modes compatible with Flask behaviors</h2>
			<p>If you've<a id="_idIndexMarker1190"/> already <a id="_idIndexMarker1191"/>tried running Flask-based behaviors (such as those with a camera) in the control server, you will have noticed some very odd behavior. Your behavior will appear to do the right thing with sensors on the robot, but the web service fails to do anything useful on port <strong class="source-inline">5001</strong>. </p>
			<p>Flask uses subprocesses to manage its debug mode, which interferes with our use of them. We don't need debug mode, so the fix is to remove debug mode by doing the following:</p>
			<ol>
				<li value="1">Open <strong class="source-inline">control_server.py</strong> and jump to the last few lines.</li>
				<li>Remove <strong class="source-inline">debug=True</strong> from the <strong class="source-inline">app.run</strong> line by running the following code:<p class="source-code"><strong class="bold">app.run(host="0.0.0.0")</strong></p></li>
			</ol>
			<p>You can now<a id="_idIndexMarker1192"/> add <a id="_idIndexMarker1193"/>the manual drive and color-tracking and face-tracking behaviors to the control server, and they will start properly.</p>
			<h2 id="_idParaDest-463"><a id="_idTextAnchor418"/>Loading video services</h2>
			<p>When we<a id="_idIndexMarker1194"/> click on a menu option for a video server-based behavior, after it starts we need to send our browser to port <strong class="source-inline">5001</strong> on our robot to see its output. </p>
			<p>Our <strong class="source-inline">menu.html</strong> file currently takes the response from the <strong class="source-inline">control_server</strong> process and puts this into the message box. We can upgrade this to instruct the code to do something else. We can start by configuring the items that need to show a server page in <strong class="source-inline">mode_config</strong> variable. </p>
			<p>Each item in the <strong class="source-inline">mode_config</strong> variable holds only the mode script; we can update this to have both a script and whether it needs to show a server, as follows: </p>
			<ol>
				<li value="1">Open <strong class="source-inline">robot_modes.py</strong>.</li>
				<li>In <strong class="source-inline">mode_config</strong>, we will take the simple text naming the script (such as <strong class="source-inline">"avoid_behavior.py"</strong>) and replace it with a dictionary, allowing a simple case (<strong class="source-inline">{"script": "avoid_behavior.py}</strong>) or a more complex case (<strong class="source-inline">{"script": "manual_drive.py", "server": True}</strong>). You'll need to change that on all items throughout the <strong class="source-inline">mode_config</strong>. The code is shown in the following snippet:<p class="source-code">    mode_config = {</p><p class="source-code">        "avoid_behavior": <strong class="bold">{"script": </strong>"avoid_behavior.py"<strong class="bold">}</strong>,</p><p class="source-code">        "circle_head": <strong class="bold">{"script": </strong>"circle_pan_tilt_behavior.py"<strong class="bold">}</strong>,</p><p class="source-code">        ...</p></li>
				<li>We then need to update the server-type scripts in <strong class="source-inline">mode_config</strong> variable using the more complex case, as follows:<p class="source-code">        <strong class="bold">"color_track": {"script": "color_track_behavior.py", "server": True},</strong></p><p class="source-code"><strong class="bold">        "face_track": {"script": "face_track_behavior.py", "server": True},</strong></p><p class="source-code"><strong class="bold">        "manual_drive": {"script": "manual_drive.py", "server": True}</strong></p><p>We've added<a id="_idIndexMarker1195"/> the new manual drive behavior too. When you added the <strong class="source-inline">manual_drive</strong> configuration here, you need to add this to <strong class="source-inline">menu_config</strong> variable too so that it shows up on the menu.</p></li>
				<li>We need to modify the <strong class="source-inline">run</strong> method to pick the script from this changed structure, as follows:<p class="source-code">    def run(self, mode_name):</p><p class="source-code">        while self.is_running():</p><p class="source-code">            self.stop()</p><p class="source-code">        script = self.mode_config[mode_name]<strong class="bold">['script']</strong></p><p class="source-code">        self.current_process = subprocess.Popen(["python", script])</p></li>
				<li>Next, we need to check if we should redirect if the mode is a server and the current process is alive. I've added the explicit <strong class="source-inline">is True</strong>, to make it clearer that the value is a <strong class="source-inline">True</strong>/<strong class="source-inline">False</strong> flag, as illustrated in the following code snippet:<p class="source-code">    def should_redirect(self, mode_name):</p><p class="source-code">        return self.mode_config[mode_name].get('server') is True and self.is_running()</p></li>
			</ol>
			<p>We've prepared <strong class="source-inline">robot_modes.py</strong>. The <strong class="source-inline">control_server.py</strong> file sends responses to the web page. Let's use the same trick we did with the <strong class="source-inline">mode_config</strong> and return a dictionary with data instead of just a string, as follows:</p>
			<ol>
				<li value="1">We will <a id="_idIndexMarker1196"/>use <strong class="bold">JavaScript Object Notation</strong> (<strong class="bold">JSON</strong>) to format the response. Open <strong class="source-inline">control_server.py</strong> and add <strong class="source-inline">jsonify</strong> to the Flask imports, as illustrated in the following code snippet:<p class="source-code">from flask import Flask, render_template<strong class="bold">, jsonify</strong></p></li>
				<li>Next, we replace the <strong class="source-inline">run</strong> method so that it creates the <strong class="source-inline">response</strong> dictionary, as follows:<p class="source-code">@app.route("/run/&lt;mode_name&gt;", methods=['POST'])</p><p class="source-code">def run(mode_name):</p><p class="source-code">    mode_manager.run(mode_name)</p><p class="source-code">    response = {'message': f'{mode_name} running'}</p><p>This <a id="_idIndexMarker1197"/>response is the basic message.</p></li>
				<li>If we intend to redirect, we should send the <strong class="source-inline">redirect</strong> setting with our response, as follows:<p class="source-code">    if mode_manager.should_redirect(mode_name):</p><p class="source-code">        response['redirect'] = True</p></li>
				<li>We need to send the response, encoded as JSON. JSON is an easy way to get data to JavaScript from Python—it is especially good with dictionary data. Run the following code:<p class="source-code">    return jsonify(response)</p></li>
				<li>Since we also sent a message back in the <strong class="source-inline">stop</strong> command, we should wrap it in the same way, like this:<p class="source-code">@app.route("/stop", methods=['POST'])</p><p class="source-code">def stop():</p><p class="source-code">    mode_manager.stop()</p><p class="source-code">    return <strong class="bold">jsonify({'message': "Stopped"})</strong></p></li>
			</ol>
			<p>The control server is able to send the <strong class="source-inline">response</strong> dictionary, and redirect if needed. The other side of this, now receiving the JSON object, requires changes in the page scripts to handle the new response. Proceed as follows:</p>
			<ol>
				<li value="1">Open <strong class="source-inline">templates/menu.html</strong> and find the <strong class="source-inline">run</strong> function, as illustrated in the following code snippet:<p class="source-code"><strong class="bold">    function run(url) {</strong></p></li>
				<li>The message handling here needs to change. We need to set the message element HTML using the message element from our response, as follows:<p class="source-code"><strong class="bold">      $.post(url, '', response =&gt; {</strong></p><p class="source-code"><strong class="bold">           $('#message').html(response.message);</strong></p></li>
				<li>However, we can also check if we need to redirect. If so, we use the same trick we did in <a id="_idIndexMarker1198"/>the previous <em class="italic">The template</em> section for the exit button in the manual drive behavior, but in a timeout, as follows:<p class="source-code"><strong class="bold">           if(response.redirect) {</strong></p><p class="source-code"><strong class="bold">              setTimeout(() =&gt; window.location.replace('//' + window.location.hostname + ":5001"), 3000);</strong></p><p class="source-code"><strong class="bold">          }</strong></p><p class="source-code"><strong class="bold">      })</strong></p><p>The <strong class="source-inline">setTimeout</strong> function calls a function after a specified time. We give it 3,000 milliseconds (3 seconds), which gives a video behavior time to warm up first.</p></li>
			</ol>
			<p>If you upload this and run <strong class="source-inline">python3 control_server.py</strong>, you'll see the menu is now more functional but looks quite plain. You should be able to click on the tracking or driving behaviors and, after 3 seconds, be redirected to their page. Clicking the exit buttons should take yo<a id="_idTextAnchor419"/>u back to the menu.</p>
			<p>Time to give it some style.</p>
			<h2 id="_idParaDest-464"><a id="_idTextAnchor420"/>Styling the menu</h2>
			<p>We've already <a id="_idIndexMarker1199"/>used a style sheet in the manual drive demo to make the exit button look better. This menu is a set of buttons too. We can build on that style and make the menu more phone-friendly.</p>
			<h3 id="_idParaDest-465">Making the menu template into buttons</h3>
			<p>We have an <a id="_idIndexMarker1200"/>existing style sheet in <strong class="source-inline">static/display.css</strong>. We can make further use of this in the menu, perhaps with a few tweaks. Our menu template can be optimized to make the most of that style sheet too. Proceed as follows:</p>
			<ol>
				<li value="1">Open <strong class="source-inline">templates/menu.html</strong>. We will add a link to the style sheet. We can add a <strong class="source-inline">charset</strong> definition too, as follows:<p class="source-code">&lt;head&gt;</p><p class="source-code">    &lt;script src="https://code.jquery.com/jquery-3.5.1.min.js"&gt;&lt;/script&gt;</p><p class="source-code">    &lt;title&gt;My Robot Menu&lt;/title&gt;</p><p class="source-code"><strong class="bold">    &lt;meta charset="UTF-8"&gt;</strong></p><p class="source-code"><strong class="bold">    &lt;link rel="stylesheet" type="text/css" href="/static/display.css"&gt;</strong></p><p class="source-code">&lt;/head&gt;</p></li>
				<li>The menu template uses a list of items for the menu. Adding a <strong class="source-inline">menu</strong> class to that list and a <strong class="source-inline">button</strong> class to the links lets us use the existing style for them, as illustrated in the following code snippet:<p class="source-code">    &lt;ul<strong class="bold"> class="menu"</strong>&gt;</p><p class="source-code">      {% for item in menu %}</p><p class="source-code">        &lt;li&gt;</p><p class="source-code">            &lt;a<strong class="bold"> class="button"</strong> href="#" onclick="run('/run/{{ item.mode_name }}')"&gt;</p><p class="source-code">                {{ item.text }}</p><p class="source-code">            &lt;/a&gt;</p><p class="source-code">        &lt;/li&gt;</p><p class="source-code">      {% endfor %}</p><p class="source-code">    &lt;li&gt;&lt;a<strong class="bold"> class="button"</strong> href="#" onclick="run('/stop')"&gt;Stop&lt;/a&gt;&lt;/li&gt;</p></li>
				<li>Now, open up <strong class="source-inline">static/display.css</strong>, where we will define the style for the <strong class="source-inline">menu</strong> class, as follows:<p class="source-code">.menu {</p><p class="source-code">    width: 100%;</p><p class="source-code">    margin-top: 0;</p><p class="source-code">    margin-bottom: 0;</p><p class="source-code">    padding: 0;</p><p class="source-code">}</p><p>We make the list container fill the screen width without any extra margins (space around the outside of the item) or padding (space between the inside of the item and its child list items).</p></li>
				<li>The menu<a id="_idIndexMarker1201"/> consists of list items. By default, these get a dot: a bullet point. We want to set this to <strong class="source-inline">none </strong>(no shape) to remove the bullet point. We can use CSS <strong class="source-inline">list-style</strong> properties to change that. The selector here applies to list items (<strong class="source-inline">li</strong>) that are children of a <strong class="source-inline">.menu</strong> class object. The code can be seen in the following snippet:<p class="source-code">.menu li {</p><p class="source-code">    list-style-type: none;</p><p class="source-code">    list-style-position: initial;</p><p class="source-code">}</p></li>
				<li>To make this touch-friendly, we make the buttons the same width. <strong class="source-inline">60vw</strong> (60% of the viewport width) should be wide enough. We use the margin <strong class="source-inline">auto</strong> trick to center this. We can also add a 1-pixel light blue border to them, as illustrated in the following code snippet:<p class="source-code">.menu .button {</p><p class="source-code">    margin-left: auto;</p><p class="source-code">    margin-right: auto;</p><p class="source-code">    width: 60vw;</p><p class="source-code">    border: 1px solid lightblue;</p><p class="source-code">}</p></li>
			</ol>
			<p>Upload the whole directory and start the menu server with <strong class="source-inline">python3 control_server.py</strong>. This menu should now look more phone-friendly.</p>
			<p>You've now seen how to make our control server work nicely on a smartphone, and you should be getting a little more comfortable with the interactions of JavaScript, HTML, and CSS<a id="_idIndexMarker1202"/> with Python. However, this system has a flaw—we are still starting it from an SSH terminal. Let's see how to fix this.</p>
			<h1 id="_idParaDest-466"><a id="_idTextAnchor421"/>Making the menu start when the Pi starts</h1>
			<p>You now have a menu system launching robot behaviors. Using SSH to log in is great to debug, see problems, and fix them. However, when you want to demonstrate your robot, a SSH session will become inconvenient.</p>
			<p>The ideal is to turn on the robot, wait for a light to come on, then point your phone browser at it to control it. </p>
			<p>We are going to do two things to make this useful, as follows:</p>
			<ul>
				<li>Use an LED to indicate that it's ready (in menu mode) to allow the robot to tell us before our phone has linked to the page</li>
				<li>Use <strong class="source-inline">systemd</strong> to automatically start the menu Flask server when we turn on the robot</li>
			</ul>
			<p>Let's get stuck in with the lights.</p>
			<h2 id="_idParaDest-467"><a id="_idTextAnchor422"/>Adding lights to the menu server</h2>
			<p>We won't want <a id="_idIndexMarker1203"/>the whole robot class loaded in our menu, but it can use the lights to indicate our robot is now ready. We will import the LED system, turn it on as the server starts, and then turn it off/release it when the first <strong class="source-inline">/run</strong> request arrives. Proceed as follows:</p>
			<ol>
				<li value="1">Open the <strong class="source-inline">control_server.py</strong> file and import the LEDs, like this:<p class="source-code">from robot_modes import RobotModes</p><p class="source-code"><strong class="bold">from leds_led_shim import Leds</strong></p></li>
				<li>We need to set up our LEDs and turn one LED green by running the following code:<p class="source-code">mode_manager = RobotModes()</p><p class="source-code"><strong class="bold">leds = Leds()</strong></p><p class="source-code"><strong class="bold">leds.set_one(1, [0, 255, 0])</strong></p><p class="source-code"><strong class="bold">leds.show()</strong></p></li>
				<li>When we run something, we know that someone's used the menu. In our <strong class="source-inline">run</strong> method, we can clear the LED. Since we only want to do it once, we can set the global LEDs to <strong class="source-inline">None</strong> and then check this next time. Note in the following code snippet<a id="_idIndexMarker1204"/> that we are inserting the highlighted code into the existing <strong class="source-inline">run</strong> function:<p class="source-code">def run(mode_name):</p><p class="source-code"><strong class="bold">    global leds</strong></p><p class="source-code"><strong class="bold">    if leds:</strong></p><p class="source-code"><strong class="bold">        leds.clear()</strong></p><p class="source-code"><strong class="bold">        leds.show()</strong></p><p class="source-code"><strong class="bold">        leds = None</strong></p><p class="source-code">...</p></li>
			</ol>
			<p>You can test this by uploading the menu server code and rerunning it. The LED should light when it starts, and then when you select another behavior, it will go out. It should work correctly to move from the menu to the LED test behavior.</p>
			<h2 id="_idParaDest-468"><a id="_idTextAnchor423"/>Using systemd to automatically start the robot</h2>
			<p>The <strong class="bold">systemd</strong> tool<a id="_idIndexMarker1205"/> is designed for <a id="_idIndexMarker1206"/>automatically starting programs on Linux. This tool is perfect for starting the menu/control server so that the robot is ready to drive. See the <em class="italic">Further reading</em> section for more information about <strong class="source-inline">systemd</strong> in Raspberry Pi.</p>
			<p>Registering a service is done by creating a unit file and copying it into the right folder on the Pi. Proceed as follows:</p>
			<ol>
				<li value="1">Make a <strong class="source-inline">menu_server.service</strong> file. Start this with a description, and tell <strong class="source-inline">systemd</strong> to start our service after we have networking on our Raspberry Pi, as illustrated in the following code snippet:<p class="source-code"><strong class="bold">[Unit]</strong></p><p class="source-code"><strong class="bold">Description=Robot Menu Web Service</strong></p><p class="source-code"><strong class="bold">After=network.target</strong></p></li>
				<li>Now, we tell <strong class="source-inline">systemd</strong> we want this to start as the Pi is ready for users to log in, as illustrated in the following code snippet:<p class="source-code"><strong class="bold">[Install]</strong></p><p class="source-code"><strong class="bold">WantedBy=multi-user.target</strong></p></li>
				<li>The <strong class="source-inline">Service</strong> section shown in the following snippet configures how to run our code: <p class="source-code"><strong class="bold">[Service]</strong></p></li>
				<li>The <a id="_idIndexMarker1207"/>working directory is where you<a id="_idIndexMarker1208"/> have copied your robot files to—for example, <strong class="source-inline">/home/pi</strong>. We can also set the <strong class="source-inline">pi</strong> user we've been using the whole time. The working directory is how your code finds its other components. Have a look at the following code snippet:<p class="source-code"><strong class="bold">WorkingDirectory=/home/pi</strong></p><p class="source-code"><strong class="bold">User=pi</strong></p></li>
				<li>The <strong class="source-inline">ExecStart</strong> statement tells <strong class="source-inline">systemd</strong> the command to run the service. However, it does not assume a path the way a shell would, so prefix the <strong class="source-inline">python3</strong> command with <strong class="source-inline">/usr/bin/env</strong>, as follows:<p class="source-code"><strong class="bold">ExecStart=/usr/bin/env python3 control_server.py</strong></p></li>
				<li>You now need to set this up on the Raspberry Pi. Upload this file to your Raspberry Pi home directory.</li>
				<li>You'll need <strong class="source-inline">sudo</strong> to copy it into the system configuration. Type this via SSH on the Pi. Note you will see permission errors if you miss the <strong class="source-inline">sudo</strong> command. The code can be seen here:<p class="source-code"><strong class="bold">$ sudo cp menu_server.service /etc/systemd/system/</strong></p></li>
				<li>We should now ask <strong class="source-inline">systemd</strong> to load our configuration and then enable our service, as follows:<p class="source-code"><strong class="bold">$ sudo systemctl daemon-reload</strong></p><p class="source-code"><strong class="bold">$ sudo systemctl enable menu_server</strong></p></li>
				<li>The system will confirm you've enabled it with this message:<p class="source-code"><strong class="bold">Created symlink /etc/systemd/system/multi-user.target.wants/menu_server.service </strong><strong class="bold">→ /etc/systemd/system/menu_server.service.</strong></p></li>
				<li>You <a id="_idIndexMarker1209"/>can then try starting your service<a id="_idIndexMarker1210"/> with this command:<p class="source-code"><strong class="bold">$ sudo systemctl start menu_server</strong></p></li>
			</ol>
			<p>If starting this server is successful, you will see a green light go on, showing it is ready. You will then be able to point your browser at the robot and control it.</p>
			<p>Let's just check that this has worked.</p>
			<h3 id="_idParaDest-469">Troubleshooting</h3>
			<p>Things can go <a id="_idIndexMarker1211"/>wrong here—if so, try these steps to fix it or find out more:</p>
			<ol>
				<li value="1">Starting/enabling the menu server with <strong class="source-inline">systemd</strong> may fail, and you will see <strong class="source-inline">Unit menu_server.service is not loaded properly: Invalid argument</strong> if there are problems with the <strong class="source-inline">menu_server.service</strong> file. Please verify its content, copy it back over, and rerun the <strong class="source-inline">sudo</strong> commands to install the new file.</li>
				<li>If you want to see more of what the server is doing, you can use this command:<p class="source-code"><strong class="bold">$ systemctl status menu_server</strong></p><p>The Pi will then respond with something like this:</p><p class="source-code"><strong class="bold">●</strong><strong class="bold"> menu_server.service - Robot Menu Web Service</strong></p><p class="source-code"><strong class="bold">  Loaded: loaded (/etc/systemd/system/menu_server.service; enabled; vendor preset: enabled)</strong></p><p class="source-code"><strong class="bold">   Active: active (running) since Wed 2020-10-21 23:41:55 BST; 2s ago</strong></p><p class="source-code"><strong class="bold"> Main PID: 1187 (python3)</strong></p><p class="source-code"><strong class="bold">    Tasks: 1 (limit: 860)</strong></p><p class="source-code"><strong class="bold">   Memory: 10.0M</strong></p><p class="source-code"><strong class="bold">   CGroup: /system.slice/menu_server.service</strong></p><p class="source-code"><strong class="bold">           └</strong><strong class="bold">─1187 python3 control_server.py</strong></p><p class="source-code"><strong class="bold">Oct 21 23:41:55 myrobot systemd[1]: Started Robot Menu Web Service.</strong></p><p class="source-code"><strong class="bold">Oct 21 23:41:56 myrobot env[1187]:  * Serving Flask app "control_server" (lazy loading)</strong></p><p class="source-code"><strong class="bold">Oct 21 23:41:56 myrobot env[1187]:  * Environment: production</strong></p><p class="source-code"><strong class="bold">Oct 21 23:41:56 myrobot env[1187]:    WARNING: This is a development server. Do not use it in a production deployment.</strong></p></li>
				<li><strong class="source-inline">systemctl</strong> can <a id="_idIndexMarker1212"/>show some recent activity, but you may want to follow the output of behaviors as they run. To do this, you will need to use the <strong class="source-inline">journalctl</strong> command. Use <strong class="source-inline">-u</strong> to specify the service we created, and then <strong class="source-inline">-f</strong> to follow the log, as illustrated in the following code snippet:<p class="source-code"><strong class="bold">$ journalctl -u menu_server -f</strong></p><p>We will then be able to see servers as they run—perhaps not as convenient for debugging, but handy for launching services. Use <em class="italic">Ctrl</em> + <em class="italic">C</em> to stop seeing the log.</p></li>
			</ol>
			<p>You can now reboot the robot, wait for the green light, and start driving it. The green light will also mean that your Mycroft voice assistant can send requests to the robot too.</p>
			<p>If you upload new code, you will need to restart the service. You can use the following command to do so:</p>
			<p class="source-code">$ sudo systemctl restart menu_server</p>
			<p>Congratulations—your<a id="_idIndexMarker1213"/> robot is now truly headless! It doesn't even need a PC or laptop to start doing things.</p>
			<h1 id="_idParaDest-470"><a id="_idTextAnchor424"/>Summary</h1>
			<p>This chapter added a small menu system to our robot to start different modes from a connected web browser.</p>
			<p>You've seen how to drive a robot from a mobile phone and how to create interesting-looking animated widgets with SVG and JavaScript. </p>
			<p>Your robot has now gained the ability to be driven manually. It may take you a while to get used to handling it, and manually correcting for veer (motors behaving slightly differently) is more challenging than when the PID systems correct themselves. Still, you will gain skills in driving it with your phone. You can use the camera on the front of the robot to get a robot's-eye view of the world.</p>
			<p>You've turned the control server into a menu server and then made that start automatically when you turn on the robot. You've also seen how to connect your menu server to the video-server apps such as manual driving, color-tracking, or face-tracking apps. By making the buttons more touch-friendly on the menu server, you can use a phone to launch most behaviors.</p>
			<p>Finally, we gave the menu server a way to indicate being ready on the robot with a LED and then set it up to automatically start when you turn on the robot. If your robot and phone can connect to the same network (perhaps you can set up your phone hotspot in a <strong class="source-inline">wpa_supplicant.conf</strong> file), you will be able to launch the behaviors from places outside your lab and demonstrate them to people. You've made the robot fully controllable with your phone!</p>
			<p>In the next chapter, we will look at meeting the robot-making community and finding further robot building and programming skills to continue building.</p>
			<h1 id="_idParaDest-471"><a id="_idTextAnchor425"/>Exercises</h1>
			<p>You could enhance the system in many ways. Here are some suggestions for building further:</p>
			<ol>
				<li value="1">In the <strong class="source-inline">manual_drive.py</strong> file, the <strong class="source-inline">handle_instruction</strong> function uses a bunch of <strong class="source-inline">if</strong> statements to handle the instruction. If this list of command handlers exceeds five, you could improve it by using a dictionary (such as <strong class="source-inline">menu_modes</strong>) and then calling different handler methods.</li>
				<li>Could you change the touch interface into two circular pads—perhaps so the left controls motor movement and the right changes the camera position?</li>
				<li>What about creating phone-friendly interfaces for other behaviors to control their parameters?</li>
				<li>You could embellish the CSS by adding round buttons or putting spacing between the buttons.</li>
				<li>The menu still uses text buttons. Could you find a way to associate an image with each behavior and make a button grid?</li>
				<li>Adding a <strong class="bold">Shutdown</strong> menu button will mean you could more gracefully shut down the Pi, where it would start the <strong class="source-inline">sudo poweroff</strong> command.</li>
				<li>For desktop compatibility, the manual driving system could be enhanced with keyboard interactions to drive the robot, which is not quite as fun as the phone but is a handy fallback.</li>
				<li>A seriously advanced improvement to the driving system would be to control motors in terms of counts per second, with a PID per wheel, matching the number of pulse counts we get with those we expect from the encoders. This improvement would make the robot drive straighter and be therefore easier to drive.</li>
			</ol>
			<h1 id="_idParaDest-472"><a id="_idTextAnchor426"/>Further reading</h1>
			<p>To find out more about the topics covered in this chapter, here are some suggestions:</p>
			<ul>
				<li>I highly recommend the Flask API documentation (<a href="http://flask.pocoo.org/docs/1.0/api/">http://flask.pocoo.org/docs/1.0/api/</a>), both to help understand the Flask functions we've used and to learn other ways to use this flexible web server library.</li>
				<li>For a more guided look at the Flask web server, I suggest reading <em class="italic">Flask By Example</em>, <em class="italic">Gareth Dwyer</em>, <em class="italic">Packt Publishing</em> (<a href="https://www.packtpub.com/product/flask-by-example/9781785286933">https://www.packtpub.com/product/flask-by-example/9781785286933</a>), showing you how to build more involved web applications using Flask.</li>
				<li>I also recommend the book <em class="italic">Mastering Flask</em>, <em class="italic">Jack Stouffer</em>, <em class="italic">Packt Publishing</em> (<a href="https://www.packtpub.com/web-development/mastering-flask">https://www.packtpub.com/web-development/mastering-flask</a>).</li>
				<li>The HTML used in this chapter is elementary. To get a more in-depth look into how you could enhance the simple menu system, I recommend the e-learning video guide <em class="italic">Beginning Responsive Web Development with HTML and CSS [eLearning]</em>, <em class="italic">Ben Frain</em>, <em class="italic">Cord Slatton-Valle</em>, <em class="italic">Joshua Miller</em>, <em class="italic">Packt Publishing</em> (<a href="https://www.packtpub.com/web-development/beginning-responsive-web-development-html-and-css-elearning-video">https://www.packtpub.com/web-development/beginning-responsive-web-development-html-and-css-elearning-video</a>). </li>
				<li>We use CSS selectors throughout HTML, CSS, and JavaScript applications. You can find a good combination of reference and tutorials at the <em class="italic">W3C Schools CSS Selectors</em> website (<a href="https://www.w3schools.com/cssref/css_selectors.asp">https://www.w3schools.com/cssref/css_selectors.asp</a>). I would recommend exploring the site for its information on most web application technologies. For CSS units, see <em class="italic">W3C Schools CSS Units</em> (<a href="https://www.w3schools.com/cssref/css_units.asp">https://www.w3schools.com/cssref/css_units.asp</a>) to practice and find more types of units to use. <em class="italic">W3C Schools</em> provides in general great reference and learning material for these web technologies.</li>
				<li>For getting more familiar with the JavaScript, CSS, and HTML technologies used here, <em class="italic">freeCodeCamp</em> (<a href="https://www.freecodecamp.org/">https://www.freecodecamp.org/</a>) is a valuable resource with self-learning modules.</li>
				<li>Raspberry Pi has handy documentation on user <strong class="source-inline">systemd</strong> files at <a href="https://www.raspberrypi.org/documentation/linux/usage/systemd.md">https://www.raspberrypi.org/documentation/linux/usage/systemd.md</a>. </li>
				<li>There is a chapter on understanding <strong class="source-inline">systemd</strong> in <em class="italic">Mastering Linux Network Administration</em>, <em class="italic">Jay LaCroix</em>, <em class="italic">Packt Publishing</em> (<a href="https://www.packtpub.com/product/mastering-linux-network-administration/9781784399597">https://www.packtpub.com/product/mastering-linux-network-administration/9781784399597</a>), published in 2015. </li>
				<li>A full reference for <strong class="source-inline">systemd</strong> services can be found on the <em class="italic">freedesktop</em> manuals at <a href="https://www.freedesktop.org/software/systemd/man/systemd.service.html">https://www.freedesktop.org/software/systemd/man/systemd.service.html</a>.</li>
			</ul>
		</div>
	</div></body></html>