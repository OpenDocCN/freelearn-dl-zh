# 前言

当稳定扩散于2022年8月22日发布时，这个基于扩散的图像生成模型迅速吸引了全世界的关注。其模型和源代码都是完全开源的，托管在GitHub上。随着数百万社区参与者和用户的加入，发布了众多新的混合模型。创建了诸如稳定扩散WebUI和InvokeAI等工具。

虽然稳定扩散WebUI工具可以生成由扩散模型驱动的奇妙图像，但其可用性有限。来自Hugging Face的开源Diffusers包允许用户使用Python完全控制稳定扩散。然而，它缺少许多关键特性，例如加载自定义LoRA模型和文本反转，利用社区共享的模型/检查点，调度和加权提示，无限提示令牌，修复图像分辨率，以及放大。本书将帮助您克服Diffusers的限制，实现高级特性，创建一个完全定制和工业级的稳定扩散应用。

在本书结束时，您不仅将能够使用Python生成和编辑图像，还能利用本书中提供的解决方案构建适用于您业务和用户的稳定扩散应用。

# 本书面向的对象

本书面向那些希望全面了解图像生成和扩散模型工作原理的AI图像和艺术生成爱好者。

本书也适合对全面理解AI图像生成和精确控制扩散模型感兴趣的艺术家。

针对那些旨在基于稳定扩散创建AI图像生成应用的Python应用开发者，本书也将提供帮助。

最后，本书旨在帮助数据科学家、机器学习工程师和研究人员，他们希望通过编程方式控制稳定扩散过程、自动化流水线、构建自定义流水线，并使用Python进行测试和验证。

# 本书涵盖的内容

[*第1章*](B21263_01.xhtml#_idTextAnchor015)，*介绍稳定扩散*，提供了对AI图像生成技术稳定扩散的介绍。

[*第2章*](B21263_02.xhtml#_idTextAnchor037)，*设置稳定扩散的环境*，介绍了如何设置CUDA和Python环境以运行稳定扩散模型。

[*第3章*](B21263_03.xhtml#_idTextAnchor064)，*使用稳定扩散生成图像*，是一个快速入门章节，帮助您开始使用Python通过稳定扩散生成图像。

[*第4章*](B21263_04.xhtml#_idTextAnchor081)，*理解扩散模型背后的理论*，深入探讨了扩散模型的内部机制。

[*第5章*](B21263_05.xhtml#_idTextAnchor097)，*理解稳定扩散的工作原理*，涵盖了稳定扩散背后的理论。

[*第6章*](B21263_06.xhtml#_idTextAnchor117), *使用稳定扩散模型*，涵盖了模型数据处理以及模型文件的转换和加载。

[*第7章*](B21263_07.xhtml#_idTextAnchor136), *优化性能和VRAM使用*，教你如何提高性能并减少VRAM使用。

[*第8章*](B21263_08.xhtml#_idTextAnchor153), *使用社区共享的LoRAs*，展示了如何使用社区共享的LoRAs与稳定扩散检查点模型。

[*第9章*](B21263_09.xhtml#_idTextAnchor178), *使用文本反转*，使用社区共享的文本反转与稳定扩散检查点模型。

[*第10章*](B21263_10.xhtml#_idTextAnchor197), *解锁77个令牌限制并启用提示权重*，涵盖了如何构建自定义提示处理代码以使用具有加权重要性分数的无限制大小提示。具体来说，我们将探讨如何为单个提示或令牌分配不同的权重，从而微调模型注意力并生成更准确的结果。

[*第11章*](B21263_11.xhtml#_idTextAnchor214), *图像修复与超分辨率*，展示了如何使用稳定扩散修复和提升图像。

[*第12章*](B21263_12.xhtml#_idTextAnchor240), *计划提示解析*，展示了如何构建自定义管道以支持计划提示。

[*第13章*](B21263_13.xhtml#_idTextAnchor257), *使用ControlNet生成图像*，涵盖了如何使用ControlNet与稳定扩散检查点模型。

[*第14章*](B21263_14.xhtml#_idTextAnchor277), *使用稳定扩散生成视频*，展示了如何使用AnimateDiff与稳定扩散一起生成短视频剪辑，并理解视频生成的理论。

[*第15章*](B21263_15.xhtml#_idTextAnchor289), *使用BLIP-2和LLaVA生成图像描述*，介绍了如何使用大型语言模型（LLMs）从图像中提取描述。

[*第16章*](B21263_16.xhtml#_idTextAnchor309), *探索稳定扩散XL*，展示了如何开始使用更新、更好的稳定扩散模型——稳定扩散XL。

[*第17章*](B21263_17.xhtml#_idTextAnchor335), *构建优化提示以用于稳定扩散*，讨论了编写稳定扩散提示以生成更好图像的技术，以及利用LLMs自动生成提示。

[*第18章*](B21263_18.xhtml#_idTextAnchor357), *应用：对象编辑和风格迁移*，涵盖了如何使用稳定扩散和相关机器学习模型编辑图像以及将风格从一个图像转移到另一个图像。

[*第19章*](B21263_19.xhtml#_idTextAnchor375), *生成数据持久化*，展示了如何将图像生成提示和参数保存到生成的PNG图像中。

[*第20章*](B21263_20.xhtml#_idTextAnchor387), *创建交互式用户界面*，展示了如何使用开源框架Gradio构建稳定扩散WebUI。

[*第21章*](B21263_21.xhtml#_idTextAnchor405)，*扩散模型迁移学习*，介绍了如何从头开始训练稳定扩散LoRA。

[*第22章*](B21263_22.xhtml#_idTextAnchor443)，*探索稳定扩散之外的内容*，提供了有关稳定扩散、AI以及如何了解最新发展的更多信息。

# 要充分利用本书

您需要具备一些Python编程语言的经验。熟悉神经网络和PyTorch将有助于阅读和运行本书中的代码。

免责声明：

这本书的编写考虑了道德规范和法规。请避免将在这里获得的知识用于任何不道德的目的。请参阅[*第22章*](B21263_22.xhtml#_idTextAnchor443)以深入了解使用AI的伦理问题。

| **本书涵盖的软件/硬件** | **操作系统要求** |
| --- | --- |
| Python 3.10+ | Linux、Windows或macOS |
| Nvidia GPU（Apple M芯片可能可行，但强烈推荐Nvidia GPU） |  |
| Hugging Face Diffusers |  |

请参阅[*第2章*](B21263_02.xhtml#_idTextAnchor037)以获取设置环境的详细步骤。

**如果您正在使用本书的数字版，我们建议您亲自输入代码或从本书的GitHub仓库（下一节中提供链接）获取代码。这样做将有助于您避免与代码的复制和粘贴相关的任何潜在错误。**

# 下载示例代码文件

您可以从GitHub（[https://github.com/PacktPublishing/Using-Stable-Diffusion-with-Python](https://github.com/PacktPublishing/Using-Stable-Diffusion-with-Python)）下载本书的示例代码文件。如果代码有更新，它将在GitHub仓库中更新。

我们还有其他来自我们丰富的图书和视频目录的代码包，可在[https://github.com/PacktPublishing/](https://github.com/PacktPublishing/)找到。查看它们吧！

# 使用的约定

本书使用了多种文本约定。

`文本中的代码`：表示文本中的代码单词、数据库表名、文件夹名、文件名、文件扩展名、路径名、虚拟URL、用户输入和Twitter昵称。以下是一个示例：“在这里，让我们使用`controlnet-openpose-sdxl-1.0` open pose ControlNet for SDXL。”

代码块设置为以下格式：

```py
import torch
from diffusers import StableDiffusionPipeline
# load model
text2img_pipe = StableDiffusionPipeline.from_pretrained(
    "stablediffusionapi/deliberate-v2",
    torch_dtype = torch.float16
).to("cuda:0")
```

任何命令行输入或输出都按以下方式编写：

```py
$ pip install pandas
```

**粗体**：表示新术语、重要单词或屏幕上看到的单词。例如，菜单或对话框中的单词以**粗体**显示。以下是一个示例：“点击**运行**按钮后，进度条将出现在输出文本框的位置。”

小贴士或重要注意事项

看起来像这样。

# 联系我们

我们欢迎读者的反馈。

`customercare@packtpub.com`并在邮件主题中提及书名。

**勘误表**：尽管我们已经尽最大努力确保内容的准确性，但错误仍然可能发生。如果您在这本书中发现了错误，我们将不胜感激，如果您能向我们报告，我们将不胜感激。请访问[www.packtpub.com/support/errata](http://www.packtpub.com/support/errata)并填写表格。

`copyright@packt.com`并附上材料的链接。

**如果您有兴趣成为作者**：如果您在某个领域有专业知识，并且您有兴趣撰写或为书籍做出贡献，请访问[authors.packtpub.com](http://authors.packtpub.com)。

# 分享您的想法

一旦您阅读了《使用Python进行稳定扩散》，我们很乐意听听您的想法！请[点击此处直接进入此书的亚马逊评论页面](https://packt.link/r/1-835-08637-3)并分享您的反馈。

您的评论对我们和科技社区非常重要，并将帮助我们确保我们提供高质量的内容。

# 下载此书的免费PDF副本

感谢您购买此书！

您喜欢在路上阅读，但无法携带您的印刷书籍到处走吗？

您的电子书购买是否与您选择的设备不兼容？

请放心，现在购买每一本Packt书籍，您都可以免费获得该书的DRM免费PDF版本。

在任何地方、任何设备上阅读。直接从您最喜欢的技术书籍中搜索、复制和粘贴代码到您的应用程序中。

优惠远不止于此，您还可以获得独家折扣、时事通讯和每日免费内容的每日电子邮件。

按照以下简单步骤获取好处：

1.  扫描下面的二维码或访问以下链接

![](img/B21263_QR_Free_PDF.jpg)

[https://packt.link/free-ebook/9781835086377](https://packt.link/free-ebook/9781835086377)

1.  提交您的购买证明

1.  就这些！我们将直接将您的免费PDF和其他好处发送到您的电子邮件中。

# 第1部分 – 稳定扩散的旋风

欢迎来到稳定扩散的迷人世界，这是一个快速发展的领域，它彻底改变了我们处理图像生成和编辑的方式。在我们旅程的第一部分，我们将全面探索基础知识，为深入理解这项强大的技术打下基础。

在接下来的六章中，我们将深入探讨稳定扩散的核心概念、原则和应用，为进一步的实验和创新提供坚实的基础。我们将从介绍稳定扩散的基础知识开始，然后提供设置成功环境的实战指南。您将学习如何使用稳定扩散生成令人惊叹的图像，然后更深入地探讨扩散模型的理论基础以及稳定扩散如何施展其魔法的复杂性。

到本部分结束时，您将全面了解稳定扩散，从其底层机制到实际应用，这将使您能够利用其潜力并创作出令人瞩目的视觉内容。那么，让我们深入探索稳定扩散的奇妙之处吧！

本部分包含以下章节：

+   [*第1章*](B21263_01.xhtml#_idTextAnchor015), *介绍稳定扩散*

+   [*第2章*](B21263_02.xhtml#_idTextAnchor037), *为稳定扩散设置环境*

+   [*第3章*](B21263_03.xhtml#_idTextAnchor064), *使用稳定扩散生成图像*

+   [*第4章*](B21263_04.xhtml#_idTextAnchor081), *理解扩散模型背后的理论*

+   [*第5章*](B21263_05.xhtml#_idTextAnchor097), *理解稳定扩散的工作原理*

+   [*第6章*](B21263_06.xhtml#_idTextAnchor117), *使用稳定扩散模型*
