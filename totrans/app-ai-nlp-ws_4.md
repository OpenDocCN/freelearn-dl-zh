# 4. 对话式人工智能

概述

本章教你如何使用Amazon Lex设计聊天机器人。你将从学习**对话式人工智能**的基础以及使用该技术设计定制聊天机器人的最佳实践开始。然后，你将使用Amazon Lex创建一个自定义聊天机器人，通过识别文本中的意图来获取最新的股市报价。到本章结束时，你将熟练掌握聊天机器人的基础知识以及设计它们的过程。利用这些知识，你将能够创建自己的聊天机器人来解决各种商业挑战。

# 对话式人工智能简介

与本书中的其他章节一样，本章涵盖了概念方面以及实用的动手构建——这次，领域是对话式人工智能。从许多报告中可以看出，对话式人工智能市场将每年增长超过30%，并且大多数客户以及员工都将与数字助手进行互动。

创建响应性、智能和交互式机器人的挑战在于，对于机器来说，对话是非常难以实现的。让我们看看为什么这是这种情况的前三个原因：

+   对话只传达必要的信息——从对话中得出的大多数信息甚至不在对话中。这是因为人类拥有常识、推理、共享的上下文、知识和假设。我们还通过语气、面部表情甚至非言语交流（即肢体语言）赋予对话丰富的含义。这些因素使得对话难以理解，尽管交换的词汇较少。因此，只关注交换的词汇的对话式人工智能可能错过了90%的嵌入信息。

+   这不仅仅是一系列计算机算法——计算机理论观点只是对话交换的一部分。我们还需要结合语言学、对话含义和其他领域。再次强调，这对计算机来说是一个非常困难的任务——它们在神经网络方面做得很好，但在语法方面就不那么擅长了。

+   消费者被极好的对话交互所宠坏。虽然对话领域非常复杂，但像Alexa、Siri和Google Assistant这样的产品在对话式人工智能方面取得了巨大的进步。这给基于对话式人工智能开发交互业务的企业带来了一定的高期望。即使是围绕对话交互的最普通任务，消费者也期望达到Alexa、Siri或Google Assistant的复杂程度。因此，你的对话系统必须跨越这个障碍。

这很自然地引出了本章的开始：Amazon Lex 使用与 Alexa 相同的技术，而 Amazon Contact Center 使用 Amazon Connect，这意味着我们可以部署他们的最佳实践。实际上，Amazon Connect 是为了满足他们客户服务部门的严格要求而开发的。所以，我们很幸运——我们可以利用我们的客户在日常生活中习惯的尖端交互。

## 交互类型

当我们谈论对话人工智能时，主要有两种类型——面向任务型和开放式对话。正如其名所示，面向任务型的对话旨在完成任务（例如，查询账户余额、订购商品、查看天气、查看股票价格、了解剩余的假期天数等）。开放式一般对话更广泛，因为它们涵盖了各种主题——这可能是天气、电影、财务状况、投资等等。在本章中，我们将专注于面向任务型的对话。

## 全渠道

另一个需要记住的是对话的全渠道方面——可以通过聊天机器人的文本界面或**语音用户界面（VUI**）进行对话；它们可以从一个跳转到另一个，而且随着新的视觉 IVR 概念的出现，它们甚至可能是并行的。这就是为什么我们将在本章中先介绍聊天机器人，然后介绍语音。多模态是对话人工智能的一个重要组成部分。

简而言之，在本章中，你将学习如何使用 **Amazon Lex** 构建聊天机器人。我们还将涵盖对话人工智能的设计。然后，我们将深入研究 Amazon Connect 并探索为我们的机器人添加语音。首先，我们将讨论如何设计聊天机器人。然后，我们将通过创建一个示例聊天机器人来深入了解 Amazon Lex 服务。

# 什么是聊天机器人？

聊天机器人是面向任务型对话人工智能的一个具体实例——目标是能够与用户进行对话，达到解决客户查询、执行客户请求的任务或建议从他们那里前进的方式所需的程度。

正如正常对话一样，我们与机器人互动的方式可以是书面文字或语音。通常，聊天机器人会集成到消息平台中，如 Slack、Facebook、Kik 和微信。这也可以集成到自定义的网页或移动界面中。

当然，在现有的消息平台中集成更容易，因为用户可能熟悉该界面。此外，这些平台为聊天机器人开发者提供基础设施和开发工具的支持。

聊天机器人的例子包括产品订购系统、报告、内部沟通和调度。

# 什么是自然语言理解？

自然语言处理（NLP）是一组处理自然语言技术的通用术语。**自然语言理解（NLU**）是 NLP 的一个专注于实际对话输入的子集。

NLU能够处理非结构化输入并将它们转换成结构化、机器可理解的格式。用户输入的词语会被转换成意图和实体，或者称为slots。NLU聊天机器人还能够从用户输入中推断意图和slots，这些可能与——但并不一定与——它所训练的例子相同。

## 核心概念概述

在我们开始构建聊天机器人之前，你首先需要了解一些概念。让我们来看看术语*chatbot*的技术含义以及构成聊天机器人并协同工作以向用户提供对话体验的各个组件的名称。

### Chatbot

聊天机器人，也称为`bot`或人工对话实体，是一种能够使用自然语言与用户进行对话的软件。目标是让用户相信他们可以与机器人自由自然地互动，几乎就像与另一个人交谈一样。

### Utterances

用户对机器人说的话被称为**utterances**。机器人将用户的utterances视为输入，并能够将其解析成机器可识别的格式。以下是一些utterances的例子：

+   我想去看看牙医。

+   你能告诉我今天的天气怎么样吗？

### Intent

**intent**是指用户根据其utterances的内容想要做的事情。意图可以是一个单一步骤（例如，获取余额）或一个多步骤过程（例如，预订包括订票、订酒店、订交通等在内的旅行）。机器人从用户的utterances以及上下文中推断出意图，并根据其内部业务规则或应用程序流程支持它们，结果可能是其内部状态的变化或执行某个动作。这些通常也会导致向用户提供反馈或信息的响应。

因此，从先前的utterance例子中，机器人可能会推断出以下意图：

+   我想去看看牙医 => SeeDentist。

+   你能告诉我今天的天气怎么样吗？ => GetWeather。

推断意图是NLU平台（如Lex）在幕后执行的重要部分。一系列训练示例，以用户可能提供的句子形式，被输入到平台中，并从这些例子中构建一个概率模型。这意味着在实践中，平台应该能够从输入中推断出正确的意图，这可能与——但不一定是——系统所训练的例子的一部分。

### Prompts

当机器人需要从用户那里获取更多信息或对意图不清楚时，它可以询问用户后续问题，以便收集更多信息。这些被称为**prompts**。Prompts通常填充所需的slot值，尽管如果你的应用程序逻辑需要，也可以尝试填充可选值。

### Slot

槽位是与意图相关联的信息或参数。信息可以包含在初始用户请求中，Lex 将能够解析出信息并将其正确分配给相应的槽位。如果此信息不是作为请求的一部分提供，那么机器人应该能够单独提示用户提供信息。槽位可以是可选的或必需的。

**槽位**所表示的信息类型称为**槽位类型**。Lex 中内置了许多槽位类型，代表常见的信息类型，例如城市或州。以下是一些常见的槽位类型示例，它们被纳入 Lex 中：

![图 4.1：Lex 内置的槽位类型表

![图片 B16061_04_01.jpg](img/B16061_04_01.jpg)

图 4.1：Lex 内置的槽位类型表

当然，这只是一个非常有限的示例子集。还有许多其他内置类型，以及不同语言的类型。

注意

您可以参考以下链接以获取内置意图和槽位的完整列表：[https://docs.aws.amazon.com/lex/latest/dg/howitworks-builtins.html](https://docs.aws.amazon.com/lex/latest/dg/howitworks-builtins.html).

大多数内置的意图和槽位都作为 Alexa 技能套件文档的一部分进行了文档记录，Lex 中有一些差异，这些差异在先前的链接中有记录。请确保将链接添加到书签并定期参考该页面，因为亚马逊会不断更新服务，事情可能会发生变化。

如果您希望您的机器人处理的信息类型不是这些内置类型之一，您可以定义自己的类型，以及槽位允许的实际值。

### 满足

注意，机器人只有在填写了所有必需的槽位值后才能继续进行下一步。当然，这并不适用于可选的槽位值。

当一个意图的所有必需槽位都已填写时，槽位就准备好进行满足了。在这个阶段，机器人准备好执行满足意图所需的企业逻辑。企业逻辑可能是以下任何一种操作：

+   内部状态的变化

+   在内部运行代码

+   调用一个内部或外部服务以从中获取信息

+   调用一个内部或外部服务以向其发布信息

完成操作可以带有或没有对用户的反馈，但作为最佳实践，总是更好地偏向于提供更多的反馈给用户，而不是更少。

# 设计对话式人工智能的最佳实践

在我们深入探讨一些最佳实践之前，我们将简要介绍两个要点。我们只涵盖最重要的内容，并且有大量优秀的资料和书籍可供深入研究。其次，你可能会遇到需要忽略这些提示的情况——这可能包括交付压力和资源限制，但它们可能只是由于技术进步而错误。然而，我们需要意识到可能产生的潜在技术债务，并在某处记录下来以供未来参考。以下是一些最佳实践：

1.  当思考机器人时，要考虑**搜索**，而不是单一的问题-答案会话。这需要一点思考——机器人应该想要理解用户的需求，并参与迭代协作互动，以促进用户寻找的内容。例如，用户可能会问“我有多少钱？”你可以将其解决到支票账户的余额，并给出答案。然而，用户可能基于股票提示想要投资，或者可能在考虑一笔大额购买。因此，一个后续问题，如“这合理吗？你在想什么？”可能是一个好的策略。一个典型的例子是问题“最近的餐厅在哪里？”对于这个问题，你可以基于距离给出一个临床正确的答案，但餐厅可能已经关闭。因此，自愿提供更多信息，如“最近的餐厅距离x分钟，但现在已关闭。你现在是否在寻找一家可以去的开放餐厅？”可能是一个好的回应。

1.  对话是一个从简单的命令和通知到深层嵌套对话的连续体，如下面的图表所示：![图4.2：对话式AI的层次]

    ![图片](img/B16061_04_02.jpg)

    图4.2：对话式AI的层次

    在当前技术的成熟度下，我们处于第3级——通过上下文机器人进行对话，这处于非常初级的阶段。理解这些层次并将你的机器人服务定位在连续统一体中对于估计可能性和所需努力非常重要，尤其是在用户期望方面。

1.  将对话式AI——聊天机器人、语音助手或两者的结合，视为**可用、智能和自主**的交互。

1.  一个机器人（聊天机器人、语音机器人，甚至是可视IVR）是一种体验。这意味着你需要开发一个最小令人喜爱的产品——它不应该过于雄心勃勃和复杂，拥有众多功能；同时，它也不应该过于狭隘，以至于不能完全发挥其作用。保持步骤简单，在确保它们完成所需任务的同时展示价值。

1.  有一种误解认为机器人没有**视觉品牌**。对话式用户体验作为一种“透明”的用户体验，仍然提供了足够多的视觉元素，这些元素会影响你机器人的品牌形象。

1.  **监控、适应和改进** —— 话语监控日志是你的朋友。广泛使用分析来询问关于用户学习曲线的问题——用户需要多长时间才能理解机器人的功能范围？

1.  视觉设计师在美学上花费时间，就像他们一样，对话设计师在编写适合你的机器人范围和受众的内容和功能上花费大量时间。我们说话的方式与我们写作的方式不同，所以你不能字面地将你的网站变成一个机器人。

1.  考虑到参与三要素，即 **吸引-参与-愉悦**。对你的机器人目的和核心功能要有非常清晰和明确的认识。用 **敏锐和意外** 来惊喜你的用户。

1.  机器人非常 **迭代** —— 你必须随着你的学习和用户的进步不断改进它们。慢慢建立用户的信任和信心。持续向用户展示新功能；一个关于新功能的话题欢迎区是个好主意。或者，为原始问题建议新的上下文功能。

1.  将机器人视为 **门户** —— 服务的界面。你仍然需要后端来满足服务——查询等。

1.  计划从真实用户那里学习并改进你的机器人。一旦你的助手能够处理几个愉快的路径故事，就是让它进入现实世界以引导开发方向的时候了。

1.  遵循 **格赖斯准则**，即质量准则、数量准则（如所需的信息量，不要更多）、关系准则（或相关性——保持相关性）、方式准则（简短有序）和智慧准则。

# 创建自定义聊天机器人

在本节中，我们将创建一个自定义聊天机器人，使用 `GetQuote` 获取股票市场报价。这向机器人表明，例如，我们必须为给定的股票代码获取股票市场报价，该报价将驻留在名为 **ticker** 的槽位中。然后机器人将从名为 **IEX** 的免费金融API中查找该股票代码的报价，并通过对话响应将信息返回给用户：

注意

股票代码是表示在交易所（如纽约证券交易所或纳斯达克）交易的股票的标准方式。一系列字母代表正在交易的公司的股票。

![图 4.3：聊天机器人工作流程

](img/B16061_04_03.jpg)

图 4.3：聊天机器人工作流程

我们可以为这个过程创建一个流程图，如下所示。让我们进一步详细地讨论它：

![图 4.4：聊天机器人工作流程流程图

](img/B16061_04_04.jpg)

图 4.4：聊天机器人工作流程流程图

**识别意图和填充槽位值**

作为第一步，机器人等待用户的输入以识别一个有效的意图。当它从用户发布的言语中提取`GetQuote`意图作为意图时，它将尝试填充所需的槽位。在我们的例子中，我们只有一个`StockTicker`类型的槽位（这是一个自定义槽位类型）。机器人将发出提示，要求用户提供槽位的值，并解析用户响应的言语，以填充槽位值。

有效的槽位是系统可以识别的槽位。如果槽位值不是允许值列表的一部分，或者如果系统无法识别输入的槽位值，则称其为`无效`或`非有效`。

如果槽位值无效，它将回退到尝试填充槽位（至少尝试到我们指定的次数，然后放弃并返回开始）。一旦机器人用有效值填充了槽位，它就会继续满足意图。

**使用Lambda函数满足意图**

当默认的满足动作是将意图和槽值返回给用户，以便他们可以在自己的应用程序中继续处理时，我们选择在AWS上设置一个Lambda函数来处理意图并运行满足该意图所需的企业逻辑。

在这一点上，Lex中运行的机器人流程将继续调用我们编写并指定的`Lambda`函数：

`Lambda_function.Lambda_handler`

当Lex调用函数以满足需求时，它发送一个包含有关发送者、意图和槽位值的各种信息的`JSON`有效负载。`Lambda_handler()`方法从`JSON`有效负载中解析意图和槽位参数值，然后调度另一个函数调用，从外部API获取我们正在寻找的市场报价值。

最后，`Lambda`函数还将响应打包为另一个`JSON`字符串，并将其返回给Lex。Lex在幕后解析`JSON`响应，并将响应消息呈现给用户。

我们将在接下来的两个练习中更深入地探讨所有这些元素。在第一个练习中，我们将设置新的聊天机器人，在第二个练习中，我们将实现我们的Lambda处理程序函数，以便它返回用户请求的股票代码的实际市场价格。

# 识别意图并填充槽位的机器人

在下一个练习中，你将创建一个自定义聊天机器人，该机器人可以识别名为`GetQuote`的意图，以便为给定的股票代码获取市场价格报价。机器人将提示用户输入他们感兴趣的股票代码的值，直到槽位被填充。你还将学习如何在同一句话中声明意图和填充槽位。这个聊天机器人可以通过对话界面进行测试。

## 练习4.01：创建一个能够识别意图并填充槽位的bot

在这个练习中，我们将创建并测试一个基于Amazon Lex的自定义意图和槽位的bot。创建具有自定义意图和槽位的bot必须执行的步骤如下：

1.  第一步是从亚马逊管理控制台导航到`Amazon Lex服务`。通常，这需要访问aws.amazon.com，然后是**我的账户**，然后点击**AWS管理控制台**。

1.  您可以通过在**机器学习**下的**Amazon Lex**处点击来选择**服务**。

1.  下一步是选择`创建`按钮。这将带您进入`bot`创建屏幕：![图4.5：Amazon Lex控制台

    ](img/B16061_04_05.jpg)

    图4.5：Amazon Lex控制台

1.  在这一点上，您可以通过点击**自定义bot**选项按钮来创建一个自定义bot。这将揭示bot的详细信息，可以填写，如下面的截图所示：![图4.6：自定义bot选项

    ](img/B16061_04_06.jpg)

    图4.6：自定义bot选项

1.  `bot`名称字段可以设置为`MarketNanny`。这是仅基于文本的应用程序，因为我们在这个部分只会用文本与bot交互，而不会使用语音。

    会话超时可以设置为默认的`5分钟`。IAM角色字段显示IAM角色的名称，Lex会自动创建该角色以供bot应用程序使用。让我们将`情感分析`设置为`是`。

1.  最后，`COPPA`字段与`否`相关。然而，如果您是13岁以下的在校学生或打算让13岁以下的某人使用您的聊天机器人，那么您应该点击`是`选项。

    注意

    1998年通过了一项法律来保护13岁以下的儿童隐私。它规定，在线网站在没有父母同意的情况下，不得收集13岁以下用户的个人信息，以及其他规定。您可以在[https://www.ftc.gov/enforcement/rules/rulemaking-regulatory-reform-proceedings/childrens-online-privacy-protection-rule](https://www.ftc.gov/enforcement/rules/rulemaking-regulatory-reform-proceedings/childrens-online-privacy-protection-rule)了解更多关于COPPA法案的信息。

1.  最后，点击`槽类型`。

1.  点击`创建意图`按钮以弹出`添加意图`对话框：![图4.7：MarketNanny bot编辑器

    ](img/B16061_04_07.jpg)

    图4.7：MarketNanny bot编辑器

1.  相反，如果您已经定义了意图，您可以通过点击屏幕左侧列中`意图`标题旁边的`+`号来创建一个新的意图。

1.  `创建意图`窗口提供了一些选项，我们可以使用这些选项将意图添加到bot中。包含一个或多个Lex格式意图的`JSON`文件的`ZIP`文件。

1.  搜索现有意图允许您重用您可能之前定义或导入的意图，以及由`Amazon Lex`定义的内置意图。

1.  点击`创建意图`链接以进入以下步骤中显示的对话框。

1.  在`创建意图`对话框中，将您的新意图命名为`GetQuote`。当您告诉机器人您对市场报价感兴趣时，机器人将识别此意图。点击`添加`按钮以完成此步骤：![图4.8：创建意图屏幕

    ![图片](img/B16061_04_08.jpg)

    图4.8：创建意图屏幕

1.  此时，您应该回到编辑器屏幕，您应该看到屏幕左侧工具栏部分的`GetQuote`意图，如以下截图所示。编辑器屏幕还包含一些用于定义和自定义新意图的字段。

1.  首先要做的是填写一些样本语句来训练Lex背后的`NLU`系统，以便识别您提供给机器人的语句作为`GetQuote`意图的信号：![图4.9：创建意图

    ![图片](img/B16061_04_09.jpg)

    图4.9：创建意图

1.  在输入一些样本语句后，点击页面顶部附近的`构建`按钮以启动机器人的训练过程：![图4.10：构建机器人

    ![图片](img/B16061_04_10.jpg)

    图4.10：构建机器人

1.  将会出现一个后续的对话框，其中还有一个`构建`按钮，您也应该点击：![图4.11：构建确认

    ![图片](img/B16061_04_11.jpg)

    图4.11：构建确认

1.  之后，您应该等待，直到您看到`MarketNanny构建成功`的消息框。这可能需要几秒钟到几分钟的时间：![图4.12：机器人构建成功

    ![图片](img/B16061_04_12.jpg)

    图4.12：机器人构建成功

    您可以在屏幕右上角的`测试机器人`面板中测试您的新意图。

    注意

    如果测试机器人面板不可见，您可能需要点击一个箭头按钮来展开它并使其可见。

1.  在面板中输入*语句*以验证机器人能否从语句中识别出正确的意图：![图4.13：测试机器人

    ![图片](img/B16061_04_13.jpg)

    图4.13：测试机器人

1.  当它返回以下响应时，你知道它已经正确识别了意图：`Intent GetQuote is ReadyForFulfillment`。请随意根据您的样本语句进行实验，以验证`GetQuote`意图及其已准备好执行的状态。这是因为我们尚未为此意图添加任何槽位。

1.  您的下一步将是添加一个槽位，以及为该槽位添加一个自定义槽位类型：![图4.14：添加槽位

    ![图片](img/B16061_04_14.jpg)

    图4.14：添加槽位

1.  添加`槽位类型`。这可以通过在编辑器屏幕左侧工具栏部分旁边按下`+`按钮来完成。这会弹出一个`添加槽位类型`对话框，我们也可以选择像之前使用意图一样使用Lex的`JSON`结构来导入槽位类型。然而，在我们这样做之前，我们将点击`创建槽位类型`链接来创建一个新的槽位类型：![图4.15：创建槽位类型

    ![图片](img/B16061_04_15.jpg)

    图4.15：创建槽位类型

1.  在弹出的`添加槽位类型`对话框中，输入槽位类型名称为`StockTicker`。这是我们正在定义的槽位类型的名称。可选地，你可以在`描述`字段中输入描述，并将`槽位解析`选项保留为`展开值`。

1.  在`值`字段下，输入一些`股票代码`符号，如图所示，以提供`StockTicker`槽位类型的示例值。如果你愿意，也可以添加一些自己的：![图 4.16：添加槽位类型

    ](img/B16061_04_16.jpg)

    图 4.16：添加槽位类型

1.  最后，点击`添加` `槽位到意图`按钮，以将槽位类型添加到意图中，并关闭对话框。

1.  我们也可以点击`保存槽位类型`按钮，并在单独的步骤中将槽位添加到意图中，但使用按钮是完成这两个动作的单步快捷方式。

1.  当你关闭对话框时，你会在槽位部分找到Lex添加的新槽位条目，它有用地预先填充了`StockTicker`槽位类型，你应该在条目的`名称`字段中将槽位名称更改为`ticker`。

1.  点击`提示`字段下的轮盘，将其展开到一个新的对话框：![图 4.17：编辑对话框

    ](img/B16061_04_17.jpg)

    图 4.17：编辑对话框

1.  提示编辑对话框（命名为股票代码提示或股票代码设置）允许我们为`槽位`输入提示，机器人将使用这些提示来存储用户的`输入`以及用户在机器人试图通过提示从用户那里获取信息时通常会提供给机器人的示例`言语`。

1.  槽位值在相应言语中的位置由花括号 `{}` 和括号内的槽位名称表示。在这种情况下，由于槽位名称为`ticker`，在示例言语中用 `{ticker}` 表示。

1.  在**提示**部分填写提示（一个提示就足够了——如果你添加更多提示，机器人将随机使用它们，以增加多样性）。

1.  然后，在相应的言语部分添加一些`言语`，在每个示例语句中使用占位符令牌 `{ticker}` 表示槽位值。

1.  将`最大重试次数`字段保留为默认值`2`。这意味着它将尝试获取槽位值两次，然后才会发出错误信号：![图 4.18：股票代码提示屏幕

    ](img/B16061_04_18.jpg)

    图 4.18：股票代码提示屏幕

1.  接下来，点击`保存`按钮以保存槽位提示和相应的言语定义。

1.  最后，点击屏幕底部的`保存` `意图`按钮，然后点击屏幕顶部的`构建`按钮，以启动使用我们定义的新槽位和槽位类型的训练过程。等待训练完成后显示完成对话框：![图 4.19：保存意图

    ](img/B16061_04_19.jpg)

    图 4.19：保存意图

1.  您更新的意图现在可以在“测试机器人”面板中进行测试：![图4.20：更新后的意图测试机器人

    ![img/B16061_04_20.jpg]

    图4.20：更新后的意图测试机器人

1.  在机器人流程结束时，当所有需要的信息都已填写完毕，它将以之前相同的格式返回意图。然而，它随后又跟了一条包含槽位参数名称和值的行：

    [PRE0]

1.  这表明股票槽位已被填充为`GOOG`值。所以，太好了；我们的带槽位意图正在工作。

1.  当你在与机器人玩耍以验证意图和槽位是否按预期工作的时候，为什么不尝试点不同的事情呢？输入一些不是你之前输入以训练机器人的样本语句的语句。

1.  以“我能得到一个市场报价吗？”作为你的初始语句，看看机器人是否能识别出意图。记住，尽管这个句子与样本语句相似，但它并不是那些语句之一：![图4.21：测试机器人屏幕

    ![img/B16061_04_21.jpg]

    图4.21：测试机器人屏幕

    如前一个屏幕截图所示，Lex不仅能够从它没有训练过的语句中识别出正确的意图，而且还能正确地将它之前没有见过的符号（ADP）识别为股票槽位的值。

1.  现在，让我们尝试通过在句子中插入一个随机的插入语作为句子的一部分，来为槽位提示尝试一种对应的对话形式，再次使用一个新股票代码符号（`VZ`），这个符号是机器人之前没有训练过的。再次，它被正确处理和识别：![图4.22：测试机器人屏幕

    ![img/B16061_04_22.jpg]

图4.22：测试机器人屏幕

显然，在训练和真实世界的对话输入之间，使用NLU引擎有很大的灵活性。

## 自然语言理解引擎

NLU展示了使用在大量对话句子上训练并形成大型推理模型的NLU引擎的优势。

它能够连接与它专门训练的句子不同的句子。事实上，它们可以非常不同，但模型足够大，可以推断出语义含义是相似的。

你可以使用一个技巧来让用户更容易与你的机器人互动。你可以用建立意图的相同语句填充槽位值。这可以通过简单地包括槽位占位符令牌（在这个例子中是`{ticker}`）在你的样本语句中来实现。执行以下步骤：

1.  按照以下方式向您的`GetQuote`意图添加一个新的样本语句：![图4.23：GetQuote屏幕

    ![img/B16061_04_23.jpg]

    图4.23：GetQuote屏幕

1.  `ticker`占位符标记表示该槽位可以直接在初始话语中填充，并且在这种情况下，不需要生成提示：![图4.24：机器人的构建屏幕

    ![图片](img/B16061_04_24.jpg)

    ![图4.24：机器人的构建屏幕

1.  点击“构建”按钮，像以前一样训练您的更新意图，然后在“测试机器人”面板中测试它，如下所示：![图4.25：测试机器人屏幕

    ![图片](img/B16061_04_25.jpg)

![图4.25：测试机器人屏幕

您可以看到意图已准备好满足，并且槽位值已适当填充，只需一步即可。

我们现在已经完成了在Amazon Lex中定义自定义聊天机器人的过程，包括自定义意图、槽位类型和槽位。此外，我们还训练并测试了机器人，以验证它能够以高度准确度对正确的意图进行分类，并从会话输入中正确推断槽位值。

最后，我们添加了一种快捷方法，通过在训练NLU引擎的示例话语中插入槽位值的占位符标记，直接在初始话语中填充槽位值。

# Lambda函数 - 实现业务逻辑

您可以创建AWS Lambda函数，这些函数可以从您的Amazon Lex机器人触发。正如我们在*第2章*中讨论的，*使用自然语言处理分析文档和文本*，无服务器计算和Lambda函数非常适合在Lex机器人中实现满足和验证功能。Lambda函数与返回到后端应用程序的每个步骤（如验证）相比，集成更好、更快，并且扩展性更好。一旦验证了意图并且您对参数满意，您就可以调用后端API来满足请求。您可以将简单的满足请求实现为Lambda函数，从而使您的机器人响应迅速且可扩展。

在下一个练习中，您将学习如何在AWS中将机器人的业务逻辑作为Lambda函数实现，并调用一个真实的REST API以获取您可以从外部服务返回给用户的信息。

## 练习4.02：创建处理聊天机器人满足的Lambda函数

在这个练习中，我们将使用在AWS上创建和部署的`Lambda`函数来处理聊天机器人满足业务逻辑。在前一个练习中，我们创建了一个具有`GetQuote`意图和`ticker`槽位的聊天机器人。执行以下步骤以实现业务逻辑：

1.  通过**AWS管理控制台 - 服务**导航到**计算**下的**AWS Lambda**屏幕。

1.  如果您以前从未使用过Lambda，您应该会看到一个欢迎屏幕：![图4.26：AWS Lambda启动屏幕

    ![图片](img/B16061_04_26.jpg)

    图4.26：AWS Lambda启动屏幕

1.  点击“创建函数”按钮开始。

1.  在下一页选择“从零开始创建作者”选项：![图4.27：选择作者

    ![图片](img/B16061_04_27.jpg)

    ![图4.27：选择作者

1.  对于运行时，从下拉菜单中选择 `Python 3.6`，因为你将在这个练习中使用 Python 语言实现处理程序。在 `Name` 字段中填写 `marketNannyHandler`：![图 4.28：填写值

    ](img/B16061_04_28.jpg)

    图 4.28：填写值

1.  点击 `Choose or create an execution role` 并选择角色字段。然后，选择 `Create a new role from AWS policy templates` 单选按钮：![图 4.29：角色选择屏幕

    ](img/B16061_04_29.jpg)

    图 4.29：角色选择屏幕

1.  在 `Role name` 字段中输入名称 `marketNannyProcessorRole`。然后，点击 `Create function` 按钮在 AWS 中创建 Lambda 函数。你应该会看到一个确认屏幕，如下所示：![图 4.30：确认屏幕

    ](img/B16061_04_30.jpg)

图 4.30：确认屏幕

在这个练习中，你学习了如何使用在 AWS 上创建和部署的 Lambda 函数处理聊天机器人满足业务逻辑。

## 实现Lambda函数

在这里，你将完全在行内使用 Lambda 函数编辑器，这意味着你可以直接输入和修改代码，而无需将任何文件上传到 AWS。你输入的代码将在 Lambda 函数被调用时执行：

![图 4.31：函数代码屏幕

](img/B16061_04_31.jpg)

图 4.31：函数代码屏幕

首先，让我们看看 Lambda 函数的结构。

当你创建 `marketNannyHandler` 函数时，AWS 创建了一个具有相同名称的文件夹，文件夹中包含一个名为 `Lambda_function.py` 的 Python 文件。这个文件包含 `Lambda_handler` 函数的占位符，这是我们的 Lambda 函数的入口点。入口点接受两个参数作为参数：

+   事件参数提供了从调用进程发送到函数的负载值。它通常以 Python `dict` 类型的形式出现，尽管它也可能是 `list`、`str`、`int`、`float` 或 `NoneType` 之一。

+   上下文参数是 `LambdaContext` 类型，包含运行时信息。在这个练习中你将不会使用此参数。

函数的返回值可以是 `JSON` 可序列化的任何类型。这个值在序列化后返回给调用应用程序。

## 输入参数结构

现在，让我们更仔细地看看传递给 `Lambda_handler` 函数的事件参数的结构。如果我们请求一个具有 `GOOG` 标记值的股票报价，参数中意图部分的 `JSON` 值将如下所示：

[PRE1]

我们在处理过程中感兴趣的相关值是 `name` 和 `currentIntent` 下的 `slots` 部分中的单个 `ticker` 值。

由于我们的 `JSON` 输入被转换为 Python 字典，我们可以在 Lambda 函数中如下获取这些值：

[PRE2]

## 实现高级处理函数

注意

`lambda_function.py` 文件包含完整的源代码。它可在 GitHub 上找到，网址为 [https://packt.live/2O8TUwA](https://packt.live/2O8TUwA)。你可以在 Lambda 编辑器中输入代码时参考它。我们在本例的末尾包含了调试技巧。在开始实现之前，先阅读示例以及技巧可能是个好主意。

实现我们处理器的第一步是识别意图名称并调用实现它的相应函数。这个伪代码看起来如下所示：

[PRE3]

到目前为止，这已经足够完整，可以实际测试你的聊天机器人，如果你愿意的话，但让我们继续进行实现。

为了测试，你应该添加一个测试事件，如下面的说明所示：

前往“配置测试事件”：

![图 4.32：配置测试事件下拉框](img/B16061_04_32.jpg)

![图片 B16061_04_32.jpg](img/B16061_04_32.jpg)

图 4.32：配置测试事件下拉框

按照此处所示进行编辑。Lambda 函数需要如所示 JSON 结构：

![图 4.33：编辑 Lambda 测试事件](img/B16061_04_33.jpg)

![图片 B16061_04_33.jpg](img/B16061_04_33.jpg)

图 4.33：编辑 Lambda 测试事件

## 实现获取市场报价的函数

下一步将是实现 `get_quote` 函数，该函数负责获取市场报价信息并将其返回给调用处理函数：

[PRE4]

注意，我们已将参数命名为 request，因此我们发送给函数的 `object` 事件在此函数中被称为请求。它包含相同的值和结构，只是重命名了。因此，我们可以通过获取具有 `ticker` 键的项的值来获取之前提到的股票槽的值，如下面的代码所示：

[PRE5]

然后，我们调用 `call_quote_api()` 函数来检索股票项目的市场报价值。我们尚未实现 `call_quote_api()`，所以让我们接下来做这个。

我们将按照以下方式实现 `call_quote_api` 函数：

[PRE6]

在这里，股票代码是股票参数的值（在这个特定示例中，它将是 `GOOG`）。我们使用 Alpha Vantage，它在网上提供了一个静态端点 [https://www.alphavantage.co/](https://www.alphavantage.co/) 来获取报价。我们还捕获了一个示例响应。你应该获取自己的 API 密钥。

由于它被实现为一个简单的 `GET` 请求，其中股票参数嵌入在 `URL` 中，包含 API 密钥，我们可以简单地使用 `urllib.request` 模块中内置的 `urlopen` 方法（我们记得要导入它）来接收包含股票嵌入其中的 URL 的响应。

由于响应也是 `JSON` 格式，我们需要导入 `json 模块` 并使用 `json.load` 函数加载响应。我们感兴趣的响应中的唯一字段是 `05. price`，因此我们将其作为函数的返回值返回。

## 将信息返回给调用应用程序（聊天机器人）

现在我们已经得到了市场报价值，我们可以将其返回到我们的调用应用程序，即我们实现的聊天机器人。然而，我们还需要做一些小事情来返回这个值。首先，我们需要将其格式化为对话响应，如下面的字符串所示：

[PRE7]

这应该让聊天机器人显示以下消息：

[PRE8]

最后一步是构建一个包含我们的消息和其他一些信息的`Amazon Lex` `JSON`返回格式。我们将使用`close`辅助函数来完成此操作：

[PRE9]

我们的`close`函数接受一个参数，即我们希望返回给聊天机器人的字符串（在这种情况下，这是消息变量的值）。它生成一个围绕内容的`JSON`包装器，符合我们的基于Lex的机器人所期望的结构，并从中提取内容并将其交付给用户。包装器的结构在此阶段并不重要，但如果你想了解，可以查看`close`函数的实现。如我们之前提到的，`lambda-function.py`文件包含Lambda函数的完整源代码。它可在GitHub上找到，网址为[https://packt.live/2O8TUwA](https://packt.live/2O8TUwA)。

代码窗口应如下所示：

![图4.34：代码窗口

![图片](img/B16061_04_34.jpg)

图4.34：代码窗口

## 连接到聊天机器人

到目前为止，唯一剩下的任务是将Lambda函数连接到聊天机器人并测试它。执行以下步骤来完成此操作：

1.  返回到Amazon Lex仪表板并选择`MarketNanny`机器人：![图4.35：连接到机器人

    ![图片](img/B16061_04_35.jpg)

    图4.35：连接到机器人

1.  然后，向下滚动到`Fulfillment`部分并选择`AWS Lambda函数`选项。接下来，从`Lambda函数`下拉菜单中选择`marketNannyHandler`函数，并将`版本或别名`保留为默认值`最新`：![图4.36：确认提示

    ![图片](img/B16061_04_36.jpg)

    图4.36：确认提示

1.  通过点击`构建`按钮重建意图，并在测试聊天机器人面板中与Lambda处理程序一起测试聊天机器人：![图4.37：聊天机器人更新

    ![图片](img/B16061_04_37.jpg)

    图4.37：聊天机器人更新

1.  以下截图显示了与机器人交互以查找AAPL当前价格的过程：![图4.38：聊天机器人更新

    ![图片](img/B16061_04_38.jpg)

图4.38：聊天机器人更新

## 调试技巧

这里有一些调试技巧可以帮助你：

1.  Lambda面板上的监控标签页的日志非常有用：![图4.39：CloudWatch指标

    ![图片](img/B16061_04_39.jpg)

    图4.39：CloudWatch指标

1.  日志收集在`CloudWatch`日志洞察中：![图4.40：CloudWatch日志洞察

    ![图片](img/B16061_04_40.jpg)

    图4.40：CloudWatch日志洞察

1.  如你所见，这需要我们进行多次尝试。我们在Lambda中使用了print语句来打印内容。以下屏幕截图显示了几个示例日志，以及Lex机器人的请求JSON的打印输出，以及来自股票报价API的http响应。这使得很容易看到各种信息片段是如何嵌套的：![图4.41：CloudWatch日志显示print语句的输出

    ![图片](img/B16061_04_41.jpg)

    ![图4.41：CloudWatch日志显示print语句的输出

1.  你可以在下面的屏幕截图看到我遇到的一个错误。股票API以嵌套JSON的形式返回值，因此你必须使用`response ['Global Quote']["05\. price"]`，而不是仅仅使用`response ["05\. price"]:`![图4.42：CloudWatch日志显示KeyError

    ![图片](img/B16061_04_42.jpg)

    ![图4.42：CloudWatch日志显示KeyError

1.  Lambda日志非常实用，能够捕捉错误。逐步开发并测试每一个变更。如果变动部分太多或变化频繁，调试将会变得困难。

1.  适应AWS生态系统中的各种控制台、理解权限等需要一点时间，但如果你坚持不懈，你将收获好处。

# 摘要

我们本章从对话式人工智能的介绍开始，学习了该技术的不同方面如何帮助我们构建一个良好、有用的聊天机器人。我们还学习了一些核心概念，如话语、意图、情节等，这些是构建聊天机器人的基础。随后，在我们构建第一个聊天机器人之前，我们讨论了一些在设计对话式人工智能时非常有用的最佳实践。有了这些知识，我们进行了一次练习，创建了一个能够识别意图并填充槽位以检索股票价格的机器人。然后我们在AWS中创建了一个Lambda函数，帮助我们实现机器人的业务逻辑。在下一章中，我们将学习如何使用语音与聊天机器人交互。
