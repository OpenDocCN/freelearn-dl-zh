<html><head></head><body>
<div aria-label="181" epub:type="pagebreak" id="page1-7" role="doc-pagebreak"/>
<div id="_idContainer079">
<h1 class="chapterNumber"><a id="_idTextAnchor231"/><span class="koboSpan" id="kobo.1.1">5</span></h1>
<h1 class="chapterTitle" id="_idParaDest-123"><a id="_idTextAnchor232"/><span class="koboSpan" id="kobo.2.1">Building Intelligent Agents</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.3.1">As generative AI adoption grows, we start using LLMs for more open and complex tasks that require knowledge about fresh events or interaction with the world. </span><span class="koboSpan" id="kobo.3.2">This is what is generally called agentic applications. </span><span class="koboSpan" id="kobo.3.3">We’ll define what an agent is later in this chapter, but you’ve likely seen the phrase circulating in the media: </span><em class="italic"><span class="koboSpan" id="kobo.4.1">2025 is the year of agentic AI</span></em><span class="koboSpan" id="kobo.5.1">. </span><span class="koboSpan" id="kobo.5.2">For example, in a recently introduced RE-Bench benchmark that consists of complex open-ended tasks, AI agents outperform humans in some settings (for example, with a thinking budget of 30 minutes) or on some specific class of tasks (like writing Triton kernels).</span></p>
<p class="normal"><span class="koboSpan" id="kobo.6.1">To understand how these agentic capabilities are built in practice, we’ll start by discussing tool calling with LLMs and how it is implemented on LangChain. </span><span class="koboSpan" id="kobo.6.2">We’ll look in detail at the ReACT pattern, and how LLMs can use tools to interact with the external environment and improve their performance on specific tasks. </span><span class="koboSpan" id="kobo.6.3">Then, we’ll touch on how tools are defined in LangChain, and which pre-built tools are available. </span><span class="koboSpan" id="kobo.6.4">We’ll also talk about developing your own custom tools, handling errors, and using advanced tool-calling capabilities. </span><span class="koboSpan" id="kobo.6.5">As a practical example, we’ll look at how to generate structured outputs with LLM using tools versus utilizing built-in capabilities offered by model providers.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.7.1">Finally, we’ll talk about what agents are and look into more advanced patterns of building agents with LangGraph before we then develop our first ReACT agent with LangGraph—a research agent that follows a plan-and-solve design pattern and uses tools such as web search, </span><em class="italic"><span class="koboSpan" id="kobo.8.1">arXiv</span></em><span class="koboSpan" id="kobo.9.1">, and </span><em class="italic"><span class="koboSpan" id="kobo.10.1">Wikipedia</span></em><span class="koboSpan" id="kobo.11.1">. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.12.1">In a nutshell, the following topics will be covered in this chapter:</span></p>
<div aria-label="182" epub:type="pagebreak" id="page2-7" role="doc-pagebreak"/>
<ul>
<li class="b lletList"><span class="koboSpan" id="kobo.13.1">What is a tool?</span></li>
<li class="b lletList"><span class="koboSpan" id="kobo.14.1">Defining built-in LangChain tools and custom tools</span></li>
<li class="b lletList"><span class="koboSpan" id="kobo.15.1">Advanced tool-calling capabilities</span></li>
<li class="b lletList"><span class="koboSpan" id="kobo.16.1">Incorporating tools into workflows</span></li>
<li class="b lletList"><span class="koboSpan" id="kobo.17.1">What are agents?</span></li>
</ul>
<div>
<div class="note" id="_idContainer072">
<p class="normal"><span class="koboSpan" id="kobo.18.1">You can find the code for this chapter in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.19.1">chapter5/</span></code><span class="koboSpan" id="kobo.20.1"> directory of the book’s GitHub repository. </span><span class="koboSpan" id="kobo.20.2">Please visit </span><a href="https://github.com/benman1/generative_ai_with_langchain/tree/second_edition"><span class="url"><span class="koboSpan" id="kobo.21.1">https://github.com/benman1/generative_ai_with_langchain/tree/second_edition</span></span></a><span class="koboSpan" id="kobo.22.1"> for the latest updates. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.23.1">See </span><a href="E_Chapter_2.xhtml#_idTextAnchor044"><em class="italic"><span class="koboSpan" id="kobo.24.1">Chapter 2</span></em></a><span class="koboSpan" id="kobo.25.1"> for setup instructions. </span><span class="koboSpan" id="kobo.25.2">If you have any questions or encounter issues while running the code, please create an issue on GitHub or join the discussion on Discord at </span><a href="https://packt.link/lang"><span class="url"><span class="koboSpan" id="kobo.26.1">https://packt.link/lang</span></span></a><span class="koboSpan" id="kobo.27.1">.</span></p>
</div>
</div>
<p class="normal"><a id="_idTextAnchor233"/><span class="koboSpan" id="kobo.28.1">Let’s begin with tools. </span><span class="koboSpan" id="kobo.28.2">Rather than diving straight into defining what an agent is, it’s more helpful to first explore how enhancing LLMs with tools actually works in practice. </span><span class="koboSpan" id="kobo.28.3">By walking through this step by step, you’ll see how these integrations unlock new capabilities. </span><span class="koboSpan" id="kobo.28.4">So, what exactly are tools, and how do they extend what LLMs can do?</span></p>
<h1 class="heading-1" id="_idParaDest-124"><a id="_idTextAnchor234"/><span class="koboSpan" id="kobo.29.1">What is a tool?</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.30.1">LLMs are trained on vast general corpus data (like web data and books), which gives them broad knowledge but limits their effectiveness in tasks that require domain-specific or up-to-date knowledge. </span><span class="koboSpan" id="kobo.30.2">However, because LLMs are good at reasoning, they can interact with the external environment through tools—APIs or interfaces that allow the model to interact with the external world. </span><span class="koboSpan" id="kobo.30.3">These tools enable LLMs to perform specific tasks and receive feedback from the external world. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.31.1">When </span><a id="_idIndexMarker428"/><span class="koboSpan" id="kobo.32.1">using tools, LLMs perform three specific generation tasks:</span></p>
<ol>
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.33.1">Choose a tool to use by generating special tokens and the name of the tool.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.34.1">Generate a payload to be sent to the tool.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.35.1">Generate a response to a user based on the initial question and a history of interactions with tools (for this specific run).</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.36.1">Now it’s time to figure out how LLMs invoke tools and how we can make LLMs tool-aware</span><a id="_idTextAnchor235"/><span class="koboSpan" id="kobo.37.1">. </span><span class="koboSpan" id="kobo.37.2">Consider a somewhat artificial but illustrative question: </span><em class="italic"><span class="koboSpan" id="kobo.38.1">What is the square root of the current US president’s age multiplied by 132</span></em><span class="koboSpan" id="kobo.39.1">? </span><span class="koboSpan" id="kobo.39.2">This question presents two specific challenges:</span></p>
<div aria-label="183" epub:type="pagebreak" id="page3-7" role="doc-pagebreak"/>
<ul>
<li class="b lletList"><span class="koboSpan" id="kobo.40.1">It references current information (as of March 2025) that likely falls outside the model’s training data. </span></li>
<li class="b lletList"><span class="koboSpan" id="kobo.41.1">It requires a precise mathematical calculation that LLMs might not be able to answer correctly just by autoregressive token generation. </span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.42.1">Rather than forcing an LLM to generate an answer solely based on its internal knowledge, we’ll give an LLM access to two tools: a search engine and a calculator. </span><span class="koboSpan" id="kobo.42.2">We expect the model to determine which tools it needs (if any) and how to use them. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.43.1">For clarity, let’s </span><a id="_idIndexMarker429"/><span class="koboSpan" id="kobo.44.1">start with a simpler question and mock our tools by creating dummy functions that always give the same response. </span><span class="koboSpan" id="kobo.44.2">Later in this chapter, we’ll implement fully functional tools and invoke them:</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.45.1">question = </span><span class="hljs-string"><span class="koboSpan" id="kobo.46.1">"how old is the US president?"</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.47.1">raw_prompt_template = (</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.48.1">"You have access to search engine that provides you an "</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.49.1">"information about fresh events and news given the query. </span><span class="koboSpan" id="kobo.49.2">"</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.50.1">"Given the question, decide whether you need an additional "</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.51.1">"information from the search engine (reply with 'SEARCH: "</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.52.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.53.1">&lt;generated query&gt;' or you know enough to answer the user "</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.54.1">"then reply with 'RESPONSE &lt;final response&gt;').\n"</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.55.1">"Now, act to answer a user question:\n{QUESTION}"</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.56.1">)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.57.1">prompt_template = PromptTemplate.from_template(raw_prompt_template)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.58.1">result = (prompt_template | llm).invoke(question)</span></p>
<p class="snippet-code"><span class="hljs-built_in"><span class="koboSpan" id="kobo.59.1">print</span></span><span class="koboSpan" id="kobo.60.1">(result,response)</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.61.1">&gt;&gt; SEARCH: current age of US president</span></p>
<p class="normal"><span class="koboSpan" id="kobo.62.1">Let’s make sure that when the LLM has enough internal knowledge, it replies directly to the user:</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.63.1">question1 = </span><span class="hljs-string"><span class="koboSpan" id="kobo.64.1">"What is the capital of Germany?"</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.65.1">result = (prompt_template | llm).invoke(question1)</span></p>
<p class="snippet-code"><span class="hljs-built_in"><span class="koboSpan" id="kobo.66.1">print</span></span><span class="koboSpan" id="kobo.67.1">(result,response)</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.68.1">&gt;&gt; RESPONSE: Berlin</span></p>
<p class="normal"><span class="koboSpan" id="kobo.69.1">Finally, let’s give the model output of a tool by incorporating it into a prompt:</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.70.1">query = </span><span class="hljs-string"><span class="koboSpan" id="kobo.71.1">"age of current US president"</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.72.1">search_result = (</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.73.1">"Donald Trump ' Age 78 years June 14, 1946\n"</span></span></p>
<div aria-label="184" epub:type="pagebreak" id="page4-7" role="doc-pagebreak"/>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.74.1">"Donald Trump 45th and 47th U.S. </span><span class="koboSpan" id="kobo.74.2">President Donald John Trump is an American "</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.75.1">"politician, media personality, and businessman who has served as the 47th "</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.76.1">"president of the United States since January 20, 2025. </span><span class="koboSpan" id="kobo.76.2">A member of the "</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.77.1">"Republican Party, he previously served as the 45th president from 2017 to 2021. </span><span class="koboSpan" id="kobo.77.2">Wikipedia"</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.78.1">)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.79.1">raw_prompt_template = (</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.80.1">"You have access to search engine that provides you an "</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.81.1">"information about fresh events and news given the query. </span><span class="koboSpan" id="kobo.81.2">"</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.82.1">"Given the question, decide whether you need an additional "</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.83.1">"information from the search engine (reply with 'SEARCH: "</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.84.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.85.1">&lt;generated query&gt;' or you know enough to answer the user "</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.86.1">"then reply with 'RESPONSE &lt;final response&gt;').\n"</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.87.1">"Today is {date}."</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.88.1">"Now, act to answer a user question and "</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.89.1">"take into account your previous actions:\n"</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.90.1">"HUMAN: {question}\n"</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.91.1">"AI: SEARCH: {query}\n"</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.92.1">"RESPONSE FROM SEARCH: {search_result}\n"</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.93.1">)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.94.1">prompt_template = PromptTemplate.from_template(raw_prompt_template)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.95.1">result = (prompt_template | llm).invoke(</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.96.1">  {</span><span class="hljs-string"><span class="koboSpan" id="kobo.97.1">"question"</span></span><span class="koboSpan" id="kobo.98.1">: question, </span><span class="hljs-string"><span class="koboSpan" id="kobo.99.1">"query"</span></span><span class="koboSpan" id="kobo.100.1">: query, </span><span class="hljs-string"><span class="koboSpan" id="kobo.101.1">"search_result"</span></span><span class="koboSpan" id="kobo.102.1">: search_result,</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.103.1">"date"</span></span><span class="koboSpan" id="kobo.104.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.105.1">"Feb 2025"</span></span><span class="koboSpan" id="kobo.106.1">})</span></p>
<p class="snippet-code"><span class="hljs-built_in"><span class="koboSpan" id="kobo.107.1">print</span></span><span class="koboSpan" id="kobo.108.1">(result.content)</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.109.1">&gt;&gt;  RESPONSE: The current US President, Donald Trump, is 78 years old.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.110.1">As a last </span><a id="_idIndexMarker430"/><span class="koboSpan" id="kobo.111.1">observation, if the search result is not successful, the LLM will try to refine the query:</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.112.1">query = </span><span class="hljs-string"><span class="koboSpan" id="kobo.113.1">"current US president"</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.114.1">search_result = (</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.115.1">"Donald Trump 45th and 47th U.S."</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.116.1">)</span></p>
<div aria-label="185" epub:type="pagebreak" id="page5-7" role="doc-pagebreak"/>
<p class="snippet-code"><span class="koboSpan" id="kobo.117.1">result = (prompt_template | llm).invoke(</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.118.1">  {</span><span class="hljs-string"><span class="koboSpan" id="kobo.119.1">"question"</span></span><span class="koboSpan" id="kobo.120.1">: question, </span><span class="hljs-string"><span class="koboSpan" id="kobo.121.1">"query"</span></span><span class="koboSpan" id="kobo.122.1">: query, </span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.123.1">"search_result"</span></span><span class="koboSpan" id="kobo.124.1">: search_result, </span><span class="hljs-string"><span class="koboSpan" id="kobo.125.1">"date"</span></span><span class="koboSpan" id="kobo.126.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.127.1">"Feb 2025"</span></span><span class="koboSpan" id="kobo.128.1">})</span></p>
<p class="snippet-code"><span class="hljs-built_in"><span class="koboSpan" id="kobo.129.1">print</span></span><span class="koboSpan" id="kobo.130.1">(result.content)</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.131.1">&gt;&gt;  SEARCH: Donald Trump age</span></p>
<p class="normal"><span class="koboSpan" id="kobo.132.1">With that, we have demonstrated how tool calling works. </span><span class="koboSpan" id="kobo.132.2">Please note that we’ve provided prompt examples for demonstration purposes only. </span><span class="koboSpan" id="kobo.132.3">Another foundational LLM might require some prompt engineering, and our prompts are just an illustration. </span><span class="koboSpan" id="kobo.132.4">And good news: using tools is easier than it seems from these examples!</span></p>
<p class="normal"><span class="koboSpan" id="kobo.133.1">As you can note, we described everything in our prompt, including a tool description and a tool-calling format. </span><span class="koboSpan" id="kobo.133.2">These days, most LLMs provide a better API for tool calling since modern LLMs are post-trained on datasets that help them excel in such tasks. </span><span class="koboSpan" id="kobo.133.3">The LLMs’ creators know how these datasets were constructed. </span><span class="koboSpan" id="kobo.133.4">That’s why, typically, you don’t incorporate a tool description</span><a id="_idIndexMarker431"/><span class="koboSpan" id="kobo.134.1"> yourself in the prompt; you just provide both a prompt and a tool description as separate arguments, and they are combined into a single prompt on the provider’s side. </span><span class="koboSpan" id="kobo.134.2">Some smaller open-source LLMs expect tool descriptions to be part of the raw prompt, but they would expect a well-defined format.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.135.1">LangChain makes it easy to develop pipelines where an LLM invokes different tools and provides access to many helpful built-in tools. </span><span class="koboSpan" id="kobo.135.2">Let’s look at how tool handling works with LangCha</span><a id="_idTextAnchor236"/><span class="koboSpan" id="kobo.136.1">in.</span></p>
<h2 class="heading-2" id="_idParaDest-125"><a id="_idTextAnchor237"/><span class="koboSpan" id="kobo.137.1">Tools in LangChain</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.138.1">With most</span><a id="_idIndexMarker432"/><span class="koboSpan" id="kobo.139.1"> modern LLMs, to use tools, you can provide a list of tool descriptions as a separate argument. </span><span class="koboSpan" id="kobo.139.2">As always in LangChain, each particular integration implementation maps the interface to the provider’s API. </span><span class="koboSpan" id="kobo.139.3">For tools, this happens through LangChain’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.140.1">tools</span></code><span class="koboSpan" id="kobo.141.1"> argument to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.142.1">invoke</span></code><span class="koboSpan" id="kobo.143.1"> method (and some other useful methods such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.144.1">bind_tools</span></code><span class="koboSpan" id="kobo.145.1"> and others, as we will learn in this chapter).</span></p>
<p class="normal"><span class="koboSpan" id="kobo.146.1">When defining a tool, we need to specify its schema in OpenAPI format. </span><span class="koboSpan" id="kobo.146.2">We provide a </span><em class="italic"><span class="koboSpan" id="kobo.147.1">title</span></em><span class="koboSpan" id="kobo.148.1"> and a </span><em class="italic"><span class="koboSpan" id="kobo.149.1">description</span></em><span class="koboSpan" id="kobo.150.1"> of the tool and also specify its parameters (each parameter has a </span><em class="italic"><span class="koboSpan" id="kobo.151.1">type</span></em><span class="koboSpan" id="kobo.152.1">, </span><em class="italic"><span class="koboSpan" id="kobo.153.1">title</span></em><span class="koboSpan" id="kobo.154.1">, and </span><em class="italic"><span class="koboSpan" id="kobo.155.1">description</span></em><span class="koboSpan" id="kobo.156.1">). </span><span class="koboSpan" id="kobo.156.2">We can inherit such a schema from various formats, which LangChain translates into OpenAPI format. </span><span class="koboSpan" id="kobo.156.3">As we go through the next few sections, we’ll illustrate how we can do this from functions, docstrings, Pydantic definitions, or by inheriting from a </span><code class="inlineCode"><span class="koboSpan" id="kobo.157.1">BaseTool</span></code><span class="koboSpan" id="kobo.158.1"> class and providing descriptions directly. </span><span class="koboSpan" id="kobo.158.2">For an LLM, a tool is anything that has an OpenAPI specification—in other words, it can be called by some external mechanism. </span></p>
<div aria-label="186" epub:type="pagebreak" id="page6-7" role="doc-pagebreak"/>
<p class="normal"><span class="koboSpan" id="kobo.159.1">The LLM itself doesn’t bother about this mechanism, it only produces instructions for when and how to call a tool. </span><span class="koboSpan" id="kobo.159.2">For LangChain, a tool is also something that can be called (and we will see later that tools are inherited from </span><code class="inlineCode"><span class="koboSpan" id="kobo.160.1">Runnables</span></code><span class="koboSpan" id="kobo.161.1">) when we execute our program.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.162.1">The wording that you use in the </span><em class="italic"><span class="koboSpan" id="kobo.163.1">title</span></em><span class="koboSpan" id="kobo.164.1"> and </span><em class="italic"><span class="koboSpan" id="kobo.165.1">description</span></em><span class="koboSpan" id="kobo.166.1"> fields is extremely important, and you can treat it as a part of the prompt engineering exercise. </span><span class="koboSpan" id="kobo.166.2">Better wording helps LLMs make better decisions on when and how to call a specific tool. </span><span class="koboSpan" id="kobo.166.3">Please note that for more complex tools, writing a schema like this can become tedious, and we’ll see a simpler way to define tools later in this chapter:</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.167.1">search_tool = {</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.168.1">"title"</span></span><span class="koboSpan" id="kobo.169.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.170.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.171.1">google_search"</span></span><span class="koboSpan" id="kobo.172.1">,</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.173.1">"description"</span></span><span class="koboSpan" id="kobo.174.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.175.1">"Returns about fresh events and news from Google Search engine based on a query"</span></span><span class="koboSpan" id="kobo.176.1">,</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.177.1">"type"</span></span><span class="koboSpan" id="kobo.178.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.179.1">"object"</span></span><span class="koboSpan" id="kobo.180.1">,</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.181.1">"properties"</span></span><span class="koboSpan" id="kobo.182.1">: {</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.183.1">"query"</span></span><span class="koboSpan" id="kobo.184.1">: {</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.185.1">"description"</span></span><span class="koboSpan" id="kobo.186.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.187.1">"Search query to be sent to the search engine"</span></span><span class="koboSpan" id="kobo.188.1">,</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.189.1">"title"</span></span><span class="koboSpan" id="kobo.190.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.191.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.192.1">search_query"</span></span><span class="koboSpan" id="kobo.193.1">,</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.194.1">"type"</span></span><span class="koboSpan" id="kobo.195.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.196.1">"string"</span></span><span class="koboSpan" id="kobo.197.1">},</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.198.1">   },</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.199.1">"required"</span></span><span class="koboSpan" id="kobo.200.1">: [</span><span class="hljs-string"><span class="koboSpan" id="kobo.201.1">"query"</span></span><span class="koboSpan" id="kobo.202.1">]</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.203.1">}</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.204.1">result = llm.invoke(question, tools=[search_tool])</span></p>
<p class="normal"><span class="koboSpan" id="kobo.205.1">If we </span><a id="_idIndexMarker433"/><span class="koboSpan" id="kobo.206.1">inspect the </span><code class="inlineCode"><span class="koboSpan" id="kobo.207.1">result.content</span></code><span class="koboSpan" id="kobo.208.1"> field, it would be empty. </span><span class="koboSpan" id="kobo.208.2">That’s because the LLM has decided to call a tool, and the output message has a hint for that. </span><span class="koboSpan" id="kobo.208.3">What happens under the hood is that LangChain maps a specific output format of the model provider into a unified tool-calling format:</span></p>
<p class="snippet-code"><span class="hljs-built_in"><span class="koboSpan" id="kobo.209.1">print</span></span><span class="koboSpan" id="kobo.210.1">(result.tool_calls)</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.211.1">&gt;&gt; [{'name': 'google_search', 'args': {'query': 'age of Donald Trump'}, 'id': '6ab0de4b-f350-4743-a4c1-d6f6fcce9d34', 'type': 'tool_call'}]</span></p>
<p class="normal"><span class="koboSpan" id="kobo.212.1">Keep in mind that some model providers might return non-empty content even in the case of tool calling (for example, there might be reasoning traces on why the model decided to call a tool). </span><span class="koboSpan" id="kobo.212.2">You need to look at the model provider specification to understand how to treat such cases.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.213.1">As we can see, an LLM returned an array of tool-calling dictionaries—each of them contains a unique identifier, the name of the tool to be called, and a dictionary with arguments to be provided to this tool. </span><span class="koboSpan" id="kobo.213.2">Let’s move to the next step and invoke the model again:</span></p>
<div aria-label="187" epub:type="pagebreak" id="page7-6" role="doc-pagebreak"/>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.214.1">from</span></span><span class="koboSpan" id="kobo.215.1"> langchain_core.messages </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.216.1">import</span></span><span class="koboSpan" id="kobo.217.1"> SystemMessage, HumanMessage, ToolMessage</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.218.1">tool_result = ToolMessage(content=</span><span class="hljs-string"><span class="koboSpan" id="kobo.219.1">"Donald Trump ' Age 78 years June 14, 1946\n"</span></span><span class="koboSpan" id="kobo.220.1">, tool_call_id=step1.tool_calls[</span><span class="hljs-number"><span class="koboSpan" id="kobo.221.1">0</span></span><span class="koboSpan" id="kobo.222.1">][</span><span class="hljs-string"><span class="koboSpan" id="kobo.223.1">"id"</span></span><span class="koboSpan" id="kobo.224.1">])</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.225.1">step2 = llm.invoke([</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.226.1">   HumanMessage(content=question), step1, tool_result], tools=[search_tool])</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.227.1">assert</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.228.1">len</span></span><span class="koboSpan" id="kobo.229.1">(step2.tool_calls) == </span><span class="hljs-number"><span class="koboSpan" id="kobo.230.1">0</span></span></p>
<p class="snippet-code"><span class="hljs-built_in"><span class="koboSpan" id="kobo.231.1">print</span></span><span class="koboSpan" id="kobo.232.1">(step2.content)</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.233.1">&gt;&gt; Donald Trump is 78 years old.</span></p>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.234.1">ToolMessage</span></code><span class="koboSpan" id="kobo.235.1"> is a special message on LangChain that allows you to feed the output of a tool execution back to the model. </span><span class="koboSpan" id="kobo.235.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.236.1">content</span></code><span class="koboSpan" id="kobo.237.1"> field of such a message contains the tool’s output, and a special field </span><code class="inlineCode"><span class="koboSpan" id="kobo.238.1">tool_call_id</span></code><span class="koboSpan" id="kobo.239.1"> maps it to the specific tool calling that was generated by the model. </span><span class="koboSpan" id="kobo.239.2">Now, we can send the whole sequence (consisting of the initial output, the step with tool calling, and the output) back to the model as a list of messages.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.240.1">It might be </span><a id="_idIndexMarker434"/><span class="koboSpan" id="kobo.241.1">odd to always pass a list of tools to the LLM (since, typically, such a list is fixed for a given workflow). </span><span class="koboSpan" id="kobo.241.2">For that reason, LangChain </span><code class="inlineCode"><span class="koboSpan" id="kobo.242.1">Runnables</span></code><span class="koboSpan" id="kobo.243.1"> offer a </span><code class="inlineCode"><span class="koboSpan" id="kobo.244.1">bind</span></code><span class="koboSpan" id="kobo.245.1"> method that memorizes arguments and adds them to every further invocation. </span><span class="koboSpan" id="kobo.245.2">Take a look at the following code:</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.246.1">llm_with_tools = llm.bind(tools=[search_tool])</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.247.1">llm_with_tools.invoke(question)</span></p>
<p class="normal"><span class="koboSpan" id="kobo.248.1">When we call </span><code class="inlineCode"><span class="koboSpan" id="kobo.249.1">llm.bind(tools=[search_tool])</span></code><span class="koboSpan" id="kobo.250.1">, LangChain creates a new object (assigned here to </span><code class="inlineCode"><span class="koboSpan" id="kobo.251.1">llm_with_tools</span></code><span class="koboSpan" id="kobo.252.1">) that automatically includes </span><code class="inlineCode"><span class="koboSpan" id="kobo.253.1">[search_tool]</span></code><span class="koboSpan" id="kobo.254.1"> in every subsequent call to a copy of the initial </span><code class="inlineCode"><span class="koboSpan" id="kobo.255.1">llm </span></code><span class="koboSpan" id="kobo.256.1">one. </span><span class="koboSpan" id="kobo.256.2">Essentially, you no longer need to pass the tools argument with each </span><code class="inlineCode"><span class="koboSpan" id="kobo.257.1">invoke</span></code><span class="koboSpan" id="kobo.258.1"> method. </span><span class="koboSpan" id="kobo.258.2">So, calling the preceding code is the same as doing:</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.259.1">llm.invoke(question, tools=[search_tool)</span></p>
<p class="normal"><span class="koboSpan" id="kobo.260.1">This is because bind has “memorized” your tools list for all future invocations. </span><span class="koboSpan" id="kobo.260.2">It’s mainly a convenience feature—ideal if you want a fixed set of tools for repeated calls rather than specifying them every time. </span><span class="koboSpan" id="kobo.260.3">Now let’s see how we can utilize tool calling even more, and improve LLM reas</span><a id="_idTextAnchor238"/><span class="koboSpan" id="kobo.261.1">oning!</span></p>
<div aria-label="188" epub:type="pagebreak" id="page8-6" role="doc-pagebreak"/>
<h2 class="heading-2" id="_idParaDest-126"><a id="_idTextAnchor239"/><span class="koboSpan" id="kobo.262.1">ReACT</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.263.1">As you</span><a id="_idIndexMarker435"/><span class="koboSpan" id="kobo.264.1"> have probably thought already, LLMs can call multiple tools before generating the final reply to the user (and the next tool to be called or a payload sent to this tool might depend on the outcome from the previous tool calls). </span><span class="koboSpan" id="kobo.264.2">This was proposed by a ReACT approach introduced in 2022 by researchers from Princeton University and Google Research: </span><em class="italic"><span class="koboSpan" id="kobo.265.1">Reasoning and ACT </span></em><span class="koboSpan" id="kobo.266.1">(</span><a href="https://arxiv.org/abs/2210.03629"><span class="url"><span class="koboSpan" id="kobo.267.1">https://arxiv.org/abs/2210.03629</span></span></a><span class="koboSpan" id="kobo.268.1">). </span><span class="koboSpan" id="kobo.268.2">The idea is simple—we should give the LLM access to tools as a way to interact with an external environment, and let the LLM run in a loop: </span></p>
<ul>
<li class="b lletList"><strong class="keyWord"><span class="koboSpan" id="kobo.269.1">Reason</span></strong><span class="koboSpan" id="kobo.270.1">: Generate a text output with observations about the current situation and a plan to solve the task.</span></li>
<li class="b lletList"><strong class="keyWord"><span class="koboSpan" id="kobo.271.1">Act</span></strong><span class="koboSpan" id="kobo.272.1">: Take an action based on the reasoning above (interact with the environment by calling a tool, or respond to the user).</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.273.1">It has been </span><a id="_idIndexMarker436"/><span class="koboSpan" id="kobo.274.1">demonstrated that ReACT can help reduce hallucination rates compared to CoT prompting, which we discussed in </span><a href="E_Chapter_3.xhtml#_idTextAnchor107"><em class="italic"><span class="koboSpan" id="kobo.275.1">Chapter 3</span></em></a><span class="koboSpan" id="kobo.276.1">.</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.277.1"><img alt="Figure 5.1: ReACT pattern" src="../Images/B32363_05_01.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.278.1">Figure 5.1: ReACT pattern</span></p>
<p class="normal"><span class="koboSpan" id="kobo.279.1">Let’s build a ReACT application ourselves. </span><span class="koboSpan" id="kobo.279.2">First, let’s create mocked search and calculator tools: </span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.280.1">import</span></span><span class="koboSpan" id="kobo.281.1"> math</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.282.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.283.1">mocked_google_search</span></span><span class="koboSpan" id="kobo.284.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.285.1">query: </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.286.1">str</span></span><span class="koboSpan" id="kobo.287.1">) -&gt; </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.288.1">str</span></span><span class="koboSpan" id="kobo.289.1">:</span></p>
<p class="snippet-code"> <span class="hljs-built_in"><span class="koboSpan" id="kobo.290.1">print</span></span><span class="koboSpan" id="kobo.291.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.292.1">f"CALLED GOOGLE_SEARCH with query=</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.293.1">{query}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.294.1">"</span></span><span class="koboSpan" id="kobo.295.1">)</span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.296.1">return</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.297.1">"Donald Trump is a president of USA and he's 78 years old"</span></span></p>
<div aria-label="189" epub:type="pagebreak" id="page9-5" role="doc-pagebreak"/>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.298.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.299.1">mocked_calculator</span></span><span class="koboSpan" id="kobo.300.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.301.1">expression: </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.302.1">str</span></span><span class="koboSpan" id="kobo.303.1">) -&gt; </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.304.1">float</span></span><span class="koboSpan" id="kobo.305.1">:</span></p>
<p class="snippet-code"> <span class="hljs-built_in"><span class="koboSpan" id="kobo.306.1">print</span></span><span class="koboSpan" id="kobo.307.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.308.1">f"CALLED CALCULATOR with expression=</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.309.1">{expression}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.310.1">"</span></span><span class="koboSpan" id="kobo.311.1">)</span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.312.1">if</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.313.1">"sqrt"</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.314.1">in</span></span><span class="koboSpan" id="kobo.315.1"> expression:</span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.316.1">return</span></span><span class="koboSpan" id="kobo.317.1"> math.sqrt(</span><span class="hljs-number"><span class="koboSpan" id="kobo.318.1">78</span></span><span class="koboSpan" id="kobo.319.1">*</span><span class="hljs-number"><span class="koboSpan" id="kobo.320.1">132</span></span><span class="koboSpan" id="kobo.321.1">)</span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.322.1">return</span></span> <span class="hljs-number"><span class="koboSpan" id="kobo.323.1">78</span></span><span class="koboSpan" id="kobo.324.1">*</span><span class="hljs-number"><span class="koboSpan" id="kobo.325.1">132</span></span></p>
<p class="normal"><span class="koboSpan" id="kobo.326.1">In the next section, we’ll see how we can build actual tools. </span><span class="koboSpan" id="kobo.326.2">For now, let’s define a schema for the calculator tool and make the LLM aware of both tools it can use. </span><span class="koboSpan" id="kobo.326.3">We’ll also use building blocks that we’re already familiar with—</span><code class="inlineCode"><span class="koboSpan" id="kobo.327.1">ChatPromptTemplate</span></code><span class="koboSpan" id="kobo.328.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.329.1">MessagesPlaceholder</span></code><span class="koboSpan" id="kobo.330.1">—to prepend a</span><a id="_idIndexMarker437"/><span class="koboSpan" id="kobo.331.1"> predetermined system message when we call our graph:</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.332.1">from</span></span><span class="koboSpan" id="kobo.333.1"> langchain.prompts </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.334.1">import</span></span><span class="koboSpan" id="kobo.335.1"> ChatPromptTemplate, MessagesPlaceholder</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.336.1">calculator_tool = {</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.337.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.338.1">title"</span></span><span class="koboSpan" id="kobo.339.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.340.1">"calculator"</span></span><span class="koboSpan" id="kobo.341.1">,</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.342.1">"description"</span></span><span class="koboSpan" id="kobo.343.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.344.1">"Computes mathematical expressions"</span></span><span class="koboSpan" id="kobo.345.1">,</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.346.1">"type"</span></span><span class="koboSpan" id="kobo.347.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.348.1">"object"</span></span><span class="koboSpan" id="kobo.349.1">,</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.350.1">"properties"</span></span><span class="koboSpan" id="kobo.351.1">: {</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.352.1">"expression"</span></span><span class="koboSpan" id="kobo.353.1">: {</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.354.1">"description"</span></span><span class="koboSpan" id="kobo.355.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.356.1">"A mathematical expression to be evaluated by a calculator"</span></span><span class="koboSpan" id="kobo.357.1">,</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.358.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.359.1">title"</span></span><span class="koboSpan" id="kobo.360.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.361.1">"expression"</span></span><span class="koboSpan" id="kobo.362.1">,</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.363.1">"type"</span></span><span class="koboSpan" id="kobo.364.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.365.1">"string"</span></span><span class="koboSpan" id="kobo.366.1">},</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.367.1">  },</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.368.1">"required"</span></span><span class="koboSpan" id="kobo.369.1">: [</span><span class="hljs-string"><span class="koboSpan" id="kobo.370.1">"expression"</span></span><span class="koboSpan" id="kobo.371.1">]</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.372.1">}</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.373.1">prompt = ChatPromptTemplate.from_messages([</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.374.1">   (</span><span class="hljs-string"><span class="koboSpan" id="kobo.375.1">"system"</span></span><span class="koboSpan" id="kobo.376.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.377.1">"Always use a calculator for mathematical computations, and use Google Search for information about fresh events and news."</span></span><span class="koboSpan" id="kobo.378.1">), </span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.379.1">   MessagesPlaceholder(variable_name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.380.1">"messages"</span></span><span class="koboSpan" id="kobo.381.1">),</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.382.1">])</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.383.1">llm_with_tools = llm.bind(tools=[search_tool, calculator_tool]).bind(prompt=prompt)</span></p>
<div aria-label="190" epub:type="pagebreak" id="page10-5" role="doc-pagebreak"/>
<p class="normal"><span class="koboSpan" id="kobo.384.1">Now that we have an LLM that can call tools, let’s create the nodes we need. </span><span class="koboSpan" id="kobo.384.2">We need one function that calls an LLM, another function that invokes tools and returns tool-calling results (by appending </span><code class="inlineCode"><span class="koboSpan" id="kobo.385.1">ToolMessages</span></code><span class="koboSpan" id="kobo.386.1"> to the list of messages in the state), and a function that will determine whether the orchestrator should continue calling tools or whether it can return the result to the user:</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.387.1">from</span></span><span class="koboSpan" id="kobo.388.1"> typing </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.389.1">import</span></span><span class="koboSpan" id="kobo.390.1"> TypedDict</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.391.1">from</span></span><span class="koboSpan" id="kobo.392.1"> langgraph.graph </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.393.1">import</span></span><span class="koboSpan" id="kobo.394.1"> MessagesState, StateGraph, START, END</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.395.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.396.1">invoke_llm</span></span><span class="koboSpan" id="kobo.397.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.398.1">state: MessagesState</span></span><span class="koboSpan" id="kobo.399.1">):</span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.400.1">return</span></span><span class="koboSpan" id="kobo.401.1"> {</span><span class="hljs-string"><span class="koboSpan" id="kobo.402.1">"messages"</span></span><span class="koboSpan" id="kobo.403.1">: [llm_with_tools.invoke(state[</span><span class="hljs-string"><span class="koboSpan" id="kobo.404.1">"messages"</span></span><span class="koboSpan" id="kobo.405.1">])]}</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.406.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.407.1">call_tools</span></span><span class="koboSpan" id="kobo.408.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.409.1">state: MessagesState</span></span><span class="koboSpan" id="kobo.410.1">):</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.411.1">   last_message = state[</span><span class="hljs-string"><span class="koboSpan" id="kobo.412.1">"messages"</span></span><span class="koboSpan" id="kobo.413.1">][-</span><span class="hljs-number"><span class="koboSpan" id="kobo.414.1">1</span></span><span class="koboSpan" id="kobo.415.1">]</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.416.1">   tool_calls = last_message.tool_calls</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.417.1">   new_messages = []</span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.418.1">for</span></span><span class="koboSpan" id="kobo.419.1"> tool_call </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.420.1">in</span></span><span class="koboSpan" id="kobo.421.1"> tool_calls:</span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.422.1">if</span></span><span class="koboSpan" id="kobo.423.1"> tool_call[</span><span class="hljs-string"><span class="koboSpan" id="kobo.424.1">"name"</span></span><span class="koboSpan" id="kobo.425.1">] == </span><span class="hljs-string"><span class="koboSpan" id="kobo.426.1">"google_search"</span></span><span class="koboSpan" id="kobo.427.1">:</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.428.1">       tool_result = mocked_google_search(**tool_call[</span><span class="hljs-string"><span class="koboSpan" id="kobo.429.1">"args"</span></span><span class="koboSpan" id="kobo.430.1">])</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.431.1">       new_messages.append(ToolMessage(content=tool_result, tool_call_id=tool_call[</span><span class="hljs-string"><span class="koboSpan" id="kobo.432.1">"id"</span></span><span class="koboSpan" id="kobo.433.1">]))</span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.434.1">elif</span></span><span class="koboSpan" id="kobo.435.1"> tool_call[</span><span class="hljs-string"><span class="koboSpan" id="kobo.436.1">"name"</span></span><span class="koboSpan" id="kobo.437.1">] == </span><span class="hljs-string"><span class="koboSpan" id="kobo.438.1">"calculator"</span></span><span class="koboSpan" id="kobo.439.1">:</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.440.1">       tool_result = mocked_calculator(**tool_call[</span><span class="hljs-string"><span class="koboSpan" id="kobo.441.1">"args"</span></span><span class="koboSpan" id="kobo.442.1">])</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.443.1">       new_messages.append(ToolMessage(content=tool_result, tool_call_id=tool_call[</span><span class="hljs-string"><span class="koboSpan" id="kobo.444.1">"id"</span></span><span class="koboSpan" id="kobo.445.1">]))</span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.446.1">else</span></span><span class="koboSpan" id="kobo.447.1">:</span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.448.1">raise</span></span><span class="koboSpan" id="kobo.449.1"> ValueError(</span><span class="hljs-string"><span class="koboSpan" id="kobo.450.1">f"Tool </span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.451.1">{tool_call[</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.452.1">'name'</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.453.1">]}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.454.1"> is not defined!"</span></span><span class="koboSpan" id="kobo.455.1">)</span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.456.1">return</span></span><span class="koboSpan" id="kobo.457.1"> {</span><span class="hljs-string"><span class="koboSpan" id="kobo.458.1">"messages"</span></span><span class="koboSpan" id="kobo.459.1">: new_messages}</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.460.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.461.1">should_run_tools</span></span><span class="koboSpan" id="kobo.462.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.463.1">state: MessagesState</span></span><span class="koboSpan" id="kobo.464.1">):</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.465.1">   last_message = state[</span><span class="hljs-string"><span class="koboSpan" id="kobo.466.1">"messages"</span></span><span class="koboSpan" id="kobo.467.1">][-</span><span class="hljs-number"><span class="koboSpan" id="kobo.468.1">1</span></span><span class="koboSpan" id="kobo.469.1">]</span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.470.1">if</span></span><span class="koboSpan" id="kobo.471.1"> last_message.tool_calls:</span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.472.1">return</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.473.1">"call_tools"</span></span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.474.1">return</span></span><span class="koboSpan" id="kobo.475.1"> END</span></p>
<div aria-label="191" epub:type="pagebreak" id="page11-4" role="doc-pagebreak"/>
<p class="normal"><span class="koboSpan" id="kobo.476.1">Now let’s bring</span><a id="_idIndexMarker438"/><span class="koboSpan" id="kobo.477.1"> everything together in a LangGraph workflow:</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.478.1">builder = StateGraph(MessagesState)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.479.1">builder.add_node(</span><span class="hljs-string"><span class="koboSpan" id="kobo.480.1">"invoke_llm"</span></span><span class="koboSpan" id="kobo.481.1">, invoke_llm)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.482.1">builder.add_node(</span><span class="hljs-string"><span class="koboSpan" id="kobo.483.1">"call_tools"</span></span><span class="koboSpan" id="kobo.484.1">, call_tools)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.485.1">builder.add_edge(START, </span><span class="hljs-string"><span class="koboSpan" id="kobo.486.1">"invoke_llm"</span></span><span class="koboSpan" id="kobo.487.1">)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.488.1">builder.add_conditional_edges(</span><span class="hljs-string"><span class="koboSpan" id="kobo.489.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.490.1">invoke_llm"</span></span><span class="koboSpan" id="kobo.491.1">, should_run_tools)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.492.1">builder.add_edge(</span><span class="hljs-string"><span class="koboSpan" id="kobo.493.1">"call_tools"</span></span><span class="koboSpan" id="kobo.494.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.495.1">"invoke_llm"</span></span><span class="koboSpan" id="kobo.496.1">)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.497.1">graph = builder.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.498.1">compile</span></span><span class="koboSpan" id="kobo.499.1">()</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.500.1">question = </span><span class="hljs-string"><span class="koboSpan" id="kobo.501.1">"What is a square root of the current US president's age multiplied by 132?"</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.502.1">result = graph.invoke({</span><span class="hljs-string"><span class="koboSpan" id="kobo.503.1">"messages"</span></span><span class="koboSpan" id="kobo.504.1">: [HumanMessage(content=question)]})</span></p>
<p class="snippet-code"><span class="hljs-built_in"><span class="koboSpan" id="kobo.505.1">print</span></span><span class="koboSpan" id="kobo.506.1">(result[</span><span class="hljs-string"><span class="koboSpan" id="kobo.507.1">"messages"</span></span><span class="koboSpan" id="kobo.508.1">][-</span><span class="hljs-number"><span class="koboSpan" id="kobo.509.1">1</span></span><span class="koboSpan" id="kobo.510.1">].content)</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.511.1">&gt;&gt; CALLED GOOGLE_SEARCH with query=age of Donald Trump</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.512.1">CALLED CALCULATOR with expression=78 * 132</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.513.1">CALLED CALCULATOR with expression=sqrt(10296)</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.514.1">The square root of 78 multiplied by 132 (which is 10296) is approximately 101.47.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.515.1">This </span><a id="_idIndexMarker439"/><span class="koboSpan" id="kobo.516.1">demonstrates how the LLM made several calls to handle a complex question—first, to </span><code class="inlineCode"><span class="koboSpan" id="kobo.517.1">Google Search</span></code><span class="koboSpan" id="kobo.518.1"> and then two calls to </span><code class="inlineCode"><span class="koboSpan" id="kobo.519.1">Calculator</span></code><span class="koboSpan" id="kobo.520.1">—and each time, it used the previously received information to adjust its actions. </span><span class="koboSpan" id="kobo.520.2">This is the ReACT pattern in action.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.521.1">With that, we’ve learned how the ReACT pattern works in detail by building it ourselves. </span><span class="koboSpan" id="kobo.521.2">The good news is that LangGraph offers a pre-built implementation of a ReACT pattern, so you don’t need to implement it yourself:</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.522.1">from</span></span><span class="koboSpan" id="kobo.523.1"> langgraph.prebuilt </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.524.1">import</span></span><span class="koboSpan" id="kobo.525.1"> create_react_agent</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.526.1">agent = create_react_agent(</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.527.1">  llm=llm,</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.528.1">  tools=[search_tool, calculator_tool],</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.529.1">  prompt=system_prompt)</span></p>
<div aria-label="192" epub:type="pagebreak" id="page12-4" role="doc-pagebreak"/>
<p class="normal"><span class="koboSpan" id="kobo.530.1">In </span><a href="E_Chapter_6.xhtml#_idTextAnchor274"><em class="italic"><span class="koboSpan" id="kobo.531.1">Chapter 6</span></em></a><span class="koboSpan" id="kobo.532.1">, we’ll see some additional adjustments you can use with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.533.1">create_react_agent</span><a id="_idTextAnchor240"/></code><span class="koboSpan" id="kobo.534.1"> function.</span></p>
<h1 class="heading-1" id="_idParaDest-127"><a id="_idTextAnchor241"/><span class="koboSpan" id="kobo.535.1">Defining tools</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.536.1">So far, we </span><a id="_idIndexMarker440"/><span class="koboSpan" id="kobo.537.1">have defined tools as OpenAPI schemas. </span><span class="koboSpan" id="kobo.537.2">But to run the workflow end to end, LangGraph should be able to call tools itself during the execution. </span><span class="koboSpan" id="kobo.537.3">Hence, in this section, let’s discuss how we define tools as Python functions or callables. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.538.1">A LangChain tool has three essential components: </span></p>
<ul>
<li class="b lletList"><code class="inlineCode"><span class="koboSpan" id="kobo.539.1">Name</span></code><span class="koboSpan" id="kobo.540.1">: A unique identifier for the tool </span></li>
<li class="b lletList"><code class="inlineCode"><span class="koboSpan" id="kobo.541.1">Description</span></code><span class="koboSpan" id="kobo.542.1">: Text that helps the LLM understand when and how to use the tool </span></li>
<li class="b lletList"><code class="inlineCode"><span class="koboSpan" id="kobo.543.1">Payload schema</span></code><span class="koboSpan" id="kobo.544.1">: A structured definition of the inputs the tool accepts</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.545.1">It allows an LLM to decide when and how to call a tool. </span><span class="koboSpan" id="kobo.545.2">Another important distinction of a LangChain tool is that it can be executed by an orchestrator, such as LangGraph. </span><span class="koboSpan" id="kobo.545.3">The base interface for a tool is </span><code class="inlineCode"><span class="koboSpan" id="kobo.546.1">BaseTool</span></code><span class="koboSpan" id="kobo.547.1">, which inherits from a </span><code class="inlineCode"><span class="koboSpan" id="kobo.548.1">RunnableSerializable</span></code><span class="koboSpan" id="kobo.549.1"> itself. </span><span class="koboSpan" id="kobo.549.2">That means it can be invoked or batched as any </span><code class="inlineCode"><span class="koboSpan" id="kobo.550.1">Runnable</span></code><span class="koboSpan" id="kobo.551.1">, or serialized or deserialized as any </span><code class="inlineCode"><span class="koboSpan" id="kobo.552.1">Se</span><a id="_idTextAnchor242"/><span class="koboSpan" id="kobo.553.1">rializable</span></code><span class="koboSpan" id="kobo.554.1">.</span></p>
<h2 class="heading-2" id="_idParaDest-128"><a id="_idTextAnchor243"/><span class="koboSpan" id="kobo.555.1">Built-in LangChain tools</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.556.1">LangChain</span><a id="_idIndexMarker441"/><span class="koboSpan" id="kobo.557.1"> has many tools already available across various categories. </span><span class="koboSpan" id="kobo.557.2">Since</span><a id="_idIndexMarker442"/><span class="koboSpan" id="kobo.558.1"> tools are often provided by third-party vendors, some tools require paid API keys, some of them are completely free, and some of them have a free tier. </span><span class="koboSpan" id="kobo.558.2">Some tools are grouped together in toolkits—collections of tools that are supposed to be used together when working on a specific task.  </span><span class="koboSpan" id="kobo.558.3">Let’s see some examples of using tools.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.559.1">Tools give an </span><a id="_idIndexMarker443"/><span class="koboSpan" id="kobo.560.1">LLM access to search engines, such as Bing, DuckDuckGo, Google, and Tavily. </span><span class="koboSpan" id="kobo.560.2">Let’s take a look at </span><code class="inlineCode"><span class="koboSpan" id="kobo.561.1">DuckDuckGoSearchRun</span></code><span class="koboSpan" id="kobo.562.1"> as this search engine doesn’t require additional registration and an API key. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.563.1">Please</span><a id="_idIndexMarker444"/><span class="koboSpan" id="kobo.564.1"> see </span><a href="E_Chapter_2.xhtml#_idTextAnchor044"><em class="italic"><span class="koboSpan" id="kobo.565.1">Chapter 2</span></em></a><span class="koboSpan" id="kobo.566.1"> for setup instructions. </span><span class="koboSpan" id="kobo.566.2">If you have any questions or encounter issues while running the code, please create an issue on GitHub or join the discussion on Discord at </span><a href="https://packt.link/lang"><span class="url"><span class="koboSpan" id="kobo.567.1">https://packt.link/lang</span></span></a><span class="koboSpan" id="kobo.568.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.569.1">As with any tool, this tool has a name, description, and schema for input arguments:</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.570.1">from</span></span><span class="koboSpan" id="kobo.571.1"> langchain_community.tools </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.572.1">import</span></span><span class="koboSpan" id="kobo.573.1"> DuckDuckGoSearchRun</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.574.1">search = DuckDuckGoSearchRun()</span></p>
<p class="snippet-code"><span class="hljs-built_in"><span class="koboSpan" id="kobo.575.1">print</span></span><span class="koboSpan" id="kobo.576.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.577.1">f"Tool's name = </span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.578.1">{search.name}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.579.1">"</span></span><span class="koboSpan" id="kobo.580.1">)</span></p>
<div aria-label="193" epub:type="pagebreak" id="page13-4" role="doc-pagebreak"/>
<p class="snippet-code"><span class="hljs-built_in"><span class="koboSpan" id="kobo.581.1">print</span></span><span class="koboSpan" id="kobo.582.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.583.1">f"Tool's name = </span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.584.1">{search.description}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.585.1">"</span></span><span class="koboSpan" id="kobo.586.1">)</span></p>
<p class="snippet-code"><span class="hljs-built_in"><span class="koboSpan" id="kobo.587.1">print</span></span><span class="koboSpan" id="kobo.588.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.589.1">f"Tool's arg schema = f</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.590.1">{search.args_schema}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.591.1">"</span></span><span class="koboSpan" id="kobo.592.1">)</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.593.1">&gt;&gt; Tool's name = fduckduckgo_search</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.594.1">Tool's name = fA wrapper around DuckDuckGo Search. </span><span class="koboSpan" id="kobo.594.2">Useful for when you need to answer questions about current events. </span><span class="koboSpan" id="kobo.594.3">Input should be a search query.</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.595.1">Tool's arg schema = class 'langchain_community.tools.ddg_search.tool.DDGInput'</span></p>
<p class="normal"><span class="koboSpan" id="kobo.596.1">The argument schema, </span><code class="inlineCode"><span class="koboSpan" id="kobo.597.1">arg_schema</span></code><span class="koboSpan" id="kobo.598.1">, is a Pydantic model and we’ll see why it’s useful later in this chapter. </span><span class="koboSpan" id="kobo.598.2">We can explore its fields either programmatically or by going to the documentation page—it expects only one input field, a query: </span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.599.1">from</span></span><span class="koboSpan" id="kobo.600.1"> langchain_community.tools.ddg_search.tool </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.601.1">import</span></span><span class="koboSpan" id="kobo.602.1"> DDGInput</span></p>
<p class="snippet-code"><span class="hljs-built_in"><span class="koboSpan" id="kobo.603.1">print</span></span><span class="koboSpan" id="kobo.604.1">(DDGInput.__fields__)</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.605.1">&gt;&gt; {'query': FieldInfo(annotation=str, required=True, description='search query to look up')}</span></p>
<p class="normal"><span class="koboSpan" id="kobo.606.1">Now we can invoke this tool and get a string output back (results from the search engine):</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.607.1">query = </span><span class="hljs-string"><span class="koboSpan" id="kobo.608.1">"What is the weather in Munich like tomorrow?"</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.609.1">search_input = DDGInput(query=query)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.610.1">result = search.invoke(search_input.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.611.1">dict</span></span><span class="koboSpan" id="kobo.612.1">())</span></p>
<p class="snippet-code"><span class="hljs-built_in"><span class="koboSpan" id="kobo.613.1">print</span></span><span class="koboSpan" id="kobo.614.1">(result)</span></p>
<p class="normal"><span class="koboSpan" id="kobo.615.1">We can also </span><a id="_idIndexMarker445"/><span class="koboSpan" id="kobo.616.1">invoke the LLM with tools, and let’s make sure that the LLM invokes the search tool and does not answer directly:</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.617.1">result = llm.invoke(query, tools=[search])</span></p>
<p class="snippet-code"><span class="hljs-built_in"><span class="koboSpan" id="kobo.618.1">print</span></span><span class="koboSpan" id="kobo.619.1">(result.tool_calls[</span><span class="hljs-number"><span class="koboSpan" id="kobo.620.1">0</span></span><span class="koboSpan" id="kobo.621.1">])</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.622.1">&gt;&gt; {'name': 'duckduckgo_search', 'args': {'query': 'weather in Munich tomorrow'}, 'id': '222dc19c-956f-4264-bf0f-632655a6717d', 'type': 'tool_call'}</span></p>
<p class="normal"><span class="koboSpan" id="kobo.623.1">Our tool is</span><a id="_idIndexMarker446"/><span class="koboSpan" id="kobo.624.1"> now a callable that LangGraph can call programmatically. </span><span class="koboSpan" id="kobo.624.2">Let’s put everything together and create our first agent. </span><span class="koboSpan" id="kobo.624.3">When we stream our graph, we get updates to the state. </span><span class="koboSpan" id="kobo.624.4">In our case, these are only messages:</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.625.1">from</span></span><span class="koboSpan" id="kobo.626.1"> langgraph.prebuilt </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.627.1">import</span></span><span class="koboSpan" id="kobo.628.1"> create_react_agent</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.629.1">agent = create_react_agent(model=llm, tools=[search])</span></p>
<div aria-label="194" epub:type="pagebreak" id="page14-4" role="doc-pagebreak"/>
<figure class="mediaobject"><span class="koboSpan" id="kobo.630.1"><img alt="Figure 5.2: A pre-built ReACT workflow on LangGraph" src="../Images/B32363_05_02.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.631.1">Figure 5.2: A pre-built ReACT workflow on LangGraph</span></p>
<p class="normal"><span class="koboSpan" id="kobo.632.1">That’s exactly what we saw earlier as well—an LLM is calling tools until it decides to stop and return the answer to the user. </span><span class="koboSpan" id="kobo.632.2">Let’s test it out! </span></p>
<p class="normal"><span class="koboSpan" id="kobo.633.1">When we stream LangGraph, we get new events that are updates to the graph’s state. </span><span class="koboSpan" id="kobo.633.2">We’re interested in the </span><code class="inlineCode"><span class="koboSpan" id="kobo.634.1">message</span></code><span class="koboSpan" id="kobo.635.1"> field of the state. </span><span class="koboSpan" id="kobo.635.2">Let’s print out the new messages added:</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.636.1">for</span></span><span class="koboSpan" id="kobo.637.1"> event </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.638.1">in</span></span><span class="koboSpan" id="kobo.639.1"> agent.stream({</span><span class="hljs-string"><span class="koboSpan" id="kobo.640.1">"messages"</span></span><span class="koboSpan" id="kobo.641.1">: [(</span><span class="hljs-string"><span class="koboSpan" id="kobo.642.1">"user"</span></span><span class="koboSpan" id="kobo.643.1">, query)]}):</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.644.1"> update = event.get(</span><span class="hljs-string"><span class="koboSpan" id="kobo.645.1">"agent"</span></span><span class="koboSpan" id="kobo.646.1">, event.get(</span><span class="hljs-string"><span class="koboSpan" id="kobo.647.1">"tools"</span></span><span class="koboSpan" id="kobo.648.1">, {}))</span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.649.1">for</span></span><span class="koboSpan" id="kobo.650.1"> message </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.651.1">in</span></span><span class="koboSpan" id="kobo.652.1"> update.get(</span><span class="hljs-string"><span class="koboSpan" id="kobo.653.1">"messages"</span></span><span class="koboSpan" id="kobo.654.1">, []):</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.655.1">    message.pretty_print()</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.656.1">&gt;&gt; ================================ Ai Message ==================================</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.657.1">Tool Calls:</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.658.1">  duckduckgo_search (a01a4012-bfc0-4eae-9c81-f11fd3ecb52c)</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.659.1"> Call ID: a01a4012-bfc0-4eae-9c81-f11fd3ecb52c</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.660.1">  Args:</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.661.1">    query: weather in Munich tomorrow</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.662.1">================================= Tool Message =================================</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.663.1">Name: duckduckgo_search</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.664.1">The temperature in Munich tomorrow in the early morning is 4 ° C… &lt;TRUNCATED&gt;</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.665.1">================================== Ai Message ==================================</span></p>
<div aria-label="195" epub:type="pagebreak" id="page15-4" role="doc-pagebreak"/>
<p class="snippet-con"><span class="koboSpan" id="kobo.666.1">The weather in Munich tomorrow will be 5°C with a 0% chance of rain in the morning.  </span><span class="koboSpan" id="kobo.666.2">The wind will blow at 11 km/h.  </span><span class="koboSpan" id="kobo.666.3">Later in the day, the high will be 53°F (approximately 12°C).  </span><span class="koboSpan" id="kobo.666.4">It will be clear in the early morning.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.667.1">Our </span><a id="_idIndexMarker447"/><span class="koboSpan" id="kobo.668.1">agent is represented by a list of messages since this is the input</span><a id="_idIndexMarker448"/><span class="koboSpan" id="kobo.669.1"> and output that the LLM expects. </span><span class="koboSpan" id="kobo.669.2">We’ll see that pattern again when we dive deeper into agentic architectures and discuss it in the next chapter. </span><span class="koboSpan" id="kobo.669.3">For now, let’s briefly mention other types of tools that are already available on LangChain:</span></p>
<div aria-label="196" epub:type="pagebreak" id="page16-4" role="doc-pagebreak"/>
<ul>
<li class="b lletList"><strong class="keyWord"><span class="koboSpan" id="kobo.670.1">Tools that enhance the LLM’s knowledge besides using a search engine</span></strong><span class="koboSpan" id="kobo.671.1">:</span><ul><li class="bulletList level-2"><span class="koboSpan" id="kobo.672.1">Academic research: arXiv and PubMed</span></li>
<li class="bulletList level-2"><span class="koboSpan" id="kobo.673.1">Knowledge bases: Wikipedia and Wikidata</span></li>
<li class="bulletList level-2"><span class="koboSpan" id="kobo.674.1">Financial data: Alpha Vantage, Polygon, and Yahoo Finance</span></li>
<li class="bulletList level-2"><span class="koboSpan" id="kobo.675.1">Weather: OpenWeatherMap</span></li>
<li class="bulletList level-2"><span class="koboSpan" id="kobo.676.1">Computation: Wolfram Alpha</span></li>
</ul></li>
<li class="b lletList"><strong class="keyWord"><span class="koboSpan" id="kobo.677.1">Tools that enhance your productivity</span></strong><span class="koboSpan" id="kobo.678.1">: You can interact with Gmail, Slack, Office 365, Google Calendar, Jira, Github, etc. </span><span class="koboSpan" id="kobo.678.2">For example, </span><code class="inlineCode"><span class="koboSpan" id="kobo.679.1">GmailToolkit</span></code><span class="koboSpan" id="kobo.680.1"> gives you access to </span><code class="inlineCode"><span class="koboSpan" id="kobo.681.1">GmailCreateDraft</span></code><span class="koboSpan" id="kobo.682.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.683.1">GmailSendMessage</span></code><span class="koboSpan" id="kobo.684.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.685.1">GmailSearch</span></code><span class="koboSpan" id="kobo.686.1">, </span><code class="inlineCode"><span class="koboSpan" id="kobo.687.1">GmailGetMessage</span></code><span class="koboSpan" id="kobo.688.1">, and </span><code class="inlineCode"><span class="koboSpan" id="kobo.689.1">GmailGetThread</span></code><span class="koboSpan" id="kobo.690.1"> tools that allow you to search, retrieve, create, and send messages with your Gmail account. </span><span class="koboSpan" id="kobo.690.2">As you can see, not only can you give the LLM additional context about the user but, with some of these tools, LLMs can take actions that actually influence the outside environment, such as creating a pull request on GitHub or sending a message on Slack!</span></li>
<li class="b lletList"><strong class="keyWord"><span class="koboSpan" id="kobo.691.1">Tools that give an LLM access to a code interpreter</span></strong><span class="koboSpan" id="kobo.692.1">: These tools give LLMs access to a code interpreter by remotely launching an isolated container and giving LLMs access to this container. </span><span class="koboSpan" id="kobo.692.2">These tools require an API key from a vendor providing the sandboxes. </span><span class="koboSpan" id="kobo.692.3">LLMs are especially good at coding, and it’s a widely used pattern to ask </span><a id="_idIndexMarker449"/><span class="koboSpan" id="kobo.693.1">an LLM to solve some complex task by writing code that solves it instead of asking it to generate tokens that represent the solution of </span><a id="_idIndexMarker450"/><span class="koboSpan" id="kobo.694.1">the task. </span><span class="koboSpan" id="kobo.694.2">Of course, you should execute code generated by LLMs with caution, and that’s why isolated sandboxes play a huge role. </span><span class="koboSpan" id="kobo.694.3">Some examples are:</span><ul><li class="bulletList level-2"><span class="koboSpan" id="kobo.695.1">Code execution: Python REPL and Bash</span></li>
<li class="bulletList level-2"><span class="koboSpan" id="kobo.696.1">Cloud services: AWS Lambda</span></li>
<li class="bulletList level-2"><span class="koboSpan" id="kobo.697.1">API tools: GraphQL and Requests</span></li>
<li class="bulletList level-2"><span class="koboSpan" id="kobo.698.1">File operations: File System</span></li>
</ul></li>
<li class="b lletList"><strong class="keyWord"><span class="koboSpan" id="kobo.699.1">Tools that give an LLM access to databases by writing and executing SQL code</span></strong><span class="koboSpan" id="kobo.700.1">: For example, </span><code class="inlineCode"><span class="koboSpan" id="kobo.701.1">SQLDatabase</span></code><span class="koboSpan" id="kobo.702.1"> includes tools to get information about the database and its objects and execute SQL queries. </span><span class="koboSpan" id="kobo.702.2">You can also access Google Drive with </span><code class="inlineCode"><span class="koboSpan" id="kobo.703.1">GoogleDriveLoader</span></code><span class="koboSpan" id="kobo.704.1"> or perform operations with usual file system tools from a </span><code class="inlineCode"><span class="koboSpan" id="kobo.705.1">FileManagementToolkit</span></code><span class="koboSpan" id="kobo.706.1">.</span></li>
<li class="b lletList"><strong class="keyWord"><span class="koboSpan" id="kobo.707.1">Other tools</span></strong><span class="koboSpan" id="kobo.708.1">: These comprise tools that integrate third-party systems and allow the LLM to gather additional information or act. </span><span class="koboSpan" id="kobo.708.2">There are also tools that can integrate data retrieval from Google Maps, NASA, and other platforms and organizations.</span></li>
<li class="b lletList"><strong class="keyWord"><span class="koboSpan" id="kobo.709.1">Tools for using other AI systems or automation</span></strong><span class="koboSpan" id="kobo.710.1">:</span><ul><li class="bulletList level-2"><span class="koboSpan" id="kobo.711.1">Image generation: DALL-E and Imagen</span></li>
<li class="bulletList level-2"><span class="koboSpan" id="kobo.712.1">Speech synthesis: Google Cloud TTS and Eleven Labs</span></li>
<li class="bulletList level-2"><span class="koboSpan" id="kobo.713.1">Model access: Hugging Face Hub</span></li>
<li class="bulletList level-2"><span class="koboSpan" id="kobo.714.1">Workflow automation: Zapier and IFTTT</span></li>
</ul></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.715.1">Any external system with an API can be wrapped as a tool if it enhances an LLM like this: </span></p>
<ul>
<li class="b lletList"><span class="koboSpan" id="kobo.716.1">Provides relevant domain knowledge to the user or the workflow</span></li>
<li class="b lletList"><span class="koboSpan" id="kobo.717.1">Allows an LLM to take actions on the user’s behalf </span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.718.1">When integrating such tools with LangChain, consider these key aspects:</span></p>
<ul>
<li class="b lletList"><strong class="keyWord"><span class="koboSpan" id="kobo.719.1">Authentication</span></strong><span class="koboSpan" id="kobo.720.1">: Secure access to the external system</span></li>
<li class="b lletList"><strong class="keyWord"><span class="koboSpan" id="kobo.721.1">Payload schema</span></strong><span class="koboSpan" id="kobo.722.1">: Define proper data structures for input/output</span></li>
<li class="b lletList"><strong class="keyWord"><span class="koboSpan" id="kobo.723.1">Error handling</span></strong><span class="koboSpan" id="kobo.724.1">: Plan for failures and edge cases</span></li>
<li class="b lletList"><strong class="keyWord"><span class="koboSpan" id="kobo.725.1">Safety considerations</span></strong><span class="koboSpan" id="kobo.726.1">: For example, when developing a SQL-to-text agent, restrict access to read-only operations to prevent unintended modifications</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.727.1">Therefore, an</span><a id="_idIndexMarker451"/><span class="koboSpan" id="kobo.728.1"> important toolkit is the </span><code class="inlineCode"><span class="koboSpan" id="kobo.729.1">RequestsToolkit</span></code><span class="koboSpan" id="kobo.730.1">, which allows one to easily wrap any HTTP API:</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.731.1">from</span></span><span class="koboSpan" id="kobo.732.1"> langchain_community.agent_toolkits.openapi.toolkit </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.733.1">import</span></span><span class="koboSpan" id="kobo.734.1"> RequestsToolkit</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.735.1">from</span></span><span class="koboSpan" id="kobo.736.1"> langchain_community.utilities.requests </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.737.1">import</span></span><span class="koboSpan" id="kobo.738.1"> TextRequestsWrapper</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.739.1">toolkit = RequestsToolkit(</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.740.1">   requests_wrapper=TextRequestsWrapper(headers={}),</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.741.1">   allow_dangerous_requests=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.742.1">True</span></span><span class="koboSpan" id="kobo.743.1">,</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.744.1">)</span></p>
<div aria-label="197" epub:type="pagebreak" id="page17-4" role="doc-pagebreak"/>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.745.1">for</span></span><span class="koboSpan" id="kobo.746.1"> tool </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.747.1">in</span></span><span class="koboSpan" id="kobo.748.1"> toolkit.get_tools():</span></p>
<p class="snippet-code"> <span class="hljs-built_in"><span class="koboSpan" id="kobo.749.1">print</span></span><span class="koboSpan" id="kobo.750.1">(tool.name)</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.751.1">&gt;&gt; requests_get</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.752.1">requests_post</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.753.1">requests_patch</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.754.1">requests_put</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.755.1">requests_delete</span></p>
<p class="normal"><span class="koboSpan" id="kobo.756.1">Let’s take</span><a id="_idIndexMarker452"/><span class="koboSpan" id="kobo.757.1"> a free open-source currency API (</span><a href="https://frankfurter.dev/"><span class="url"><span class="koboSpan" id="kobo.758.1">https://frankfurter.dev/</span></span></a><span class="koboSpan" id="kobo.759.1">). </span><span class="koboSpan" id="kobo.759.2">It’s a random free API we took from the Internet for illustrative purposes only, just to show you how you can wrap any existing API as a tool. </span><span class="koboSpan" id="kobo.759.3">First, we need to put together an API spec based on the OpenAPI format. </span><span class="koboSpan" id="kobo.759.4">We truncated the spec but you can find the full version on our GitHub:</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.760.1">api_spec = </span><span class="hljs-string"><span class="koboSpan" id="kobo.761.1">"""</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.762.1">openapi: 3.0.0</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.763.1">info:</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.764.1"> title: Frankfurter Currency Exchange API</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.765.1"> version: v1</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.766.1"> description: API for retrieving currency exchange rates. </span><span class="koboSpan" id="kobo.766.2">Pay attention to the base currency and change it if needed.</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.767.1">servers:</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.768.1"> - url: https://api.frankfurter.dev/v1</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.769.1">paths:</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.770.1"> /v1/latest:</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.771.1">   get:</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.772.1">     summary: Get the latest exchange rates.</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.773.1">     parameters:</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.774.1">       - in: query</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.775.1">         name: symbols</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.776.1">         schema:</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.777.1">           type: string</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.778.1">         description: Comma-separated list of currency symbols to retrieve rates for. </span><span class="koboSpan" id="kobo.778.2">Example: CHF,GBP</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.779.1">       - in: query</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.780.1">         name: base</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.781.1">         schema:</span></span></p>
<div aria-label="198" epub:type="pagebreak" id="page18-4" role="doc-pagebreak"/>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.782.1">           type: string</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.783.1">         description: The base currency for the exchange rates. </span><span class="koboSpan" id="kobo.783.2">If not provided, EUR is used as a base currency. </span><span class="koboSpan" id="kobo.783.3">Example: USD</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.784.1">   /v1/{date}:</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.785.1">   ...</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.786.1">"""</span></span></p>
<p class="normal"><span class="koboSpan" id="kobo.787.1">Now let’s </span><a id="_idIndexMarker453"/><span class="koboSpan" id="kobo.788.1">build and</span><a id="_idIndexMarker454"/><span class="koboSpan" id="kobo.789.1"> run our ReACT agent; we’ll see that the LLM can query the third-party API and provide fresh answers on currency exchange rates:</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.790.1">system_message = (</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.791.1">"You're given the API spec:\n{api_spec}\n"</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.792.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.793.1">Use the API to answer users' queries if possible. </span><span class="koboSpan" id="kobo.793.2">"</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.794.1">)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.795.1">agent = create_react_agent(llm, toolkit.get_tools(), state_modifier=system_message.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.796.1">format</span></span><span class="koboSpan" id="kobo.797.1">(api_spec=api_spec))</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.798.1">query = </span><span class="hljs-string"><span class="koboSpan" id="kobo.799.1">"What is the swiss franc to US dollar exchange rate?"</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.800.1">events = agent.stream(</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.801.1">   {</span><span class="hljs-string"><span class="koboSpan" id="kobo.802.1">"messages"</span></span><span class="koboSpan" id="kobo.803.1">: [(</span><span class="hljs-string"><span class="koboSpan" id="kobo.804.1">"user"</span></span><span class="koboSpan" id="kobo.805.1">, query)]},</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.806.1">   stream_mode=</span><span class="hljs-string"><span class="koboSpan" id="kobo.807.1">"values"</span></span><span class="koboSpan" id="kobo.808.1">,</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.809.1">)</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.810.1">for</span></span><span class="koboSpan" id="kobo.811.1"> event </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.812.1">in</span></span><span class="koboSpan" id="kobo.813.1"> events:</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.814.1">   event[</span><span class="hljs-string"><span class="koboSpan" id="kobo.815.1">"messages"</span></span><span class="koboSpan" id="kobo.816.1">][-</span><span class="hljs-number"><span class="koboSpan" id="kobo.817.1">1</span></span><span class="koboSpan" id="kobo.818.1">].pretty_print()</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.819.1">&gt;&gt; ============================== Human Message =================================</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.820.1">What is the swiss franc to US dollar exchange rate?</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.821.1">================================== Ai Message ==================================</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.822.1">Tool Calls:</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.823.1">  requests_get (541a9197-888d-4ffe-a354-c726804ad7ff)</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.824.1"> Call ID: 541a9197-888d-4ffe-a354-c726804ad7ff</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.825.1">  Args:</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.826.1">    url: https://api.frankfurter.dev/v1/latest?symbols=CHF&amp;base=USD</span></p>
<div aria-label="199" epub:type="pagebreak" id="page19-4" role="doc-pagebreak"/>
<p class="snippet-con"><span class="koboSpan" id="kobo.827.1">================================= Tool Message =================================</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.828.1">Name: requests_get</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.829.1">{"amount":1.0,"base":"USD","date":"2025-01-31","rates":{"CHF":0.90917}}</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.830.1">================================== Ai Message ==================================</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.831.1">The Swiss franc to US dollar exchange rate is 0.90917.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.832.1">Observe</span><a id="_idIndexMarker455"/><span class="koboSpan" id="kobo.833.1"> that, this time, we use a </span><code class="inlineCode"><span class="koboSpan" id="kobo.834.1">stream_mode="values"</span></code><span class="koboSpan" id="kobo.835.1"> option, and in this option, each time, we get a full current state from the graph. </span></p>
<div>
<div class="note" id="_idContainer075">
<p class="normal"><span class="koboSpan" id="kobo.836.1">There are over 50 tools already available. </span><span class="koboSpan" id="kobo.836.2">You can find a full list on the documentation page: </span><a href="https://python.langchain.com/docs/integrations/tools/"><span class="url"><span class="koboSpan" id="kobo.837.1">https://python.langchain.com/docs/integrations/tools/</span></span></a><span class="koboSpan" id="kobo.838.1">. </span></p>
</div>
</div>
<h2 class="heading-2" id="_idParaDest-129"><a id="_idTextAnchor244"/><span class="koboSpan" id="kobo.839.1">Custom tools</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.840.1">We looked</span><a id="_idIndexMarker456"/><span class="koboSpan" id="kobo.841.1"> at the</span><a id="_idIndexMarker457"/><span class="koboSpan" id="kobo.842.1"> variety of built-in tools offered by LangGraph. </span><span class="koboSpan" id="kobo.842.2">Now it’s time to discuss how you can create your own custom tools, besides the example we looked at when we wrapped the third-party API with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.843.1">RequestsToolkit</span></code><span class="koboSpan" id="kobo.844.1"> by providing an API </span><a id="_idTextAnchor245"/><span class="koboSpan" id="kobo.845.1">spec. </span><span class="koboSpan" id="kobo.845.2">Let’s get down to it!</span></p>
<h3 class="heading-3" id="_idParaDest-130"><a id="_idTextAnchor246"/><span class="koboSpan" id="kobo.846.1">Wrapping a Python function as a tool</span></h3>
<p class="normal"><span class="koboSpan" id="kobo.847.1">Any </span><code class="inlineCode"><span class="koboSpan" id="kobo.848.1">Python</span></code><span class="koboSpan" id="kobo.849.1"> function (or callable) can be wrapped as a tool. </span><span class="koboSpan" id="kobo.849.2">As we remember, a tool on LangChain</span><a id="_idIndexMarker458"/><span class="koboSpan" id="kobo.850.1"> should have a name, a description, and an argument schema. </span><span class="koboSpan" id="kobo.850.2">Let’s build our own calculator based on the Python </span><code class="inlineCode"><span class="koboSpan" id="kobo.851.1">numexr</span></code><span class="koboSpan" id="kobo.852.1"> library—a fast numerical expression evaluator based on NumPy (</span><a href="https://github.com/pydata/numexpr"><span class="url"><span class="koboSpan" id="kobo.853.1">https://github.com/pydata/numexpr</span></span></a><span class="koboSpan" id="kobo.854.1">). </span><span class="koboSpan" id="kobo.854.2">We’re going to use a special </span><code class="inlineCode"><span class="koboSpan" id="kobo.855.1">@tool</span></code><span class="koboSpan" id="kobo.856.1"> decorator that will wrap our function as a tool:</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.857.1">import</span></span><span class="koboSpan" id="kobo.858.1"> math</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.859.1">from</span></span><span class="koboSpan" id="kobo.860.1"> langchain_core.tools </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.861.1">import</span></span><span class="koboSpan" id="kobo.862.1"> tool</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.863.1">import</span></span><span class="koboSpan" id="kobo.864.1"> numexpr </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.865.1">as</span></span><span class="koboSpan" id="kobo.866.1"> ne</span></p>
<p class="snippet-code"><span class="hljs-meta"><span class="koboSpan" id="kobo.867.1">@tool</span></span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.868.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.869.1">calculator</span></span><span class="koboSpan" id="kobo.870.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.871.1">expression: </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.872.1">str</span></span><span class="koboSpan" id="kobo.873.1">) -&gt; </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.874.1">str</span></span><span class="koboSpan" id="kobo.875.1">:</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.876.1">"""Calculates a single mathematical expression, incl. </span><span class="koboSpan" id="kobo.876.2">complex numbers.</span></span></p>
<p class="snippet-code"><span class="hljs-string"> </span></p>
<div aria-label="200" epub:type="pagebreak" id="page20-4" role="doc-pagebreak"/>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.877.1">   Always add * to operations, examples:</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.878.1">     73i -&gt; 73*i</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.879.1">     7pi**2 -&gt; 7*pi**2</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.880.1">   """</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.881.1">   math_constants = {</span><span class="hljs-string"><span class="koboSpan" id="kobo.882.1">"pi"</span></span><span class="koboSpan" id="kobo.883.1">: math.pi, </span><span class="hljs-string"><span class="koboSpan" id="kobo.884.1">"i"</span></span><span class="koboSpan" id="kobo.885.1">: </span><span class="hljs-number"><span class="koboSpan" id="kobo.886.1">1j</span></span><span class="koboSpan" id="kobo.887.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.888.1">"e"</span></span><span class="koboSpan" id="kobo.889.1">: math.exp}</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.890.1">   result = ne.evaluate(expression.strip(), local_dict=math_constants)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.891.1">   return str(result)</span></p>
<p class="normal"><span class="koboSpan" id="kobo.892.1">Let’s</span><a id="_idIndexMarker459"/><span class="koboSpan" id="kobo.893.1"> explore the calculator object we have! </span><span class="koboSpan" id="kobo.893.2">Notice that LangChain auto-inherited the name, the description, and args schema from the docstring and type hints. </span><span class="koboSpan" id="kobo.893.3">Please note that we used a few-shot technique (discussed in </span><a href="E_Chapter_3.xhtml#_idTextAnchor107"><em class="italic"><span class="koboSpan" id="kobo.894.1">Chapter 3</span></em></a><span class="koboSpan" id="kobo.895.1">) to teach LLMs how to prepare the payload for our tool by adding two examples in the docstring:</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.896.1">from</span></span><span class="koboSpan" id="kobo.897.1"> langchain_core.tools </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.898.1">import</span></span><span class="koboSpan" id="kobo.899.1"> BaseTool</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.900.1">assert</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.901.1">isinstance</span></span><span class="koboSpan" id="kobo.902.1">(calculator, BaseTool)</span></p>
<p class="snippet-code"><span class="hljs-built_in"><span class="koboSpan" id="kobo.903.1">print</span></span><span class="koboSpan" id="kobo.904.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.905.1">f"Tool schema: </span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.906.1">{calculator.args_schema.model_json_schema()}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.907.1">"</span></span><span class="koboSpan" id="kobo.908.1">)</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.909.1">&gt;&gt; Tool schema: {'description': 'Calculates a single mathematical expression, incl. </span><span class="koboSpan" id="kobo.909.2">complex numbers.\n\nAlways add * to operations, examples:\n  73i -&gt; 73*i\n  7pi**2 -&gt; 7*pi**2', 'properties': {'expression': {'title': 'Expression', 'type': 'string'}}, 'required': ['expression'], 'title': 'calculator', 'type': 'object'}</span></p>
<p class="normal"><span class="koboSpan" id="kobo.910.1">Let’s try out our new tool to evaluate an expression with complex numbers, which extend real numbers with a special imaginary unit </span><code class="inlineCode"><span class="koboSpan" id="kobo.911.1">i</span></code><span class="koboSpan" id="kobo.912.1"> that has a property </span><code class="inlineCode"><span class="koboSpan" id="kobo.913.1">i**2=-1</span></code><span class="koboSpan" id="kobo.914.1">:</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.915.1">query = </span><span class="hljs-string"><span class="koboSpan" id="kobo.916.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.917.1">How much is 2+3i squared?"</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.918.1">agent = create_react_agent(llm, [calculator])</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.919.1">for</span></span><span class="koboSpan" id="kobo.920.1"> event </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.921.1">in</span></span><span class="koboSpan" id="kobo.922.1"> agent.stream({</span><span class="hljs-string"><span class="koboSpan" id="kobo.923.1">"messages"</span></span><span class="koboSpan" id="kobo.924.1">: [(</span><span class="hljs-string"><span class="koboSpan" id="kobo.925.1">"user"</span></span><span class="koboSpan" id="kobo.926.1">, query)]}, stream_mode=</span><span class="hljs-string"><span class="koboSpan" id="kobo.927.1">"values"</span></span><span class="koboSpan" id="kobo.928.1">):</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.929.1">   event[</span><span class="hljs-string"><span class="koboSpan" id="kobo.930.1">"messages"</span></span><span class="koboSpan" id="kobo.931.1">][-</span><span class="hljs-number"><span class="koboSpan" id="kobo.932.1">1</span></span><span class="koboSpan" id="kobo.933.1">].pretty_print()</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.934.1">&gt;&gt; ===============================Human Message =================================</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.935.1">How much is 2+3i squared?</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.936.1">================================== Ai Message ==================================</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.937.1">Tool Calls:</span></p>
<div aria-label="201" epub:type="pagebreak" id="page21-4" role="doc-pagebreak"/>
<p class="snippet-con"><span class="koboSpan" id="kobo.938.1">  calculator (9b06de35-a31c-41f3-a702-6e20698bf21b)</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.939.1"> Call ID: 9b06de35-a31c-41f3-a702-6e20698bf21b</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.940.1">  Args:</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.941.1">    expression: (2+3*i)**2</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.942.1">================================= Tool Message =================================</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.943.1">Name: calculator</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.944.1">(-5+12j)</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.945.1">================================== Ai Message ==================================</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.946.1">(2+3i)² = -5+12i.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.947.1">With</span><a id="_idIndexMarker460"/><span class="koboSpan" id="kobo.948.1"> just a few lines of code, we’ve successfully extended our LLM’s capabilities to work with complex numbers. </span><span class="koboSpan" id="kobo.948.2">Now we can put together the example we started with:</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.949.1">question = </span><span class="hljs-string"><span class="koboSpan" id="kobo.950.1">"What is a square root of the current US president's age multiplied by 132?"</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.951.1">system_hint = </span><span class="hljs-string"><span class="koboSpan" id="kobo.952.1">"Think step-by-step. </span><span class="koboSpan" id="kobo.952.2">Always use search to get the fresh information about events or public facts that can change over time."</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.953.1">agent = create_react_agent(</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.954.1">   llm, [calculator, search],</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.955.1">   state_modifier=system_hint)</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.956.1">for</span></span><span class="koboSpan" id="kobo.957.1"> event </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.958.1">in</span></span><span class="koboSpan" id="kobo.959.1"> agent.stream({</span><span class="hljs-string"><span class="koboSpan" id="kobo.960.1">"messages"</span></span><span class="koboSpan" id="kobo.961.1">: [(</span><span class="hljs-string"><span class="koboSpan" id="kobo.962.1">"user"</span></span><span class="koboSpan" id="kobo.963.1">, question)]}, stream_mode=</span><span class="hljs-string"><span class="koboSpan" id="kobo.964.1">"values"</span></span><span class="koboSpan" id="kobo.965.1">):</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.966.1">   event[</span><span class="hljs-string"><span class="koboSpan" id="kobo.967.1">"messages"</span></span><span class="koboSpan" id="kobo.968.1">][-</span><span class="hljs-number"><span class="koboSpan" id="kobo.969.1">1</span></span><span class="koboSpan" id="kobo.970.1">].pretty_print()</span></p>
<p class="snippet-code"><span class="hljs-built_in"><span class="koboSpan" id="kobo.971.1">print</span></span><span class="koboSpan" id="kobo.972.1">(event[</span><span class="hljs-string"><span class="koboSpan" id="kobo.973.1">"messages"</span></span><span class="koboSpan" id="kobo.974.1">][-</span><span class="hljs-number"><span class="koboSpan" id="kobo.975.1">1</span></span><span class="koboSpan" id="kobo.976.1">].content)</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.977.1">&gt;&gt; The square root of Donald Trump's age multiplied by 132 is approximately 101.47.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.978.1">We </span><a id="_idIndexMarker461"/><span class="koboSpan" id="kobo.979.1">haven’t provided the full output here in the book (you can find it on our GitHub), but if you run this snippet, you should see that the LLM was able to query tools step by step:</span></p>
<div aria-label="202" epub:type="pagebreak" id="page22-4" role="doc-pagebreak"/>
<ol>
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.980.1">It called the search engine with the query </span><code class="inlineCode"><span class="koboSpan" id="kobo.981.1">"current US president"</span></code><span class="koboSpan" id="kobo.982.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.983.1">Then, it again called the search engine with the query </span><code class="inlineCode"><span class="koboSpan" id="kobo.984.1">"donald trump age"</span></code><span class="koboSpan" id="kobo.985.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.986.1">As the last step, the LLM called the calculator tool with the expression </span><code class="inlineCode"><span class="koboSpan" id="kobo.987.1">"sqrt(78*132)"</span></code><span class="koboSpan" id="kobo.988.1">.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.989.1">Finally, it returned the correct answer to the user.</span></li>
</ol>
<p class="normal"><span class="koboSpan" id="kobo.990.1">At every step, the LLM reasoned based on the previously collected information and then acted with an appropriate tool—that’s the</span><a id="_idTextAnchor247"/><span class="koboSpan" id="kobo.991.1"> essence of the ReACT approach.</span></p>
<h3 class="heading-3" id="_idParaDest-131"><a id="_idTextAnchor248"/><span class="koboSpan" id="kobo.992.1">Creating a tool from a Runnable</span></h3>
<p class="normal"><span class="koboSpan" id="kobo.993.1">Sometimes, LangChain </span><a id="_idIndexMarker462"/><span class="koboSpan" id="kobo.994.1">might not be able to derive a passing description or args schema from a function, or we might be using a complex callable that is difficult to wrap with a decorator. </span><span class="koboSpan" id="kobo.994.2">For example, we can use another LangChain chain or LangGraph graph as a tool. </span><span class="koboSpan" id="kobo.994.3">We can create a tool from any </span><code class="inlineCode"><span class="koboSpan" id="kobo.995.1">Runnable</span></code><span class="koboSpan" id="kobo.996.1"> by explicitly specifying all needed descriptions. </span><span class="koboSpan" id="kobo.996.2">Let’s create a calculator tool from a function in an alternative fashion, and we will tune the retry behavior (in our case, we’re going to retry three times and add an exponential backoff between consecutive attempts):</span></p>
<div>
<div class="note" id="_idContainer076">
<p class="normal"><span class="koboSpan" id="kobo.997.1">Please note that we use the same function as above but we removed the </span><code class="inlineCode"><span class="koboSpan" id="kobo.998.1">@tool</span></code><span class="koboSpan" id="kobo.999.1"> decorator.</span></p>
</div>
</div>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1000.1">from</span></span><span class="koboSpan" id="kobo.1001.1"> langchain_core.runnables </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1002.1">import</span></span><span class="koboSpan" id="kobo.1003.1"> RunnableLambda, RunnableConfig</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1004.1">from</span></span><span class="koboSpan" id="kobo.1005.1"> langchain_core.tools </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1006.1">import</span></span><span class="koboSpan" id="kobo.1007.1"> tool, convert_runnable_to_tool</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1008.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1009.1">calculator</span></span><span class="koboSpan" id="kobo.1010.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1011.1">expression: </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1012.1">str</span></span><span class="koboSpan" id="kobo.1013.1">) -&gt; </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1014.1">str</span></span><span class="koboSpan" id="kobo.1015.1">:</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1016.1">   math_constants = {</span><span class="hljs-string"><span class="koboSpan" id="kobo.1017.1">"pi"</span></span><span class="koboSpan" id="kobo.1018.1">: math.pi, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1019.1">"i"</span></span><span class="koboSpan" id="kobo.1020.1">: </span><span class="hljs-number"><span class="koboSpan" id="kobo.1021.1">1j</span></span><span class="koboSpan" id="kobo.1022.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1023.1">"e"</span></span><span class="koboSpan" id="kobo.1024.1">: math.exp}</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1025.1">   result = ne.evaluate(expression.strip(), local_dict=math_constants)</span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1026.1">return</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1027.1">str</span></span><span class="koboSpan" id="kobo.1028.1">(result)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1029.1">calculator_with_retry = RunnableLambda(calculator).with_retry(</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1030.1">   wait_exponential_jitter=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.1031.1">True</span></span><span class="koboSpan" id="kobo.1032.1">,</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1033.1">   stop_after_attempt=</span><span class="hljs-number"><span class="koboSpan" id="kobo.1034.1">3</span></span><span class="koboSpan" id="kobo.1035.1">,</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1036.1">)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1037.1">calculator_tool = convert_runnable_to_tool(</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1038.1">   calculator_with_retry,</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1039.1">   name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.1040.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1041.1">calculator"</span></span><span class="koboSpan" id="kobo.1042.1">,</span></p>
<div aria-label="203" epub:type="pagebreak" id="page23-4" role="doc-pagebreak"/>
<p class="snippet-code"><span class="koboSpan" id="kobo.1043.1">   description=(</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1044.1">"Calculates a single mathematical expression, incl. </span><span class="koboSpan" id="kobo.1044.2">complex numbers."</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1045.1">"'\nAlways add * to operations, examples:\n73i -&gt; 73*i\n"</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1046.1">"7pi**2 -&gt; 7*pi**2"</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1047.1">   ),</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1048.1">   arg_types={</span><span class="hljs-string"><span class="koboSpan" id="kobo.1049.1">"expression"</span></span><span class="koboSpan" id="kobo.1050.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.1051.1">"str"</span></span><span class="koboSpan" id="kobo.1052.1">},</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1053.1">)</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1054.1">Observe </span><a id="_idIndexMarker463"/><span class="koboSpan" id="kobo.1055.1">that we defined our function in a similar way to how we define LangGraph nodes—it takes a state (which now is a Pydantic model) and a config. </span><span class="koboSpan" id="kobo.1055.2">Then, we wrapped this function as </span><code class="inlineCode"><span class="koboSpan" id="kobo.1056.1">RunnableLambda</span></code><span class="koboSpan" id="kobo.1057.1"> and added retries. </span><span class="koboSpan" id="kobo.1057.2">It might be useful if we want to keep our Python function as a function without wrapping it with a decorator, or if we want to wrap an external API (hence, description and arguments schema can’t be auto-inherited from the docstrings). </span><span class="koboSpan" id="kobo.1057.3">We can use any Runnable (for example, a chain or a graph) to create a tool, and that allows us to build multi-agent systems since now one LLM-based workflow can invoke another LLM-based one. </span><span class="koboSpan" id="kobo.1057.4">Let’s convert our Runnable to a tool:</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1058.1">calculator_tool = convert_runnable_to_tool(</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1059.1">   calculator_with_retry,</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1060.1">   name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.1061.1">"calculator"</span></span><span class="koboSpan" id="kobo.1062.1">,</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1063.1">   description=(</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1064.1">"Calculates a single mathematical expression, incl. </span><span class="koboSpan" id="kobo.1064.2">complex numbers."</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1065.1">"'</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1066.1">\nAlways add * to operations, examples:\n73i -&gt; 73*i\n"</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1067.1">"7pi**2 -&gt; 7*pi**2"</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1068.1">   ),</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1069.1">   arg_types={</span><span class="hljs-string"><span class="koboSpan" id="kobo.1070.1">"expression"</span></span><span class="koboSpan" id="kobo.1071.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.1072.1">"str"</span></span><span class="koboSpan" id="kobo.1073.1">},</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1074.1">)</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1075.1">Let’s test our new </span><code class="inlineCode"><span class="koboSpan" id="kobo.1076.1">calculator</span></code><span class="koboSpan" id="kobo.1077.1"> function with the LLM:</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1078.1">llm.invoke(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1079.1">"How much is (2+3i)**2"</span></span><span class="koboSpan" id="kobo.1080.1">, tools=[calculator_tool]).tool_calls[</span><span class="hljs-number"><span class="koboSpan" id="kobo.1081.1">0</span></span><span class="koboSpan" id="kobo.1082.1">]</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.1083.1">&gt;&gt; {'name': 'calculator',</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.1084.1"> 'args': {'__arg1': '(2+3*i)**2'},</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.1085.1"> 'id': '46c7e71c-4092-4299-8749-1b24a010d6d6',</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.1086.1"> 'type': 'tool_call'}</span></p>
<div aria-label="204" epub:type="pagebreak" id="page24-4" role="doc-pagebreak"/>
<p class="normal"><span class="koboSpan" id="kobo.1087.1">As you can note, LangChain didn’t inherit the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1088.1">args</span></code><span class="koboSpan" id="kobo.1089.1"> schema fully; that’s why it created artificial names for arguments like </span><code class="inlineCode"><span class="koboSpan" id="kobo.1090.1">__arg1</span></code><span class="koboSpan" id="kobo.1091.1">. </span><span class="koboSpan" id="kobo.1091.2">Let’s change our tool to accept a Pydantic model instead, in a similar</span><a id="_idIndexMarker464"/><span class="koboSpan" id="kobo.1092.1"> fashion to how we define LangGraph nodes:</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1093.1">from</span></span><span class="koboSpan" id="kobo.1094.1"> pydantic </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1095.1">import</span></span><span class="koboSpan" id="kobo.1096.1"> BaseModel, Field</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1097.1">from</span></span><span class="koboSpan" id="kobo.1098.1"> langchain_core.runnables </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1099.1">import</span></span><span class="koboSpan" id="kobo.1100.1"> RunnableConfig</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1101.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1102.1">CalculatorArgs</span></span><span class="koboSpan" id="kobo.1103.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.1104.1">BaseModel</span></span><span class="koboSpan" id="kobo.1105.1">):</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1106.1">   expression: </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1107.1">str</span></span><span class="koboSpan" id="kobo.1108.1"> = Field(description=</span><span class="hljs-string"><span class="koboSpan" id="kobo.1109.1">"Mathematical expression to be evaluated"</span></span><span class="koboSpan" id="kobo.1110.1">)</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1111.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1112.1">calculator</span></span><span class="koboSpan" id="kobo.1113.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1114.1">state: CalculatorArgs, config: RunnableConfig</span></span><span class="koboSpan" id="kobo.1115.1">) -&gt; </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1116.1">str</span></span><span class="koboSpan" id="kobo.1117.1">:</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1118.1">   expression = state[</span><span class="hljs-string"><span class="koboSpan" id="kobo.1119.1">"expression"</span></span><span class="koboSpan" id="kobo.1120.1">]</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1121.1">   math_constants = config[</span><span class="hljs-string"><span class="koboSpan" id="kobo.1122.1">"configurable"</span></span><span class="koboSpan" id="kobo.1123.1">].get(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1124.1">"math_constants"</span></span><span class="koboSpan" id="kobo.1125.1">, {})</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1126.1">   result = ne.evaluate(expression.strip(), local_dict=math_constants)</span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1127.1">return</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1128.1">str</span></span><span class="koboSpan" id="kobo.1129.1">(result)</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1130.1">Now the full schema is a proper one:</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1131.1">assert</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1132.1">isinstance</span></span><span class="koboSpan" id="kobo.1133.1">(calculator_tool, BaseTool)</span></p>
<p class="snippet-code"><span class="hljs-built_in"><span class="koboSpan" id="kobo.1134.1">print</span></span><span class="koboSpan" id="kobo.1135.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1136.1">f"Tool name: </span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.1137.1">{calculator_tool.name}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1138.1">"</span></span><span class="koboSpan" id="kobo.1139.1">)</span></p>
<p class="snippet-code"><span class="hljs-built_in"><span class="koboSpan" id="kobo.1140.1">print</span></span><span class="koboSpan" id="kobo.1141.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1142.1">f"Tool description: </span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.1143.1">{calculator_tool.description}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1144.1">"</span></span><span class="koboSpan" id="kobo.1145.1">)</span></p>
<p class="snippet-code"><span class="hljs-built_in"><span class="koboSpan" id="kobo.1146.1">print</span></span><span class="koboSpan" id="kobo.1147.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1148.1">f"Args schema: </span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.1149.1">{calculator_tool.args_schema.model_json_schema()}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1150.1">"</span></span><span class="koboSpan" id="kobo.1151.1">)</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.1152.1">&gt;&gt; Tool name: calculator</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.1153.1">Tool description: Calculates a single mathematical expression, incl. </span><span class="koboSpan" id="kobo.1153.2">complex numbers.'</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.1154.1">Always add * to operations, examples:</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.1155.1">73i -&gt; 73*i</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.1156.1">7pi**2 -&gt; 7*pi**2</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.1157.1">Args schema: {'properties': {'expression': {'title': 'Expression', 'type': 'string'}}, 'required': ['expression'], 'title': 'calculator', 'type': 'object'}</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1158.1">Let’s test it together with an LLM:</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1159.1">tool_call = llm.invoke(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1160.1">"How much is (2+3i)**2"</span></span><span class="koboSpan" id="kobo.1161.1">, tools=[calculator_tool]).tool_calls[</span><span class="hljs-number"><span class="koboSpan" id="kobo.1162.1">0</span></span><span class="koboSpan" id="kobo.1163.1">]</span></p>
<p class="snippet-code"><span class="hljs-built_in"><span class="koboSpan" id="kobo.1164.1">print</span></span><span class="koboSpan" id="kobo.1165.1">(tool_call)</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.1166.1">&gt;&gt; {'name': 'calculator', 'args': {'expression': '(2+3*i)**2'}, 'id': 'f8be9cbc-4bdc-4107-8cfb-fd84f5030299', 'type': 'tool_call'}</span></p>
<div aria-label="205" epub:type="pagebreak" id="page25-3" role="doc-pagebreak"/>
<p class="normal"><span class="koboSpan" id="kobo.1167.1">We can </span><a id="_idIndexMarker465"/><span class="koboSpan" id="kobo.1168.1">call our calculator tool and pass it to the LangGraph configuration in runtime:</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1169.1">math_constants = {</span><span class="hljs-string"><span class="koboSpan" id="kobo.1170.1">"pi"</span></span><span class="koboSpan" id="kobo.1171.1">: math.pi, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1172.1">"i"</span></span><span class="koboSpan" id="kobo.1173.1">: </span><span class="hljs-number"><span class="koboSpan" id="kobo.1174.1">1j</span></span><span class="koboSpan" id="kobo.1175.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1176.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1177.1">e"</span></span><span class="koboSpan" id="kobo.1178.1">: math.exp}</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1179.1">config = {</span><span class="hljs-string"><span class="koboSpan" id="kobo.1180.1">"configurable"</span></span><span class="koboSpan" id="kobo.1181.1">: {</span><span class="hljs-string"><span class="koboSpan" id="kobo.1182.1">"math_constants"</span></span><span class="koboSpan" id="kobo.1183.1">: math_constants}}</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1184.1">calculator_tool.invoke(tool_call[</span><span class="hljs-string"><span class="koboSpan" id="kobo.1185.1">"args"</span></span><span class="koboSpan" id="kobo.1186.1">], config=config)</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.1187.1">&gt;&gt; (-5+12j)</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1188.1">With that, we have learned how we can easily convert any Runnable to a tool by providing additional details to LangChain to ensure an </span><a id="_idTextAnchor249"/><span class="koboSpan" id="kobo.1189.1">LLM can correctly handle this tool.</span></p>
<h3 class="heading-3" id="_idParaDest-132"><a id="_idTextAnchor250"/><span class="koboSpan" id="kobo.1190.1">Subclass StructuredTool or BaseTool</span></h3>
<p class="normal"><span class="koboSpan" id="kobo.1191.1">Another </span><a id="_idIndexMarker466"/><span class="koboSpan" id="kobo.1192.1">method to define a tool is by creating a custom tool by subclassing the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1193.1">BaseTool</span></code><span class="koboSpan" id="kobo.1194.1"> class. </span><span class="koboSpan" id="kobo.1194.2">As with other approaches, you must specify the tool’s name, description, and argument schema. </span><span class="koboSpan" id="kobo.1194.3">You’ll also need to implement one or two abstract methods: </span><code class="inlineCode"><span class="koboSpan" id="kobo.1195.1">_run</span></code><span class="koboSpan" id="kobo.1196.1"> for synchronous execution and, if necessary, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1197.1">_arun</span></code><span class="koboSpan" id="kobo.1198.1"> for asynchronous behavior (if it differs from simply wrapping the sync version). </span><span class="koboSpan" id="kobo.1198.2">This option is particularly useful when your tool needs to be stateful (for example, to maintain long-lived connection clients) or when its logic is too complex to be implemented as a single function or </span><code class="inlineCode"><span class="koboSpan" id="kobo.1199.1">Runnable</span></code><span class="koboSpan" id="kobo.1200.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1201.1">If you want more flexibility than a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1202.1">@tool</span></code><span class="koboSpan" id="kobo.1203.1"> decorator gives you but don’t want to implement your own class, there’s an intermediate approach. </span><span class="koboSpan" id="kobo.1203.2">You can also use the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1204.1">StructuredTool.from_function</span></code><span class="koboSpan" id="kobo.1205.1"> class method, which allows you to explicitly specify tools’ meta parameters such as description or </span><code class="inlineCode"><span class="koboSpan" id="kobo.1206.1">args_schema</span></code><span class="koboSpan" id="kobo.1207.1"> with a few lines of code only:</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1208.1">from</span></span><span class="koboSpan" id="kobo.1209.1"> langchain_core.tools </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1210.1">import</span></span><span class="koboSpan" id="kobo.1211.1"> StructuredTool</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1212.1">calculator_tool = StructuredTool.from_function(</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1213.1">   name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.1214.1">"calculator"</span></span><span class="koboSpan" id="kobo.1215.1">,</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1216.1">   description=(</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1217.1">"Calculates a single mathematical expression, incl. </span><span class="koboSpan" id="kobo.1217.2">complex numbers."</span></span><span class="koboSpan" id="kobo.1218.1">),</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1219.1">   func=calculator,</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1220.1">   args_schema=CalculatorArgs</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1221.1">)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1222.1">tool_call = llm.invoke(</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1223.1">"How much is (2+3i)**2"</span></span><span class="koboSpan" id="kobo.1224.1">, tools=[calculator_tool]).tool_calls[</span><span class="hljs-number"><span class="koboSpan" id="kobo.1225.1">0</span></span><span class="koboSpan" id="kobo.1226.1">]</span></p>
<div aria-label="206" epub:type="pagebreak" id="page26-3" role="doc-pagebreak"/>
<p class="normal"><span class="koboSpan" id="kobo.1227.1">One last note about synchronous and asynchronous implementations is necessary at this point. </span><span class="koboSpan" id="kobo.1227.2">If an underlying function besides your tool is a synchronous function, LangChain will wrap it for the tool’s asynchronous implementation by launching it in a separate thread. </span><span class="koboSpan" id="kobo.1227.3">In most cases, it </span><a id="_idIndexMarker467"/><span class="koboSpan" id="kobo.1228.1">doesn’t matter, but if you care about the additional overhead of creating a separate thread, you have two options—either subclass from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1229.1">BaseClass</span></code><span class="koboSpan" id="kobo.1230.1"> and override async implementation, or create a separate async implementation of your function and pass it to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1231.1">StructruredTool.from_function</span></code><span class="koboSpan" id="kobo.1232.1"> as a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1233.1">coroutine</span></code><span class="koboSpan" id="kobo.1234.1"> argument. </span><span class="koboSpan" id="kobo.1234.2">You can also provide only async implementation, but then you won’t be able to invoke your workflows in a synchronous manner.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1235.1">To conclude, let’s take another look at three options that we have to create a LangChain tool, and when to use each of them.</span></p>
<table class="No-Table-Style _idGenTablePara-1" id="table001-5">
<colgroup>
<col/>
<col/>
</colgroup>
<tbody>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.1236.1">Method to create a tool</span></strong></p>
</td>
<td class="No-Table-Style">
<p class="normal"><strong class="keyWord"><span class="koboSpan" id="kobo.1237.1">When to use</span></strong></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p class="normal"><span class="koboSpan" id="kobo.1238.1">@tool decorator</span></p>
</td>
<td class="No-Table-Style">
<p class="normal"><span class="koboSpan" id="kobo.1239.1">You have a function with clear docstrings and this function isn’t used anywhere in your code </span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p class="normal"><span class="koboSpan" id="kobo.1240.1">convert_runnable_to_tool</span></p>
</td>
<td class="No-Table-Style">
<p class="normal"><span class="koboSpan" id="kobo.1241.1">You have an existing Runnable, or you need more detailed controlled on how arguments or tool descriptions are passed to an LLM (you wrap an existing function by a RunnableLambda in that case)</span></p>
</td>
</tr>
<tr class="No-Table-Style">
<td class="No-Table-Style">
<p class="normal"><span class="koboSpan" id="kobo.1242.1">subclass from StructuredTool or BaseTool</span></p>
</td>
<td class="No-Table-Style">
<p class="normal"><span class="koboSpan" id="kobo.1243.1">You need full control over tool description and logic (for example, you want to handle sync and async requests differently)</span></p>
</td>
</tr>
</tbody>
</table>
<p class="packt_figref"><span class="koboSpan" id="kobo.1244.1">Table 5.1: Options to create a LangChain tool</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1245.1">When an LLM generates payloads and calls tools, it might hallucinate or make other mistakes. </span><span class="koboSpan" id="kobo.1245.2">Therefore, we need to carefully think about error handling. </span></p>
<h2 class="heading-2" id="_idParaDest-133"><a id="_idTextAnchor251"/><span class="koboSpan" id="kobo.1246.1">Error handling</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1247.1">We already</span><a id="_idIndexMarker468"/><span class="koboSpan" id="kobo.1248.1"> discussed error handling in </span><a href="E_Chapter_3.xhtml#_idTextAnchor107"><em class="italic"><span class="koboSpan" id="kobo.1249.1">Chapter 3</span></em></a><span class="koboSpan" id="kobo.1250.1">, but it becomes even more important when you enhance an LLM with tools; you need logging, working with exceptions, and </span><a id="_idIndexMarker469"/><span class="koboSpan" id="kobo.1251.1">so on even more. </span><span class="koboSpan" id="kobo.1251.2">One additional consideration is to think about whether you would like your workflow to continue and try to auto-recover if one of your tools fails. </span><span class="koboSpan" id="kobo.1251.3">LangChain has a special </span><code class="inlineCode"><span class="koboSpan" id="kobo.1252.1">ToolException</span></code><span class="koboSpan" id="kobo.1253.1"> that allows the workflow to continue its execution by handling the exception.</span></p>
<p class="normal"><code class="inlineCode"><span class="koboSpan" id="kobo.1254.1">BaseTool</span></code><span class="koboSpan" id="kobo.1255.1"> has two special flags: </span><code class="inlineCode"><span class="koboSpan" id="kobo.1256.1">handle_tool_error</span></code><span class="koboSpan" id="kobo.1257.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1258.1">handle_validation_error</span></code><span class="koboSpan" id="kobo.1259.1">. </span><span class="koboSpan" id="kobo.1259.2">Of course, since </span><code class="inlineCode"><span class="koboSpan" id="kobo.1260.1">StructuredTool</span></code><span class="koboSpan" id="kobo.1261.1"> inherits from </span><code class="inlineCode"><span class="koboSpan" id="kobo.1262.1">BaseTool</span></code><span class="koboSpan" id="kobo.1263.1">, you can pass these flags to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1264.1">StructuredTool.from_function </span></code><span class="koboSpan" id="kobo.1265.1">class method. </span><span class="koboSpan" id="kobo.1265.2">If this flag is set, LangChain would construct a string to return as a result of tools’ execution if either a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1266.1">ToolException</span></code><span class="koboSpan" id="kobo.1267.1"> or a Pydantic </span><code class="inlineCode"><span class="koboSpan" id="kobo.1268.1">ValidationException</span></code><span class="koboSpan" id="kobo.1269.1"> (when validating input payload) happens.</span></p>
<div aria-label="207" epub:type="pagebreak" id="page27-3" role="doc-pagebreak"/>
<p class="normal"><span class="koboSpan" id="kobo.1270.1">To </span><a id="_idIndexMarker470"/><span class="koboSpan" id="kobo.1271.1">understand </span><a id="_idIndexMarker471"/><span class="koboSpan" id="kobo.1272.1">what happens, let’s take a look at the LangChain source code for the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1273.1">_handle_tool_error</span></code><span class="koboSpan" id="kobo.1274.1"> function:</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1275.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1276.1">_handle_tool_error</span></span><span class="koboSpan" id="kobo.1277.1">(</span></p>
<p class="snippet-code"><span class="hljs-params"><span class="koboSpan" id="kobo.1278.1">    e: ToolException,</span></span></p>
<p class="snippet-code"><span class="hljs-params"><span class="koboSpan" id="kobo.1279.1">    *,</span></span></p>
<p class="snippet-code"><span class="hljs-params"><span class="koboSpan" id="kobo.1280.1">    flag: </span></span><span class="hljs-type"><span class="koboSpan" id="kobo.1281.1">Optional</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1282.1">[</span></span><span class="hljs-type"><span class="koboSpan" id="kobo.1283.1">Union</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1284.1">[</span></span><span class="hljs-type"><span class="koboSpan" id="kobo.1285.1">Literal</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1286.1">[</span></span><span class="hljs-literal"><span class="koboSpan" id="kobo.1287.1">True</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1288.1">], </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1289.1">str</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1290.1">, </span></span><span class="hljs-type"><span class="koboSpan" id="kobo.1291.1">Callable</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1292.1">[[ToolException], </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1293.1">str</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1294.1">]]],</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1295.1">) -&gt; </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1296.1">str</span></span><span class="koboSpan" id="kobo.1297.1">:</span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1298.1">if</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1299.1">isinstance</span></span><span class="koboSpan" id="kobo.1300.1">(flag, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1301.1">bool</span></span><span class="koboSpan" id="kobo.1302.1">):</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1303.1">        content = e.args[</span><span class="hljs-number"><span class="koboSpan" id="kobo.1304.1">0</span></span><span class="koboSpan" id="kobo.1305.1">] </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1306.1">if</span></span><span class="koboSpan" id="kobo.1307.1"> e.args </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1308.1">else</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1309.1">"Tool execution error"</span></span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1310.1">elif</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1311.1">isinstance</span></span><span class="koboSpan" id="kobo.1312.1">(flag, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1313.1">str</span></span><span class="koboSpan" id="kobo.1314.1">):</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1315.1">        content = flag</span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1316.1">elif</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1317.1">callable</span></span><span class="koboSpan" id="kobo.1318.1">(flag):</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1319.1">        content = flag(e)</span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1320.1">else</span></span><span class="koboSpan" id="kobo.1321.1">:</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1322.1">        msg = (</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1323.1">f"Got an unexpected type of `handle_tool_error`. </span><span class="koboSpan" id="kobo.1323.2">Expected bool, str "</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1324.1">f"or callable. </span><span class="koboSpan" id="kobo.1324.2">Received: </span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.1325.1">{flag}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1326.1">"</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1327.1">        )</span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1328.1">raise</span></span><span class="koboSpan" id="kobo.1329.1"> ValueError(msg)  </span><span class="hljs-comment"><span class="koboSpan" id="kobo.1330.1"># noqa: TRY004</span></span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1331.1">return</span></span><span class="koboSpan" id="kobo.1332.1"> content</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1333.1">As we can see, we can set this flag to a Boolean, string, or callable (that converts a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1334.1">ToolException</span></code><span class="koboSpan" id="kobo.1335.1"> to a string). </span><span class="koboSpan" id="kobo.1335.2">Based on this, LangChain would try to handle </span><code class="inlineCode"><span class="koboSpan" id="kobo.1336.1">ToolException </span></code><span class="koboSpan" id="kobo.1337.1">and pass a string to the next stage instead. </span><span class="koboSpan" id="kobo.1337.2">We can incorporate this feedback into our workflow and add an auto-recover loop.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1338.1">Let’s look at an example. </span><span class="koboSpan" id="kobo.1338.2">We adjust our </span><code class="inlineCode"><span class="koboSpan" id="kobo.1339.1">calculator</span></code><span class="koboSpan" id="kobo.1340.1"> function by removing a substitution </span><code class="inlineCode"><span class="koboSpan" id="kobo.1341.1">i-&gt;j</span></code><span class="koboSpan" id="kobo.1342.1"> (a substitution from an imaginary unit in math to an imaginary unit in Python), and we also make </span><code class="inlineCode"><span class="koboSpan" id="kobo.1343.1">StructuredTool</span></code><span class="koboSpan" id="kobo.1344.1"> auto-inherit descriptions and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1345.1">arg_schema</span></code><span class="koboSpan" id="kobo.1346.1"> from the docstring:</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1347.1">from</span></span><span class="koboSpan" id="kobo.1348.1"> langchain_core.tools </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1349.1">import</span></span><span class="koboSpan" id="kobo.1350.1"> StructuredTool</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1351.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1352.1">calculator</span></span><span class="koboSpan" id="kobo.1353.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1354.1">expression: </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1355.1">str</span></span><span class="koboSpan" id="kobo.1356.1">) -&gt; </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1357.1">str</span></span><span class="koboSpan" id="kobo.1358.1">:</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1359.1">"""Calculates a single mathematical expression, incl. </span><span class="koboSpan" id="kobo.1359.2">complex numbers."""</span></span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1360.1">return</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1361.1">str</span></span><span class="koboSpan" id="kobo.1362.1">(ne.evaluate(expression.strip(), local_dict={}))</span></p>
<div aria-label="208" epub:type="pagebreak" id="page28-3" role="doc-pagebreak"/>
<p class="snippet-code"><span class="koboSpan" id="kobo.1363.1">calculator_tool = StructuredTool.from_function(</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1364.1">   func=calculator,</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1365.1">   handle_tool_error=</span><span class="hljs-literal"><span class="koboSpan" id="kobo.1366.1">True</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1367.1">)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1368.1">agent = create_react_agent(</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1369.1">   llm, [calculator_tool])</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1370.1">for</span></span><span class="koboSpan" id="kobo.1371.1"> event </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1372.1">in</span></span><span class="koboSpan" id="kobo.1373.1"> agent.stream({</span><span class="hljs-string"><span class="koboSpan" id="kobo.1374.1">"messages"</span></span><span class="koboSpan" id="kobo.1375.1">: [(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1376.1">"user"</span></span><span class="koboSpan" id="kobo.1377.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1378.1">"How much is (2+3i)^2"</span></span><span class="koboSpan" id="kobo.1379.1">)]}, stream_mode=</span><span class="hljs-string"><span class="koboSpan" id="kobo.1380.1">"values"</span></span><span class="koboSpan" id="kobo.1381.1">):</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1382.1">   event[</span><span class="hljs-string"><span class="koboSpan" id="kobo.1383.1">"messages"</span></span><span class="koboSpan" id="kobo.1384.1">][-</span><span class="hljs-number"><span class="koboSpan" id="kobo.1385.1">1</span></span><span class="koboSpan" id="kobo.1386.1">].pretty_print()</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.1387.1">&gt;&gt; ============================== Human Message =================================</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.1388.1">How much is (2+3i)^2</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.1389.1">================================== Ai Message ==================================</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.1390.1">Tool Calls:</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.1391.1">  calculator (8bfd3661-d2e1-4b8d-84f4-0be4892d517b)</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.1392.1"> Call ID: 8bfd3661-d2e1-4b8d-84f4-0be4892d517b</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.1393.1">  Args:</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.1394.1">    expression: (2+3i)^2</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.1395.1">================================= Tool Message =================================</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.1396.1">Name: calculator</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.1397.1">Error: SyntaxError('invalid decimal literal', ('&lt;expr&gt;', 1, 4, '(2+3i)^2', 1, 4))</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.1398.1"> Please fix your mistakes.</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.1399.1">================================== Ai Message ==================================</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.1400.1">(2+3i)^2 is equal to -5 + 12i.  </span><span class="koboSpan" id="kobo.1400.2">I tried to use the calculator tool, but it returned an error. </span><span class="koboSpan" id="kobo.1400.3">I will calculate it manually for you.</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.1401.1">(2+3i)^2 = (2+3i)*(2+3i) = 2*2 + 2*3i + 3i*2 + 3i*3i = 4 + 6i + 6i - 9 = -5 + 12i</span></p>
<div aria-label="209" epub:type="pagebreak" id="page29-3" role="doc-pagebreak"/>
<p class="normal"><span class="koboSpan" id="kobo.1402.1">As we can see, now </span><a id="_idIndexMarker472"/><span class="koboSpan" id="kobo.1403.1">our execution of a calculator fails, but since the error </span><a id="_idIndexMarker473"/><span class="koboSpan" id="kobo.1404.1">description is not clear enough, the LLM decides to respond itself without using the tool. </span><span class="koboSpan" id="kobo.1404.2">Depending on your use case, you might want to adjust the behavior; for example, provide more meaningful errors from the tool, force the workflow to try to adjust the payload for the tool, etc.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1405.1">LangGraph also offers a built-in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1406.1">ValidationNode</span></code><span class="koboSpan" id="kobo.1407.1"> that takes the last messages (by inspecting the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1408.1">messages</span></code><span class="koboSpan" id="kobo.1409.1"> key in the graph’s state) and checks whether it has tool calls. </span><span class="koboSpan" id="kobo.1409.2">If that’s the case, LangGraph </span><a id="_idIndexMarker474"/><span class="koboSpan" id="kobo.1410.1">validates the schema of the tool call, and if it doesn’t follow the expected </span><a id="_idIndexMarker475"/><span class="koboSpan" id="kobo.1411.1">schema, it raises a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1412.1">ToolMessage</span></code><span class="koboSpan" id="kobo.1413.1"> with the validation error (and a default command to fix it). </span><span class="koboSpan" id="kobo.1413.2">You can add a conditional edge that cycles back to the LLM and then the LLM would regenerate the tool call, similar to the pattern we discussed in </span><a href="E_Chapter_3.xhtml#_idTextAnchor107"><em class="italic"><span class="koboSpan" id="kobo.1414.1">Chapter 3</span></em></a><span class="koboSpan" id="kobo.1415.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1416.1">Now that we’ve learned what a tool is, how to create one, and how to use built-in LangChain tools, it’s time to take a look at additional instructions that you can pass to an LLM on how to use</span><a id="_idTextAnchor252"/><span class="koboSpan" id="kobo.1417.1"> tools.</span></p>
<h1 class="heading-1" id="_idParaDest-134"><a id="_idTextAnchor253"/><span class="koboSpan" id="kobo.1418.1">Advanced tool-calling capabilities</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1419.1">Many LLMs </span><a id="_idIndexMarker476"/><span class="koboSpan" id="kobo.1420.1">offer you some additional configuration options on tool calling. </span><span class="koboSpan" id="kobo.1420.2">First, some models support parallel function calling—specifically, an LLM can call multiple tools at once. </span><span class="koboSpan" id="kobo.1420.3">LangChain natively supports this since the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1421.1">tool_calls</span></code><span class="koboSpan" id="kobo.1422.1"> field of an </span><code class="inlineCode"><span class="koboSpan" id="kobo.1423.1">AIMessage</span></code><span class="koboSpan" id="kobo.1424.1"> is a list. </span><span class="koboSpan" id="kobo.1424.2">When you return </span><code class="inlineCode"><span class="koboSpan" id="kobo.1425.1">ToolMessage</span></code><span class="koboSpan" id="kobo.1426.1"> objects as function call results, you should carefully match the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1427.1">tool_call_id</span></code><span class="koboSpan" id="kobo.1428.1"> field of a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1429.1">ToolMessage</span></code><span class="koboSpan" id="kobo.1430.1"> to the generated payload. </span><span class="koboSpan" id="kobo.1430.2">This alignment is necessary so that LangChain and the underlying LLM can match them together when doing the next turn.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1431.1">Another advanced capability is forcing an LLM to call a tool, or even to call a specific tool. </span><span class="koboSpan" id="kobo.1431.2">Generally speaking, an LLM decides whether it should call a tool, and if it should, which tool to call from the list of provided tools. </span><span class="koboSpan" id="kobo.1431.3">Typically, it’s handled by </span><code class="inlineCode"><span class="koboSpan" id="kobo.1432.1">tool_choice</span></code><span class="koboSpan" id="kobo.1433.1"> and/or </span><code class="inlineCode"><span class="koboSpan" id="kobo.1434.1">tool_config</span></code><span class="koboSpan" id="kobo.1435.1"> arguments passed to the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1436.1">invoke</span></code><span class="koboSpan" id="kobo.1437.1"> method, but implementation depends on the model’s provider. </span><span class="koboSpan" id="kobo.1437.2">Anthropic, Google, OpenAI, and other major providers have slightly different APIs, and although LangChain tries to unify arguments, in such cases, you should double-check details by the model’s provider.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1438.1">Typically, the following options are available:</span></p>
<ul>
<li class="b lletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1439.1">"auto"</span></code><span class="koboSpan" id="kobo.1440.1">: An LLM can respond or call one or many tools. </span></li>
<li class="b lletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1441.1">"any"</span></code><span class="koboSpan" id="kobo.1442.1">: An LLM is forced to respond by calling one or many tools.</span></li>
<li class="b lletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1443.1">"tool"</span></code><span class="koboSpan" id="kobo.1444.1"> or </span><code class="inlineCode"><span class="koboSpan" id="kobo.1445.1">"any"</span></code><span class="koboSpan" id="kobo.1446.1"> with a provided list of tools: An LLM is forced to respond by calling a tool from the restricted list.</span></li>
<li class="b lletList"><code class="inlineCode"><span class="koboSpan" id="kobo.1447.1">"None"</span></code><span class="koboSpan" id="kobo.1448.1">: An LLM is forced to respond without calling a tool.</span></li>
</ul>
<div aria-label="210" epub:type="pagebreak" id="page30-3" role="doc-pagebreak"/>
<p class="normal"><span class="koboSpan" id="kobo.1449.1">Another important thing to keep in mind is that schemas might become pretty complex—i.e., they might have nullable fields or nested fields, include enums, or reference other schemas. </span><span class="koboSpan" id="kobo.1449.2">Depending on the model’s provider, some definitions might not be supported (and you will see warning or compiling errors). </span><span class="koboSpan" id="kobo.1449.3">Although LangChain aims to make switching across vendors seamless, for some complex workflows, this might not be the case, so pay attention to warnings in the error logs. </span><span class="koboSpan" id="kobo.1449.4">Sometimes, compilations of a provided schema to a schema supported by the model’s provider are done on the best effort basis—for example, a field with a type of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1450.1">Union[str, int]</span></code><span class="koboSpan" id="kobo.1451.1"> is compiled to a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1452.1">str</span></code><span class="koboSpan" id="kobo.1453.1"> type if an underlying LLM doesn’t support </span><code class="inlineCode"><span class="koboSpan" id="kobo.1454.1">Union</span></code><span class="koboSpan" id="kobo.1455.1"> types with tool calling. </span><span class="koboSpan" id="kobo.1455.2">You’ll get a warning, but ignoring such a warning during a migration might change the behavior of your application unpredictably.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1456.1">As a final </span><a id="_idIndexMarker477"/><span class="koboSpan" id="kobo.1457.1">note, it is worth mentioning that some providers (for example, OpenAI or Google) offer custom tools, such as a code interpreter or Google search, that can be invoked by the model itself, and the model will use the tool’s output to prepare a final generation. </span><span class="koboSpan" id="kobo.1457.2">You can think of this as a ReACT agent on the provider’s side, where the model receives an enhanced response based on a tool it calls. </span><span class="koboSpan" id="kobo.1457.3">This approach reduces latency and costs. </span><span class="koboSpan" id="kobo.1457.4">In these cases, you typically supply the LangChain wrapper with a custom tool created using the provider’s SDK rather than one built with LangChain (i.e., a tool that doesn’t inherit from the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1458.1">BaseTool</span></code><span class="koboSpan" id="kobo.1459.1"> class), which means your code won’t be transferable acros</span><a id="_idTextAnchor254"/><span class="koboSpan" id="kobo.1460.1">s models.</span></p>
<h1 class="heading-1" id="_idParaDest-135"><a id="_idTextAnchor255"/><span class="koboSpan" id="kobo.1461.1">Incorporating tools into workflows</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.1462.1">Now that we know how to create and use tools, let’s discuss how we can incorporate the tool-calling paradigm deeper into the workflows we’re de</span><a id="_idTextAnchor256"/><span class="koboSpan" id="kobo.1463.1">veloping.</span></p>
<h2 class="heading-2" id="_idParaDest-136"><a id="_idTextAnchor257"/><span class="koboSpan" id="kobo.1464.1">Controlled generation</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1465.1">In </span><a href="E_Chapter_3.xhtml#_idTextAnchor107"><em class="italic"><span class="koboSpan" id="kobo.1466.1">Chapter 3</span></em></a><span class="koboSpan" id="kobo.1467.1">, we</span><a id="_idIndexMarker478"/><span class="koboSpan" id="kobo.1468.1"> started to discuss a </span><em class="italic"><span class="koboSpan" id="kobo.1469.1">controlled</span></em><span class="koboSpan" id="kobo.1470.1"> generation, when you want an LLM to follow a specific schema. </span><span class="koboSpan" id="kobo.1470.2">We can improve our parsing workflows not only by creating more sophisticated and reliable parsers but also by being more strict in forcing an LLM to adhere to a certain schema. </span><span class="koboSpan" id="kobo.1470.3">Calling a tool requires controlled generation since the generated payload should follow a specific schema, but we can take a step back and substitute our expected schema with a forced tool calling that follows the expected schema. </span><span class="koboSpan" id="kobo.1470.4">LangChain has a built-in mechanism to help with that—an LLM has the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1471.1">with_structured_output</span></code><span class="koboSpan" id="kobo.1472.1"> method that takes a schema as a Pydantic model, converts it to a tool, invokes the LLM with a given prompt by forcing it to call this tool, and parses the output by compiling to a corresponding Pydantic model instance.</span></p>
<div aria-label="211" epub:type="pagebreak" id="page31-3" role="doc-pagebreak"/>
<p class="normal"><span class="koboSpan" id="kobo.1473.1">Later in this chapter, we’ll discuss a plan-and-solve agent, so let’s start preparing a building block. </span><span class="koboSpan" id="kobo.1473.2">Let’s ask our LLM to generate a plan for a given action, but instead of parsing the plan, let’s define it as a Pydantic model (a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1474.1">Plan</span></code><span class="koboSpan" id="kobo.1475.1"> is a list of </span><code class="inlineCode"><span class="koboSpan" id="kobo.1476.1">Steps</span></code><span class="koboSpan" id="kobo.1477.1">):</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1478.1">from</span></span><span class="koboSpan" id="kobo.1479.1"> pydantic </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1480.1">import</span></span><span class="koboSpan" id="kobo.1481.1"> BaseModel, Field</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1482.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1483.1">Step</span></span><span class="koboSpan" id="kobo.1484.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.1485.1">BaseModel</span></span><span class="koboSpan" id="kobo.1486.1">):</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1487.1">"""A step that is a part of the plan to solve the task."""</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1488.1">   step: </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1489.1">str</span></span><span class="koboSpan" id="kobo.1490.1"> = Field(description=</span><span class="hljs-string"><span class="koboSpan" id="kobo.1491.1">"Description of the step"</span></span><span class="koboSpan" id="kobo.1492.1">)</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1493.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1494.1">Plan</span></span><span class="koboSpan" id="kobo.1495.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.1496.1">BaseModel</span></span><span class="koboSpan" id="kobo.1497.1">):</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1498.1">"""A plan to solve the task."""</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1499.1">   steps: </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1500.1">list</span></span><span class="koboSpan" id="kobo.1501.1">[Step]</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1502.1">Keep in mind that we use nested models (one field is referencing another), but LangChain will compile a unified schema for us. </span><span class="koboSpan" id="kobo.1502.2">Let’s put together a simple workflow and run it:</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1503.1">prompt = PromptTemplate.from_template(</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1504.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1505.1">Prepare a step-by-step plan to solve the given task.\n"</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1506.1">"TASK:\n{task}\n"</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1507.1">)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1508.1">result = (prompt | llm.with_structured_output(Plan)).invoke(</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1509.1">"How to write a bestseller on Amazon about generative AI?"</span></span><span class="koboSpan" id="kobo.1510.1">)</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1511.1">If we</span><a id="_idIndexMarker479"/><span class="koboSpan" id="kobo.1512.1"> inspect the output, we’ll see that we got a Pydantic model as a result. </span><span class="koboSpan" id="kobo.1512.2">We don’t need to parse the output anymore; we got a list of specific steps out of the box (and later, we’ll see how we can use it further):</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1513.1">assert</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1514.1">isinstance</span></span><span class="koboSpan" id="kobo.1515.1">(result, Plan)</span></p>
<p class="snippet-code"><span class="hljs-built_in"><span class="koboSpan" id="kobo.1516.1">print</span></span><span class="koboSpan" id="kobo.1517.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1518.1">f"Amount of steps: </span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.1519.1">{</span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1520.1">len</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.1521.1">(result.steps)}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1522.1">"</span></span><span class="koboSpan" id="kobo.1523.1">)</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1524.1">for</span></span><span class="koboSpan" id="kobo.1525.1"> step </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1526.1">in</span></span><span class="koboSpan" id="kobo.1527.1"> result.steps:</span></p>
<p class="snippet-code"> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1528.1">print</span></span><span class="koboSpan" id="kobo.1529.1">(step.step)</span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1530.1">break</span></span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.1531.1">&gt;&gt; Amount of steps: 21</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.1532.1">**1. </span><span class="koboSpan" id="kobo.1532.2">Idea Generation and Va</span><a id="_idTextAnchor258"/><span class="koboSpan" id="kobo.1533.1">lidation:**</span></p>
<div aria-label="212" epub:type="pagebreak" id="page32-3" role="doc-pagebreak"/>
<h3 class="heading-3" id="_idParaDest-137"><a id="_idTextAnchor259"/><span class="koboSpan" id="kobo.1534.1">Controlled generation provided by the vendor</span></h3>
<p class="normal"><span class="koboSpan" id="kobo.1535.1">Another </span><a id="_idIndexMarker480"/><span class="koboSpan" id="kobo.1536.1">way is vendor-dependent. </span><span class="koboSpan" id="kobo.1536.2">Some foundational model providers offer additional API parameters that can instruct a model to generate a structured output (typically, a JSON or enum). </span><span class="koboSpan" id="kobo.1536.3">You can force the model to use JSON generation the same way as above using </span><code class="inlineCode"><span class="koboSpan" id="kobo.1537.1">with_structured_output</span></code><span class="koboSpan" id="kobo.1538.1">, but provide another argument, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1539.1">method="json_mode"</span></code><span class="koboSpan" id="kobo.1540.1"> (and double-check that the underlying model provider supports controlled generation as JSON):</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1541.1">plan_schema = {</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1542.1">"type"</span></span><span class="koboSpan" id="kobo.1543.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.1544.1">"ARRAY"</span></span><span class="koboSpan" id="kobo.1545.1">,</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1546.1">"items"</span></span><span class="koboSpan" id="kobo.1547.1">: {</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1548.1">"type"</span></span><span class="koboSpan" id="kobo.1549.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.1550.1">"OBJECT"</span></span><span class="koboSpan" id="kobo.1551.1">,</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1552.1">"properties"</span></span><span class="koboSpan" id="kobo.1553.1">: {</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1554.1">"step"</span></span><span class="koboSpan" id="kobo.1555.1">: {</span><span class="hljs-string"><span class="koboSpan" id="kobo.1556.1">"type"</span></span><span class="koboSpan" id="kobo.1557.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.1558.1">"STRING"</span></span><span class="koboSpan" id="kobo.1559.1">},</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1560.1">         },</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1561.1">     },</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1562.1">}</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1563.1">query = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1564.1">"How to write a bestseller on Amazon about generative AI?"</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1565.1">result = (prompt | llm.with_structured_output(schema=plan_schema, method=</span><span class="hljs-string"><span class="koboSpan" id="kobo.1566.1">"json_mode"</span></span><span class="koboSpan" id="kobo.1567.1">)).invoke(query)</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1568.1">Note</span><a id="_idIndexMarker481"/><span class="koboSpan" id="kobo.1569.1"> that the JSON schema doesn’t contain descriptions of the fields, hence typically, your prompts should be more detailed and informative. </span><span class="koboSpan" id="kobo.1569.2">But as an output, we get a full-qualified Python dictionary:</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1570.1">assert</span></span><span class="koboSpan" id="kobo.1571.1">(</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1572.1">isinstance</span></span><span class="koboSpan" id="kobo.1573.1">(result, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1574.1">list</span></span><span class="koboSpan" id="kobo.1575.1">))</span></p>
<p class="snippet-code"><span class="hljs-built_in"><span class="koboSpan" id="kobo.1576.1">print</span></span><span class="koboSpan" id="kobo.1577.1">(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1578.1">f"Amount of steps: </span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.1579.1">{</span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1580.1">len</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.1581.1">(result)}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1582.1">"</span></span><span class="koboSpan" id="kobo.1583.1">)</span></p>
<p class="snippet-code"><span class="hljs-built_in"><span class="koboSpan" id="kobo.1584.1">print</span></span><span class="koboSpan" id="kobo.1585.1">(result[</span><span class="hljs-number"><span class="koboSpan" id="kobo.1586.1">0</span></span><span class="koboSpan" id="kobo.1587.1">])</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.1588.1">&gt;&gt; Amount of steps: 10</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.1589.1">{'step': 'Step 1: Define your niche and target audience. </span><span class="koboSpan" id="kobo.1589.2">Generative AI is a broad topic. </span><span class="koboSpan" id="kobo.1589.3">Focus on a specific area, like generative AI in marketing, art, music, or writing. </span><span class="koboSpan" id="kobo.1589.4">Identify your ideal reader (such as  marketers, artists, developers).'}</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1590.1">You can instruct the LLM instance directly to follow controlled generation instructions. </span><span class="koboSpan" id="kobo.1590.2">Note that specific arguments and functionality might vary from one model provider to another (for example, OpenAI models use a </span><code class="inlineCode"><span class="koboSpan" id="kobo.1591.1">response_format</span></code><span class="koboSpan" id="kobo.1592.1"> argument). </span><span class="koboSpan" id="kobo.1592.2">Let’s look at how to instruct Gemini to return JSON:</span></p>
<div aria-label="213" epub:type="pagebreak" id="page33-3" role="doc-pagebreak"/>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1593.1">from</span></span><span class="koboSpan" id="kobo.1594.1"> langchain_core.output_parsers </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1595.1">import</span></span><span class="koboSpan" id="kobo.1596.1"> JsonOutputParser</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1597.1">llm_json = ChatVertexAI(</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1598.1">  model_name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.1599.1">"gemini-1.5-pro-002"</span></span><span class="koboSpan" id="kobo.1600.1">, response_mime_type=</span><span class="hljs-string"><span class="koboSpan" id="kobo.1601.1">"application/json"</span></span><span class="koboSpan" id="kobo.1602.1">,</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1603.1">  response_schema=plan_schema)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1604.1">result = (prompt | llm_json | JsonOutputParser()).invoke(query)</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1605.1">assert</span></span><span class="koboSpan" id="kobo.1606.1">(</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1607.1">isinstance</span></span><span class="koboSpan" id="kobo.1608.1">(result, </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1609.1">list</span></span><span class="koboSpan" id="kobo.1610.1">))</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1611.1">We can also ask Gemini to return an enum—in other words, only one value from a set of values:</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1612.1">from</span></span><span class="koboSpan" id="kobo.1613.1"> langchain_core.output_parsers </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1614.1">import</span></span><span class="koboSpan" id="kobo.1615.1"> StrOutputParser</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1616.1">response_schema = {</span><span class="hljs-string"><span class="koboSpan" id="kobo.1617.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1618.1">type"</span></span><span class="koboSpan" id="kobo.1619.1">: </span><span class="hljs-string"><span class="koboSpan" id="kobo.1620.1">"STRING"</span></span><span class="koboSpan" id="kobo.1621.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1622.1">"enum"</span></span><span class="koboSpan" id="kobo.1623.1">: [</span><span class="hljs-string"><span class="koboSpan" id="kobo.1624.1">"positive"</span></span><span class="koboSpan" id="kobo.1625.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1626.1">"negative"</span></span><span class="koboSpan" id="kobo.1627.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1628.1">"neutral"</span></span><span class="koboSpan" id="kobo.1629.1">]}</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1630.1">prompt = PromptTemplate.from_template(</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1631.1">"Classify the tone of the following customer's review:"</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1632.1">"\n{review}\n"</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1633.1">)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1634.1">review = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1635.1">"I like this movie!"</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1636.1">llm_enum = ChatVertexAI(model_name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.1637.1">"</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1638.1">gemini-1.5-pro-002"</span></span><span class="koboSpan" id="kobo.1639.1">, response_mime_type=</span><span class="hljs-string"><span class="koboSpan" id="kobo.1640.1">"text/x.enum"</span></span><span class="koboSpan" id="kobo.1641.1">, response_schema=response_schema)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1642.1">result = (prompt | llm_enum | StrOutputParser()).invoke(review)</span></p>
<p class="snippet-code"><span class="hljs-built_in"><span class="koboSpan" id="kobo.1643.1">print</span></span><span class="koboSpan" id="kobo.1644.1">(result)</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.1645.1">&gt;&gt; positive</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1646.1">LangChain abstracts</span><a id="_idIndexMarker482"/><span class="koboSpan" id="kobo.1647.1"> the details of the model provider’s implementation with the </span><code class="inlineCode"><span class="koboSpan" id="kobo.1648.1">method="json_mode"</span></code><span class="koboSpan" id="kobo.1649.1"> parameter or by allowing custom </span><code class="inlineCode"><span class="koboSpan" id="kobo.1650.1">kwargs</span></code><span class="koboSpan" id="kobo.1651.1"> to be passed to the model. </span><span class="koboSpan" id="kobo.1651.2">Some of the controlled generation capabilities are model-specific. </span><span class="koboSpan" id="kobo.1651.3">Check your model’s documentation for supported schema types, constraints, </span><a id="_idTextAnchor260"/><span class="koboSpan" id="kobo.1652.1">and arguments.</span></p>
<h2 class="heading-2" id="_idParaDest-138"><a id="_idTextAnchor261"/><span class="koboSpan" id="kobo.1653.1">ToolNode</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1654.1">To simplify </span><a id="_idIndexMarker483"/><span class="koboSpan" id="kobo.1655.1">agent development, LangGraph has built-in capabilities such as </span><code class="inlineCode"><span class="koboSpan" id="kobo.1656.1">ToolNode</span></code><span class="koboSpan" id="kobo.1657.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1658.1">tool_conditions</span></code><span class="koboSpan" id="kobo.1659.1">. </span><span class="koboSpan" id="kobo.1659.2">The </span><code class="inlineCode"><span class="koboSpan" id="kobo.1660.1">ToolNode</span></code><span class="koboSpan" id="kobo.1661.1"> checks the last message in </span><code class="inlineCode"><span class="koboSpan" id="kobo.1662.1">messages</span></code><span class="koboSpan" id="kobo.1663.1"> (you can redefine the key name). </span><span class="koboSpan" id="kobo.1663.2">If this message contains tool calls, it invokes the corresponding tools and updates the state. </span><span class="koboSpan" id="kobo.1663.3">On the other hand, </span><code class="inlineCode"><span class="koboSpan" id="kobo.1664.1">tool_conditions</span></code><span class="koboSpan" id="kobo.1665.1"> is a conditional edge that checks whether </span><code class="inlineCode"><span class="koboSpan" id="kobo.1666.1">ToolNode</span></code><span class="koboSpan" id="kobo.1667.1"> should be called (or finishes otherwise). </span></p>
<div aria-label="214" epub:type="pagebreak" id="page34-3" role="doc-pagebreak"/>
<p class="normal"><span class="koboSpan" id="kobo.1668.1">Now we can build our ReACT engine in minutes:</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1669.1">from</span></span><span class="koboSpan" id="kobo.1670.1"> langgraph.prebuilt </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1671.1">import</span></span><span class="koboSpan" id="kobo.1672.1"> ToolNode, tools_condition</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1673.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1674.1">invoke_llm</span></span><span class="koboSpan" id="kobo.1675.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1676.1">state: MessagesState</span></span><span class="koboSpan" id="kobo.1677.1">):</span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1678.1">return</span></span><span class="koboSpan" id="kobo.1679.1"> {</span><span class="hljs-string"><span class="koboSpan" id="kobo.1680.1">"messages"</span></span><span class="koboSpan" id="kobo.1681.1">: [llm_with_tools.invoke(state[</span><span class="hljs-string"><span class="koboSpan" id="kobo.1682.1">"messages"</span></span><span class="koboSpan" id="kobo.1683.1">])]}</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1684.1">builder = StateGraph(MessagesState)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1685.1">builder.add_node(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1686.1">"invoke_llm"</span></span><span class="koboSpan" id="kobo.1687.1">, invoke_llm)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1688.1">builder.add_node(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1689.1">"tools"</span></span><span class="koboSpan" id="kobo.1690.1">, ToolNode([search, calculator]))</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1691.1">builder.add_edge(START, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1692.1">"invoke_llm"</span></span><span class="koboSpan" id="kobo.1693.1">)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1694.1">builder.add_conditional_edges(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1695.1">"invoke_llm"</span></span><span class="koboSpan" id="kobo.1696.1">, tools_condition)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1697.1">builder.add_edge(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1698.1">"tools"</span></span><span class="koboSpan" id="kobo.1699.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1700.1">"invoke_llm"</span></span><span class="koboSpan" id="kobo.1701.1">)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1702.1">graph = bu</span><a id="_idTextAnchor262"/><span class="koboSpan" id="kobo.1703.1">ilder.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1704.1">compile</span></span><span class="koboSpan" id="kobo.1705.1">()</span></p>
<h2 class="heading-2" id="_idParaDest-139"><a id="_idTextAnchor263"/><span class="koboSpan" id="kobo.1706.1">Tool-calling paradigm</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1707.1">Tool calling is</span><a id="_idIndexMarker484"/><span class="koboSpan" id="kobo.1708.1"> a very powerful design paradigm that requires a change in how you develop your applications. </span><span class="koboSpan" id="kobo.1708.2">In many cases, instead of performing rounds of prompt engineering and many attempts to improve your prompts, think whether you could ask the model to call a tool instead.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1709.1">Let’s assume we’re working on an agent that deals with contract cancellations and it should follow certain business logic. </span><span class="koboSpan" id="kobo.1709.2">First, we need to understand the contract starting date (and dealing with dates might be difficult!). </span><span class="koboSpan" id="kobo.1709.3">If you try to come up with a prompt that can correctly handle cases like this, you’ll realize it might be quite difficult:</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1710.1">examples = [</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1711.1">"I signed my contract 2 years ago"</span></span><span class="koboSpan" id="kobo.1712.1">,</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1713.1">"I started the deal with your company in February last year"</span></span><span class="koboSpan" id="kobo.1714.1">,</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1715.1">"Our contract started on March 24th two years ago"</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1716.1">]</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1717.1">Instead, force a model to call a tool (and maybe even through a ReACT agent!). </span><span class="koboSpan" id="kobo.1717.2">For example, we have two very native tools in Python—</span><code class="inlineCode"><span class="koboSpan" id="kobo.1718.1">date</span></code><span class="koboSpan" id="kobo.1719.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1720.1">timedelta</span></code><span class="koboSpan" id="kobo.1721.1">:</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1722.1">from</span></span><span class="koboSpan" id="kobo.1723.1"> datetime </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1724.1">import</span></span><span class="koboSpan" id="kobo.1725.1"> date, timedelta</span></p>
<p class="snippet-code"><span class="hljs-meta"><span class="koboSpan" id="kobo.1726.1">@tool</span></span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1727.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1728.1">get_date</span></span><span class="koboSpan" id="kobo.1729.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1730.1">year: </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1731.1">int</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1732.1">, month: </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1733.1">int</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1734.1"> = </span></span><span class="hljs-number"><span class="koboSpan" id="kobo.1735.1">1</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1736.1">, day: </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1737.1">int</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1738.1"> = </span></span><span class="hljs-number"><span class="koboSpan" id="kobo.1739.1">1</span></span><span class="koboSpan" id="kobo.1740.1">) -&gt; date:</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1741.1">"""Returns a date object given year, month and day.</span></span></p>
<div aria-label="215" epub:type="pagebreak" id="page35-3" role="doc-pagebreak"/>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.1742.1">     Default month and day are 1 (January) and 1.</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.1743.1">     Examples in YYYY-MM-DD format:</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.1744.1">       2023-07-27 -&gt; date(2023, 7, 27)</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.1745.1">       2022-12-15 -&gt; date(2022, 12, 15)</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.1746.1">       March 2022 -&gt; date(2022, 3)</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.1747.1">       2021 -&gt; date(2021)</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.1748.1">   """</span></span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1749.1">return</span></span><span class="koboSpan" id="kobo.1750.1"> date(year, month, day).isoformat()</span></p>
<p class="snippet-code"><span class="hljs-meta"><span class="koboSpan" id="kobo.1751.1">@tool</span></span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1752.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1753.1">time_difference</span></span><span class="koboSpan" id="kobo.1754.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1755.1">days: </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1756.1">int</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1757.1"> = </span></span><span class="hljs-number"><span class="koboSpan" id="kobo.1758.1">0</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1759.1">, weeks: </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1760.1">int</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1761.1"> = </span></span><span class="hljs-number"><span class="koboSpan" id="kobo.1762.1">0</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1763.1">, months: </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1764.1">int</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1765.1"> = </span></span><span class="hljs-number"><span class="koboSpan" id="kobo.1766.1">0</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1767.1">, years: </span></span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1768.1">int</span></span><span class="hljs-params"><span class="koboSpan" id="kobo.1769.1"> = </span></span><span class="hljs-number"><span class="koboSpan" id="kobo.1770.1">0</span></span><span class="koboSpan" id="kobo.1771.1">) -&gt; date:</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1772.1">"""Returns a date given a difference in days, weeks, months and years relative to the current date.</span></span></p>
<p class="snippet-code"><span class="hljs-string"> </span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.1773.1">   By default, days, weeks, months and years are 0.</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.1774.1">   Examples:</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.1775.1">     two weeks ago -&gt; time_difference(weeks=2)</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.1776.1">     last year -&gt; time_difference(years=1)</span></span></p>
<p class="snippet-code"><span class="hljs-string"><span class="koboSpan" id="kobo.1777.1">   """</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1778.1">   dt = date.today() - timedelta(days=days, weeks=weeks)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1779.1">   new_year = dt.year+(dt.month-months) // </span><span class="hljs-number"><span class="koboSpan" id="kobo.1780.1">12</span></span><span class="koboSpan" id="kobo.1781.1"> - years</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1782.1">   new_month = (dt.month-months) % </span><span class="hljs-number"><span class="koboSpan" id="kobo.1783.1">12</span></span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1784.1">return</span></span><span class="koboSpan" id="kobo.1785.1"> dt.replace(year=new_year, month=new_month)</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1786.1">Now it works </span><a id="_idIndexMarker485"/><span class="koboSpan" id="kobo.1787.1">like a charm:</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1788.1">from</span></span><span class="koboSpan" id="kobo.1789.1"> langchain_google_vertexai </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1790.1">import</span></span><span class="koboSpan" id="kobo.1791.1"> ChatVertexAI</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1792.1">llm = ChatVertexAI(model=</span><span class="hljs-string"><span class="koboSpan" id="kobo.1793.1">"gemini-1.5-pro-002"</span></span><span class="koboSpan" id="kobo.1794.1">)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1795.1">agent = create_react_agent(</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1796.1">   llm, [get_date, time_difference], prompt=</span><span class="hljs-string"><span class="koboSpan" id="kobo.1797.1">"Extract the starting date of a contract. </span><span class="koboSpan" id="kobo.1797.2">Current year is 2025."</span></span><span class="koboSpan" id="kobo.1798.1">)</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1799.1">for</span></span><span class="koboSpan" id="kobo.1800.1"> example </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1801.1">in</span></span><span class="koboSpan" id="kobo.1802.1"> examples:</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1803.1"> result = agent.invoke({</span><span class="hljs-string"><span class="koboSpan" id="kobo.1804.1">"messages"</span></span><span class="koboSpan" id="kobo.1805.1">: [(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1806.1">"user"</span></span><span class="koboSpan" id="kobo.1807.1">, example)]})</span></p>
<p class="snippet-code"> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1808.1">print</span></span><span class="koboSpan" id="kobo.1809.1">(example, result[</span><span class="hljs-string"><span class="koboSpan" id="kobo.1810.1">"messages"</span></span><span class="koboSpan" id="kobo.1811.1">][-</span><span class="hljs-number"><span class="koboSpan" id="kobo.1812.1">1</span></span><span class="koboSpan" id="kobo.1813.1">].content)</span></p>
<div aria-label="216" epub:type="pagebreak" id="page36-3" role="doc-pagebreak"/>
<p class="snippet-con"><span class="koboSpan" id="kobo.1814.1">&gt;&gt; I signed my contract 2 years ago The contract started on 2023-02-07.</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.1815.1">I started the deal with your company in February last year The contract started on 2024-02-01.</span></p>
<p class="snippet-con"><span class="koboSpan" id="kobo.1816.1">Our contract started on March 24th two years ago The contract started on 2023-03-24</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1817.1">We learned how to use tools, or function calls, to enhance LLMs’ performance on complex tasks. </span><span class="koboSpan" id="kobo.1817.2">This is one of the fundamental architectural patterns behind agents—now it’s time to discuss </span><a id="_idTextAnchor264"/><span class="koboSpan" id="kobo.1818.1">what an agent is.</span></p>
<h1 class="heading-1" id="_idParaDest-140"><a id="_idTextAnchor265"/><span class="koboSpan" id="kobo.1819.1">What are agents?</span></h1>
<p class="normal"><a id="_idIndexMarker486"/><span class="koboSpan" id="kobo.1820.1">Agents are one of the hottest topics of generative AI these days. </span><span class="koboSpan" id="kobo.1820.2">People talk about agents a lot, but there are many different definitions of what an agent is. </span><span class="koboSpan" id="kobo.1820.3">LangChain itself defines an agent as “</span><em class="italic"><span class="koboSpan" id="kobo.1821.1">a system that uses an LLM to decide the control flow of an application</span></em><span class="koboSpan" id="kobo.1822.1">.” </span><span class="koboSpan" id="kobo.1822.2">While we feel it’s a great definition that is worth citing, it missed some aspects.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1823.1">As Python </span><a id="_idIndexMarker487"/><span class="koboSpan" id="kobo.1824.1">developers, you might be familiar with duck typing to determine an object’s behavior by the so-called duck test: “</span><em class="italic"><span class="koboSpan" id="kobo.1825.1">If it walks like a duck and it quacks like a duck, then it must be a duck</span></em><span class="koboSpan" id="kobo.1826.1">.” </span><span class="koboSpan" id="kobo.1826.2">With that concept in mind, let’s describe some properties of an agent in the context of generative AI:</span></p>
<ul>
<li class="b lletList"><span class="koboSpan" id="kobo.1827.1">Agents help a user solve complex non-deterministic tasks without being given an explicit algorithm on how to do it. </span><span class="koboSpan" id="kobo.1827.2">Advanced agents can even act on behalf of a user.</span></li>
<li class="b lletList"><span class="koboSpan" id="kobo.1828.1">To solve a task, agents typically perform multiple steps and iterations. </span><span class="koboSpan" id="kobo.1828.2">They </span><em class="italic"><span class="koboSpan" id="kobo.1829.1">reason</span></em><span class="koboSpan" id="kobo.1830.1"> (generate new information based on available context), </span><em class="italic"><span class="koboSpan" id="kobo.1831.1">act</span></em><span class="koboSpan" id="kobo.1832.1"> (interact with the external environment), </span><em class="italic"><span class="koboSpan" id="kobo.1833.1">observe</span></em><span class="koboSpan" id="kobo.1834.1"> (incorporate feedback from the external environment), and </span><em class="italic"><span class="koboSpan" id="kobo.1835.1">communicate</span></em><span class="koboSpan" id="kobo.1836.1"> (interact and/or work collaboratively with other agents or humans).</span></li>
<li class="b lletList"><span class="koboSpan" id="kobo.1837.1">Agents utilize LLMs for reasoning (and solving tasks).</span></li>
<li class="b lletList"><span class="koboSpan" id="kobo.1838.1">While agents have certain autonomy (and to a certain extent, they even figure out what is the best way to solve the task by thinking and learning from interacting with the environment), when running an agent, we’d still like to keep a certain degree of control of the execution flow.</span></li>
</ul>
<p class="normal"><span class="koboSpan" id="kobo.1839.1">Retaining control over an agent’s behavior—an agentic workflow—is a core concept behind LangGraph. </span><span class="koboSpan" id="kobo.1839.2">While LangGraph provides developers with a rich set of building blocks (such as memory management, tool invocation, and cyclic graphs with recursion depth control), its primary design pattern focuses on managing the flow and level of autonomy that LLMs exercise in executing tasks. </span><span class="koboSpan" id="kobo.1839.3">Let’s start with an example and</span><a id="_idTextAnchor266"/><span class="koboSpan" id="kobo.1840.1"> develop our agent.</span></p>
<div aria-label="217" epub:type="pagebreak" id="page37-3" role="doc-pagebreak"/>
<h2 class="heading-2" id="_idParaDest-141"><a id="_idTextAnchor267"/><span class="koboSpan" id="kobo.1841.1">Plan-and-solve agent</span></h2>
<p class="normal"><span class="koboSpan" id="kobo.1842.1">What do we</span><a id="_idIndexMarker488"/><span class="koboSpan" id="kobo.1843.1"> as humans typically do when we have a complex task ahead of us? </span><span class="koboSpan" id="kobo.1843.2">We plan! </span><span class="koboSpan" id="kobo.1843.3">In 2023, Lei Want et al. </span><span class="koboSpan" id="kobo.1843.4">demonstrated that plan-and-solve prompting </span><a id="_idIndexMarker489"/><span class="koboSpan" id="kobo.1844.1">improves LLM reasoning. </span><span class="koboSpan" id="kobo.1844.2">It has been also demonstrated by multiple studies that LLMs’ performance tends to deteriorate as the complexity (in particular, the length and the number of instructions) of the prompt increases. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.1845.1">Hence, the first design pattern to keep in mind is </span><em class="italic"><span class="koboSpan" id="kobo.1846.1">task decomposition</span></em><span class="koboSpan" id="kobo.1847.1">—to decompose complex tasks into a sequence of smaller ones, keep your prompts simple and focused on a single task, and don’t hesitate to add examples to your prompts. </span><span class="koboSpan" id="kobo.1847.2">In our case, we are going to develop a research assistant. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.1848.1">Faced with a complex task, let’s first ask the LLM to come up with a detailed plan to solve this task, and then use the same LLM to execute on every step. </span><span class="koboSpan" id="kobo.1848.2">Remember, at the end of the day, LLMs autoregressively generate output tokens based on input tokens. </span><span class="koboSpan" id="kobo.1848.3">Such simple patterns as ReACT or plan-and-solve help us to better use their implicit reasoning capabilities. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.1849.1">First, we need </span><a id="_idIndexMarker490"/><span class="koboSpan" id="kobo.1850.1">to define our planner. </span><span class="koboSpan" id="kobo.1850.2">There’s nothing new here; we’re using building blocks </span><a id="_idIndexMarker491"/><span class="koboSpan" id="kobo.1851.1">that we have already discussed—chat prompt templates and controlled generation with a Pydantic model:</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1852.1">from</span></span><span class="koboSpan" id="kobo.1853.1"> pydantic </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1854.1">import</span></span><span class="koboSpan" id="kobo.1855.1"> BaseModel, Field</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1856.1">from</span></span><span class="koboSpan" id="kobo.1857.1"> langchain_core.prompts </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1858.1">import</span></span><span class="koboSpan" id="kobo.1859.1"> ChatPromptTemplate</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1860.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1861.1">Plan</span></span><span class="koboSpan" id="kobo.1862.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.1863.1">BaseModel</span></span><span class="koboSpan" id="kobo.1864.1">):</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1865.1">"""Plan to follow in future"""</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1866.1">   steps: </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1867.1">list</span></span><span class="koboSpan" id="kobo.1868.1">[</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1869.1">str</span></span><span class="koboSpan" id="kobo.1870.1">] = Field(</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1871.1">       description=</span><span class="hljs-string"><span class="koboSpan" id="kobo.1872.1">"different steps to follow, should be in sorted order"</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1873.1">   )</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1874.1">system_prompt_template = (</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1875.1">"For the given task, come up with a step by step plan.\n"</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1876.1">"This plan should involve individual tasks, that if executed correctly will "</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1877.1">"yield the correct answer. </span><span class="koboSpan" id="kobo.1877.2">Do not add any superfluous steps.\n"</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1878.1">"The result of the final step should be the final answer. </span><span class="koboSpan" id="kobo.1878.2">Make sure that each "</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1879.1">"step has all the information needed - do not skip steps."</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1880.1">)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1881.1">planner_prompt = ChatPromptTemplate.from_messages(</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1882.1">   [(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1883.1">"system"</span></span><span class="koboSpan" id="kobo.1884.1">, system_prompt_template),</span></p>
<div aria-label="218" epub:type="pagebreak" id="page38-3" role="doc-pagebreak"/>
<p class="snippet-code"><span class="koboSpan" id="kobo.1885.1">    (</span><span class="hljs-string"><span class="koboSpan" id="kobo.1886.1">"user"</span></span><span class="koboSpan" id="kobo.1887.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1888.1">"Prepare a plan how to solve the following task:\n{task}\n"</span></span><span class="koboSpan" id="kobo.1889.1">)])</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1890.1">planner = planner_prompt | ChatVertexAI(</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1891.1">   model_name=</span><span class="hljs-string"><span class="koboSpan" id="kobo.1892.1">"gemini-1.5-pro-002"</span></span><span class="koboSpan" id="kobo.1893.1">, temperature=</span><span class="hljs-number"><span class="koboSpan" id="kobo.1894.1">1.0</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1895.1">).with_structured_output(Plan)</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1896.1">For a step execution, let’s use a ReACT agent with built-in tools—DuckDuckGo search, retrievers from arXiv and Wikipedia, and our custom </span><code class="inlineCode"><span class="koboSpan" id="kobo.1897.1">calculator</span></code><span class="koboSpan" id="kobo.1898.1"> tool we developed earlier in this chapter:</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1899.1">from</span></span><span class="koboSpan" id="kobo.1900.1"> langchain.agents </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1901.1">import</span></span><span class="koboSpan" id="kobo.1902.1"> load_tools</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1903.1">tools = load_tools(</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1904.1"> tool_names=[</span><span class="hljs-string"><span class="koboSpan" id="kobo.1905.1">"ddg-search"</span></span><span class="koboSpan" id="kobo.1906.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1907.1">"arxiv"</span></span><span class="koboSpan" id="kobo.1908.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.1909.1">"wikipedia"</span></span><span class="koboSpan" id="kobo.1910.1">],</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1911.1"> llm=llm</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1912.1">) + [calculator_tool]</span></p>
<p class="normal"><span class="koboSpan" id="kobo.1913.1">Next, let’s </span><a id="_idIndexMarker492"/><span class="koboSpan" id="kobo.1914.1">define our workflow state. </span><span class="koboSpan" id="kobo.1914.2">We need to keep track of the initial </span><a id="_idIndexMarker493"/><span class="koboSpan" id="kobo.1915.1">task and initially generated plan, and let’s add </span><code class="inlineCode"><span class="koboSpan" id="kobo.1916.1">past_steps</span></code><span class="koboSpan" id="kobo.1917.1"> and </span><code class="inlineCode"><span class="koboSpan" id="kobo.1918.1">final_response</span></code><span class="koboSpan" id="kobo.1919.1"> to the state:</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1920.1">class</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1921.1">PlanState</span></span><span class="koboSpan" id="kobo.1922.1">(</span><span class="hljs-title"><span class="koboSpan" id="kobo.1923.1">TypedDict</span></span><span class="koboSpan" id="kobo.1924.1">):</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1925.1">   task: </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1926.1">str</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1927.1">   plan: Plan</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1928.1">   past_steps: Annotated[</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1929.1">list</span></span><span class="koboSpan" id="kobo.1930.1">[</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1931.1">str</span></span><span class="koboSpan" id="kobo.1932.1">], operator.add]</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1933.1">   final_response: </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1934.1">str</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1935.1">   past_steps: </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1936.1">list</span></span><span class="koboSpan" id="kobo.1937.1">[</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1938.1">str</span></span><span class="koboSpan" id="kobo.1939.1">]</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1940.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1941.1">get_current_step</span></span><span class="koboSpan" id="kobo.1942.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1943.1">state: PlanState</span></span><span class="koboSpan" id="kobo.1944.1">) -&gt; </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1945.1">int</span></span><span class="koboSpan" id="kobo.1946.1">:</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1947.1">"""Returns the number of current step to be executed."""</span></span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1948.1">return</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1949.1">len</span></span><span class="koboSpan" id="kobo.1950.1">(state.get(</span><span class="hljs-string"><span class="koboSpan" id="kobo.1951.1">"past_steps"</span></span><span class="koboSpan" id="kobo.1952.1">, []))</span></p>
<p class="snippet-code"> </p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1953.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.1954.1">get_full_plan</span></span><span class="koboSpan" id="kobo.1955.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.1956.1">state: PlanState</span></span><span class="koboSpan" id="kobo.1957.1">) -&gt; </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.1958.1">str</span></span><span class="koboSpan" id="kobo.1959.1">:</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1960.1">"""Returns formatted plan with step numbers and past results."""</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1961.1"> full_plan = []</span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1962.1">for</span></span><span class="koboSpan" id="kobo.1963.1"> i, step </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1964.1">in</span></span> <span class="hljs-built_in"><span class="koboSpan" id="kobo.1965.1">enumerate</span></span><span class="koboSpan" id="kobo.1966.1">(state[</span><span class="hljs-string"><span class="koboSpan" id="kobo.1967.1">"plan"</span></span><span class="koboSpan" id="kobo.1968.1">]):</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1969.1">   full_step = </span><span class="hljs-string"><span class="koboSpan" id="kobo.1970.1">f"# </span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.1971.1">{i+</span></span><span class="hljs-number"><span class="koboSpan" id="kobo.1972.1">1</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.1973.1">}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1974.1">. </span><span class="koboSpan" id="kobo.1974.2">Planned step: </span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.1975.1">{step}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1976.1">\n"</span></span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1977.1">if</span></span><span class="koboSpan" id="kobo.1978.1"> i &lt; get_current_step(state):</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1979.1">     full_step += </span><span class="hljs-string"><span class="koboSpan" id="kobo.1980.1">f"Result: </span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.1981.1">{state[</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1982.1">'past_steps'</span></span><span class="hljs-subst"><span class="koboSpan" id="kobo.1983.1">][i]}</span></span><span class="hljs-string"><span class="koboSpan" id="kobo.1984.1">\n"</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1985.1">   full_plan.append(full_step)</span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.1986.1">return</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.1987.1">"\n"</span></span><span class="koboSpan" id="kobo.1988.1">.join(full_plan)</span></p>
<div aria-label="219" epub:type="pagebreak" id="page39-3" role="doc-pagebreak"/>
<p class="normal"><span class="koboSpan" id="kobo.1989.1">Now, it’s time to define our nodes and edges:</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1990.1">from</span></span><span class="koboSpan" id="kobo.1991.1"> typing </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1992.1">import</span></span> <span class="hljs-type"><span class="koboSpan" id="kobo.1993.1">Literal</span></span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.1994.1">from</span></span><span class="koboSpan" id="kobo.1995.1"> langgraph.graph </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.1996.1">import</span></span><span class="koboSpan" id="kobo.1997.1"> StateGraph, START, END</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.1998.1">final_prompt = PromptTemplate.from_template(</span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.1999.1">"You're a helpful assistant that has executed on a plan."</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.2000.1">"Given the results of the execution, prepare the final response.\n"</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.2001.1">"Don't assume anything\nTASK:\n{task}\n\nPLAN WITH RESUlTS:\n{plan}\n"</span></span></p>
<p class="snippet-code"> <span class="hljs-string"><span class="koboSpan" id="kobo.2002.1">"FINAL RESPONSE:\n"</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.2003.1">)</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2004.1">async</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2005.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2006.1">_build_initial_plan</span></span><span class="koboSpan" id="kobo.2007.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2008.1">state: PlanState</span></span><span class="koboSpan" id="kobo.2009.1">) -&gt; PlanState:</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.2010.1"> plan = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2011.1">await</span></span><span class="koboSpan" id="kobo.2012.1"> planner.ainvoke(state[</span><span class="hljs-string"><span class="koboSpan" id="kobo.2013.1">"task"</span></span><span class="koboSpan" id="kobo.2014.1">])</span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2015.1">return</span></span><span class="koboSpan" id="kobo.2016.1"> {</span><span class="hljs-string"><span class="koboSpan" id="kobo.2017.1">"plan"</span></span><span class="koboSpan" id="kobo.2018.1">: plan}</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2019.1">async</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2020.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2021.1">_run_step</span></span><span class="koboSpan" id="kobo.2022.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2023.1">state: PlanState</span></span><span class="koboSpan" id="kobo.2024.1">) -&gt; PlanState:</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.2025.1"> plan = state[</span><span class="hljs-string"><span class="koboSpan" id="kobo.2026.1">"plan"</span></span><span class="koboSpan" id="kobo.2027.1">]</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.2028.1"> current_step = get_current_step(state)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.2029.1"> step = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2030.1">await</span></span><span class="koboSpan" id="kobo.2031.1"> execution_agent.ainvoke({</span><span class="hljs-string"><span class="koboSpan" id="kobo.2032.1">"plan"</span></span><span class="koboSpan" id="kobo.2033.1">: get_full_plan(plan), </span><span class="hljs-string"><span class="koboSpan" id="kobo.2034.1">"step"</span></span><span class="koboSpan" id="kobo.2035.1">: plan.steps[current_step], </span><span class="hljs-string"><span class="koboSpan" id="kobo.2036.1">"task"</span></span><span class="koboSpan" id="kobo.2037.1">: state[</span><span class="hljs-string"><span class="koboSpan" id="kobo.2038.1">"task"</span></span><span class="koboSpan" id="kobo.2039.1">]})</span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2040.1">return</span></span><span class="koboSpan" id="kobo.2041.1"> {</span><span class="hljs-string"><span class="koboSpan" id="kobo.2042.1">"past_steps"</span></span><span class="koboSpan" id="kobo.2043.1">: [step[</span><span class="hljs-string"><span class="koboSpan" id="kobo.2044.1">"messages"</span></span><span class="koboSpan" id="kobo.2045.1">][-</span><span class="hljs-number"><span class="koboSpan" id="kobo.2046.1">1</span></span><span class="koboSpan" id="kobo.2047.1">].content]}</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2048.1">async</span></span> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2049.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2050.1">_get_final_response</span></span><span class="koboSpan" id="kobo.2051.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2052.1">state: PlanState</span></span><span class="koboSpan" id="kobo.2053.1">) -&gt; PlanState:</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.2054.1"> final_response = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2055.1">await</span></span><span class="koboSpan" id="kobo.2056.1"> (final_prompt | llm).ainvoke({</span><span class="hljs-string"><span class="koboSpan" id="kobo.2057.1">"task"</span></span><span class="koboSpan" id="kobo.2058.1">: state[</span><span class="hljs-string"><span class="koboSpan" id="kobo.2059.1">"task"</span></span><span class="koboSpan" id="kobo.2060.1">], </span><span class="hljs-string"><span class="koboSpan" id="kobo.2061.1">"plan"</span></span><span class="koboSpan" id="kobo.2062.1">: get_full_plan(state)})</span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2063.1">return</span></span><span class="koboSpan" id="kobo.2064.1"> {</span><span class="hljs-string"><span class="koboSpan" id="kobo.2065.1">"final_response"</span></span><span class="koboSpan" id="kobo.2066.1">: final_response}</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2067.1">def</span></span> <span class="hljs-title"><span class="koboSpan" id="kobo.2068.1">_should_continue</span></span><span class="koboSpan" id="kobo.2069.1">(</span><span class="hljs-params"><span class="koboSpan" id="kobo.2070.1">state: PlanState</span></span><span class="koboSpan" id="kobo.2071.1">) -&gt; </span><span class="hljs-type"><span class="koboSpan" id="kobo.2072.1">Literal</span></span><span class="koboSpan" id="kobo.2073.1">[</span><span class="hljs-string"><span class="koboSpan" id="kobo.2074.1">"run"</span></span><span class="koboSpan" id="kobo.2075.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.2076.1">"response"</span></span><span class="koboSpan" id="kobo.2077.1">]:</span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2078.1">if</span></span><span class="koboSpan" id="kobo.2079.1"> get_current_step(plan) &lt; </span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2080.1">len</span></span><span class="koboSpan" id="kobo.2081.1">(state[</span><span class="hljs-string"><span class="koboSpan" id="kobo.2082.1">"plan"</span></span><span class="koboSpan" id="kobo.2083.1">].steps):</span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2084.1">return</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2085.1">"run"</span></span></p>
<p class="snippet-code"> <span class="hljs-keyword"><span class="koboSpan" id="kobo.2086.1">return</span></span> <span class="hljs-string"><span class="koboSpan" id="kobo.2087.1">"final_response"</span></span></p>
<p class="normal"><span class="koboSpan" id="kobo.2088.1">And put </span><a id="_idIndexMarker494"/><span class="koboSpan" id="kobo.2089.1">together </span><a id="_idIndexMarker495"/><span class="koboSpan" id="kobo.2090.1">the final graph:</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.2091.1">builder = StateGraph(PlanState)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.2092.1">builder.add_node(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2093.1">"initial_plan"</span></span><span class="koboSpan" id="kobo.2094.1">, _build_initial_plan)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.2095.1">builder.add_node(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2096.1">"run"</span></span><span class="koboSpan" id="kobo.2097.1">, _run_step)</span></p>
<div aria-label="220" epub:type="pagebreak" id="page40-2" role="doc-pagebreak"/>
<p class="snippet-code"><span class="koboSpan" id="kobo.2098.1">builder.add_node(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2099.1">"response"</span></span><span class="koboSpan" id="kobo.2100.1">, _get_final_response)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.2101.1">builder.add_edge(START, </span><span class="hljs-string"><span class="koboSpan" id="kobo.2102.1">"initial_plan"</span></span><span class="koboSpan" id="kobo.2103.1">)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.2104.1">builder.add_edge(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2105.1">"initial_plan"</span></span><span class="koboSpan" id="kobo.2106.1">, </span><span class="hljs-string"><span class="koboSpan" id="kobo.2107.1">"run"</span></span><span class="koboSpan" id="kobo.2108.1">)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.2109.1">builder.add_conditional_edges(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2110.1">"run"</span></span><span class="koboSpan" id="kobo.2111.1">, _should_continue)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.2112.1">builder.add_edge(</span><span class="hljs-string"><span class="koboSpan" id="kobo.2113.1">"response"</span></span><span class="koboSpan" id="kobo.2114.1">, END)</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.2115.1">graph = builder.</span><span class="hljs-built_in"><span class="koboSpan" id="kobo.2116.1">compile</span></span><span class="koboSpan" id="kobo.2117.1">()</span></p>
<p class="snippet-code"><span class="hljs-keyword"><span class="koboSpan" id="kobo.2118.1">from</span></span><span class="koboSpan" id="kobo.2119.1"> IPython.display </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2120.1">import</span></span><span class="koboSpan" id="kobo.2121.1"> Image, display</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.2122.1">display(Image(graph.get_graph().draw_mermaid_png()))</span></p>
<figure class="mediaobject"><span class="koboSpan" id="kobo.2123.1"><img alt="Figure 5.3: Plan-and-solve agentic workflow" src="../Images/B32363_05_03.png"/></span></figure>
<p class="packt_figref"><span class="koboSpan" id="kobo.2124.1">Figure 5.3: Plan-and-solve agentic workflow</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2125.1">Now we can run the workflow:</span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.2126.1">task = </span><span class="hljs-string"><span class="koboSpan" id="kobo.2127.1">"Write a strategic one-pager of building an AI startup"</span></span></p>
<p class="snippet-code"><span class="koboSpan" id="kobo.2128.1">result = </span><span class="hljs-keyword"><span class="koboSpan" id="kobo.2129.1">await</span></span><span class="koboSpan" id="kobo.2130.1"> graph.ainvoke({</span><span class="hljs-string"><span class="koboSpan" id="kobo.2131.1">"task"</span></span><span class="koboSpan" id="kobo.2132.1">: task})</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2133.1">You can see</span><a id="_idIndexMarker496"/><span class="koboSpan" id="kobo.2134.1"> the full output on our GitHub, and we encourage </span><a id="_idIndexMarker497"/><span class="koboSpan" id="kobo.2135.1">you to play with it yourself. </span><span class="koboSpan" id="kobo.2135.2">It might be especially interesting to investigate whether you like the result more compared to a single L</span><a id="_idTextAnchor268"/><span class="koboSpan" id="kobo.2136.1">LM prompt with a given task.</span></p>
<div aria-label="221" epub:type="pagebreak" id="page41-2" role="doc-pagebreak"/>
<h1 class="heading-1" id="_idParaDest-142"><a id="_idTextAnchor269"/><span class="koboSpan" id="kobo.2137.1">Summary</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2138.1">In this chapter, we explored how to enhance LLMs by integrating tools and design patterns for tool invocation, including the ReACT pattern. </span><span class="koboSpan" id="kobo.2138.2">We started by building a ReACT agent from scratch and then demonstrated how to create a customized one with just one line of code using LangGraph. </span></p>
<p class="normal"><span class="koboSpan" id="kobo.2139.1">Next, we delved into advanced techniques for controlled generation—showing how to force an LLM to call any tool or a specific one, and instructing it to return responses in structured formats (such as JSON, enums, or Pydantic models). </span><span class="koboSpan" id="kobo.2139.2">In that context, we covered LangChain’s </span><code class="inlineCode"><span class="koboSpan" id="kobo.2140.1">with_structured_output</span></code><span class="koboSpan" id="kobo.2141.1"> method, which transforms your data structure into a tool schema, prompts the model to call the tool, parses the output, and compiles it into a corresponding Pydantic instance.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2142.1">Finally, we built our first plan-and-solve agent with LangGraph, applying all the concepts we’ve learned so far: tool calling, ReACT, structured outputs, and more. </span><span class="koboSpan" id="kobo.2142.2">In the next chapter, we’ll continue discussing how to develop agents and look into more adva</span><a id="_idTextAnchor270"/><span class="koboSpan" id="kobo.2143.1">nced architectural patterns.</span></p>
<h1 class="heading-1" id="_idParaDest-143"><a id="_idTextAnchor271"/><span class="koboSpan" id="kobo.2144.1">Questions</span></h1>
<ol>
<li class="numberedList" value="1"><span class="koboSpan" id="kobo.2145.1">What are the key benefits of using tools with LLMs, and why are they important?</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2146.1">How does LangChain’s ToolMessage class facilitate communication between the LLM and the external environment? </span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2147.1">Explain the ReACT pattern. </span><span class="koboSpan" id="kobo.2147.2">What are its two main steps? </span><span class="koboSpan" id="kobo.2147.3">How does it improve LLM performance? </span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2148.1">How would you define a generative AI agent? </span><span class="koboSpan" id="kobo.2148.2">How does this relate to or differ from LangChain’s definition?</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2149.1">Explain some advantages and disadvantages of using the with_structured_output method compared to using a controlled generation directly.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2150.1">How can you programmatically define a custom tool in LangChain?</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2151.1">Explain the purpose of the Runnable.bind() and bind_tools() methods in LangChain.</span></li>
<li class="numberedList"><span class="koboSpan" id="kobo.2152.1">How does LangChain handle errors that occur during tool execution? </span><span class="koboSpan" id="kobo.2152.2">What options are available for configuring this behavior?</span></li>
</ol>
<div aria-label="222" epub:type="pagebreak" id="page42-1" role="doc-pagebreak"/>
<h1 class="heading-1" id="_idParaDest-144"><a id="_idTextAnchor272"/><a id="_idTextAnchor273"/><span class="koboSpan" id="kobo.2153.1">Subscribe to our weekly newsletter</span></h1>
<p class="normal"><span class="koboSpan" id="kobo.2154.1">Subscribe to AI_Distilled, the go-to newsletter for AI professionals, researchers, and innovators, at </span><a href="E_Chapter_5.xhtml"><span class="url"><span class="koboSpan" id="kobo.2155.1">https://packt.link/Q5UyU</span></span></a><span class="koboSpan" id="kobo.2156.1">.</span></p>
<p class="normal"><span class="koboSpan" id="kobo.2157.1"><img alt="" src="../Images/Newsletter_QRcode1.jpg"/></span></p>
</div>
</body></html>