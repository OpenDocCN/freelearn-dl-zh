<html><head></head><body>
		<div id="_idContainer033">
			<h1 id="_idParaDest-53" class="chapter-number"><a id="_idTextAnchor081"/>4</h1>
			<h1 id="_idParaDest-54"><a id="_idTextAnchor082"/>Understanding the Theory Behind Diffusion Models</h1>
			<p>This chapter will dive into the theory that powers <strong class="bold">diffusion models</strong> and see the internal workings of the system. How could a neural network model generate such realistic images? Curious minds would like to lift the cover and see the <span class="No-Break">internal workings.</span></p>
			<p>We are going to touch on the foundation of the diffusion model, aiming to figure out how it works internally and pave the foundation to implement a workable pipeline in the <span class="No-Break">next chapter.</span></p>
			<p>By comprehending the intricacies of diffusion models, we not only enhance our understanding of the <a id="_idIndexMarker107"/>advanced <strong class="bold">Stable Diffusion</strong> (also known as <strong class="bold">latent diffusion models</strong> (<strong class="bold">LDMs</strong>)) but also gain the ability to navigate <a id="_idIndexMarker108"/>the source code of the Diffusers package <span class="No-Break">more effectively.</span></p>
			<p>This knowledge will enable us to extend the package’s features in line with <span class="No-Break">emerging requirements.</span></p>
			<p>Specifically, we will go through the <span class="No-Break">following topics:</span></p>
			<ul>
				<li>Understanding the <span class="No-Break">image-to-noise process</span></li>
				<li>A more efficient <strong class="bold">forward </strong><span class="No-Break"><strong class="bold">diffusion process</strong></span></li>
				<li>The noise-to-image <span class="No-Break">training process</span></li>
				<li>The noise-to-image <span class="No-Break">sampling process</span></li>
				<li>Understanding Classifier <span class="No-Break">Guidance denoising</span></li>
			</ul>
			<p>By the end of this chapter, we will have taken a deep dive into the internal workings of the diffusion model initially brought out by Jonathan Ho et al. [4]. We will understand the foundational idea of the diffusion model and learn about the <strong class="bold">forward diffusion process</strong>. We will understand the reverse diffusion process for diffusion model training and sampling and learn to enable a text-guided <span class="No-Break">diffusion model.</span></p>
			<p>Let’s <span class="No-Break">get started<a id="_idTextAnchor083"/>.</span></p>
			<h1 id="_idParaDest-55"><a id="_idTextAnchor084"/>Understanding the image-to-noise process</h1>
			<p>The idea of the diffusion model is inspired by the diffusion concept from thermodynamics. Take one<a id="_idIndexMarker109"/> image as a cup of water and add enough noise (ink) to the image (water) to finally turn the image (water) into a complete noise image (<span class="No-Break">ink water).</span></p>
			<p>As shown in <span class="No-Break"><em class="italic">Figure 4</em></span><em class="italic">.1</em>, image <span class="_-----MathTools-_Math_Text">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Text">0</span> can be converted to a nearly Gaussian (normally distributed) noise image <span class="No-Break"><span class="_-----MathTools-_Math_Text">x</span></span><span class="No-Break"><span class="_-----MathTools-_Math_Base"> </span></span><span class="No-Break"><span class="_-----MathTools-_Math_Text">T</span></span><span class="No-Break">.</span></p>
			<div>
				<div id="_idContainer024" class="IMG---Figure">
					<img src="image/B21263_04_01.jpg" alt="Figure 4.1: Forward diffusion and reverse denoising"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.1: Forward diffusion and reverse denoising</p>
			<p>We employ a predetermined forward diffusion process, denoted as <span class="_-----MathTools-_Math_Variable">q</span>, which systematically introduces Gaussian noise to an image until it culminates in pure noise. The process is denoted by <span class="_-----MathTools-_Math_Variable">q</span><span class="_-----MathTools-_Math_Base">(</span><span class="_-----MathTools-_Math_Text">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Text">t</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">|</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Text">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Text">t-1</span><span class="_-----MathTools-_Math_Base">)</span>. Note that the reverse process <span class="_-----MathTools-_Math_Variable">p</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable_v-normal">θ</span><span class="_-----MathTools-_Math_Base">(</span><span class="_-----MathTools-_Math_Text">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Text">t-1</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">|</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Text">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Text">t</span><span class="_-----MathTools-_Math_Base">)</span> is <span class="No-Break">still unknown.</span></p>
			<p>One step of the forward diffusion process can be denoted <span class="No-Break">as follows:</span></p>
			<p><span class="_-----MathTools-_Math_Variable">q</span><span class="_-----MathTools-_Math_Base">(</span><span class="_-----MathTools-_Math_Text">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Text">t</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">|</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Text">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Text">t-1</span><span class="_-----MathTools-_Math_Base">)</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator_Extended">≔</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base"> </span>𝒩<span class="_-----MathTools-_Math_Base">(</span><span class="_-----MathTools-_Math_Text">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Text">t</span><span class="_-----MathTools-_Math_Operator">;</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">√</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">_</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Number">1</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">−</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable_v-normal">β</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Text">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Text">t-1</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">,</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable_v-normal">β</span><span class="_-----MathTools-_Math_Base"> </span><span class="No-Break"><span class="_-----MathTools-_Math_Variable">t</span></span><span class="No-Break"><span class="_-----MathTools-_Math_Base"> </span></span><span class="No-Break"><span class="_-----MathTools-_Math_Variable">I</span></span><span class="No-Break"><span class="_-----MathTools-_Math_Variable">)</span></span></p>
			<p>Let me explain this formula bit by bit from left <span class="No-Break">to right:</span></p>
			<ul>
				<li>The notation <span class="_-----MathTools-_Math_Variable">q</span><span class="_-----MathTools-_Math_Base">(</span><span class="_-----MathTools-_Math_Text">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Text">t</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">|</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Text">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Text">t-1</span><span class="_-----MathTools-_Math_Base">)</span> is used to denote a conditional probability distribution. In this case, the distribution <span class="_-----MathTools-_Math_Variable">q</span> represents the probability of observing the noisy image <span class="_-----MathTools-_Math_Variable">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span> given the previous image <span class="No-Break"><span class="_-----MathTools-_Math_Variable">x</span></span><span class="No-Break"><span class="_-----MathTools-_Math_Base"> </span></span><span class="No-Break"><span class="_-----MathTools-_Math_Variable">t</span></span><span class="No-Break"><span class="_-----MathTools-_Math_Operator">−</span></span><span class="No-Break"><span class="_-----MathTools-_Math_Number">1</span></span><span class="No-Break">.</span></li>
				<li>The define sign <span class="_-----MathTools-_Math_Operator">:</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">=</span> is used in the formula instead of the tilde symbol (<span class="_-----MathTools-_Math_Operator_Extended">∼</span>) because the diffusion forward process is a deterministic process. The tilde symbol (<span class="_-----MathTools-_Math_Operator_Extended">∼</span>) is typically used to represent a distribution. In this case, if we used the tilde symbol, the formula would be saying that the noisy image is a complete Gaussian distribution. However, this is not the case. The noisy image in <span class="_-----MathTools-_Math_Variable">t</span> step is defined by a deterministic<a id="_idIndexMarker110"/> function of the previous image and <span class="No-Break">added noise.</span></li>
				<li>Then why is 𝒩 used here? The 𝒩 symbol is used to represent a Gaussian distribution. However, in this case, the 𝒩 symbol is being used to represent the functional form of the <span class="No-Break">noisy image.</span></li>
				<li>On the right side, before the semicolon, <span class="_-----MathTools-_Math_Variable">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span> is the thing we want to have in normal distribution. After the semicolon, those are the parameters of the distribution. A semicolon is usually used to separate the output <span class="No-Break">and parameters.</span></li>
				<li><span class="_-----MathTools-_Math_Variable">β</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span> is the noise variance at step <span class="_-----MathTools-_Math_Variable">t</span>. <span class="_-----MathTools-_Math_Base">√</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">_</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Number">1</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">−</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">β</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Operator">−</span><span class="_-----MathTools-_Math_Number">1</span> is the mean of the <span class="No-Break">new distribution.</span></li>
				<li>Why is the big <span class="_-----MathTools-_Math_Variable">I</span> used in the formula? Because an RGB image can have multiple channels, and the identity matrix can apply the noise variance to different <span class="No-Break">channels independently.</span></li>
			</ul>
			<p>It is quite easy to add Gaussian noise to an image <span class="No-Break">using Python:</span></p>
			<pre class="source-code">
import numpy as np
import matplotlib.pyplot as plt
import ipyplot
from PIL import Image
# Load an image
img_path = r"dog.png"
image = plt.imread(img_path)
# Parameters
num_iterations = 16
beta = 0.1              # noise_variance
images = []
steps = ["Step:"+str(i) for i in range(num_iterations)]
# Forward diffusion process
for i in range(num_iterations):
    mean = np.sqrt(1 - beta) * image
    image = np.random.normal(mean, beta, image.shape)
    # convert image to PIL image object
    pil_image = Image.fromarray((image * 255).astype('uint8'), 'RGB')
    # add to image list
    images.append(pil_image)
ipyplot.plot_images(images, labels=steps, img_width=120)</pre>
			<p>To execute the preceding code, you<a id="_idIndexMarker111"/> will also need to install the <strong class="source-inline">ipyplot</strong> package by <strong class="source-inline">pip install ipyplot</strong>. The code provided performs a simulation of a forward diffusion process on an image and then visualizes the progression of this process over a number of iterations. Here’s a step-by-step explanation of what each part of the code <span class="No-Break">is doing:</span></p>
			<ol>
				<li><span class="No-Break">Importing libraries:</span><ul><li><strong class="source-inline">ipyplot</strong> is a library for plotting images in Jupyter notebooks in a more <span class="No-Break">interactive way.</span></li><li><strong class="source-inline">PIL</strong> (which <a id="_idIndexMarker112"/>stands for <strong class="bold">Python Imaging Library</strong>), specifically the <strong class="source-inline">Image</strong> module, is used for <span class="No-Break">image </span><span class="No-Break"><a id="_idIndexMarker113"/></span><span class="No-Break">manipulation.</span></li></ul></li>
				<li>Loading <span class="No-Break">the image:</span><ul><li><strong class="source-inline">img_path</strong> is defined as the path to the <strong class="source-inline">image</strong> <span class="No-Break">file </span><span class="No-Break"><strong class="source-inline">dog.png</strong></span><span class="No-Break">.</span></li><li><strong class="source-inline">image</strong> is loaded <span class="No-Break">using </span><span class="No-Break"><strong class="source-inline">plt.imread(img_path)</strong></span><span class="No-Break">.</span></li></ul></li>
				<li><span class="No-Break">Setting parameters:</span><ul><li><strong class="source-inline">num_iterations</strong> defines the number of times the diffusion process will <span class="No-Break">be simulated.</span></li><li><strong class="source-inline">beta</strong> is a parameter that simulates noise variance in the <span class="No-Break">diffusion process.</span></li></ul></li>
				<li><span class="No-Break">Initializing lists:</span><ul><li><strong class="source-inline">images</strong> is initialized as an empty list, which will later hold the PIL image objects that result from each iteration of the <span class="No-Break">diffusion process.</span></li><li><strong class="source-inline">steps</strong> is a list of strings that will act as labels for the images when they are plotted, indicating the step number for <span class="No-Break">each image.</span></li></ul></li>
				<li>Forward <span class="No-Break">diffusion process:</span><ul><li>A <strong class="source-inline">for</strong> loop runs for <strong class="source-inline">num_iterations</strong> times, each time performing a diffusion step. <strong class="source-inline">mean</strong> is computed by scaling the image with a factor of <strong class="source-inline">sqrt(1 - </strong><span class="No-Break"><strong class="source-inline">beta)</strong></span><span class="No-Break">.</span></li><li>A new image is generated by adding Gaussian noise to the mean, where the noise has a standard deviation of <strong class="source-inline">beta</strong>. This is done <span class="No-Break">using </span><span class="No-Break"><strong class="source-inline">np.random.normal</strong></span><span class="No-Break">.</span></li><li>The resulting image array values are scaled to the range 0-255 and converted to an 8-bit unsigned integer format, which is a common format <span class="No-Break">for images.</span></li><li><strong class="source-inline">pil_image</strong> is created by converting the image array to a PIL image object in <span class="No-Break">RGB mode.</span></li></ul></li>
				<li>Plot the image using <strong class="source-inline">ipyplot</strong> in a grid <a id="_idIndexMarker114"/>as shown in <span class="No-Break"><em class="italic">Figure 4</em></span><span class="No-Break"><em class="italic">.2</em></span><span class="No-Break">.</span></li>
			</ol>
			<div>
				<div id="_idContainer025" class="IMG---Figure">
					<img src="image/B21263_04_02.jpg" alt="Figure 4.2: Add noise to the image"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.2: Add noise to the image</p>
			<p>From the result, we can see that even though every image is from a normal distribution function, not every image is a complete Gaussian distribution, or more strictly speaking, an <strong class="bold">isotropic Gaussian distribution</strong>. The image will become a complete Gaussian distribution only when <a id="_idIndexMarker115"/>setting the step to infinite. But this is unnecessary. In the original DDPM paper [4], the step number is set to <strong class="source-inline">1000</strong>, and later, in Stable Diffusion, the step number is reduced to between <strong class="source-inline">20</strong> <span class="No-Break">to </span><span class="No-Break"><strong class="source-inline">50</strong></span><span class="No-Break">.</span></p>
			<p>If the last image of <span class="No-Break"><em class="italic">Figure 4</em></span><em class="italic">.2</em> is an isotropic Gaussian distribution, its 2D distribution visualization will appear as a circle; it is characterized by having equal variances in all dimensions. In other words, the spread or width of the distribution is the same along <span class="No-Break">all axes.</span></p>
			<p>Let’s plot an image pixel distribution after adding 16x times <span class="No-Break">Gaussian noise:</span></p>
			<pre class="source-code">
sample_img = image  # take the last image from the diffusion process
plt.scatter(sample_img[:, 0], sample_img[:, 1], alpha=0.5)
plt.title("2D Isotropic Gaussian Distribution")
plt.xlabel("X")
plt.ylabel("Y")
plt.axis("equal")
plt.show()</pre>
			<p>The result is shown in <span class="No-Break"><em class="italic">Figure 4</em></span><span class="No-Break"><em class="italic">.3</em></span><span class="No-Break">.</span></p>
			<div>
				<div id="_idContainer026" class="IMG---Figure">
					<img src="image/B21263_04_03.jpg" alt="Figure 4.3: A nearly isotropic, normally distributed noise image"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.3: A nearly isotropic, normally distributed noise image</p>
			<p>The figure shows how the<a id="_idIndexMarker116"/> code efficiently transforms an image into a nearly isotropic, normally distributed noise image in just 16 steps, as illustrated in the last image of <span class="No-Break"><em class="italic">Figur<a id="_idTextAnchor085"/>e 4</em></span><span class="No-Break"><em class="italic">.2</em></span><span class="No-Break">.</span></p>
			<h1 id="_idParaDest-56"><a id="_idTextAnchor086"/>A more efficient forward diffusion process</h1>
			<p>If we use the chained process to <a id="_idIndexMarker117"/>calculate a noisy image at <span class="_-----MathTools-_Math_Variable">t</span> step, it first requires calculating the noisy image from <span class="_-----MathTools-_Math_Number">1</span> to <span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">−</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Number">1</span> steps, which is not efficient. We can leverage a trick called <strong class="bold">reparameterization</strong> [10] to transform the original chained process into a <a id="_idIndexMarker118"/>one-step process. Here is what the trick <span class="No-Break">looks like.</span></p>
			<p>If we have a Gaussian distribution <span class="_-----MathTools-_Math_Variable">z</span> with <span class="_-----MathTools-_Math_Variable">μ</span> as the mean and <span class="_-----MathTools-_Math_Variable">σ</span><span class="_-----MathTools-_Math_Base"> </span><span class="No-Break"><span class="_-----MathTools-_Math_Number">2</span></span><span class="No-Break"> variance:</span></p>
			<p><span class="_-----MathTools-_Math_Variable">z</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator_Extended">∼</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base"> </span>𝒩<span class="_-----MathTools-_Math_Base">(</span><span class="_-----MathTools-_Math_Variable_v-normal">μ</span><span class="_-----MathTools-_Math_Operator">,</span><span class="_-----MathTools-_Math_Base"> </span><span class="No-Break"><span class="_-----MathTools-_Math_Variable_v-normal">σ</span></span><span class="No-Break"><span class="_-----MathTools-_Math_Base"> </span></span><span class="No-Break"><span class="_-----MathTools-_Math_Number">2</span></span><span class="No-Break"><span class="_-----MathTools-_Math_Base">)</span></span></p>
			<p>Then, we can rewrite the distribution <span class="No-Break">as follows:</span></p>
			<p><span class="_-----MathTools-_Math_Symbol_Extended">ϵ</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator_Extended">∼</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base"> </span><span class="No-Break">𝒩</span><span class="No-Break"><span class="_-----MathTools-_Math_Base">(</span></span><span class="No-Break"><span class="_-----MathTools-_Math_Number">0,1</span></span><span class="No-Break"><span class="_-----MathTools-_Math_Number">)</span></span></p>
			<p><span class="_-----MathTools-_Math_Variable">z</span><span class="_-----MathTools-_Math_Space"> </span><span class="_-----MathTools-_Math_Operator">=</span><span class="_-----MathTools-_Math_Space"> </span><span class="No-Break"><span class="_-----MathTools-_Math_Variable_v-normal">μ</span></span><span class="No-Break"><span class="_-----MathTools-_Math_Operator">+</span></span><span class="No-Break"><span class="_-----MathTools-_Math_Space"> </span></span><span class="No-Break"><span class="_-----MathTools-_Math_Variable_v-normal">σ</span></span><span class="No-Break"><span class="_-----MathTools-_Math_Symbol_Extended">ϵ</span></span></p>
			<p>The benefit brought by this trick is that we can now calculate an image at any step with a one-step calculation, which will greatly boost the <span class="No-Break">training performance:</span></p>
			<p><span class="_-----MathTools-_Math_Variable">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">=</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">√</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">_</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Number">1</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">−</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable_v-normal">β</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Operator">−</span><span class="_-----MathTools-_Math_Number">1</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">+</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">√</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">_</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable_v-normal">β</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base"> </span><span class="No-Break"><span class="_-----MathTools-_Math_Symbol_Extended">ϵ</span></span><span class="No-Break"><span class="_-----MathTools-_Math_Base"> </span></span><span class="No-Break"><span class="_-----MathTools-_Math_Variable">t</span></span><span class="No-Break"><span class="_-----MathTools-_Math_Operator">−</span></span><span class="No-Break"><span class="_-----MathTools-_Math_Number">1</span></span></p>
			<p>Now, say we define <span class="No-Break">the following:</span></p>
			<p><span class="_-----MathTools-_Math_Variable_v-normal">α</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">=</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Number">1</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">−</span><span class="_-----MathTools-_Math_Base"> </span><span class="No-Break"><span class="_-----MathTools-_Math_Variable_v-normal">β</span></span><span class="No-Break"><span class="_-----MathTools-_Math_Base"> </span></span><span class="No-Break"><span class="_-----MathTools-_Math_Variable">t</span></span></p>
			<p>We now have <span class="No-Break">the following:</span></p>
			<p><span class="_-----MathTools-_Math_Base">_</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable_v-normal">α</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">=</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">∏</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">i</span><span class="_-----MathTools-_Math_Operator">=</span><span class="_-----MathTools-_Math_Number">1</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Variable"> </span><span class="No-Break"><span class="_-----MathTools-_Math_Variable_v-normal">α</span></span><span class="No-Break"><span class="_-----MathTools-_Math_Base"> </span></span><span class="No-Break"><span class="_-----MathTools-_Math_Variable">i</span></span></p>
			<p>There is no magic here; define <span class="_-----MathTools-_Math_Variable">α</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span> and <span class="_-----MathTools-_Math_Variable">α</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Symbol_Extended">‾</span><span class="_-----MathTools-_Math_Symbol_Extended"> </span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span> is only for convenience, so that we can calculate a noised image at step <span class="_-----MathTools-_Math_Variable">t</span> and generate <span class="_-----MathTools-_Math_Variable">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span> from the source un-noised image <span class="_-----MathTools-_Math_Variable">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Number">0</span> using the <span class="No-Break">following equation:</span></p>
			<p><span class="_-----MathTools-_Math_Variable">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">=</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">√</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">_</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">_</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable_v-normal">α</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Number">0</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">+</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">√</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">_</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Number">1</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">−</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">_</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable_v-normal">α</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Base"> </span></p>
			<p>What do <span class="_-----MathTools-_Math_Variable">α</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span> and <span class="_-----MathTools-_Math_Variable">α</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Symbol_Extended">‾</span><span class="_-----MathTools-_Math_Symbol_Extended"> </span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span> look like? Here is a simplified sample (<span class="No-Break"><em class="italic">Figure 4</em></span><span class="No-Break"><em class="italic">.4</em></span><span class="No-Break">).</span></p>
			<div>
				<div id="_idContainer027" class="IMG---Figure">
					<img src="image/B21263_04_04.jpg" alt="Figure 4.4: Implementation of reparameterization"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.4: Implementation of reparameterization</p>
			<p>In <span class="No-Break"><em class="italic">Figure 4</em></span><em class="italic">.4</em>, we have all the same <span class="_-----MathTools-_Math_Variable">α</span> - 0.1 and <span class="_-----MathTools-_Math_Variable">β</span> - 0.9. Now, whenever we need to generate a noised image <span class="_-----MathTools-_Math_Variable">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span>, we can quickly calculate <span class="_-----MathTools-_Math_Variable">α</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Symbol_Extended">‾</span><span class="_-----MathTools-_Math_Symbol_Extended"> </span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span> from known numbers; the lines show what numbers are <a id="_idIndexMarker119"/>used to calculate <span class="_-----MathTools-_Math_Variable">α</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Symbol_Extended">‾</span><span class="_-----MathTools-_Math_Symbol_Extended"> </span><span class="_-----MathTools-_Math_Base"> </span><span class="No-Break"><span class="_-----MathTools-_Math_Variable">t</span></span><span class="No-Break">.</span></p>
			<p>The following code can generate a noised image at <span class="No-Break">any step:</span></p>
			<pre class="source-code">
import numpy as np
import matplotlib.pyplot as plt
from PIL import Image
from itertools import accumulate
def get_product_accumulate(numbers):
    product_list = list(accumulate(numbers, lambda x, y: x * y))
    return product_list
# Load an image
img_path = r"dog.png"
image = plt.imread(img_path)
image = image * 2 - 1                   # [0,1] to [-1,1]
# Parameters
num_iterations = 16
beta = 0.05                             # noise_variance
betas = [beta]*num_iterations
alpha_list = [1 - beta for beta in betas]
alpha_bar_list = get_product_accumulate(alpha_list)
target_index = 5
x_target = (
    np.sqrt(alpha_bar_list[target_index]) * image
    + np.sqrt(1 - alpha_bar_list[target_index]) * 
    np.random.normal(0,1,image.shape)
)
x_target = (x_target+1)/2
x_target = Image.fromarray((x_target * 255).astype('uint8'), 'RGB')
display(x_target)</pre>
			<p>This code is the implementation <a id="_idIndexMarker120"/>of the previously presented math formula. I present the code here to help build a correlated understanding between the math formula and the real implementation. If you are familiar with Python, you may find that this code makes the underlying subtleties easier to understand. The code can generate a noised image as shown in <span class="No-Break"><em class="italic">Figure 4</em></span><span class="No-Break"><em class="italic">.5</em></span><span class="No-Break">.</span></p>
			<div>
				<div id="_idContainer028" class="IMG---Figure">
					<img src="image/B21263_04_05.jpg" alt="Figure 4.5: Implementation of reparameterization"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.5: Implementation of reparameterization</p>
			<p>Now, let’s think about <a id="_idIndexMarker121"/>how to recover an image by leveraging a <span class="No-Break">neural<a id="_idTextAnchor087"/> network.</span></p>
			<h1 id="_idParaDest-57"><a id="_idTextAnchor088"/>The noise-to-image training process</h1>
			<p>We have the solution to add noise to the image, which is known as forward diffusion, as shown in <span class="No-Break"><em class="italic">Figure 4</em></span><em class="italic">.6</em>. To recover an image<a id="_idIndexMarker122"/> from the noise, or <strong class="bold">reverse diffusion</strong>, as shown in <span class="No-Break"><em class="italic">Figure 4</em></span><em class="italic">.6</em>, we need to<a id="_idIndexMarker123"/> find a way to implement the reverse step <span class="_-----MathTools-_Math_Variable">p</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">θ</span><span class="_-----MathTools-_Math_Base">(</span><span class="_-----MathTools-_Math_Variable">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Operator">−</span><span class="_-----MathTools-_Math_Number">1</span><span class="_-----MathTools-_Math_Base">|</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Base">)</span>. However, this step is intractable or uncomputable without <span class="No-Break">additional help.</span></p>
			<p>Consider that we have the ending Gaussian noise data, and all those noise step data in hand. What if we can train a neural network that can reverse the process? We can use the neural network to provide the mean and variance of a noise image and then remove the generated noise from the previous image data. By doing this, we should be able to use this step to represent <span class="_-----MathTools-_Math_Variable">p</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">θ</span><span class="_-----MathTools-_Math_Base">(</span><span class="_-----MathTools-_Math_Variable">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Operator">−</span><span class="_-----MathTools-_Math_Number">1</span><span class="_-----MathTools-_Math_Base">|</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Base">)</span>, and thus recover <span class="No-Break">an image.</span></p>
			<div>
				<div id="_idContainer029" class="IMG---Figure">
					<img src="image/B21263_04_06.jpg" alt="Figure 4.6: Forward diffusion and reverse process"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.6: Forward diffusion and reverse process</p>
			<p>You may ask how we should calculate the loss and update the weights. The ending image (<span class="_-----MathTools-_Math_Variable">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">T</span>) removes the previously added noise and will provide the ground truth data. After all, we can generate the noise data in the forward diffusion processes on the fly. Next, compare it with the output data from the neural network (usually a UNet). We get the loss data that can be used to calculate the gradient descendant data and update the neural <span class="No-Break">network weights.</span></p>
			<p>The DDPM paper [4] provided a simplified way to calculate <span class="No-Break">the loss:</span></p>
			<p><span class="_-----MathTools-_Math_Variable">L</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">s</span><span class="_-----MathTools-_Math_Variable">i</span><span class="_-----MathTools-_Math_Variable">m</span><span class="_-----MathTools-_Math_Variable">p</span><span class="_-----MathTools-_Math_Variable">l</span><span class="_-----MathTools-_Math_Variable">e</span><span class="_-----MathTools-_Math_Base">(</span><span class="_-----MathTools-_Math_Variable">θ</span><span class="_-----MathTools-_Math_Variable">)</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">:</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">=</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Symbol_Extended">𝔼</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable_v-normal">t</span><span class="_-----MathTools-_Math_Operator">,</span><span class="_-----MathTools-_Math_Space"> </span><span class="_-----MathTools-_Math_Variable_v-normal">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Number">0</span><span class="_-----MathTools-_Math_Operator">,</span><span class="_-----MathTools-_Math_Operator_Extended">∈</span><span class="_-----MathTools-_Math_Base">[</span><span class="_-----MathTools-_Math_Base">|</span><span class="_-----MathTools-_Math_Base">|</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator_Extended">∈</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">−</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator_Extended">∈</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">θ</span><span class="_-----MathTools-_Math_Base">(</span><span class="_-----MathTools-_Math_Base">√</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">_</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">_</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">α</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Text">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Text">0</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">+</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">√</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">_</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Number">1</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">−</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">_</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">α</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Symbol_Extended">ϵ</span><span class="_-----MathTools-_Math_Operator">,</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Variable">)</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">|</span><span class="_-----MathTools-_Math_Base">|</span><span class="_-----MathTools-_Math_Base"> </span><span class="No-Break"><span class="_-----MathTools-_Math_Number">2</span></span><span class="No-Break"><span class="_-----MathTools-_Math_Base">]</span></span></p>
			<p>Since <span class="_-----MathTools-_Math_Text">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Text">t</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">=</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">√</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">_</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">_</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">α</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Text">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Text">0</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">+</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">√</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">_</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Number">1</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">−</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">_</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">α</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Base"> </span>, we can further simplify the formula to <span class="No-Break">the following:</span></p>
			<p><span class="_-----MathTools-_Math_Variable">L</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">s</span><span class="_-----MathTools-_Math_Variable">i</span><span class="_-----MathTools-_Math_Variable">m</span><span class="_-----MathTools-_Math_Variable">p</span><span class="_-----MathTools-_Math_Variable">l</span><span class="_-----MathTools-_Math_Variable">e</span><span class="_-----MathTools-_Math_Base">(</span><span class="_-----MathTools-_Math_Variable">θ</span><span class="_-----MathTools-_Math_Variable">)</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator_Extended">≔</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Symbol_Extended">𝔼</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Operator">,</span><span class="_-----MathTools-_Math_Text">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Text">0</span><span class="_-----MathTools-_Math_Operator">,</span><span class="_-----MathTools-_Math_Symbol_Extended">ϵ</span><span class="_-----MathTools-_Math_Base">[</span><span class="_-----MathTools-_Math_Base">|</span><span class="_-----MathTools-_Math_Base">|</span><span class="_-----MathTools-_Math_Symbol_Extended">ϵ</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">−</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Symbol_Extended">ϵ</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">θ</span><span class="_-----MathTools-_Math_Base">(</span><span class="_-----MathTools-_Math_Text">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Text">t</span><span class="_-----MathTools-_Math_Operator">,</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Variable">)</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">|</span><span class="_-----MathTools-_Math_Base">|</span><span class="_-----MathTools-_Math_Base"> </span><span class="No-Break"><span class="_-----MathTools-_Math_Number">2</span></span><span class="No-Break"><span class="_-----MathTools-_Math_Base">]</span></span></p>
			<p>The UNet will take a noised<a id="_idIndexMarker124"/> image data: <span class="_-----MathTools-_Math_Text">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Text">t</span> and a time step data: <span class="_-----MathTools-_Math_Variable">t</span> as inputs as shown in <span class="No-Break"><em class="italic">Figure 4</em></span><em class="italic">.7</em>. Why take <span class="_-----MathTools-_Math_Variable">t</span> as input? Because all the denoising processes share the same neural network weights, the input <span class="_-----MathTools-_Math_Variable">t</span> will help train a UNet with a time step <span class="No-Break">in mind.</span></p>
			<div>
				<div id="_idContainer030" class="IMG---Figure">
					<img src="image/B21263_04_07.jpg" alt="Figure 4.7: UNet training inputs and loss calculation"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.7: UNet training inputs and loss calculation</p>
			<p>When we say let’s train a neural network to predict the noise distribution that will be removed from the image leading to a clearer image, what is the neural network predicting? In the DDPM paper [4], the original diffusion model uses a fixed variance <span class="_-----MathTools-_Math_Variable">θ</span>, and sets the Gaussian distribution mean - <span class="_-----MathTools-_Math_Variable">μ</span> as the only parameter that needs to be learned through a <span class="No-Break">neural network.</span></p>
			<p>In a PyTorch implementation, the loss data can be calculated <span class="No-Break">like this:</span></p>
			<pre class="source-code">
import torch
import torch.nn as nn
# code prepare the model object, image and timestep
# ...
# noise is the Ɛ ~ N(0,1) with the shape of the image x_t.
noise = torch.randn_like(x_t)
# x_t is the noised image at step "t", together with the time_step value
predicted_noise = model(x_t, time_step)
loss = nn.MSELoss(noise, predicted_noise)
# backward weight propagation
# ...</pre>
			<p>Now, we should be able to<a id="_idIndexMarker125"/> train a diffusion model and the model should be able to recover an image from a random Gaussian distributed noise. Next, let’s take a look at how the inference or <span class="No-Break">samp<a id="_idTextAnchor089"/>ling works.</span></p>
			<h1 id="_idParaDest-58"><a id="_idTextAnchor090"/>The noise-to-image sampling process</h1>
			<p>Here are the steps to sample <a id="_idIndexMarker126"/>an image from the model, or, in other words, generate an image from the reverse <span class="No-Break">diffusion process:</span></p>
			<ol>
				<li>Generate a complete Gaussian noise with a mean of 0 and a variance <span class="No-Break">of 1:</span></li>
			</ol>
			<p><span class="_-----MathTools-_Math_Text">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Text">T</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator_Extended">∼</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base"> </span><span class="No-Break">𝒩</span><span class="No-Break"><span class="_-----MathTools-_Math_Base">(</span></span><span class="No-Break"><span class="_-----MathTools-_Math_Number">0,1</span></span><span class="No-Break"><span class="_-----MathTools-_Math_Number">)</span></span></p>
			<p class="list-inset">We will use this noise as the <span class="No-Break">starting image.</span></p>
			<p>2.	Loop through <span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">=</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">T</span> to <span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">=</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Number">1</span>. In each step, if <span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">&gt;</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Number">1</span>, then generate another Gaussian noise <span class="No-Break">image </span><span class="No-Break"><span class="_-----MathTools-_Math_Text">z</span></span><span class="No-Break">:</span></p>
			<p><span class="_-----MathTools-_Math_Text">z</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator_Extended">∼</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base"> </span><span class="No-Break">𝒩</span><span class="No-Break"><span class="_-----MathTools-_Math_Base">(</span></span><span class="No-Break"><span class="_-----MathTools-_Math_Number">0,1</span></span><span class="No-Break"><span class="_-----MathTools-_Math_Number">)</span></span></p>
			<p class="list-inset">If <span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">=</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Number">1</span>, then the <span class="No-Break">following occurs:</span></p>
			<p><span class="_-----MathTools-_Math_Text">z</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">=</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Number">0</span></p>
			<p class="list-inset">Then, generate a noise from the UNet model, and remove the generated noise from the input noisy image <span class="No-Break"><span class="_-----MathTools-_Math_Text">x</span></span><span class="No-Break"><span class="_-----MathTools-_Math_Base"> </span></span><span class="No-Break"><span class="_-----MathTools-_Math_Text">t</span></span><span class="No-Break">:</span></p>
			<p class="IMG---Figure"><span class="_-----MathTools-_Math_Text">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Text">t-1</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">=</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Number">1</span><span class="_-----MathTools-_Math_Number"> </span><span class="_-----MathTools-_Math_Base">_</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">√</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">_</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">α</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">(</span><span class="_-----MathTools-_Math_Text">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Text">t</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">−</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Number">1</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">−</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">α</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">_</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">√</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">_</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Number">1</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">−</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">_</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">α</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Symbol_Extended">ϵ</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">θ</span><span class="_-----MathTools-_Math_Base">(</span><span class="_-----MathTools-_Math_Text">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Text">t</span><span class="_-----MathTools-_Math_Operator">,</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Variable">)</span><span class="_-----MathTools-_Math_Base">)</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">+</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">√</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">_</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Number">1</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">−</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">α</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Text">z</span></p>
			<p class="list-inset">If we take a look at the preceding equation, all those <span class="_-----MathTools-_Math_Variable">α</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span> and <span class="_-----MathTools-_Math_Variable">α</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Symbol_Extended">‾</span><span class="_-----MathTools-_Math_Symbol_Extended"> </span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span> are known numbers sourced from <span class="_-----MathTools-_Math_Variable">β</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span>. The only thing we need from the UNet is the <span class="_-----MathTools-_Math_Symbol_Extended">ϵ</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">θ</span><span class="_-----MathTools-_Math_Base">(</span><span class="_-----MathTools-_Math_Text">x</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Text">t</span><span class="_-----MathTools-_Math_Operator">,</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Variable">)</span>, which is the noise produced by the UNet, as shown in <span class="No-Break"><em class="italic">Figure 4</em></span><span class="No-Break"><em class="italic">.8</em></span><span class="No-Break">.</span></p>
			<div>
				<div id="_idContainer031" class="IMG---Figure">
					<img src="image/B21263_04_08.jpg" alt="Figure 4.8: Sampling from UNet"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.8: Sampling from UNet</p>
			<p class="list-inset">The added <span class="_-----MathTools-_Math_Base">√</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base">_</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Number">1</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Operator">−</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">α</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Variable">t</span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Base"> </span><span class="_-----MathTools-_Math_Text">z</span> looks a little bit mysterious here. Why add this to the process? The original paper doesn’t explain this added noise, but researchers found that the added <a id="_idIndexMarker127"/>noise in the denoising process will significantly improve the generated <span class="No-Break">image quality!</span></p>
			<p>3.	Loop end, return the final generated image <span class="No-Break"><span class="_-----MathTools-_Math_Text">x</span></span><span class="No-Break"><span class="_-----MathTools-_Math_Base"> </span></span><span class="No-Break"><span class="_-----MathTools-_Math_Text">0</span></span><span class="No-Break">.</span></p>
			<p>Now, let’s talk about the image <span class="No-Break">generati<a id="_idTextAnchor091"/>on guidance.</span></p>
			<h1 id="_idParaDest-59"><a id="_idTextAnchor092"/>Understanding Classifier Guidance denoising</h1>
			<p>Until now, we haven’t talked<a id="_idIndexMarker128"/> about the text guidance yet. The image generation process will take a random Gaussian noise as the only input, and then randomly generate an image based on the training dataset. But we want a guided image generation; for example, input “dog” to ask the diffusion model to generate an image <span class="No-Break">including “dog.”</span></p>
			<p>In 2021, Dhariwal and Nichol, from OpenAI, proposed classifier guidance in their paper titled <em class="italic">Diffusion Models Beat GANs on Image </em><span class="No-Break"><em class="italic">Synthesis</em></span><span class="No-Break"> [12].</span></p>
			<p>Based on the proposed methodology, we can achieve classifier-guided denoising by providing a classification label <a id="_idIndexMarker129"/>during the training stage. Instead of just image or time-step embedding, we also provide text description embeddings as shown in <span class="No-Break"><em class="italic">Figure 4</em></span><span class="No-Break"><em class="italic">.9</em></span><span class="No-Break">.</span></p>
			<div>
				<div id="_idContainer032" class="IMG---Figure">
					<img src="image/B21263_04_09.jpg" alt="Figure 4.9: Train a diffusion model with conditional text"/>
				</div>
			</div>
			<p class="IMG---Caption" lang="en-US" xml:lang="en-US">Figure 4.9: Train a diffusion model with conditional text</p>
			<p>In <span class="No-Break"><em class="italic">Figure 4</em></span><em class="italic">.7</em>, there are two inputs, while in <span class="No-Break"><em class="italic">Figure 4</em></span><em class="italic">.9</em>, there is one additional input –  <strong class="bold">Text embedding</strong>; it is the embedding data generated from OpenAI’s CLIP model. We will discuss the way more powerful CLIP model guided diffusion model in the <a id="_idTextAnchor093"/><span class="No-Break">next chapter.</span></p>
			<h1 id="_idParaDest-60"><a id="_idTextAnchor094"/>Summary</h1>
			<p>In this chapter, we took a deep dive into the internal workings of the diffusion model initially brought out by Jonathan Ho et al. [4]. We learned about the foundational ideas of the diffusion model and learned about the forward diffusion process. We also walked through the reverse diffusion process for diffusion model training and sampling and explored how to enable a text-guided <span class="No-Break">diffusion model.</span></p>
			<p>Through this chapter, we aimed to explain the core idea of the diffusion model. If you want to implement a diffusion model by yourself, I would recommend reading through the original DDPM <span class="No-Break">paper directly.</span></p>
			<p>The DDPM diffusion model can generate realistic images, but one of its problems is its performance. Not only is training a model slow, but the image sampling is also slow. In the next chapter, we are going to discuss the Stable Diffusion model, which will boost the speed in <a id="_idTextAnchor095"/>a <span class="No-Break">genius way.</span></p>
			<h1 id="_idParaDest-61"><a id="_idTextAnchor096"/>References</h1>
			<ol>
				<li><em class="italic">The Annotated Diffusion Model</em> – <a href="https://colab.research.google.com/github/huggingface/notebooks/blob/main/examples/annotated_diffusion.ipynb#scrollTo=c5a94671&#13;"><span class="No-Break">https://colab.research.google.com/github/huggingface/notebooks/blob/main/examples/annotated_diffusion.ipynb#scrollTo=c5a94671</span></a></li>
				<li><em class="italic">Training with Diffusers</em> – <a href="https://colab.research.google.com/gist/anton-l/f3a8206dae4125b93f05b1f5f703191d/diffusers_training_example.ipynb">https://colab.research.google.com/gist/anton-l/f3a8206dae4125b93f05b1f5f703191d/diffusers_training_example.ipynb</a> </li>
				<li><em class="italic">Diffusers</em> – <a href="https://colab.research.google.com/github/huggingface/notebooks/blob/main/diffusers/diffusers_intro.ipynb#scrollTo=PzW5ublpBuUt&#13;"><span class="No-Break">https://colab.research.google.com/github/huggingface/notebooks/blob/main/diffusers/diffusers_intro.ipynb#scrollTo=PzW5ublpBuUt</span></a></li>
				<li>Jonathan Ho et al., <em class="italic">Denoising Diffusion Probabilistic Models</em> – <a href="https://arxiv.org/abs/2006.11239"><span class="No-Break">https://arxiv.org/abs/2006.11239</span></a></li>
				<li>Steins, <em class="italic">Diffusion Model Clearly Explained!</em> – <a href="https://medium.com/@steinsfu/diffusion-model-clearly-explained-cd331bd41166"><span class="No-Break">https://medium.com/@steinsfu/diffusion-model-clearly-explained-cd331bd41166</span></a></li>
				<li>Steins, <em class="italic">Stable Diffusion Clearly Explained!</em> – <a href="https://medium.com/@steinsfu/stable-diffusion-clearly-explained-ed008044e07e"><span class="No-Break">https://medium.com/@steinsfu/stable-diffusion-clearly-explained-ed008044e07e</span></a></li>
				<li>DeepFindr, <em class="italic">Diffusion models from scratch in PyTorch</em> – <a href="https://www.youtube.com/watch?v=a4Yfz2FxXiY&amp;t=5s&amp;ab_channel=DeepFindr&#13;"><span class="No-Break">https://www.youtube.com/watch?v=a4Yfz2FxXiY&amp;t=5s&amp;ab_channel=DeepFindr</span></a></li>
				<li>Ari Seff, <em class="italic">What are Diffusion Models?</em> – <a href="https://www.youtube.com/watch?v=fbLgFrlTnGU&amp;ab_channel=AriSeff&#13;"><span class="No-Break">https://www.youtube.com/watch?v=fbLgFrlTnGU&amp;ab_channel=AriSeff</span></a></li>
				<li>Prafulla Dhariwal, Alex Nichol<em class="italic">, Diffusion Models Beat GANs on Image Synthesis</em> – <a href="https://arxiv.org/abs/2105.05233"><span class="No-Break">https://arxiv.org/abs/2105.05233</span></a></li>
				<li>Diederik P Kingma, Max Welling, <em class="italic">Auto-Encoding Variational Bayes</em> – <a href="https://arxiv.org/abs/1312.6114"><span class="No-Break">https://arxiv.org/abs/1312.6114</span></a></li>
				<li>Lilian Weng, <em class="italic">What are Diffusion Models?</em> – <a href="https://lilianweng.github.io/posts/2021-07-11-diffusion-models/"><span class="No-Break">https://lilianweng.github.io/posts/2021-07-11-diffusion-models/</span></a></li>
				<li>Prafulla Dhariwal, Alex Nichol, <em class="italic">Diffusion Models Beat GANs on Image Synthesis</em> – <a href="https://arxiv.org/abs/2105.05233"><span class="No-Break">https://arxiv.org/abs/2105.05233</span></a></li>
			</ol>
		</div>
	</body></html>