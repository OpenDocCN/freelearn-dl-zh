<html><head></head><body>
  <div><h1 class="chapter-number" id="_idParaDest-216">
    <a id="_idTextAnchor218">
    </a>
    
     11
    
   </h1>
   <h1 id="_idParaDest-217">
    <a id="_idTextAnchor219">
    </a>
    
     Understanding the Environment Query System
    
   </h1>
   <p>
    
     The
    
    <strong class="bold">
     
      Environment Query System
     
    </strong>
    
     (
    
    <strong class="bold">
     
      EQS
     
    </strong>
    
     ) in
    
    <a id="_idIndexMarker557">
    </a>
    
     Unreal Engine is a powerful feature within the AI framework that allows developers to collect data about the virtual environment by letting AI agents query the environment and make informed decisions based on the returned results.
    
    
     In this chapter, you will learn how to properly set up an environment query and how to integrate it inside the behavior tree of an
    
    
     
      AI agent.
     
    
   </p>
   <p>
    
     By mastering the EQS, you’ll gain the power to create intelligent AI systems that can make informed decisions based on their surroundings.
    
    
     Whether it’s finding the best vantage point, locating crucial resources, or strategizing for optimal gameplay, the EQS opens a world of possibilities.
    
    
     While still an experimental feature, learning about the EQS will let you create intelligent and dynamic AI systems in
    
    
     
      Unreal Engine.
     
    
   </p>
   <p>
    
     In this chapter, we will be covering the
    
    
     
      following topics:
     
    
   </p>
   <ul>
    <li>
     
      Introducing the Environment
     
     
      
       Query System
      
     
    </li>
    <li>
     
      Setting up an
     
     
      
       environment query
      
     
    </li>
    <li>
     
      Handling environment queries within a
     
     
      
       behavior tree
      
     
    </li>
    <li>
     
      Displaying
     
     
      
       EQS information
      
     
    </li>
   </ul>
   <h1 id="_idParaDest-218">
    <a id="_idTextAnchor220">
    </a>
    
     Technical requirements
    
   </h1>
   <p>
    
     To follow the topics presented in this chapter, you should have completed the previous ones and understood
    
    
     
      their content.
     
    
   </p>
   <p>
    
     Additionally, if you would prefer to begin with code from the companion repository for this book, you can download the
    
    <strong class="source-inline">
     
      .zip
     
    </strong>
    
     project files provided in this book’s companion project
    
    
     
      repository:
     
    
    <a href="https://github.com/PacktPublishing/Artificial-Intelligence-in-Unreal-Engine-5">
     
      
       https://github.com/PacktPublishing/Artificial-Intelligence-in-Unreal-Engine-5
      
     
    </a>
    
     
      .
     
    
   </p>
   <p>
    
     To download the files from the end of the last chapter, click the
    
    <strong class="source-inline">
     
      Unreal Agility Arena –
     
    </strong>
    
     <strong class="source-inline">
      
       Chapter 10
      
     </strong>
    
    <strong class="source-inline">
     
      -
     
    </strong>
    
     <strong class="source-inline">
      
       End
      
     </strong>
    
    
     
      link.
     
    
   </p>
   <h1 id="_idParaDest-219">
    <a id="_idTextAnchor221">
    </a>
    
     Introducing the Environment Query System
    
   </h1>
   <p>
    
     Well, it seems Dr.
    
    
     Markus is making some progress in his
    
    
     
      secret lab:
     
    
   </p>
   <p>
    <em class="italic">
     
      Deep within the hidden confines of their secret laboratory, Dr.
     
     
      Markus and Professor Viktoria toiled tirelessly on their latest endeavor; they were determined to revolutionize their AI dummy puppets by granting them the ability to analyze and probe their environment in
     
    </em>
    
     <em class="italic">
      
       unprecedented ways.
      
     </em>
    
   </p>
   <p>
    <em class="italic">
     
      With their minds brimming with excitement, Dr.
     
     
      Markus and Professor Viktoria meticulously crafted intricate algorithms as they imbued their creations with an insatiable hunger for knowledge, equipping them with experimental methods to observe and interact with the world around them.
     
     
      As the AI dummy puppets awakened, their eyes flickered with a newfound spark of intelligence, each one exploring its surroundings and analyzing
     
    </em>
    
     <em class="italic">
      
       the environment.
      
     </em>
    
   </p>
   <p>
    
     Unreal Engine’s
    
    <a id="_idIndexMarker558">
    </a>
    
     EQS is a powerful tool that allows developers to define complex queries to gather information about the game world.
    
    
     The EQS enables developers to create AI behaviors that can dynamically adapt to changing environmental conditions.
    
    
     By using the EQS, NPCs or other game entities can make intelligent decisions based on their surroundings.
    
    
     With its flexibility and ease of use, the EQS is a valuable feature in Unreal Engine for creating immersive and interactive
    
    
     
      gameplay experiences.
     
    
   </p>
   <p>
    
     With the EQS, you can inquire about gathered data using a set of
    
    <strong class="bold">
     
      tests
     
    </strong>
    
     that will generate elements that align most closely with the nature of the
    
    
     
      query posed.
     
    
   </p>
   <p>
    
     An
    
    <strong class="bold">
     
      EQS query
     
    </strong>
    
     can
    
    <a id="_idIndexMarker559">
    </a>
    
     be triggered inside a behavior tree – or, alternatively, through scripting – to guide decisions based on the result of tests.
    
    
     These queries mainly consist
    
    <a id="_idIndexMarker560">
    </a>
    
     of
    
    <strong class="bold">
     
      generators
     
    </strong>
    
     (elements that determine the locations or actors to
    
    <a id="_idIndexMarker561">
    </a>
    
     be tested and weighted) and
    
    <strong class="bold">
     
      contexts
     
    </strong>
    
     (elements that provide a reference frame for tests or generators).
    
    
     EQS queries empower AI characters to locate optimal positions for tasks such as attacking a player with a line of sight, retrieving health or ammo pickups, or seeking the nearest cover point, among
    
    
     
      other options.
     
    
   </p>
   <p>
    
     Let’s start by examining all these elements
    
    
     
      in detail.
     
    
   </p>
   <h2 id="_idParaDest-220">
    <a id="_idTextAnchor222">
    </a>
    
     Explaining generators
    
   </h2>
   <p>
    
     A generator
    
    <a id="_idIndexMarker562">
    </a>
    
     creates the locations or actors – known as
    
    <strong class="bold">
     
      items
     
    </strong>
    
     – that will undergo testing and weighting; the result will be returned to the
    
    <a id="_idIndexMarker563">
    </a>
    
     behavior tree to which the query
    
    <a id="_idIndexMarker564">
    </a>
    
     belongs.
    
    
     Generators that are available out of the box are
    
    
     
      as follows:
     
    
   </p>
   <ul>
    <li>
     <strong class="bold">
      
       Actors of Class
      
     </strong>
     
      : This will find all actors of a given class returning them as items
     
     
      
       for tests
      
     
    </li>
    <li>
     <strong class="bold">
      
       Composite
      
     </strong>
     
      : This will let you create an array of generators and use them
     
     
      
       for tests
      
     
    </li>
    <li>
     <strong class="bold">
      
       Current Location
      
     </strong>
     
      : This will let you get the location of a specified context and use it to
     
     
      
       validate tests
      
     
    </li>
    <li>
     <strong class="bold">
      
       Points
      
     </strong>
     
      : Generators can be used to create shape-based traces –
     
     <strong class="bold">
      
       Circle
      
     </strong>
     
      ,
     
     <strong class="bold">
      
       Cone
      
     </strong>
     
      ,
     
     <strong class="bold">
      
       Donut
      
     </strong>
     
      ,
     
     <strong class="bold">
      
       Grid
      
     </strong>
     
      , and
     
     <strong class="bold">
      
       Pathing Grid
      
     </strong>
     
      – around a
     
     
      
       predefined location
      
     
    </li>
   </ul>
   <p>
    
     What’s more, you may implement your own by extending the
    
    <strong class="source-inline">
     
      EnvQueryGenerator
     
    </strong>
    
     class (if developing in C++) or
    
    <strong class="source-inline">
     
      EnvQueryGenerator_BlueprintBase
     
    </strong>
    
     (if developing
    
    
     
      with Blueprints).
     
    
   </p>
   <p class="callout-heading">
    
     Note
    
   </p>
   <p class="callout">
    
     Generators created in C++ typically run faster than those developed
    
    
     
      in Blueprints.
     
    
   </p>
   <h2 id="_idParaDest-221">
    <a id="_idTextAnchor223">
    </a>
    
     Explaining contexts
    
   </h2>
   <p>
    
     A context supplies a point of
    
    <a id="_idIndexMarker565">
    </a>
    
     reference for the different tests and generators and can range from the
    
    <strong class="bold">
     
      querier
     
    </strong>
    
     – the pawn currently possessed by the AI controller executing the
    
    <a id="_idIndexMarker566">
    </a>
    
     behavior tree – to more complex scenarios involving all actors of a certain type.
    
    
     A generator, such as
    
    <strong class="bold">
     
      Points: Circle
     
    </strong>
    
     , can use a context that will provide multiple locations
    
    
     
      or actors.
     
    
   </p>
   <p>
    
     Available
    
    <strong class="source-inline">
     
      Context
     
    </strong>
    
     classes are
    
    
     
      as follows:
     
    
   </p>
   <ul>
    <li>
     <strong class="bold">
      
       EnvQueryContext_Item
      
     </strong>
     
      : This represents either a location – as a vector – or
     
     
      
       an actor
      
     
    </li>
    <li>
     <strong class="bold">
      
       EnvQueryContext_Querier
      
     </strong>
     
      : This represents the querier executing the
     
     
      
       behavior tree
      
     
    </li>
   </ul>
   <p>
    
     As you may
    
    <a id="_idIndexMarker567">
    </a>
    
     have guessed, you may implement your own context by extending
    
    <a id="_idIndexMarker568">
    </a>
    
     the
    
    <strong class="source-inline">
     
      EnvQueryContext
     
    </strong>
    
     class if developing in C++ or
    
    <strong class="source-inline">
     
      EnvQueryContext_BlueprintBase
     
    </strong>
    
     if developing
    
    
     
      with Blueprints.
     
    
   </p>
   <h2 id="_idParaDest-222">
    <a id="_idTextAnchor224">
    </a>
    
     Explaining tests
    
   </h2>
   <p>
    
     A test
    
    <a id="_idIndexMarker569">
    </a>
    
     determines
    
    <a id="_idIndexMarker570">
    </a>
    
     the criteria used by the
    
    <strong class="bold">
     
      environment query
     
    </strong>
    
     – the actual request to the environment – to select the optimal Item from the generator, given
    
    
     
      a context.
     
    
   </p>
   <p>
    
     Some of the out-of-the-box available tests are
    
    
     
      as follows:
     
    
   </p>
   <ul>
    <li>
     <strong class="bold">
      
       Distance
      
     </strong>
     
      : This will return the distance between the item location and
     
     
      
       another location
      
     
    </li>
    <li>
     <strong class="bold">
      
       Overlap: Box
      
     </strong>
     
      : This can be used to check whether an item is within the bounds defined by the
     
     
      
       test itself
      
     
    </li>
    <li>
     <strong class="bold">
      
       PathExists: from Querier
      
     </strong>
     
      : This can be used to check whether a path to the context exists and will return some useful information about it, such as how long the
     
     
      
       path is
      
     
    </li>
   </ul>
   <p>
    
     You may implement your own tests by extending the
    
    <strong class="source-inline">
     
      EnvQueryTest
     
    </strong>
    
     class both in C++
    
    
     
      and Blueprints.
     
    
   </p>
   <p>
    
     Now that you have acquired a basic understanding of the main EQS elements, it is time to delve deeper and begin implementing a fully working and effective AI agent
    
    
     
      with it.
     
    
   </p>
   <h1 id="_idParaDest-223">
    <a id="_idTextAnchor225">
    </a>
    
     Setting up an environment query
    
   </h1>
   <p>
    
     In this section, you’ll be learning how to add a query to a behavior tree; in particular, we will be tweaking the dummy gunner AI brain in order to let it shoot at a target achieved by an
    
    
     
      environment query.
     
    
   </p>
   <p class="callout-heading">
    
     Note
    
   </p>
   <p class="callout">
    
     As previously mentioned, the EQS is still an experimental feature, so you should use caution if you want to develop a game using it.
    
    
     At the time of writing this book, the EQS is enabled by default by using
    
    <a id="_idIndexMarker571">
    </a>
    
     the
    
    <strong class="bold">
     
      Environment Query
     
    </strong>
    
     <strong class="bold">
      
       Editor
      
     </strong>
    
    
     
      plugin.
     
    
   </p>
   <h2 id="_idParaDest-224">
    <a id="_idTextAnchor226">
    </a>
    
     Creating the gym
    
   </h2>
   <p>
    
     As a first step, we are going to
    
    <a id="_idIndexMarker572">
    </a>
    
     create a proper gym, so start by doing
    
    
     
      the following:
     
    
   </p>
   <ol>
    <li>
     
      Create a level of your choice, starting from the Level Instances and Packed Level Actors, which I provided in the
     
     
      
       project template.
      
     
    </li>
    <li>
     
      Add a
     
     <strong class="bold">
      
       BP_GunnerDummyCharacter
      
     </strong>
     
      instance; just remember to check
     
     <strong class="bold">
      
       Use Controller Rotation Yaw
      
     </strong>
     
      so it will be able to rotate and point to the target when prompted to
     
     
      
       do this.
      
     
    </li>
    <li>
     
      Add one or more
     
     <strong class="bold">
      
       BP_Target
      
     </strong>
     
      instances so that your AI character will have a line of sight
     
     
      
       to them.
      
     
    </li>
    <li>
     
      Add some obstacles that will block the line of sight with the AI agent.
     
     
      The final gym should look similar to the one depicted in
     
     
      <em class="italic">
       
        Figure 11
       
      </em>
     
     
      <em class="italic">
       
        .1
       
      </em>
     
     
      
       :
      
     
    </li>
   </ol>
   <div><div><img alt="Figure 11.1 – Finished gym" src="img/Figure_11.1_B31016.jpg"/>
     
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    
     Figure 11.1 – Finished gym
    
   </p>
   <p>
    
     It’s now time to set up the AI controller for the
    
    
     
      AI agent.
     
    
   </p>
   <h2 id="_idParaDest-225">
    <a id="_idTextAnchor227">
    </a>
    
     Creating the AI controller
    
   </h2>
   <p>
    
     The second step is
    
    <a id="_idIndexMarker573">
    </a>
    
     to create a dedicated behavior tree and an AI controller, so do
    
    
     
      the following:
     
    
   </p>
   <ol>
    <li>
     
      In the
     
     <strong class="source-inline">
      
       AI
      
     </strong>
     
      folder, create a new behavior tree and call
     
     
      
       it
      
     
     
      <strong class="source-inline">
       
        BT_EQSGunnerDummy
       
      </strong>
     
     
      
       .
      
     
    </li>
    <li>
     
      In the
     
     <strong class="source-inline">
      
       Blueprints
      
     </strong>
     
      folder, create a new Blueprint class extending from
     
     <strong class="bold">
      
       BaseDummyAIController
      
     </strong>
     
      , name it
     
     <strong class="source-inline">
      
       AIEQSGunnerDummyController
      
     </strong>
     
      , and
     
     
      
       open it.
      
     
    </li>
    <li>
     
      In the
     
     <strong class="bold">
      
       Details
      
     </strong>
     
      panel, look for the
     
     <strong class="bold">
      
       Dummy AI Controller
      
     </strong>
     
      category and set the
     
     <strong class="bold">
      
       Behavior Tree
      
     </strong>
     
      attribute
     
     
      
       to
      
     
     
      <strong class="bold">
       
        BT_EQSGunnerDummy
       
      </strong>
     
     
      
       .
      
     
    </li>
    <li>
     
      Select the gunner dummy in the level and set its
     
     <strong class="bold">
      
       AI Controller Class
      
     </strong>
     
      attribute
     
     
      
       to
      
     
     
      <strong class="bold">
       
        AIEQSGunnerDummyController
       
      </strong>
     
     
      
       .
      
     
    </li>
   </ol>
   <p>
    
     Now that the AI controller and its controller character are properly set, it’s time to set up an environment query that we will be using in the
    
    
     
      behavior tree.
     
    
   </p>
   <h2 id="_idParaDest-226">
    <a id="_idTextAnchor228">
    </a>
    
     Creating an environment query
    
   </h2>
   <p>
    
     We are now going to
    
    <a id="_idIndexMarker574">
    </a>
    
     create an environment query that will look for a viable target in the level.
    
    
     This is going to be pretty similar to the
    
    <strong class="bold">
     
      FindAvailableTarget
     
    </strong>
    
     task we implemented in
    
    <a href="B31016_09.xhtml#_idTextAnchor170">
     
      <em class="italic">
       
        Chapter 9
       
      </em>
     
    </a>
    
     ,
    
    <em class="italic">
     
      Extending Behavior Trees
     
    </em>
    
     , with a couple of differences; we will be searching for instances of a particular class and the target will need to be in line of sight with the gunner.
    
    
     Additionally, we won’t be writing a single line of code.
    
    
     So, let’s start by doing the
    
    
     
      following steps:
     
    
   </p>
   <ol>
    <li>
     
      In the
     
     <strong class="source-inline">
      
       AI
      
     </strong>
     
      folder, right-right click and select
     
     <strong class="bold">
      
       Artificial Intelligence
      
     </strong>
     
      |
     
     <strong class="bold">
      
       Environment Query
      
     </strong>
     
      to create one
     
     
      
       such asset.
      
     
    </li>
    <li>
     
      Name the newly created asset
     
     <strong class="source-inline">
      
       EQS_FindTarget
      
     </strong>
     
      and
     
     
      
       open it.
      
     
     <p class="list-inset">
      
       You will be presented with a graph named
      
      <strong class="bold">
       
        Query Graph
       
      </strong>
      
       (pretty similar to the behavior tree one) that will let you implement your
      
      
       
        own query.
       
      
     </p>
    </li>
    <li>
     
      Click and drag from the
     
     <strong class="bold">
      
       ROOT
      
     </strong>
     
      node and add an
     
     <strong class="bold">
      
       Actors of Class
      
     </strong>
     
      
       generator node.
      
     
    </li>
    <li>
     
      Select the newly created node and, in the
     
     <strong class="bold">
      
       Details
      
     </strong>
     
      panel, do
     
     
      
       the following:
      
     
     <ul>
      <li>
       
        Set the
       
       <strong class="bold">
        
         Searched Actor Class
        
       </strong>
       
        attribute
       
       
        
         to
        
       
       
        <strong class="bold">
         
          BP_Target
         
        </strong>
       
      </li>
      <li>
       
        Set the
       
       <strong class="bold">
        
         Search Radius
        
       </strong>
       
        attribute
       
       
        
         to
        
       
       
        <strong class="source-inline">
         
          3000.0
         
        </strong>
       
      </li>
     </ul>
    </li>
    <li>
     
      Right-click on the
     
     <strong class="bold">
      
       ActorsOfClass
      
     </strong>
     
      node and select
     
     <strong class="bold">
      
       Add Test
      
     </strong>
     
      |
     
     <strong class="bold">
      
       Trace
      
     </strong>
     
      ; a test will be added inside
     
     
      
       the node.
      
     
    </li>
    <li>
     
      Select the test and, in the
     
     <strong class="bold">
      
       Details
      
     </strong>
     
      panel, do
     
     
      
       the following:
      
     
     <ul>
      <li>
       
        Set the
       
       <strong class="bold">
        
         Test Purpose
        
       </strong>
       
        attribute to
       
       
        <strong class="bold">
         
          Filter Only
         
        </strong>
       
      </li>
      <li>
       
        Set the
       
       <strong class="bold">
        
         Item Height Offset
        
       </strong>
       
        attribute
       
       
        
         to
        
       
       
        <strong class="source-inline">
         
          50.0
         
        </strong>
       
      </li>
      <li>
       
        Set the
       
       <strong class="bold">
        
         Context Height Offset
        
       </strong>
       
        attribute
       
       
        
         to
        
       
       
        <strong class="source-inline">
         
          50.0
         
        </strong>
       
      </li>
     </ul>
    </li>
    <li>
     
      Uncheck
     
     <a id="_idIndexMarker575">
     </a>
     
      the
     
     <strong class="bold">
      
       Bool
      
     </strong>
     
      <strong class="bold">
       
        Match
       
      </strong>
     
     
      
       attribute.
      
     
    </li>
   </ol>
   <p>
    
     The complete graph for the environment query is depicted in
    
    
     <em class="italic">
      
       Figure 11
      
     </em>
    
    
     <em class="italic">
      
       .2
      
     </em>
    
    
     
      :
     
    
   </p>
   <div><div><img alt="Figure 11.2 – Finished environment query" src="img/Figure_11.2_B31016.jpg"/>
     
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    
     Figure 11.2 – Finished environment query
    
   </p>
   <p>
    
     What we have done here obviously needs some explanation; we have added a generator that will look for all actors of a certain class –
    
    <strong class="bold">
     
      BP_Target
     
    </strong>
    
     – that are near the querier (the AI agent executing this environment query).
    
    
     Only the items that are in line of sight with the queries will pass the trace test and so they will be the only ones that will be considered for selecting a viable target.
    
    <strong class="bold">
     
      Test Purpose
     
    </strong>
    
     has been set to
    
    <strong class="bold">
     
      Filter Only
     
    </strong>
    
     because we only need to
    
    <a id="_idIndexMarker576">
    </a>
    
     have a list of Items and are not interested in their importance – or
    
    <strong class="bold">
     
      score
     
    </strong>
    
     – in
    
    
     
      the search.
     
    
   </p>
   <p>
    
     Now that the environment query has been defined, we can start implementing the
    
    
     
      behavior tree.
     
    
   </p>
   <h1 id="_idParaDest-227">
    <a id="_idTextAnchor229">
    </a>
    
     Handling environment queries within a behavior tree
    
   </h1>
   <p>
    
     We are
    
    <a id="_idIndexMarker577">
    </a>
    
     now ready to implement the
    
    <a id="_idIndexMarker578">
    </a>
    
     behavior tree, which, as you will see, shows some similarities with the
    
    <strong class="bold">
     
      BT_GunnerDummy
     
    </strong>
    
     asset; the only difference is the way we get possible targets.
    
    
     For this reason, we will be using the same Blackboard as
    
    <strong class="bold">
     
      BT_GunnerDummy
     
    </strong>
    
     .
    
    
     So, without further ado, open
    
    <strong class="bold">
     
      BT_EQSGunnerDummy
     
    </strong>
    
     and, in the
    
    <strong class="bold">
     
      Details
     
    </strong>
    
     panel, set the
    
    <strong class="bold">
     
      Blackboard Asset
     
    </strong>
    
     attribute
    
    
     
      to
     
    
    
     <strong class="bold">
      
       BB_GunnerDummy
      
     </strong>
    
    
     
      .
     
    
   </p>
   <p>
    
     Now, focus on the behavior tree graph and do the
    
    
     
      following steps:
     
    
   </p>
   <ol>
    <li>
     
      Add a
     
     <strong class="bold">
      
       Selector
      
     </strong>
     
      node to the
     
     <strong class="bold">
      
       ROOT
      
     </strong>
     
      node and name it
     
     
      <strong class="source-inline">
       
        Root Selector
       
      </strong>
     
     
      
       .
      
     
    </li>
    <li>
     
      Add a
     
     <strong class="bold">
      
       Sequence
      
     </strong>
     
      node to the
     
     <strong class="bold">
      
       Root Selector
      
     </strong>
     
      node and name it
     
     
      <strong class="source-inline">
       
        Shoot Sequence
       
      </strong>
     
     
      
       .
      
     
    </li>
    <li>
     
      Add a
     
     <strong class="bold">
      
       Blackboard
      
     </strong>
     
      decorator to the
     
     <strong class="bold">
      
       Shoot Sequence
      
     </strong>
     
      node and name it
     
     <strong class="source-inline">
      
       Has Ammo?
      
     </strong>
     
      .
     
     
      In the
     
     <strong class="bold">
      
       Details
      
     </strong>
     
      panel, do
     
     
      
       the following:
      
     
     <ul>
      <li>
       
        Set the
       
       <strong class="bold">
        
         Notify Observers
        
       </strong>
       
        attribute to
       
       <strong class="bold">
        
         On
        
       </strong>
       
        <strong class="bold">
         
          Value Change
         
        </strong>
       
      </li>
      <li>
       
        Set the
       
       <strong class="bold">
        
         Key Query
        
       </strong>
       
        attribute to
       
       <strong class="bold">
        
         Is
        
       </strong>
       
        <strong class="bold">
         
          Not Set
         
        </strong>
       
      </li>
      <li>
       
        Set the
       
       <strong class="bold">
        
         Blackboard Key
        
       </strong>
       
        attribute
       
       
        
         to
        
       
       
        <strong class="bold">
         
          NeedsReload
         
        </strong>
       
      </li>
     </ul>
     <p class="list-inset">
      
       The graph so far should look like the one shown in
      
      
       <em class="italic">
        
         Figure 11
        
       </em>
      
      
       <em class="italic">
        
         .3
        
       </em>
      
      
       
        :
       
      
     </p>
    </li>
   </ol>
   <div><div><img alt="Figure 11.3 – Starting graph" src="img/Figure_11.3_B31016.jpg"/>
     
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    
     Figure 11.3 – Starting graph
    
   </p>
   <p class="list-inset">
    
     Now, let’s connect the environment query to
    
    
     
      the graph.
     
    
   </p>
   <ol>
    <li value="4">
     
      Add a
     
     <strong class="bold">
      
       Run EQSQuery
      
     </strong>
     
      task to
     
     <strong class="bold">
      
       Shoot Sequence
      
     </strong>
     
      and name it
     
     <strong class="source-inline">
      
       Find
      
     </strong>
     
      <strong class="source-inline">
       
        Visible Target
       
      </strong>
     
     
      
       .
      
     
    </li>
    <li>
     
      With the task selected, do the
     
     
      
       following steps:
      
     
     <ul>
      <li>
       
        Set the
       
       <strong class="bold">
        
         Query Template
        
       </strong>
       
        attribute
       
       
        
         to
        
       
       
        <strong class="bold">
         
          EQS_FindTarget
         
        </strong>
       
       
        
         .
        
       
      </li>
      <li>
       
        Set the
       
       <strong class="bold">
        
         Run Mode
        
       </strong>
       
        attribute to
       
       <strong class="bold">
        
         Single Random Item from
        
       </strong>
       
        <strong class="bold">
         
          Best 25%
         
        </strong>
       
       
        
         .
        
       
      </li>
      <li>
       
        Set the
       
       <strong class="bold">
        
         Blackboard Key
        
       </strong>
       
        attribute
       
       
        
         to
        
       
       
        <strong class="bold">
         
          TargetActor
         
        </strong>
       
       
        
         .
        
       
      </li>
     </ul>
     <p class="list-inset">
      
       What we are doing here is executing the environment query and, once the resulting items are returned, we select a random one and assign it to the
      
      <strong class="bold">
       
        TargetActor
       
      </strong>
      
       key of the Blackboard so it will be available to the behavior tree.
      
      
       Now, let’s continue our
      
      
       
        AI logic.
       
      
     </p>
    </li>
    <li>
     
      Add
     
     <strong class="bold">
      
       RotateToFaceBBEntry
      
     </strong>
     
      to
     
     <strong class="bold">
      
       Shoot Sequence
      
     </strong>
     
      at the right of the
     
     <strong class="bold">
      
       Find Visible Target
      
     </strong>
     
      node and name it
     
     <strong class="source-inline">
      
       Rotate
      
     </strong>
     
      <strong class="source-inline">
       
        Towards Target
       
      </strong>
     
     
      
       .
      
     
    </li>
    <li>
     
      Select the newly created node and set the
     
     <strong class="bold">
      
       Blackboard Key
      
     </strong>
     
      attribute
     
     
      
       to
      
     
     
      <strong class="bold">
       
        TargetActor
       
      </strong>
     
     
      
       .
      
     
     <p class="list-inset">
      
       You should be already familiar with this portion of the graph; we are simply rotating the AI agent toward the target, in order to be ready
      
      
       
        to shoot.
       
      
     </p>
     <p class="list-inset">
      
       Let’s go
      
      <a id="_idIndexMarker579">
      </a>
      
       on with
      
      <a id="_idIndexMarker580">
      </a>
      
       
        the graph.
       
      
     </p>
    </li>
    <li>
     
      Add a
     
     <strong class="bold">
      
       Play Montage
      
     </strong>
     
      node to the
     
     <strong class="bold">
      
       Shoot Sequence
      
     </strong>
     
      node, at the right of the
     
     <strong class="bold">
      
       Rotate Towards Target
      
     </strong>
     
      node and name it
     
     
      <strong class="source-inline">
       
        Shoot Montage
       
      </strong>
     
     
      
       .
      
     
    </li>
    <li>
     
      Set the
     
     <strong class="bold">
      
       Anim Montage
      
     </strong>
     
      property
     
     
      
       to
      
     
     
      <strong class="bold">
       
        AM_1H_Shoot
       
      </strong>
     
     
      
       .
      
     
    </li>
    <li>
     
      Add a
     
     <strong class="bold">
      
       Set Ammo
      
     </strong>
     
      service to the node and name it
     
     <strong class="source-inline">
      
       Deplete Ammo
      
     </strong>
     
      .
     
     
      In the
     
     <strong class="bold">
      
       Details
      
     </strong>
     
      panel, do the
     
     
      
       following steps:
      
     
     <ul>
      <li>
       
        Set the
       
       <strong class="bold">
        
         Needs Reload
        
       </strong>
       
        property
       
       
        
         to
        
       
       
        <strong class="bold">
         
          NeedsReload
         
        </strong>
       
      </li>
      <li>
       
        Check the
       
       <strong class="bold">
        
         Key
        
       </strong>
       
        <strong class="bold">
         
          Value
         
        </strong>
       
       
        
         property
        
       
      </li>
     </ul>
     <p class="list-inset">
      
       This will start the shooting animation montage and, subsequently, will spawn
      
      
       
        a projectile.
       
      
     </p>
    </li>
    <li>
     
      Add a
     
     <strong class="bold">
      
       Wait
      
     </strong>
     
      task to
     
     <strong class="bold">
      
       Shoot Sequence
      
     </strong>
     
      at the right of the
     
     <strong class="bold">
      
       Shoot Montage
      
     </strong>
     
      node, setting the
     
     <strong class="bold">
      
       Wait Time
      
     </strong>
     
      attribute to
     
     <strong class="source-inline">
      
       2.0
      
     </strong>
     
      and the
     
     <strong class="bold">
      
       Random Deviation
      
     </strong>
     
      attribute
     
     <a id="_idIndexMarker581">
     </a>
     
      to
     
     <strong class="source-inline">
      
       0.5
      
     </strong>
     
      .
     
     
      This portion of the
     
     <a id="_idIndexMarker582">
     </a>
     
      graph should look like the one depicted in
     
     
      <em class="italic">
       
        Figure 11
       
      </em>
     
     
      <em class="italic">
       
        .4
       
      </em>
     
     
      
       :
      
     
    </li>
   </ol>
   <div><div><img alt="Figure 11.4 – Shoot sequence" src="img/Figure_11.4_B31016.jpg"/>
     
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    
     Figure 11.4 – Shoot sequence
    
   </p>
   <p class="list-inset">
    
     We now need to create the
    
    
     
      reload sequence.
     
    
   </p>
   <ol>
    <li value="12">
     
      Add a
     
     <strong class="bold">
      
       Sequence
      
     </strong>
     
      node to
     
     <strong class="bold">
      
       Root Selector
      
     </strong>
     
      at the right of
     
     <strong class="bold">
      
       Shoot Sequence
      
     </strong>
     
      and name it
     
     
      <strong class="source-inline">
       
        Reload Sequence
       
      </strong>
     
     
      
       .
      
     
    </li>
    <li>
     
      Add a
     
     <strong class="bold">
      
       Play Montage
      
     </strong>
     
      node to the
     
     <strong class="bold">
      
       Reload Sequence
      
     </strong>
     
      node and name it
     
     
      <strong class="source-inline">
       
        Reload Montage
       
      </strong>
     
     
      
       .
      
     
    </li>
    <li>
     
      Set the
     
     <strong class="bold">
      
       Anim Montage
      
     </strong>
     
      property
     
     
      
       to
      
     
     
      <strong class="bold">
       
        AM_1H_Reload
       
      </strong>
     
     
      
       .
      
     
    </li>
    <li>
     
      Add a
     
     <strong class="bold">
      
       Set Ammo
      
     </strong>
     
      service to the node and name it
     
     <strong class="source-inline">
      
       Refill Ammo
      
     </strong>
     
      .
     
     
      In the
     
     <strong class="bold">
      
       Details
      
     </strong>
     
      panel, do the
     
     
      
       following steps:
      
     
     <ul>
      <li>
       
        Set the
       
       <strong class="bold">
        
         Needs Reload
        
       </strong>
       
        property
       
       
        
         to
        
       
       
        <strong class="bold">
         
          NeedsReload
         
        </strong>
       
      </li>
      <li>
       
        Leave the
       
       <strong class="bold">
        
         Key Value
        
       </strong>
       
        
         property unchecked
        
       
      </li>
     </ul>
    </li>
    <li>
     
      Add a
     
     <strong class="bold">
      
       Wait
      
     </strong>
     
      task to
     
     <strong class="bold">
      
       Reload Sequence
      
     </strong>
     
      at the right of the
     
     <strong class="bold">
      
       Reload Montage
      
     </strong>
     
      node, setting the
     
     <strong class="bold">
      
       Wait Time
      
     </strong>
     
      attribute to
     
     <strong class="source-inline">
      
       2.0
      
     </strong>
     
      and the
     
     <strong class="bold">
      
       Random Deviation
      
     </strong>
     
      attribute
     
     <a id="_idIndexMarker583">
     </a>
     
      to
     
     <strong class="source-inline">
      
       0.5
      
     </strong>
     
      .
     
     
      This portion of the graph
     
     <a id="_idIndexMarker584">
     </a>
     
      is depicted in
     
     
      <em class="italic">
       
        Figure 11
       
      </em>
     
     
      <em class="italic">
       
        .5
       
      </em>
     
     
      
       :
      
     
    </li>
   </ol>
   <div><div><img alt="Figure 11.5 – Reload sequence" src="img/Figure_11.5_B31016.jpg"/>
     
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    
     Figure 11.5 – Reload sequence
    
   </p>
   <p>
    
     The behavior tree is now finished and ready to
    
    
     
      be used.
     
    
   </p>
   <p>
    
     In this section, we showed how to integrate an environment query inside a behavior tree; in the next section, we will be testing its functionality, and I will show you how to use the debugging tools
    
    
     
      with it.
     
    
   </p>
   <h1 id="_idParaDest-228">
    <a id="_idTextAnchor230">
    </a>
    
     Displaying EQS information
    
   </h1>
   <p>
    
     To test your gym, just start the
    
    <a id="_idIndexMarker585">
    </a>
    
     simulation; you should notice the
    
    
     
      following behavior:
     
    
   </p>
   <ul>
    <li>
     
      The AI agent will shoot at a target and then reload
     
     
      
       the weapon
      
     
    </li>
    <li>
     
      The AI agent will avoid shooting at targets that are not in the line
     
     
      
       of sight
      
     
    </li>
   </ul>
   <p>
    
     This behavior should go on indefinitely; that’s perfectly fine as the gunner is looking for targets by searching for the
    
    <strong class="source-inline">
     
      BP_Target
     
    </strong>
    
     class.
    
    
     To improve the gym, you may wish to implement some extra logic, such as a destroy system for targets that have been hit or a points counter for each target that has
    
    
     
      been hit.
     
    
   </p>
   <p>
    
     To show on the screen what’s happening, you will need to enable the debugging tools, as explained in
    
    <a href="B31016_06.xhtml#_idTextAnchor116">
     
      <em class="italic">
       
        Chapter 6
       
      </em>
     
    </a>
    
     ,
    
    <em class="italic">
     
      Optimizing the Navigation System
     
    </em>
    
     .
    
    
     Once the debugging tools are enabled, you will just need to hit the
    
    <em class="italic">
     
      3
     
    </em>
    
     key on your numpad to show the EQS information and then select the AI agent; in our case, you should see a set of information similar to the one depicted in
    
    
     <em class="italic">
      
       Figure 11
      
     </em>
    
    
     <em class="italic">
      
       .6
      
     </em>
    
    
     
      :
     
    
   </p>
   <div><div><img alt="Figure 11.6 – EQS debugging" src="img/Figure_11.6_B31016.jpg"/>
     
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    
     Figure 11.6 – EQS debugging
    
   </p>
   <p>
    
     Obviously, each
    
    <a id="_idIndexMarker586">
    </a>
    
     environment query will have its own information.
    
    
     In this example, you will notice that each target will show some data and a red wireframe, and the selected target will be marked as a
    
    <strong class="bold">
     
      Winner
     
    </strong>
    
     , as shown in
    
    
     <em class="italic">
      
       Figure 11
      
     </em>
    
    
     <em class="italic">
      
       .7
      
     </em>
    
    
     
      :
     
    
   </p>
   <div><div><img alt="Figure 11.7 – Selected target" src="img/Figure_11.7_B31016.jpg"/>
     
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    
     Figure 11.7 – Selected target
    
   </p>
   <p>
    
     Targets that won’t be in the line of sight with the querier will be labeled as
    
    <strong class="bold">
     
      Trace(0)
     
    </strong>
    
     to show that the trace failed, as shown in
    
    
     <em class="italic">
      
       Figure 11
      
     </em>
    
    
     <em class="italic">
      
       .8
      
     </em>
    
    
     
      :
     
    
   </p>
   <div><div><img alt="Figure 11.8 – Target not in the line of sight" src="img/Figure_11.8_B31016.jpg"/>
     
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    
     Figure 11.8 – Target not in the line of sight
    
   </p>
   <p>
    
     If you want more
    
    <a id="_idIndexMarker587">
    </a>
    
     detailed information for each item in the query, as shown in
    
    
     <em class="italic">
      
       Figure 11
      
     </em>
    
    <em class="italic">
     
      .9
     
    </em>
    
     , you may want to hit the divide key (
    
    <em class="italic">
     
      /
     
    </em>
    
     ) from
    
    
     
      the numpad:
     
    
   </p>
   <div><div><img alt="Figure 11.9 – Detailed information" src="img/Figure_11.9_B31016.jpg"/>
     
    </div>
   </div>
   <p class="IMG---Caption" lang="en-US" xml:lang="en-US">
    
     Figure 11.9 – Detailed information
    
   </p>
   <p>
    
     I highly encourage you to create your own queries and test them in the level.
    
    
     Using the debugging tools can be a significant time-saver during the development of your project.
    
    
     Take full advantage of these tools to streamline your workflow and
    
    
     
      enhance efficiency.
     
    
   </p>
   <h1 id="_idParaDest-229">
    <a id="_idTextAnchor231">
    </a>
    
     Summary
    
   </h1>
   <p>
    
     In this chapter, we saw a new way – although experimental – to let your AI agents probe the level and gather information in order to make
    
    
     
      meaningful decisions.
     
    
   </p>
   <p>
    
     Beginning with a bit of theory, we created an environment query, developed a fully operational behavior tree utilizing environment queries effectively, and tested it in a gym setting.
    
    
     Furthermore, we explored the use of debugging tools to analyze the activities within
    
    
     
      the level.
     
    
   </p>
   <p>
    
     This concludes
    
    <em class="italic">
     
      Part 3
     
    </em>
    
     of this book.
    
    
     In the upcoming chapters, we will delve into new features within the AI framework, beginning with a glimpse at an alternative method of implementing AI agents: hierarchical
    
    
     
      state machines.
     
    
   </p>
  </div>
 

  <div><h1 id="_idParaDest-230" lang="en-US" xml:lang="en-US">
    <a id="_idTextAnchor232">
    </a>
    
     Part 4: Exploring Advanced Topics
    
   </h1>
   <p>
    
     In the fourth part of this book, you will be presented with some cutting-edge and experimental AI features within the Unreal Engine ecosystem.
    
    
     Additionally, you will gain knowledge on how to integrate these features within your
    
    
     
      own projects.
     
    
   </p>
   <p>
    
     This part includes the
    
    
     
      following chapters:
     
    
   </p>
   <ul>
    <li>
     <a href="B31016_12.xhtml#_idTextAnchor233">
      <em class="italic">
       
        Chapter 12
       
      </em>
     </a>
     
      ,
     
     <em class="italic">
      
       Using Hierarchical State Machines with State Trees
      
     </em>
    </li>
    <li>
     <a href="B31016_13.xhtml#_idTextAnchor251">
      <em class="italic">
       
        Chapter 13
       
      </em>
     </a>
     
      ,
     
     <em class="italic">
      
       Implementing Data-Oriented Calculations with Mass
      
     </em>
    </li>
    <li>
     <a href="B31016_14.xhtml#_idTextAnchor270">
      <em class="italic">
       
        Chapter 14
       
      </em>
     </a>
     
      ,
     
     <em class="italic">
      
       Implementing Interactable Elements with Smart Objects
      
     </em>
    </li>
   </ul>
  </div>
  <div><div></div>
  </div>
  <div><div></div>
  </div>
 </body></html>