<html><head></head><body><div id="book-content"><div id="sbo-rt-content"><div id="_idContainer098">&#13;
    <h1 class="chapterNumber"><a id="_idTextAnchor066"/>10</h1>&#13;
    <h1 id="_idParaDest-152" class="chapterTitle">Creating an Intelligent Recommendation System</h1>&#13;
    <p class="normal">Now that we have loaded the data into a graph, and looked at how we can augment the graph using Langchain4j and Spring AI, along with generating recommendations, we will look at how we can go further to improve the recommendations by leveraging <strong class="keyWord">Graph Data Science</strong> (<strong class="keyWord">GDS</strong>) <strong class="keyWord">algorithms</strong> and <a id="_idIndexMarker449"/>machine learning. We will review the GDS algorithms provided by Neo4j to go beyond the recommendation system we created in the previous chapter. We will also learn how to use the GDS algorithms to build collaborative filtering as well as content-based approaches to provide recommendations. We will also take a look at the results after we run the algorithms to review how our approach is working and whether we are on the right path to build a better recommendation system. We will try to understand why these algorithms are better than the approach we implemented in the previous chapter.</p>&#13;
    <p class="normal">In this chapter, we are going to cover the following main topics:</p>&#13;
    <ul>&#13;
      <li class="bulletList">Improving recommendations with GDS algorithms</li>&#13;
      <li class="bulletList">Understanding the power of communities</li>&#13;
      <li class="bulletList">Combining collaborative filtering and content-based approaches</li>&#13;
    </ul>&#13;
    <h1 id="_idParaDest-153" class="heading-1">Technical requirements</h1>&#13;
    <p class="normal">We will be using a Java IDE environment to work with the Langchain4j and Spring AI projects. You will need to have these installed and know how to work with them.</p>&#13;
    <h2 id="_idParaDest-154" class="heading-2">Setting up the environment</h2>&#13;
    <p class="normal">We will be starting from the graph database we built in the last chapter. The code is tested with the Neo4j <code class="inlineCode">5.21.2</code> version of the database.</p>&#13;
    <p class="normal">To set up the environment, you will need</p>&#13;
    <ul>&#13;
      <li class="bulletList">Neo4j Desktop with the following plugins installed. :<ul>&#13;
          <li class="bulletList">APOC plugin – <code class="inlineCode">5.21.2</code></li>&#13;
          <li class="bulletList">Graph Data Science library – <code class="inlineCode">2.9.0</code></li>&#13;
        </ul>&#13;
      </li>&#13;
    </ul>&#13;
    <p class="normal"><em class="italic">Figure 10.1</em> shows how to install these plugins for a DBMS.</p>&#13;
    <figure class="mediaobject"><img src="../Images/B31107_10_01.png" alt="Figure 10.1 — Install plugins in Neo4j Desktop" width="1202" height="881"/></figure>&#13;
    <p class="packt_figref">Figure 10.1 — Install plugins in Neo4j Desktop</p>&#13;
    <p class="normal">When you select the DBMS in Neo4j Desktop, on the right side, it shows its details. Click on the <strong class="screenText">Plugins</strong> tab and select the plugins. Once that is expanded, click on the <strong class="screenText">Install and Restart</strong> button.</p>&#13;
    <p class="normal">Next, we will look at the database dump required for this chapter.</p>&#13;
    <h2 id="_idParaDest-155" class="heading-2">Getting the database ready</h2>&#13;
    <p class="normal">Before you begin, you will need to create the communities. It will take some time for the similarity and community detection algorithms to complete. Thus, it is recommended to download the database dump from <a href="https://packt-neo4j-powered-applications.s3.us-east-1.amazonaws.com/hmreco_post_augment_with_summary_communities"><span class="url">https://packt-neo4j-powered-applications.s3.us-east-1.amazonaws.com/hmreco_post_augment_with_summary_communities</span></a><span class="url">.dump</span> and use it to create a database in Neo4j Desktop. You can use these instructions to load this dump into Neo4j Desktop: <a href="https://neo4j.com/docs/desktop-manual/current/operations/create-from-dump/"><span class="url">https://neo4j.com/docs/desktop-manual/current/operations/create-from-dump/</span></a>. </p>&#13;
    <p class="normal">This database dump has all the <code class="inlineCode">SUMMER_2019_SIMILAR</code> relationships created and the communities are identified.</p>&#13;
    <p class="normal">Let’s start with using the GDS algorithms to enhance our knowledge graph for improved recommendations.</p>&#13;
    <h1 id="_idParaDest-156" class="heading-1">Improving recommendations with GDS algorithms</h1>&#13;
    <p class="normal">In<a id="_idIndexMarker450"/> this section, we will look at how we can<a id="_idIndexMarker451"/> enhance the graph further to gain more insights into the graph to build a better recommendation system. We will start with the graph database we created in the last chapter. For reference, you can download it from <a href="https://packt-neo4j-powered-applications.s3.us-east-1.amazonaws.com/Building+Neo4j-Powered+Applications+with+LLMs+Database+Dump+files.zip"><span class="url">https://packt-neo4j-powered-applications.s3.us-east-1.amazonaws.com/Building+Neo4j-Powered+Applications+with+LLMs+Database+Dump+files.zip</span></a>.</p>&#13;
    <p class="normal">The <a id="_idIndexMarker452"/>Neo4j GDS algorithms (<a href="https://neo4j.com/docs/graph-data-science/current/"><span class="url">https://neo4j.com/docs/graph-data-science/current/</span></a>) will help us enhance the graph. This process includes the following steps:</p>&#13;
    <ol>&#13;
      <li class="numberedList" value="1">Calculate<a id="_idIndexMarker453"/> the similarity between customers based on the embeddings we have created and create a similar relationship between these customers. For this purpose, we will leverage<a id="_idIndexMarker454"/> the <strong class="keyWord">K-Nearest Neighbors</strong> (<strong class="keyWord">KNN</strong>) algorithm (<a href="https://neo4j.com/docs/graph-data-science/current/algorithms/knn/"><span class="url">https://neo4j.com/docs/graph-data-science/current/algorithms/knn/</span></a>).</li>&#13;
      <li class="numberedList">Run the community<a id="_idIndexMarker455"/> detection algorithm to group the customers based on similar relationships. For this purpose, we will leverage the <strong class="screenText">Louvain community detection</strong> algorithm (<a href="https://neo4j.com/docs/graph-data-science/current/algorithms/louvain/"><span class="url">https://neo4j.com/docs/graph-data-science/current/algorithms/louvain/</span></a>).</li>&#13;
    </ol>&#13;
    <p class="normal">First, we will utilize the KNN algorithm to enhance the graph.</p>&#13;
    <h2 id="_idParaDest-157" class="heading-2">Computing similarity with the KNN algorithm</h2>&#13;
    <p class="normal">The <strong class="screenText">K-Nearest Neighbors</strong> (<strong class="screenText">KNN</strong>) algorithm collects<a id="_idIndexMarker456"/> node pairs, computes a distance value between a node and its neighbors, and creates a relationship between the node and<a id="_idIndexMarker457"/> its <strong class="keyWord">top K</strong> neighbors. The distance is calculated based on node properties. We need to provide a homogeneous graph <span id="page4-12" role="doc-pagebreak" aria-label="208" epub:type="pagebreak"/>for this algorithm. When all the nodes and relationships are the same, it is called<a id="_idIndexMarker458"/> a <strong class="keyWord">homogeneous graph</strong>. The node pairs we provide to the KNN algorithm do not need any node labels or relationship types.  The KNN algorithm just needs node pairs that are connected and an optional property that can be used as the context of the relationship between them. You can read more about this at <a href="https://neo4j.com/docs/graph-data-science/current/algorithms/knn"><span class="url">https://neo4j.com/docs/graph-data-science/current/algorithms/knn</span></a>.</p>&#13;
    <p class="normal">To use this algorithm, we need to follow this process:</p>&#13;
    <ol>&#13;
      <li class="numberedList" value="1">Project graph of interest to apply the algorithm.</li>&#13;
      <li class="numberedList">Invoke the algorithm with the appropriate configuration. There are three modes of this algorithm:<ul>&#13;
          <li class="bulletList"><strong class="screenText">Stream</strong>: This applies the algorithm to the in-memory graph and streams the results. You can use the stream mode to inspect the results and see if they are what we want.</li>&#13;
          <li class="bulletList"><strong class="screenText">Mutate</strong>: This applies the algorithm to the in-memory graph and writes the data back to the in-memory graph. The actual database does not change. The mutate method is used when we want to update the in-memory graph and want to process it later for different purposes.</li>&#13;
          <li class="bulletList"><strong class="screenText">Write</strong>: This applies the algorithm to the in-memory graph and writes the relationships back to the actual database. This mode is used when we are sure of the process and want to write the results back to the graph immediately.</li>&#13;
        </ul>&#13;
      </li>&#13;
    </ol>&#13;
    <p class="normal">We will start <a id="_idIndexMarker459"/>with graph projection. Since we <a id="_idIndexMarker460"/>have written the embeddings on the <code class="inlineCode">SUMMER_2019</code> relationships, we will use those for processing.</p>&#13;
    <p class="normal">This Cypher projects the graph in memory to be able to invoke this algorithm:</p>&#13;
    <pre class="programlisting code"><code class="hljs-code">  MATCH (c:Customer)-[sr:SU<a id="_idTextAnchor067"/>MMER_2019]-&gt;()&#13;
  WHERE sr.embedding is not null&#13;
  RETURN gds.graph.project(&#13;
    'myGraph',&#13;
    c,&#13;
    null,&#13;
    {&#13;
      sourceNodeProp<a id="_idTextAnchor068"/>erties: sr { .embedding },&#13;
      targetNodeProperties: {}&#13;
    }&#13;
  )&#13;
</code></pre>&#13;
    <p class="normal">Normally, we will use the properties on the node to build a projection. Here, we have written the embedding value on a relationship, as this embedding is created to represent the summer 2019 season purchases. If we had written that embedding on the <code class="inlineCode">Customer</code> node, then if we wanted to understand the customer purchase behavior for various scenarios, we would need to use some clever naming to write those to only the <code class="inlineCode">Customer</code> node. By writing that embedding on the relationship, we are preserving the context of the embedding in the graph.</p>&#13;
    <p class="normal">We can see from the preceding Cypher that we are retrieving the embedding from the relationship and adding it as a source node property in the projection. Now, let us invoke the algorithm to write back similar relationships to the graph.</p>&#13;
    <p class="normal">This Cypher invokes the algorithm to write back the results:</p>&#13;
    <pre class="programlisting code"><code class="hljs-code">CALL gds.knn.write('myGraph', {&#13;
    writeRelationshipType: 'SUMMER_2019_SIMILAR',&#13;
    writeProperty: 'score',&#13;
    topK: 5,&#13;
    nodeProperties: ['embedding'],&#13;
    similarityCutoff: 0.9&#13;
})&#13;
YIELD nodesCompared, relationshipsWritten&#13;
</code></pre>&#13;
    <p class="normal">From the <a id="_idIndexMarker461"/>Cypher, we can see we are invoking the <code class="inlineCode">write</code> mode of the algorithm. The algorithm will calculate the similarity between Customers by <a id="_idIndexMarker462"/>using <strong class="keyWord">cosine similarity</strong> on the embeddings, with <a id="_idIndexMarker463"/>a cut-off score of <code class="inlineCode">0.9</code>, pick the top 5 neighbors in the order of similarity score, and write a relationship named <code class="inlineCode">SUMMER_2019_SIMILAR</code> between those customers. </p>&#13;
    <div class="note">&#13;
      <p class="normal"><strong class="keyWord">Note</strong></p>&#13;
      <p class="normal">Cosine similarity calculates the angle between two vectors. So, if the vectors are farther apart, then the similarity value will be close to 0. If they are closer to each other, then the similarity value will be close to 1. If you want to<a id="_idIndexMarker464"/> read more about it, you can read at <a href="https://en.wikipedia.org/wiki/Cosine_similarity"><span class="url">https://en.wikipedia.org/wiki/Cosine_similarity</span></a>. </p>&#13;
    </div>&#13;
    <p class="normal">Similar scores can be between 0 and 1. If the score is closer to 0 between 2 entities, then they are not similar to each other. If it is close to 1, then they are more similar. We are using <code class="inlineCode">0.9</code> as the similarity cutoff as we are generating embeddings based on the summary text generated – customers might have a higher similarity score. We don’t want a similar relationship between <span id="page6-12" role="doc-pagebreak" aria-label="210" epub:type="pagebreak"/>customers because there are some keywords that are similar. We will validate this assumption in later steps. We are limiting ourselves to the top five (<code class="inlineCode">k</code> <code class="inlineCode">=5</code>) similar customer behaviors, to get closer recommendations.</p>&#13;
    <div class="note">&#13;
      <p class="normal"><strong class="keyWord">Note</strong></p>&#13;
      <p class="normal">Please note that the KNN algorithm is a non-deterministic algorithm by default. This means that different runs might give different results. You can learn more about this at <a href="https://neo4j.com/docs/graph-data-science/2.14/algorithms/knn/"><span class="url">https://neo4j.com/docs/graph-data-science/2.14/algorithms/knn/</span></a>. If you want deterministic results, then you must ensure that the concurrency parameter is set to one and the <code class="inlineCode">randomSeed</code> parameter is explicitly set.</p>&#13;
    </div>&#13;
    <p class="normal">Once the algorithm is invoked, we need to remove the graph projection. Otherwise, it will keep using the memory in the database server:</p>&#13;
    <pre class="programlisting code"><code class="hljs-code">CALL gds.graph.drop('myGraph')&#13;
</code></pre>&#13;
    <p class="normal">This <a id="_idIndexMarker465"/>Cypher will drop the graph and clear<a id="_idIndexMarker466"/> the memory used by the graph projection.</p>&#13;
    <p class="normal">We will take a look at community detection next, based on the <code class="inlineCode">SUMMER_2019_SIMILAR</code> relationship.</p>&#13;
    <p class="normal">For this, we will be leveraging the Louvain community detection algorithm, which is the most popular community detection algorithm.</p>&#13;
    <h2 id="_idParaDest-158" class="heading-2">Detecting communities with the Louvain algorithm</h2>&#13;
    <p class="normal">The <strong class="keyWord">Louvain algorithm</strong> relies <a id="_idIndexMarker467"/>on the similarity scores between entities and groups them into communities. It takes large, networked data and groups it into smaller, tighter-knit <a id="_idIndexMarker468"/>communities<a id="_idIndexMarker469"/> by looking at the neighbors and their relationships.  This hierarchical clustering algorithm recursively merges communities into a single node and executes the modularity clustering on the condensed graphs. It maximizes a modularity score for each community, evaluating how much more densely connected the nodes within a community are compared to how connected they would be in a random network. We want to group our customers in more tight-knit groups in a more automated way to provide broader recommendations. You<a id="_idIndexMarker470"/> can read more about this at <a href="https://neo4j.com/docs/graph-data-science/current/algorithms/louvain/"><span class="url">https://neo4j.com/docs/graph-data-science/current/algorithms/louvain/</span></a>.</p>&#13;
    <p class="normal">The approach is very similar to how we invoked the KNN algorithm. To use this algorithm, we need to follow this process.</p>&#13;
    <ol>&#13;
      <li class="numberedList" value="1">Project graph of interest to apply the algorithm.</li>&#13;
      <li class="numberedList">Invoke the algorithm with the appropriate configuration. There are three modes of this algorithm.<ul>&#13;
          <li class="bulletList"><strong class="screenText">Stream</strong>: This applies the algorithm to the in-memory graph and streams the results. You can use the stream mode to inspect the results and see if they are what we want.</li>&#13;
          <li class="bulletList"><strong class="screenText">Mutate</strong>: This applies the algorithm to the in-memory graph and writes the data back to the in-memory graph. The actual database has not changed. The <code class="inlineCode">mutate</code> method is used when we want to update the in-memory graph and want to process it later for different purposes.</li>&#13;
          <li class="bulletList"><strong class="screenText">Write</strong>: This applies the algorithm to the in-memory graph and writes the relationships back to the actual database. This mode is used when we are sure of the process and want to write the results back to the graph immediately.</li>&#13;
        </ul>&#13;
      </li>&#13;
    </ol>&#13;
    <p class="normal">Let’s start with <strong class="screenText">graph projection</strong>. We will use the <code class="inlineCode">SUMMER_2019_SIMILAR </code>relationship and the <code class="inlineCode">score</code> value saved on that relationship to perform community detection:</p>&#13;
    <pre class="programlisting code"><code class="hljs-code"><span class="hljs-keyword">MATCH</span> (source:Customer)<span class="hljs-operator">-</span>[r:SUMMER_2019_SIMILAR]<span class="hljs-operator">-&gt;</span>(target)&#13;
<span class="hljs-keyword">RETURN</span> gds.graph.project(&#13;
  <span class="hljs-string">'communityGraph'</span>,&#13;
  source,&#13;
  target,&#13;
  {&#13;
    relationshipProperties: r { .score }&#13;
  },&#13;
  { undirectedRelationshipTypes: [<span class="hljs-string">'*'</span>] }&#13;
)&#13;
</code></pre>&#13;
    <p class="normal">The preceding<a id="_idIndexMarker471"/> Cypher creates an in-memory projection named <code class="inlineCode">communityGraph</code>. It takes the source node, target node, and the score on the <code class="inlineCode">SUMMER_2019_SIMILAR</code> relationship to build the projection.</p>&#13;
    <p class="normal">Once the projection is built, we<a id="_idIndexMarker472"/> can use this Cypher to perform community detection:</p>&#13;
    <pre class="programlisting code"><code class="hljs-code">CALL gds.louvain.write('communityGraph', { writeProperty:<a id="_idTextAnchor069"/> 'summer_2019_community' })&#13;
YIELD communityCount, modularity, modularities&#13;
</code></pre>&#13;
    <p class="normal">This Cypher performs the community detection and writes back the community ID as a property named <code class="inlineCode">summer_2019_community</code> on the <code class="inlineCode">Customer</code> node.</p>&#13;
    <p class="normal">Once the community detection is complete, we need to drop the graph projection.</p>&#13;
    <pre class="programlisting code"><code class="hljs-code">CALL gds.graph.drop('communityGraph')&#13;
</code></pre>&#13;
    <p class="normal">This Cypher will drop the graph and clear the memory used by the graph projection.</p>&#13;
    <p class="normal">We can use this Cypher to inspect how many communities are created:</p>&#13;
    <pre class="programlisting code"><code class="hljs-code">MA<a id="_idTextAnchor070"/>TCH (c:Customer) WHERE c.summer_2019_commun<a id="_idTextAnchor071"/>ity IS NOT NULL&#13;
RETURN c.summer_2019_community, COUNT(c) as count&#13;
ORDER BY count DESC&#13;
</code></pre>&#13;
    <p class="normal">This <a id="_idIndexMarker473"/>Cypher gives all communities, in the order of how many customers <a id="_idIndexMarker474"/>belong to that community. The response would look as shown in <em class="italic">Figure 10.2</em>.</p>&#13;
    <figure class="mediaobject"><img src="../Images/B31107_10_02.png" alt="Figure 10.2 — Communities with customer counts" width="1205" height="595"/></figure>&#13;
    <p class="packt_figref">Figure 10.2 — Communities with customer counts</p>&#13;
    <div class="note">&#13;
      <p class="normal"><strong class="keyWord">Note</strong>:</p>&#13;
      <p class="normal">Please note that the Louvain community detection algorithm is a non-deterministic algorithm by default. This means that different runs might give different results. You can learn more about this at <a href="https://neo4j.com/docs/graph-data-science/2.14/algorithms/louvain/"><span class="url">https://neo4j.com/docs/graph-data-science/2.14/algorithms/louvain/</span></a>.</p>&#13;
    </div>&#13;
    <p class="normal">Now that we have built communities, let us take a look at the communities generated. In the next section, we will inspect a few of these communities to observe whether they group customers based on their purchase behavior.</p>&#13;
    <h1 id="_idParaDest-159" class="heading-1">Understanding the power of communities</h1>&#13;
    <p class="normal">Previously, in <a href="Chapter_09.xhtml#_idTextAnchor059"><em class="italic">Chapter 9</em></a>, we looked at finding similar<a id="_idIndexMarker475"/> customers using vector similarity and how to provide recommendations for a customer<span class="Annotation-reference">.</span> Let’s revisit <em class="italic">Figure 9.10</em> and <em class="italic">Figure 9.11</em>. <em class="italic">Figure 9.10 </em>displays the purchase history of customers similar to a particular customer. <em class="italic">Figure 9.11</em> shows the recommendations for a customer based on the purchases of similar customers. The purchase history and customer recommendations are a result of the Cypher queries we worked on in the <em class="italic">Fine-tuning your recommendations</em> section to understand vector similarity usage.</p>&#13;
    <p class="normal">In this section, we will take a deeper look at communities and see why they might be better than leveraging simple vector similarity to find similar customers.</p>&#13;
    <div class="note">&#13;
      <p class="normal"><strong class="keyWord">Note</strong></p>&#13;
      <p class="normal">The following Cyphers are related to the database shared in the <em class="italic">Technical <br/>requirements</em> section.</p>&#13;
    </div>&#13;
    <p class="normal">From the Cypher we ran in the last section, <em class="italic">Detecting communities with the Louvain  algorithm</em>, let us pick a community that has a good number of customers in it. We will take a look at the community with ID <code class="inlineCode">133</code>, which has around <code class="inlineCode">1,242</code> customers in it.</p>&#13;
    <p class="normal">The following Cypher displays the customer purchase summary without the article details for the first five customers:</p>&#13;
    <pre class="programlisting code"><code class="hljs-code">MATCH (c:C<a id="_idTextAnchor072"/>ustomer)-[<a id="_idTextAnchor073"/>r:SUMMER_2019]-&gt;()&#13;
WHERE c.summer_2019_community=133&#13;
WITH split(r.summary, '<a id="_idTextAnchor074"/>\n') AS s&#13;
WITH C<a id="_idTextAnchor075"/>ASE WHEN s<a id="_idTextAnchor076"/>[2] &lt;&gt; '' THEN s[2] ELSE s[3] END AS d&#13;
return d LIMIT 5&#13;
</code></pre>&#13;
    <p class="normal">When we run community detection, the community IDs generated can be different for each run. So, if you have run your own Cypher script to create the customer communities, you need to take a look at the communities and use those IDs to validate the data.</p>&#13;
    <p class="normal">When we run the preceding <a id="_idIndexMarker476"/>Cypher script, the output looks like this:</p>&#13;
    <pre class="programlisting code"><code class="hljs-code">The customer demonstrates a preference for stylish and modern pieces, particularly favoring dresses and lingerie that offer both comfort and elegance. The consistent choice of midi and short dresses paired with a variety of non-wired bras suggests a desire for chic yet relaxed fashion options. Additionally, the inclusion of tailored blouses and fashionable outerwear indicates an appreciation for versatile styles suitable for various occasions.&#13;
The customer exhibits a preference for comfortable yet stylish clothing, favoring light and soft colors such as light pink and light blue. Their purchases reflect a blend of casual and lingerie items, indicating a focus on both everyday wear and intimate apparel. The selection features a mix of high-waisted denim and lace detailing, suggesting an appreciation for modern, flattering silhouettes.&#13;
The customer demonstrates a strong preference for versatile and stylish pieces, favoring bold colors like pink and orange while incorporating comfortable fabrics such as jersey and cotton. Their purchases include a mix of casual wear, activewear, and lingerie, suggesting a balanced lifestyle that values both comfort and aesthetics. The frequent selection of shorts and dresses indicates a preference for easy-to-wear, fashionable items suitable for various occasions.&#13;
The customer demonstrates a preference for comfortable and stylish lingerie, favoring soft materials with unique design details such as lace trims and laser-cut edges. Additionally, their choice of everyday wear leans towards light and airy fabrics, showcasing a blend of casual and chic styles suitable for various occasions. The color palette reflects a soft and neutral aesthetic, with light pinks, beiges, and whites dominating their selections.&#13;
The customer exhibits a preference for comfortable and functional clothing, particularly in the realm of casual and lingerie wear. There is a clear inclination towards basic styles in neutral colors such as black and white, complemented by playful accents in perceived colors like orange and pink. The focus on versatile pieces suggests a desire for practicality combined with style.&#13;
</code></pre>&#13;
    <p class="normal">From the summary descriptions, we can see the customers in this community prefer to buy casual and lingerie clothing together.</p>&#13;
    <p class="normal">Let’s take a look at the articles purchased by these customers:</p>&#13;
    <pre class="programlisting code"><code class="hljs-code">MATCH (c:Customer)&#13;
WHERE c.summer_2019_community=133&#13;
WITH c LIMIT 10&#13;
MATCH (c)-[:SUMMER_2019]-&gt;(start)&#13;
MATCH (c)-[:FALL_2019]-&gt;(end)&#13;
WITH c, start, end&#13;
CALL {&#13;
    WITH start, end&#13;
    MATCH p=(start)-[:NEXT*]-&gt;(end)&#13;
    WITH nodes(p) as nodes&#13;
    UNWIND nodes as n&#13;
    MATCH (n)-[:HAS_ARTICLE]-&gt;(a)&#13;
    WITH a LIMIT 3&#13;
    RETURN collect(a.desc) as articles&#13;
}&#13;
WITH c, articles&#13;
RETURN articles&#13;
</code></pre>&#13;
    <p class="normal">This Cypher gives<a id="_idIndexMarker477"/> this output:</p>&#13;
    <pre class="programlisting code"><code class="hljs-code">["Calf-length dress in a crinkled weave with a V-neck, wrapover front with ties at the waist and short sleeves with a slit and ties. Unlined.", "Calf-length dress in a crinkled weave with a V-neck, wrapover front with ties at the waist and short sleeves with a slit and ties. Unlined.", "Soft, non-wired bras in cotton jersey with moulded, padded triangular cups for a larger bust and fuller cleavage. Adjustable shoulder straps that cross at the back and lace at the hem. No fasteners."]&#13;
["High-waisted jeans in washed superstretch denim with hard-worn details, a zip fly and button, back pockets and skinny legs.", "Lace push-up bra with underwired, moulded, padded cups for a larger bust and fuller cleavage. Adjustable shoulder straps and a hook-and-eye fastening at the back.", "Lace push-up bra with underwired, moulded, padded cups for a larger bust and fuller cleavage. Adjustable shoulder straps and a hook-and-eye fastening at the back."]&#13;
["Vest top in cotton jersey with a print motif.", "Soft, non-wired bras in microfibre with padded cups that shape the bust and provide good support. Adjustable shoulder straps and a hook-and-eye fastening at the back.", "Chino shorts in washed cotton poplin with a zip fly, side pockets, welt <span id="page12-7" role="doc-pagebreak" aria-label="216" epub:type="pagebreak"/>back pockets with a button and legs with creases."]&#13;
["Microfibre Brazilian briefs with laser-cut edges, a low waist, lined gusset, wide sides and half-string back.", "Hipster briefs in microfibre with lace trims, a low waist, lined gusset and cutaway coverage at the back.", "Blouse in an airy weave with a V-neck, covered buttons down the front, short dolman sleeves and a tie detail at the hem."]&#13;
["Round-necked T-shirt in soft cotton jersey.", "Round-necked T-shirt in soft cotton jersey.", "Thong briefs in cotton jersey and lace with a low waist, lined gusset, wide sides and string back."]&#13;
</code></pre>&#13;
    <p class="normal">We are limiting<a id="_idIndexMarker478"/> ourselves to the first three articles so that we won’t look at a lot of data here. We can see from the articles purchased that the summaries summarize the customer’s purchase behavior well.</p>&#13;
    <p class="normal">Let us look at how the customer age group to communities’ correlation exists.</p>&#13;
    <p class="normal">The following Cypher gives us the most frequently occurring age group in a community age group in a community:</p>&#13;
    <pre class="programlisting code"><code class="hljs-code">MATCH (c:Customer) where c.summer_2019_community is not null&#13;
WITH  c.summer_2019_community as community, toInteger(c.age) as age,  c&#13;
WITH community,&#13;
    CASE WHEN age &lt; 10 THEN "Young"&#13;
         WHEN 10 &lt; age &lt; 20 THEN "Teen"&#13;
         WHEN 20 &lt; age &lt; 30 THEN "Youth"&#13;
         WHEN 30 &lt; age &lt; 50 THEN "Adult"&#13;
         ELSE "Old"&#13;
    END as ageGroup,&#13;
    C&#13;
WITH community, ageGroup, count(*) as count&#13;
CALL {&#13;
    WITH community&#13;
    MATCH (c:Customer) where c.summer_2019_community=community&#13;
    RETURN count(*) as totalCommunity&#13;
}&#13;
WITH community, ageGroup,count, totalCommunity&#13;
WITH community, ageGroup, round(count*100.0/totalCommunity, 2) as ratio&#13;
WITH community, collect({ageGroup: ageGroup, ratio:ratio}) as data&#13;
CALL {&#13;
    WITH community, data&#13;
    UNWIND data as d&#13;
    WITH community, d&#13;
    ORDER BY d.ratio DESC&#13;
    RETURN community as c, d.ageGroup as a, d.ratio as r&#13;
    LIMIT 1&#13;
}&#13;
RETURN c as community, a as ageGroup, r as ratio&#13;
ORDER BY r DESC&#13;
</code></pre>&#13;
    <p class="normal">The results will <a id="_idIndexMarker479"/>look as shown in <em class="italic">Figure 10.3</em>.</p>&#13;
    <table id="table001-1" class="table-container">&#13;
      <tbody>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="center">Community</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">Age Group</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">Ratio</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="center">1899</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">“Youth”</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">60.87</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="center">5823</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">“Adult”</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">56.68</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="center">770</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">“Youth”</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">47.9</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="center">1729</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">“Youth”</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">46.92</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="center">4602</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">“Youth”</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">45.71</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="center">133</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">“Youth”</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">44.61</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="center">921</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">“Youth”</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">44.17</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="center">3444</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">“Youth”</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">41.73</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="center">649</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">“Youth”</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">41.62</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="center">1881</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">“Youth”</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">41.26</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="center">1696</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">“Old”</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">41.06</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="center">2381</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">“Old”</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">40.94</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="center">6010</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">“Old”</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">37.67</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="center">713</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">“Youth”</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">37.64</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="center">760</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">“Youth”</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">36.09</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="center">1875</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">“Old”</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">35.09</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="center">2778</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">“Youth”</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="center">34.47</p>&#13;
          </td>&#13;
        </tr>&#13;
      </tbody>&#13;
    </table>&#13;
    <p class="packt_figref">Figure 10.3 — Most frequently occurring age group and its ratio in every community</p>&#13;
    <p class="normal">We can see most <a id="_idIndexMarker480"/>communities are dominated by the <strong class="screenText">Age Group</strong><strong class="screenText">, </strong><strong class="screenText">Youth</strong>, who are aged between 20 and 30. Let us look at one of the communities where the <strong class="screenText">Youth</strong> age group is not dominant. Let us look at community <strong class="screenText">5823</strong>.</p>&#13;
    <p class="normal">This Cypher gives us the first five customers’ purchase summary of community <code class="inlineCode">5823</code>:</p>&#13;
    <pre class="programlisting code"><code class="hljs-code">MATCH (c:Customer)-[r:SUMMER_2019]<a id="_idTextAnchor077"/>-&gt;()&#13;
WHERE<a id="_idTextAnchor078"/> c.summer_2019_community=5823&#13;
WITH c, split(r.summary, '\n') AS s&#13;
WITH c, CASE WHEN<a id="_idTextAnchor079"/> s[2] &lt;&gt; '' THEN<a id="_idTextAnchor080"/> s[2] ELSE<a id="_idTextAnchor081"/> s[3] END AS d&#13;
RETURN d LIMIT 5&#13;
</code></pre>&#13;
    <p class="normal">When you perform a similarity search for a specific customer using their vector embedding, the results will primarily be other individual customers whose vector representations are close to the target customer’s vector. You may observe a degree of heterogeneity. An important caveat is that when we solely rely on finding similar customers to a target customer, based on vector distance, we might miss out on potentially relevant recommendations.</p>&#13;
    <p class="normal">Take a look at the <a id="_idIndexMarker481"/>following results:</p>&#13;
    <pre class="programlisting code"><code class="hljs-code">The customer demonstrates a strong preference for <code style="font-weight: bold;" class="codeHighlighted">versatile and stylish pieces, with a notable inclination towards swimwear and casual skirts, reflecting an active and chic lifestyle</code>. The selection features a mix of practical and trendy items, highlighting an appreciation for both comfort and aesthetics. The color palette leans towards soft tones and earthy shades, suggesting a preference for understated elegance.&#13;
The customer exhibits a preference for stylish yet <code style="font-weight: bold;" class="codeHighlighted">comfortable footwear and swimwear, favoring pieces that blend functionality with trendy elements. The consistent use of white and orange in swimwear suggests a bold and lively aesthetic, while the choice of soft organic cotton for kids'</code> basics indicates an appreciation for quality and sustainability. Overall, there is a clear inclination towards versatile and fashionable pieces suitable for both leisure and casual settings.&#13;
The customer's fashion preferences indicate a strong inclination towards <code style="font-weight: bold;" class="codeHighlighted">relaxed and comfortable styles, particularly in children's denim wear. The consistent choice of blue tones across multiple purchases suggests a preference for classic and versatile colors.</code> Additionally, the inclusion of a dress with a structured yet casual design highlights an appreciation for both practicality and style in their wardrobe choices.&#13;
The customer exhibits a preference for <code style="font-weight: bold;" class="codeHighlighted">versatile and comfortable clothing, with a notable inclination towards knitwear and soft fabrics. Their choices reflect a balance of casual and practical styles suitable for everyday wear</code>, particularly in hues of black, dark orange, and grey, complemented by accents of pink. The selected items also indicate a focus on functionality, especially with the inclusion of nursin<a id="_idTextAnchor082"/>g bras.&#13;
The customer demonstrates a preference for <code style="font-weight: bold;" class="codeHighlighted">versatile and stylish pieces that blend comfort with contemporary design. They appreciate a mix of youthful and sophisticated styles, as seen in their selection of both kids' dresses and women's wear.</code> The choice of colors suggests a fondness for neutral tones with pops of color, reflecting both playful and elegant aesthetics.&#13;
</code></pre>&#13;
    <p class="normal">These summaries show this <a id="_idIndexMarker482"/>community leans toward people who have kids. After observing the communities and a few customer summaries in those communities, we are able to understand the purchase behaviors better than just going by vector similarity.</p>&#13;
    <p class="normal">Our next step is to combine collaborative filtering and content-based approaches to give better recommendations.</p>&#13;
    <h1 id="_idParaDest-160" class="heading-1">Combining collaborative filtering and content-based approaches</h1>&#13;
    <p class="normal"><strong class="keyWord">Collaborative filtering</strong> involves <a id="_idIndexMarker483"/>providing recommendations based on customer similarity based on their purchases, using which we have built customer communities, or using article similarity based on their characteristics. <strong class="keyWord">Content-based filtering</strong> allows providing recommendations based on <a id="_idIndexMarker484"/>article attributes or characteristics. We will ta<a id="_idTextAnchor083"/>ke a look at how we can combine both of these approaches to provide better recommendations.</p>&#13;
    <p class="normal">We will try these scenarios:</p>&#13;
    <ul>&#13;
      <li class="bulletList"><strong class="screenText">Scenario 1</strong>: Filtering articles that belong to other communities</li>&#13;
      <li class="bulletList"><strong class="screenText">Scenario 2</strong>: Filtering articles by characteristics and belonging to other communities</li>&#13;
    </ul>&#13;
    <p class="normal">Let’s discuss Scenario 1 first.</p>&#13;
    <h2 id="_idParaDest-161" class="heading-2">Scenario 1: Filtering articles that belong to other communities</h2>&#13;
    <p class="normal">In<a id="_idIndexMarker485"/> this scenario, we will first find all the articles purchased by all the customers in the same community. Next, we will find the articles purchased by customers who belong to other communities.  The articles that belong to other communities will then be removed. This is followed by filtering out (removing) these articles (belonging to other communities).</p>&#13;
    <p class="normal">For this scenario, we will pick the customer identified by <code class="inlineCode">000ae8a03447710b4de81d85698dfc0559258c93136650efc2429fcca80d699a</code> from community <code class="inlineCode">1696</code>.</p>&#13;
    <ol>&#13;
      <li class="numberedList" value="1">Let us look at the purchase summary for this customer:&#13;
        <pre class="programlisting code"><code class="hljs-code">MATCH (c:Customer)-[r:SUMMER_<a id="_idTextAnchor084"/>2019]-&gt;()&#13;
WHERE&#13;
.id='000ae8a03447710b4de81d85698dfc0559258c93136650efc2429fcca80d699&#13;
'&#13;
WITH c, split(r.summary, '\n') AS s&#13;
WITH c, CASE<a id="_idTextAnchor085"/> WHEN s[2] &lt;&gt; ''<a id="_idTextAnchor086"/> THEN s[2]<a id="_idTextAnchor087"/> ELSE s[3] END AS d&#13;
RETURN d&#13;
</code></pre>&#13;
      </li>&#13;
    </ol>&#13;
    <p class="normal">This Cypher gives us this output:</p>&#13;
    <pre class="programlisting code"><code class="hljs-code">"The customer's fashion preferences indicate a strong inclination towards comfortable yet stylish pieces, often favoring soft fabrics and relaxed fits. The choices reflect a taste for versatile items that can be dressed up or down, particularly in a palette that leans towards darker shades with hints of pink. Overall, there is a notable emphasis on casual wear that combines simplicity with a touch of elegance."&#13;
</code></pre>&#13;
    <ol>&#13;
      <li class="numberedList" value="2">Now let us get<a id="_idIndexMarker486"/> recommendations for this customer – the articles that they have not purchased earlier, using the following Cypher:&#13;
        <pre class="programlisting code"><code class="hljs-code">MATCH (c:Customer {id:'000ae8a03447710b4de81d85698dfc0559258c93136650efc2429fcca80d699a'})&#13;
WITH c&#13;
CALL {&#13;
</code></pre>&#13;
      </li>&#13;
      <li class="numberedList">Get the articles purchased by this customer:&#13;
        <pre class="programlisting code"><code class="hljs-code">    WITH c&#13;
    MATCH (c)-[:SUMMER_2019]-&gt;(start)&#13;
    MATCH (c)-[:FALL_2019]-&gt;(end)&#13;
    MATCH p=(start)-[:NEXT*]-&gt;(end)&#13;
    WITH nodes(p) as txns&#13;
    UNWIND txns as txn&#13;
    MATCH (txn)-[:HAS_ARTICLE]-&gt;(a)&#13;
    WITH DISTINCT a&#13;
    RETURN collect(a) as articles&#13;
}&#13;
WITH c, articles, c.summer_2019_community as community&#13;
CALL {&#13;
</code></pre>&#13;
      </li>&#13;
      <li class="numberedList">Get the<a id="_idIndexMarker487"/> articles purchased by customers in the same community as the original customer:&#13;
        <pre class="programlisting code"><code class="hljs-code">    WITH community&#13;
    MATCH (inc:Customer) WHERE inc.summer_2019_community = community&#13;
    MATCH (inc)-[:SUMMER_2019]-&gt;(start)&#13;
    MATCH (inc)-[:FALL_2019]-&gt;(end)&#13;
    MATCH p=(start)-[:NEXT*]-&gt;(end)&#13;
    WITH nodes(p) as txns&#13;
    UNWIND txns as txn&#13;
    MATCH (txn)-[:HAS_ARTICLE]-&gt;(a)&#13;
    WITH DISTINCT a&#13;
    RETURN collect(a) as inCommunityArticles&#13;
}&#13;
WITH c, articles,  community, inCommunityArticles&#13;
CALL {&#13;
</code></pre>&#13;
      </li>&#13;
      <li class="numberedList">Get the <a id="_idIndexMarker488"/>articles purchased by customers that are not in the same community as the original customer:&#13;
        <pre class="programlisting code"><code class="hljs-code">    WITH community&#13;
    MATCH (outc:Customer) WHERE outc.summer_2019_community is not&#13;
ull and outc.summer_2019_community &lt;&gt; community&#13;
    MATCH (outc)-[:SUMMER_2019]-&gt;(start)&#13;
    MATCH (outc)-[:FALL_2019]-&gt;(end)&#13;
    MATCH p=(start)-[:NEXT*]-&gt;(end)&#13;
    WITH nodes(p) as txns&#13;
    UNWIND txns as txn&#13;
    MATCH (txn)-[:HAS_ARTICLE]-&gt;(a)&#13;
    WITH DISTINCT a&#13;
    RETURN collect(a) as outCommunityArticles&#13;
}&#13;
WITH c, articles,  community, inCommunityArticles,&#13;
utCommunityArticles&#13;
</code></pre>&#13;
      </li>&#13;
      <li class="numberedList">Remove the articles purchased by customers outside the community the original customer belongs to:&#13;
        <pre class="programlisting code"><code class="hljs-code">WITH c, articles, apoc.coll.subtract(inCommunityArticles, outCommunityArticles) as onlyInCommunity&#13;
</code></pre>&#13;
      </li>&#13;
      <li class="numberedList">Remove the articles purchased by the original customer from the <code class="inlineCode">onlyInCommunityArticles</code>:&#13;
        <pre class="programlisting code"><code class="hljs-code">WITH c, apoc.coll.subtract(onlyInCommunity, articles) as notPurchasedButInCommunity&#13;
</code></pre>&#13;
      </li>&#13;
      <li class="numberedList">Provide 10 recommended articles from the remaining list. We are limiting this to 10 articles for simplicity and demonstration purposes. We can look at all the articles and maybe group them by other aspects and provide different recommendations:&#13;
        <pre class="programlisting code"><code class="hljs-code">UNWIND notPurchasedButInCommunity as article&#13;
RETURN article.id as id, article.desc as desc&#13;
LIMIT 10&#13;
</code></pre>&#13;
      </li>&#13;
    </ol>&#13;
    <p class="normal">Here, we get<a id="_idIndexMarker489"/> the articles purchased by the customer first. Then, we retrieve all the articles of the community the customer belongs to. After that, we get all the articles customers belonging to other communities purchased. We get the subset of the articles purchased only by customers in the community. From this set, we remove the articles the customer purchased and provide the articles as recommendations.</p>&#13;
    <p class="normal">The output of this query would look as shown in <em class="italic">Figure 10.4</em>. </p>&#13;
    <table id="table002-1" class="table-container">&#13;
      <tbody>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="normal">Id</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="normal">Desc</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="normal">0708679001</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="normal">Slim-fit, ankle-length jeans in washed, superstretch denim with a high waist, zip fly, fake front pockets and real back pockets.</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="normal">0834749001</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="normal">Oversized jumper in a soft rib knit containing some wool with a polo neck, low dropped shoulders, long, voluminous sleeves, and wide ribbing at the cuffs and hem. The polyester content of the jumper is recycled.</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="normal">0513701002</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="normal">V-neck T-shirts in organic cotton jersey.</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="normal">0522374003</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="normal">Jumper in a soft, fine knit with dropped shoulders, long sleeves and gently rounded hem.</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="normal">0522374001</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="normal">Jumper in a soft, fine knit with dropped shoulders, long sleeves and gently rounded hem.</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="normal">0687041002</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="normal">Long-sleeved, fitted top in soft, organic cotton jersey with a deep neckline, buttons at the top and a rounded hem.</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="normal">0724567004</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="normal">Pyjamas with a strappy top and shorts in soft satin with lace details. Top with a V-neck and narrow adjustable shoulder straps. Shorts with narrow elastication at the waist.</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="normal">0785086001</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="normal">Short satin nightslip with a V-neck, lace trims at the top and hem, and adjustable spaghetti shoulder straps.</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="normal">0725353002</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="normal">Bell-shaped, knee-length skirt in woven fabric with a high waist and a concealed zip and hook-and-eye fastening <a id="_idTextAnchor088"/>in one side. Lined.</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="normal">0604655007</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="normal">Pyjamas in <a id="_idTextAnchor089"/>printed cotton jersey. Short-sleeved top with a round neck. Bottoms with an elasticated waist and wide, gently tapered legs with ribbed hems.</p>&#13;
          </td>&#13;
        </tr>&#13;
      </tbody>&#13;
    </table>&#13;
    <p class="packt_figref">Figure 10.4  — Recommendations by filtering out the articles purchased by a customer and by customers outside the community</p>&#13;
    <p class="normal">These<a id="_idIndexMarker490"/> recommendations do seem to fit into the customer purchase summary.</p>&#13;
    <p class="normal">Now let us look at scenario 2.</p>&#13;
    <h2 id="_idParaDest-162" class="heading-2">Scenario 2: Filtering articles by characteristics and belonging to other communities</h2>&#13;
    <p class="normal">In this scenario, we <a id="_idIndexMarker491"/>want to add article characteristics to the query. This <a id="_idIndexMarker492"/>means, for a customer, we will first find all the articles purchased by the community with certain characteristics. Then we will find the communities these articles belong to and remove the articles that belong to other communities.</p>&#13;
    <p class="normal">For this purpose, we will choose community <code class="inlineCode">5823</code> and the customer with ID <code class="inlineCode">00281c683a8eb0942e22d88275ad756309895813e0648d4b97c7bc8178502b33</code>. Let us look at this customer’s purchases.</p>&#13;
    <ol>&#13;
      <li class="numberedList" value="1">This Cypher gives us this information:&#13;
        <pre class="programlisting code"><code class="hljs-code">MATCH (c:Customer) where c.id='00281c683a8eb0942e22d88275ad756309895813e0648d4b97c7bc8178502b33'&#13;
WITH c&#13;
CALL {&#13;
    WITH c&#13;
    MATCH (c)-[:SUMMER_2019]-&gt;(start)&#13;
    MATCH (c)-[:FALL_2019]-&gt;(end)&#13;
    MATCH p=(start)-[:NEXT*]-&gt;(end)&#13;
    WITH nodes(p) as txns&#13;
    UNWIND txns as txn&#13;
    MATCH (txn)-[:HAS_ARTICLE]-&gt;(a)-[:HAS_SECTION]-&gt;(s)&#13;
    WITH DISTINCT a,s&#13;
    RETURN collect({section:s.name, article:a.desc}) as articles&#13;
}&#13;
return articles&#13;
</code></pre>&#13;
      </li>&#13;
    </ol>&#13;
    <p class="normal">Based on <a id="_idIndexMarker493"/>the preceding <a id="_idIndexMarker494"/>Cypher we get this output:</p>&#13;
    <pre class="programlisting code"><code class="hljs-code">{&#13;
  "article": "5-pocket jeans in washed stretch denim in a relaxed fit with an adjustable elasticated waist, zip fly and press-stud and tapered legs.",&#13;
  "section": "Kids Boy"}&#13;
,&#13;
{&#13;
  "article": "5-pocket jeans in washed stretch denim with hard-worn details in a relaxed fit with an adjustable elasticated waist, zip fly and press-stud, and tapered legs.",&#13;
  "section": "Kids Boy"&#13;
}&#13;
,&#13;
{&#13;
  "article": "Short dress in woven fabric with a collar, buttons down the front and a yoke at the back. Narrow, detachable belt at the waist and long sleeves with buttoned cuffs. Unlined.",&#13;
  "section": "Divided Collection"&#13;
}&#13;
,&#13;
{&#13;
  "article": "Dungarees in washed stretch denim with a three-part chest pocket, adjustable straps with metal fasteners, and front and back pockets. Fake fly, press-studs at the sides, jersey-lined legs and a lining at the hems in a patterned weave.",&#13;
  "section": "Kids Boy"&#13;
}&#13;
</code></pre>&#13;
    <p class="normal">Since this customer is buying clothing from the <code class="inlineCode">"Kids Boy"</code> section, let us retrieve recommendations that belong to this section.</p>&#13;
    <ol>&#13;
      <li class="numberedList" value="2">This Cypher gives us recommendations by adding this section’s details to the earlier query. Let us get the Customer with ID: <code class="inlineCode">00281c683a8eb0942e22d88275ad756309895813e0648d4b97c7bc8178502b33</code> and the section named <code class="inlineCode">Kids Boy</code>:&#13;
        <pre class="programlisting code"><code class="hljs-code">MATCH (c:Customer {id:'00281c683a8eb0942e22d88275ad756309895813e0648d4b97c7bc8178502b33'})&#13;
MATCH (s:Section) WHERE s.name='Kids Boy'&#13;
WITH c,s&#13;
CALL {&#13;
</code></pre>&#13;
      </li>&#13;
      <li class="numberedList">Get the articles<a id="_idIndexMarker495"/> purchased by this customer that belong to the <a id="_idIndexMarker496"/>section of importance:&#13;
        <pre class="programlisting code"><code class="hljs-code">    WITH c,s&#13;
    MATCH (c)-[:SUMMER_2019]-&gt;(start)&#13;
    MATCH (c)-[:FALL_2019]-&gt;(end)&#13;
    MATCH p=(start)-[:NEXT*]-&gt;(end)&#13;
    WITH nodes(p) as txns&#13;
    UNWIND txns as txn&#13;
    MATCH (txn)-[:HAS_ARTICLE]-&gt;(a)-[:HAS_SECTION]-&gt;(s)&#13;
    WITH DISTINCT a&#13;
    RETURN collect(a) as articles&#13;
}&#13;
WITH c, articles,s, c.summer_2019_community as community&#13;
CALL {&#13;
</code></pre>&#13;
      </li>&#13;
      <li class="numberedList">Get the articles that belong to the section of importance purchased by customers in the same community as the original customer:&#13;
        <pre class="programlisting code"><code class="hljs-code">    WITH community, s&#13;
    MATCH (inc:Customer) WHERE inc.summer_2019_community = community&#13;
    MATCH (inc)-[:SUMMER_2019]-&gt;(start)&#13;
    MATCH (inc)-[:FALL_2019]-&gt;(end)&#13;
    MATCH p=(start)-[:NEXT*]-&gt;(end)&#13;
    WITH nodes(p) as txns, s&#13;
    UNWIND txns as txn&#13;
    MATCH (txn)-[:HAS_ARTICLE]-&gt;(a)-[:HAS_SECTION]-&gt;(s)&#13;
    WITH DISTINCT a&#13;
    RETURN collect(a) as inCommunityArticles&#13;
}&#13;
WITH c, articles,  community, inCommunityArticles, s&#13;
CALL {&#13;
</code></pre>&#13;
      </li>&#13;
      <li class="numberedList">Get the articles that belong to the section of importance purchased by customers in the communities<a id="_idIndexMarker497"/> outside the one the original customer <a id="_idIndexMarker498"/>belongs to:&#13;
        <pre class="programlisting code"><code class="hljs-code">    WITH community, s&#13;
    MATCH (outc:Customer) WHERE outc.summer_2019_community is not&#13;
ull and outc.summer_2019_community &lt;&gt; community&#13;
    MATCH (outc)-[:SUMMER_2019]-&gt;(start)&#13;
    MATCH (outc)-[:FALL_2019]-&gt;(end)&#13;
    MATCH p=(start)-[:NEXT*]-&gt;(end)&#13;
    WITH nodes(p) as txns, s&#13;
    UNWIND txns as txn&#13;
    MATCH (txn)-[:HAS_ARTICLE]-&gt;(a)-[:HAS_SECTION]-&gt;(s)&#13;
    WITH DISTINCT a&#13;
    RETURN collect(a) as outCommunityArticles&#13;
}&#13;
WITH c, articles,  community, inCommunityArticles,&#13;
utCommunityArticles&#13;
</code></pre>&#13;
      </li>&#13;
      <li class="numberedList">Remove the articles purchased by customers outside the community from the articles purchased by customers in the community of the original customer:&#13;
        <pre class="programlisting code"><code class="hljs-code">WITH c, articles, apoc.coll.subtract(inCommunityArticles, outCommunityArticles) as onlyInCommunity&#13;
</code></pre>&#13;
      </li>&#13;
      <li class="numberedList">Remove the articles purchased by the original customer from the list of articles we got in the previous step:&#13;
        <pre class="programlisting code"><code class="hljs-code">WITH c, apoc.coll.subtract(onlyInCommunity, articles) as notPurchasedButInCommunity&#13;
</code></pre>&#13;
      </li>&#13;
      <li class="numberedList">Provide 10 of these articles as recommendations:&#13;
        <pre class="programlisting code"><code class="hljs-code">UNWIND notPurchasedButInCommunity as article&#13;
RETURN article.id as id, article.desc as desc&#13;
LIMIT 10&#13;
</code></pre>&#13;
      </li>&#13;
    </ol>&#13;
    <p class="normal">When we run this <a id="_idIndexMarker499"/>query, we will see the output shown<a id="_idIndexMarker500"/> in <em class="italic">Figure 10.5</em>:</p>&#13;
    <table id="table003-1" class="table-container">&#13;
      <tbody>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="normal">Id</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="normal">Desc</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="normal">0505507003</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="normal">5-pocket slim-fit jeans in washed stretch denim with an adjustable elasticated waist and zip fly.</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="normal">0704150011</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="normal">Long-sleeved top in sweatshirt fabric with a motif on the front and ribbing around the neckline, cuffs and hem.</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="normal">0701969005</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="normal">Shorts in soft, patterned cotton twill with an elasticated drawstring waist, fake fly and side pockets.</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="normal">0595548001</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="normal">Shorts in soft, washed denim with an elasticated drawstring waist and a back pocket.</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="normal">0704150006</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="normal">Long-sleeved top in sweatshirt fabric with a motif on the front and ribbing around the neckline, cuffs and hem.</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="normal">0626380001</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="normal">Top in soft, patterned cotton jersey with long sleeves, an open chest pocket and slits at the hem. Slightly longer at the back.</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="normal">0701972005</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="normal">Shorts in woven fabric with an adjustable elasticated waist and decorative drawstring. Zip fly and button, diagonal side pockets and welt back pockets.</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="normal">0771489001</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="normal">T-shirts in airy cotton jersey with a chest pocket and short slits in the sides. Longer at the back.</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="normal">0705911001</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="normal">Vest top in cotton jersey with a print motif and a ribbed trim around the neckline and armholes.</p>&#13;
          </td>&#13;
        </tr>&#13;
        <tr>&#13;
          <td class="table-cell">&#13;
            <p class="normal">0666327011</p>&#13;
          </td>&#13;
          <td class="table-cell">&#13;
            <p class="normal">T-shirt in soft cotton jersey with a motif on the front.</p>&#13;
          </td>&#13;
        </tr>&#13;
      </tbody>&#13;
    </table>&#13;
    <p class="packt_figref">Figure 10.5 — Recommendations that consider purchases and article attributes by filtering out the articles purchased by the customer and by customers outside the community</p>&#13;
    <p class="normal">The demonstrations in this chapter showed how, by using these approaches, we can provide different types of recommendations based on similar purchases by other customers.</p>&#13;
    <h1 id="_idParaDest-163" class="heading-1">Summary</h1>&#13;
    <p class="normal">In this chapter, we looked at how to go beyond a basic recommendation application and leverage graph algorithms to enhance the graph and provide more appropriate recommendations. We explored how we can use the KNN similarity algorithm and community detection to gain hidden insights into the data.</p>&#13;
    <p class="normal">In the upcoming chapters, we will take a look at how we can deploy these applications in the cloud and what best practices we can follow for deployment.</p>&#13;
  </div>&#13;
</div></div></body></html>